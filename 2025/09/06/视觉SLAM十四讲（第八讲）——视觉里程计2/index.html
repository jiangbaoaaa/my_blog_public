<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gen2710.netlify.app","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":100},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="视觉SLAM十四讲（第八讲）——视觉里程计2直接法的引出直接法只计算关键点，不计算描述子，会根据图像的像素灰度信息同时估计相机运动和点的投影，不要求提取到的点必须是角点。直接发根据像素的亮度信息估计相机的运动，可以完全不计算关键点和描述子，只要场景中存在明暗变化，直接法就能工作，根据使用像素的数量，直接法分为系数、稠密、半稠密三种。  特殊点法和直接法的对比     2D光流直接法从光流演变而来，">
<meta property="og:type" content="article">
<meta property="og:title" content="第八讲-视觉里程计2">
<meta property="og:url" content="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/index.html">
<meta property="og:site_name" content="U.N.O">
<meta property="og:description" content="视觉SLAM十四讲（第八讲）——视觉里程计2直接法的引出直接法只计算关键点，不计算描述子，会根据图像的像素灰度信息同时估计相机运动和点的投影，不要求提取到的点必须是角点。直接发根据像素的亮度信息估计相机的运动，可以完全不计算关键点和描述子，只要场景中存在明暗变化，直接法就能工作，根据使用像素的数量，直接法分为系数、稠密、半稠密三种。  特殊点法和直接法的对比     2D光流直接法从光流演变而来，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112719382.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112739282.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828150507385.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-bf1f8c83d411a81b327d1f518d2deda4_r.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828151228168.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828153002903.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20200415221947629.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828161114606.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828165648850.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-6850c4e4acb75faa5e52010975d41686_r.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828173323922.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-22736e7053e97845983719468bb27613_r.jpg">
<meta property="article:published_time" content="2025-09-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-06T03:29:17.042Z">
<meta property="article:author" content="Hita">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112719382.png">


<link rel="canonical" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/","path":"2025/09/06/视觉SLAM十四讲（第八讲）——视觉里程计2/","title":"第八讲-视觉里程计2"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>第八讲-视觉里程计2 | U.N.O</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">U.N.O</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12"><span class="nav-number">1.</span> <span class="nav-text">视觉SLAM十四讲（第八讲）——视觉里程计2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B3%95%E7%9A%84%E5%BC%95%E5%87%BA"><span class="nav-number">1.1.</span> <span class="nav-text">直接法的引出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2D%E5%85%89%E6%B5%81"><span class="nav-number">1.2.</span> <span class="nav-text">2D光流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A-LK%E5%85%89%E6%B5%81"><span class="nav-number">1.3.</span> <span class="nav-text">实践： LK光流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8LK%E5%85%89%E6%B5%81"><span class="nav-number">1.3.1.</span> <span class="nav-text">使用LK光流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E9%AB%98%E6%96%AF%E7%89%9B%E9%A1%BF%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%85%89%E6%B5%81"><span class="nav-number">1.3.2.</span> <span class="nav-text">用高斯牛顿法实现光流</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E5%B1%82%E5%85%89%E6%B5%81"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">单层光流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E5%B1%82%E5%85%89%E6%B5%81"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">多层光流</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%89%E6%B5%81%E5%AE%9E%E8%B7%B5%E5%B0%8F%E7%BB%93"><span class="nav-number">1.3.3.</span> <span class="nav-text">光流实践小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B3%95"><span class="nav-number">1.4.</span> <span class="nav-text">直接法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B3%95%E7%9A%84%E6%8E%A8%E5%AF%BC"><span class="nav-number">1.4.1.</span> <span class="nav-text">直接法的推导</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%B3%95%E7%9A%84%E8%AE%A8%E8%AE%BA"><span class="nav-number">1.4.2.</span> <span class="nav-text">直接法的讨论</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A8%80%E7%96%8F%E7%9B%B4%E6%8E%A5%E6%B3%95"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">稀疏直接法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A8%A0%E5%AF%86%E7%9B%B4%E6%8E%A5%E6%B3%95"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">稠密直接法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8A%E7%A8%A0%E5%AF%86%E7%9B%B4%E6%8E%A5%E6%B3%95"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">半稠密直接法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E7%9B%B4%E6%8E%A5%E6%B3%95"><span class="nav-number">1.5.</span> <span class="nav-text">实践：直接法</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hita"
      src="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
  <p class="site-author-name" itemprop="name">Hita</p>
  <div class="site-description" itemprop="description">Gains Don't Stop!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiangbaoaaa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiangbaoaaa" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:n13155609602@163.com" title="E-mail → mailto:n13155609602@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="第八讲-视觉里程计2 | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第八讲-视觉里程计2
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:29:17" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="视觉SLAM十四讲（第八讲）——视觉里程计2"><a href="#视觉SLAM十四讲（第八讲）——视觉里程计2" class="headerlink" title="视觉SLAM十四讲（第八讲）——视觉里程计2"></a>视觉SLAM十四讲（第八讲）——视觉里程计2</h1><h2 id="直接法的引出"><a href="#直接法的引出" class="headerlink" title="直接法的引出"></a>直接法的引出</h2><p>直接法只计算关键点，不计算描述子，会根据图像的像素灰度信息同时估计相机运动和点的投影，不要求提取到的点必须是角点。直接发根据像素的亮度信息估计相机的运动，可以完全不计算关键点和描述子，只要场景中存在明暗变化，直接法就能工作，根据使用像素的数量，直接法分为系数、稠密、半稠密三种。</p>
<blockquote>
<p>特殊点法和直接法的对比</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112719382.png" alt="image-20250828112719382"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112739282.png" alt="image-20250828112739282"></p>
<hr>
<h2 id="2D光流"><a href="#2D光流" class="headerlink" title="2D光流"></a>2D光流</h2><p>直接法从光流演变而来，光流描述像素在图像中的运动，直接法附带着一个相机运动模型。二者都是基于一个假设：空间中同一个三维点，当它被相机从不同角度拍摄时，它在图像上的像素亮度（灰度）是基本不变的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828150507385.png" alt="image-20250828150507385"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-bf1f8c83d411a81b327d1f518d2deda4_r.jpg" alt="重读《视觉SLAM十四讲》ch8 视觉里程计2 - 知乎"></p>
<p>光流是一种描述像素随时间在图像之间运动的方法，计算部分像素运动称为稀疏光流，计算全部像素称为稠密光流。光流的目标是计算图像中每个像素点在连续两帧之间的<strong>二维运动向量</strong>，这会产出一个<strong>二维向量场</strong>描述纯粹的图像平面上的运动。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828151228168.png" alt="image-20250828151228168"></p>
<p>在SLAM中，LK光流常被用来跟踪角点的运动。</p>
<h2 id="实践：-LK光流"><a href="#实践：-LK光流" class="headerlink" title="实践： LK光流"></a>实践： LK光流</h2><h3 id="使用LK光流"><a href="#使用LK光流" class="headerlink" title="使用LK光流"></a>使用LK光流</h3><p>我们使用两张来自Euroc数据集中的图像，在第一章图像中提取角点，然后利用光流追踪它们在第二张图像中的位置。</p>
<p>把源代码中的图片复制到新建文件夹:<code>slambook/ch8/</code></p>
<p>新建文件:<code>slambook/ch8/optical_flow.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span> <span class="comment">// 【修改】为使用 lambda 包含头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 光流追踪器类定义 (保持不变)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpticalFlowTracker</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">OpticalFlowTracker</span>(</span><br><span class="line">        <span class="type">const</span> Mat &amp;img1_,</span><br><span class="line">        <span class="type">const</span> Mat &amp;img2_,</span><br><span class="line">        <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1_,</span><br><span class="line">        vector&lt;KeyPoint&gt; &amp;kp2_,</span><br><span class="line">        vector&lt;<span class="type">bool</span>&gt; &amp;success_,</span><br><span class="line">        <span class="type">bool</span> inverse_ = <span class="literal">true</span>, <span class="type">bool</span> has_initial_ = <span class="literal">false</span>) :</span><br><span class="line">        <span class="built_in">img1</span>(img1_), <span class="built_in">img2</span>(img2_), <span class="built_in">kp1</span>(kp1_), <span class="built_in">kp2</span>(kp2_), <span class="built_in">success</span>(success_), <span class="built_in">inverse</span>(inverse_),</span><br><span class="line">        <span class="built_in">has_initial</span>(has_initial_) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">calculateOpticalFlow</span><span class="params">(<span class="type">const</span> Range &amp;range)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> Mat &amp;img1;</span><br><span class="line">    <span class="type">const</span> Mat &amp;img2;</span><br><span class="line">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1;</span><br><span class="line">    vector&lt;KeyPoint&gt; &amp;kp2;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; &amp;success;</span><br><span class="line">    <span class="type">bool</span> inverse = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">bool</span> has_initial = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明 (保持不变)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowSingleLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> has_initial_guess = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowMultiLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【修改】稍微清理了边界检查逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">float</span> <span class="title">GetPixelValue</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, <span class="type">float</span> x, <span class="type">float</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 边界检查</span></span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>) x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>) y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= img.cols - <span class="number">1</span>) x = img.cols - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= img.rows - <span class="number">1</span>) y = img.rows - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> xx = x - <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">float</span> yy = y - <span class="built_in">floor</span>(y);</span><br><span class="line">    <span class="type">int</span> x_int = <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">int</span> y_int = <span class="built_in">floor</span>(y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> - xx) * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int)</span><br><span class="line">           + xx * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int + <span class="number">1</span>)</span><br><span class="line">           + (<span class="number">1</span> - xx) * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int)</span><br><span class="line">           + xx * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 【修改】将全局变量移入 main 作为常量</span></span><br><span class="line">    <span class="type">const</span> string file_1 = <span class="string">&quot;../LK1.png&quot;</span>;  <span class="comment">// first image</span></span><br><span class="line">    <span class="type">const</span> string file_2 = <span class="string">&quot;../LK2.png&quot;</span>;  <span class="comment">// second image</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 【修改】使用 cv::IMREAD_GRAYSCALE 替换旧的宏 `0`</span></span><br><span class="line">    Mat img1 = <span class="built_in">imread</span>(file_1, cv::IMREAD_GRAYSCALE);</span><br><span class="line">    Mat img2 = <span class="built_in">imread</span>(file_2, cv::IMREAD_GRAYSCALE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (img<span class="number">1.</span><span class="built_in">empty</span>() || img<span class="number">2.</span><span class="built_in">empty</span>()) &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Could not open or find the images!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 GFTT 检测特征点</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp1;</span><br><span class="line">    Ptr&lt;GFTTDetector&gt; detector = GFTTDetector::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">0.01</span>, <span class="number">20</span>);</span><br><span class="line">    detector-&gt;<span class="built_in">detect</span>(img1, kp1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单层光流</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp2_single;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; success_single;</span><br><span class="line">    <span class="built_in">OpticalFlowSingleLevel</span>(img1, img2, kp1, kp2_single, success_single);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多层光流</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp2_multi;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; success_multi;</span><br><span class="line">    chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">OpticalFlowMultiLevel</span>(img1, img2, kp1, kp2_multi, success_multi, <span class="literal">true</span>);</span><br><span class="line">    chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;optical flow by gauss-newton: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// OpenCV 的光流函数作为对比</span></span><br><span class="line">    vector&lt;Point2f&gt; pt1, pt2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: kp1) pt<span class="number">1.</span><span class="built_in">push_back</span>(kp.pt);</span><br><span class="line">    vector&lt;uchar&gt; status;</span><br><span class="line">    vector&lt;<span class="type">float</span>&gt; error;</span><br><span class="line">    t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    cv::<span class="built_in">calcOpticalFlowPyrLK</span>(img1, img2, pt1, pt2, status, error);</span><br><span class="line">    t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;optical flow by opencv: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制结果</span></span><br><span class="line">    Mat img2_single, img2_multi, img2_CV;</span><br><span class="line">    <span class="comment">// 【修改】使用 cv::COLOR_GRAY2BGR 替换旧的宏</span></span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_single, cv::COLOR_GRAY2BGR);</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_multi, cv::COLOR_GRAY2BGR);</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_CV, cv::COLOR_GRAY2BGR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; kp2_single.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (success_single[i]) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_single, kp2_single[i].pt, <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_single, kp1[i].pt, kp2_single[i].pt, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; kp2_multi.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (success_multi[i]) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_multi, kp2_multi[i].pt, <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_multi, kp1[i].pt, kp2_multi[i].pt, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pt<span class="number">2.</span><span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status[i]) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_CV, pt2[i], <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_CV, pt1[i], pt2[i], cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;tracked single level&quot;</span>, img2_single);</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;tracked multi level&quot;</span>, img2_multi);</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;tracked by opencv&quot;</span>, img2_CV);</span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowSingleLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse, <span class="type">bool</span> has_initial)</span> </span>&#123;</span><br><span class="line">    kp<span class="number">2.</span><span class="built_in">resize</span>(kp<span class="number">1.</span><span class="built_in">size</span>());</span><br><span class="line">    success.<span class="built_in">resize</span>(kp<span class="number">1.</span><span class="built_in">size</span>());</span><br><span class="line">    <span class="function">OpticalFlowTracker <span class="title">tracker</span><span class="params">(img1, img2, kp1, kp2, success, inverse, has_initial)</span></span>;</span><br><span class="line">    <span class="comment">// 【修改】使用 Lambda 表达式替代 std::bind，更简洁</span></span><br><span class="line">    <span class="built_in">parallel_for_</span>(<span class="built_in">Range</span>(<span class="number">0</span>, kp<span class="number">1.</span><span class="built_in">size</span>()),</span><br><span class="line">                  [&amp;](<span class="type">const</span> Range &amp;range) &#123;</span><br><span class="line">                      tracker.<span class="built_in">calculateOpticalFlow</span>(range);</span><br><span class="line">                  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowTracker::calculateOpticalFlow</span><span class="params">(<span class="type">const</span> Range &amp;range)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// parameters</span></span><br><span class="line">    <span class="type">int</span> half_patch_size = <span class="number">4</span>;</span><br><span class="line">    <span class="type">int</span> iterations = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = range.start; i &lt; range.end; i++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> kp = kp1[i];</span><br><span class="line">        <span class="type">double</span> dx = <span class="number">0</span>, dy = <span class="number">0</span>; <span class="comment">// dx,dy need to be estimated</span></span><br><span class="line">        <span class="keyword">if</span> (has_initial) &#123;</span><br><span class="line">            dx = kp2[i].pt.x - kp.pt.x;</span><br><span class="line">            dy = kp2[i].pt.y - kp.pt.y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> cost = <span class="number">0</span>, lastCost = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> succ = <span class="literal">true</span>; <span class="comment">// indicate if this point succeeded</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gauss-Newton iterations</span></span><br><span class="line">        Eigen::Matrix2d H = Eigen::Matrix2d::<span class="built_in">Zero</span>();    <span class="comment">// hessian</span></span><br><span class="line">        Eigen::Vector2d b = Eigen::Vector2d::<span class="built_in">Zero</span>();    <span class="comment">// bias</span></span><br><span class="line">        Eigen::Vector2d J;  <span class="comment">// jacobian</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; iterations; iter++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!inverse) &#123;</span><br><span class="line">                H = Eigen::Matrix2d::<span class="built_in">Zero</span>();</span><br><span class="line">                b = Eigen::Vector2d::<span class="built_in">Zero</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                b = Eigen::Vector2d::<span class="built_in">Zero</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cost = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// compute cost and jacobian</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> x = -half_patch_size; x &lt; half_patch_size; x++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> y = -half_patch_size; y &lt; half_patch_size; y++) &#123;</span><br><span class="line">                    <span class="type">double</span> error = <span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x, kp.pt.y + y) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img2, kp.pt.x + x + dx, kp.pt.y + y + dy);</span><br><span class="line">                    <span class="keyword">if</span> (!inverse) &#123;</span><br><span class="line">                        J = <span class="number">-1.0</span> * Eigen::<span class="built_in">Vector2d</span>(</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x + <span class="number">1</span>, kp.pt.y + dy + y) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x - <span class="number">1</span>, kp.pt.y + dy + y)),</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x, kp.pt.y + dy + y + <span class="number">1</span>) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x, kp.pt.y + dy + y - <span class="number">1</span>))</span><br><span class="line">                        );</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iter == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// in inverse mode, J keeps same for all iterations</span></span><br><span class="line">                        J = <span class="number">-1.0</span> * Eigen::<span class="built_in">Vector2d</span>(</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x + <span class="number">1</span>, kp.pt.y + y) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x - <span class="number">1</span>, kp.pt.y + y)),</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x, kp.pt.y + y + <span class="number">1</span>) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x, kp.pt.y + y - <span class="number">1</span>))</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                    b += -error * J;</span><br><span class="line">                    cost += error * error;</span><br><span class="line">                    <span class="keyword">if</span> (!inverse || iter == <span class="number">0</span>) &#123;</span><br><span class="line">                        H += J * J.<span class="built_in">transpose</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// compute update</span></span><br><span class="line">            Eigen::Vector2d update = H.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(b);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (std::<span class="built_in">isnan</span>(update[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="comment">// sometimes occurred when we have a black or white patch and H is irreversible</span></span><br><span class="line">                <span class="comment">// cout &lt;&lt; &quot;update is nan&quot; &lt;&lt; endl;</span></span><br><span class="line">                succ = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (iter &gt; <span class="number">0</span> &amp;&amp; cost &gt; lastCost) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// update dx, dy</span></span><br><span class="line">            dx += update[<span class="number">0</span>];</span><br><span class="line">            dy += update[<span class="number">1</span>];</span><br><span class="line">            lastCost = cost;</span><br><span class="line">            succ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (update.<span class="built_in">norm</span>() &lt; <span class="number">1e-2</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        success[i] = succ;</span><br><span class="line">        kp2[i].pt = kp.pt + <span class="built_in">Point2f</span>(dx, dy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowMultiLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parameters</span></span><br><span class="line">    <span class="type">int</span> pyramids = <span class="number">4</span>;</span><br><span class="line">    <span class="type">double</span> pyramid_scale = <span class="number">0.5</span>;</span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; scales = &#123;<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.25</span>, <span class="number">0.125</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create pyramids</span></span><br><span class="line">    vector&lt;Mat&gt; pyr1, pyr2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pyramids; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Mat img1_pyr, img2_pyr;</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr1[i - <span class="number">1</span>], img1_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr1[i - <span class="number">1</span>].cols * pyramid_scale, pyr1[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr2[i - <span class="number">1</span>], img2_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr2[i - <span class="number">1</span>].cols * pyramid_scale, pyr2[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1_pyr);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2_pyr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// coarse-to-fine LK tracking in pyramids</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp1_pyr = kp1;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp : kp1_pyr) &#123;</span><br><span class="line">        kp.pt *= scales[pyramids - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vector&lt;KeyPoint&gt; kp2_pyr = kp1_pyr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> level = pyramids - <span class="number">1</span>; level &gt;= <span class="number">0</span>; level--) &#123;</span><br><span class="line">        <span class="comment">// from coarse to fine</span></span><br><span class="line">        success.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">OpticalFlowSingleLevel</span>(pyr1[level], pyr2[level], kp1_pyr, kp2_pyr, success, inverse, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (level &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: kp1_pyr)</span><br><span class="line">                kp.pt /= pyramid_scale;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: kp2_pyr)</span><br><span class="line">                kp.pt /= pyramid_scale;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kp2 = kp2_pyr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置最低 CMake 版本要求，以支持现代 CMake 命令</span></span><br><span class="line">cmake_minimum_required(VERSION 3.12)</span><br><span class="line">project(ch8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 C++ 标准为 17</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建议在命令行中设置编译类型, e.g., cmake -DCMAKE_BUILD_TYPE=Release ..</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 查找依赖包 ---</span></span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(Pangolin REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义可执行文件目标 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标 1: optical_flow</span></span><br><span class="line">add_executable(optical_flow optical_flow.cpp)</span><br><span class="line"><span class="comment"># 优化：开启原生指令集优化，提高运行速度</span></span><br><span class="line">target_compile_options(optical_flow PRIVATE -march=native)</span><br><span class="line"><span class="comment"># 链接库</span></span><br><span class="line">target_link_libraries(optical_flow</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">    Eigen3::Eigen</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标 2: direct_method</span></span><br><span class="line"><span class="comment"># add_executable(direct_method direct_method.cpp)</span></span><br><span class="line"><span class="comment"># # 为该目标添加头文件目录</span></span><br><span class="line"><span class="comment"># target_include_directories(direct_method</span></span><br><span class="line"><span class="comment">#     PRIVATE</span></span><br><span class="line"><span class="comment">#     $&#123;Sophus_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment">#     $&#123;Pangolin_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment">#     $&#123;EIGEN3_INCLUDE_DIR&#125;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"><span class="comment"># # 优化：开启原生指令集优化</span></span><br><span class="line"><span class="comment"># target_compile_options(direct_method PRIVATE -march=native)</span></span><br><span class="line"><span class="comment"># # 链接库</span></span><br><span class="line"><span class="comment"># target_link_libraries(direct_method</span></span><br><span class="line"><span class="comment">#     PRIVATE</span></span><br><span class="line"><span class="comment">#     $&#123;OpenCV_LIBS&#125;</span></span><br><span class="line"><span class="comment">#     Sophus::Sophus</span></span><br><span class="line"><span class="comment">#     $&#123;Pangolin_LIBRARIES&#125;</span></span><br><span class="line"><span class="comment">#     Eigen3::Eigen</span></span><br><span class="line"><span class="comment"># )</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828153002903.png" alt="image-20250828153002903"></p>
<p>所有的窗口的背景都是第二张图片，绿色的线代表一个特征点的运动轨迹，线的起点是一个特征点在第一张图片中的位置，线的终点时算法追踪到的、在第二张图片中的新位置。绿色的圈表示特征点在第二章图片的最终位置。</p>
<p>三个图片分别展示了单程光流、多层光流、OpenCV光流追踪的结果。</p>
<h3 id="用高斯牛顿法实现光流"><a href="#用高斯牛顿法实现光流" class="headerlink" title="用高斯牛顿法实现光流"></a>用高斯牛顿法实现光流</h3><h4 id="单层光流"><a href="#单层光流" class="headerlink" title="单层光流"></a>单层光流</h4><p>光流可以看成一个优化问题，通过最小化灰度误差估计最优的像素偏移，所以可以实现一个基于高斯牛顿法的光流。</p>
<h4 id="多层光流"><a href="#多层光流" class="headerlink" title="多层光流"></a>多层光流</h4><p>如果相机运动较快，两张图像差异明显，那么单层图像光流容易达到一个局部极小值，可以引入图像金字塔来改善。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20200415221947629.jpg" alt="图像处理作业4——图像金字塔多尺度特征提取（改进版）_金字塔特征提取-CSDN博客"></p>
<p>图像金字塔是指对同一个图像进行缩放，得到不同分辨率下的图像。金字塔的底部是高分辨率图像，顶部是低分辨率图像。在计算光流时，先从顶层图像开始计算，然后把上一层追踪结果，作为下一层光流的初始值，这是一个由粗至精的光流，也是实际光流法通常的流程。这个好处在于，当原始图像的像素运动较大时，在金字塔顶层图像看来，运动仍然在一个很小的范围内。</p>
<h3 id="光流实践小结"><a href="#光流实践小结" class="headerlink" title="光流实践小结"></a>光流实践小结</h3><p>LK光流跟踪能够直接得到特征点的对应关系，就像是描述子的匹配，只是光流对图像的连续性和光照稳定性要求较高。光流法可以加速基于特征点的视觉里程计算法，避免计算和匹配描述子的过程，但要求相机运动较为平滑。</p>
<h2 id="直接法"><a href="#直接法" class="headerlink" title="直接法"></a>直接法</h2><p>直接法的的目标是估计相机本身的三维空间运动，会产出一个六自由度的三维变换，描述相机从第一个位置移动到第二个位置的完整过程。</p>
<h3 id="直接法的推导"><a href="#直接法的推导" class="headerlink" title="直接法的推导"></a>直接法的推导</h3><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828161114606.png" alt="image-20250828161114606"></p>
<h3 id="直接法的讨论"><a href="#直接法的讨论" class="headerlink" title="直接法的讨论"></a>直接法的讨论</h3><p>假设$P$是一个已知位置的空间点，并且深度也是已知的，根据$P$的来源，可以把直接法分类</p>
<h4 id="稀疏直接法"><a href="#稀疏直接法" class="headerlink" title="稀疏直接法"></a>稀疏直接法</h4><p>这个方法最接近特征点法，这并不使用图像中所有的像素点，只是选择一组稀疏的、具有代表性的像素点。这些点通常时角点或者梯度非常明显的点。虽然要选择角点，但是与特征点法不同的是：<strong>它不计算描述子</strong>，而是直接使用角点周围的一小块图像(patch)的像素亮度信息进行追踪和位姿优化。速度虽然很快，但是信息丢失严重。</p>
<h4 id="稠密直接法"><a href="#稠密直接法" class="headerlink" title="稠密直接法"></a>稠密直接法</h4><p>这种方法最为极端，同时也是理论上利用信息最充分的方法</p>
<p>它会尝试使用图像帧中所有拥有有效深度值的像素来构建广度误差模型，进行位姿优化。信息最为完整，但是需要巨大的计算量</p>
<h4 id="半稠密直接法"><a href="#半稠密直接法" class="headerlink" title="半稠密直接法"></a>半稠密直接法</h4><p>这是介于稀疏和稠密之间的一种非常使用和流行的折中方案</p>
<p>它的策略是：<strong>选择图像中梯度（亮度变化）比较明显的像素点</strong>，这意味着会忽略大部分没有纹理的区域，但是会保留物体的边缘等所有能够提供优化信息的地方。</p>
<hr>
<h2 id="实践：直接法"><a href="#实践：直接法" class="headerlink" title="实践：直接法"></a>实践：直接法</h2><p>求解直接法最后等价于求解一个优化问题，因此可以使用g2o或者Ceres这些优化库来求解，同样也可以使用金字塔式的多层直接法。</p>
<p>将原始图片lift.png，五张不同位置图片000001-000005.png,一张深度图disparity.png放入文件夹<code>slambook/ch8/</code>下，新建文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sophus/se3.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pangolin/pangolin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Sophus;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useful typedefs</span></span><br><span class="line"><span class="keyword">typedef</span> Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">6</span>, <span class="number">6</span>&gt; Matrix6d;</span><br><span class="line"><span class="keyword">typedef</span> Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">2</span>, <span class="number">6</span>&gt; Matrix26d;</span><br><span class="line"><span class="keyword">typedef</span> Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">6</span>, <span class="number">1</span>&gt; Vector6d;</span><br><span class="line"><span class="keyword">typedef</span> vector&lt;Eigen::Vector2d, Eigen::aligned_allocator&lt;Eigen::Vector2d&gt;&gt; VecVector2d;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将相机内参封装到结构体中</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CameraIntrinsics</span> &#123;</span><br><span class="line">    <span class="type">double</span> fx, fy, cx, cy, baseline;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bilinear interpolation</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">float</span> <span class="title">GetPixelValue</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, <span class="type">float</span> x, <span class="type">float</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 边界检查</span></span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>) x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>) y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= img.cols - <span class="number">1</span>) x = img.cols - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= img.rows - <span class="number">1</span>) y = img.rows - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> xx = x - <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">float</span> yy = y - <span class="built_in">floor</span>(y);</span><br><span class="line">    <span class="type">int</span> x_int = <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">int</span> y_int = <span class="built_in">floor</span>(y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> - xx) * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int)</span><br><span class="line">           + xx * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int + <span class="number">1</span>)</span><br><span class="line">           + (<span class="number">1</span> - xx) * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int)</span><br><span class="line">           + xx * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// class for accumulator jacobians in parallel</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JacobianAccumulator</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">JacobianAccumulator</span>(</span><br><span class="line">        <span class="type">const</span> cv::Mat &amp;img1_,</span><br><span class="line">        <span class="type">const</span> cv::Mat &amp;img2_,</span><br><span class="line">        <span class="type">const</span> VecVector2d &amp;px_ref_,</span><br><span class="line">        <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref_,</span><br><span class="line">        <span class="type">const</span> CameraIntrinsics&amp; camera_,</span><br><span class="line">        SE3d &amp;T21_) :</span><br><span class="line">        <span class="built_in">img1</span>(img1_), <span class="built_in">img2</span>(img2_), <span class="built_in">px_ref</span>(px_ref_), <span class="built_in">depth_ref</span>(depth_ref_), <span class="built_in">camera</span>(camera_), <span class="built_in">T21</span>(T21_) &#123;</span><br><span class="line">        projection.<span class="built_in">resize</span>(px_ref.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">accumulate_jacobian</span><span class="params">(<span class="type">const</span> cv::Range &amp;range)</span></span>;</span><br><span class="line">    <span class="function">Matrix6d <span class="title">hessian</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> H; &#125;</span><br><span class="line">    <span class="function">Vector6d <span class="title">bias</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> b; &#125;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">cost_func</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> cost; &#125;</span><br><span class="line">    <span class="function">VecVector2d <span class="title">projected_points</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> projection; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        H = Matrix6d::<span class="built_in">Zero</span>();</span><br><span class="line">        b = Vector6d::<span class="built_in">Zero</span>();</span><br><span class="line">        cost = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> cv::Mat &amp;img1;</span><br><span class="line">    <span class="type">const</span> cv::Mat &amp;img2;</span><br><span class="line">    <span class="type">const</span> VecVector2d &amp;px_ref;</span><br><span class="line">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref;</span><br><span class="line">    <span class="type">const</span> CameraIntrinsics&amp; camera;</span><br><span class="line">    SE3d &amp;T21;</span><br><span class="line">    VecVector2d projection;</span><br><span class="line"></span><br><span class="line">    std::mutex hessian_mutex;</span><br><span class="line">    Matrix6d H = Matrix6d::<span class="built_in">Zero</span>();</span><br><span class="line">    Vector6d b = Vector6d::<span class="built_in">Zero</span>();</span><br><span class="line">    <span class="type">double</span> cost = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationSingleLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationMultiLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> string left_file = <span class="string">&quot;../left.png&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string disparity_file = <span class="string">&quot;../disparity.png&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string other_files_fmt = <span class="string">&quot;../%06d.png&quot;</span>;</span><br><span class="line"></span><br><span class="line">    CameraIntrinsics camera = &#123;<span class="number">718.856</span>, <span class="number">718.856</span>, <span class="number">607.1928</span>, <span class="number">185.2157</span>, <span class="number">0.573</span>&#125;;</span><br><span class="line"></span><br><span class="line">    cv::Mat left_img = cv::<span class="built_in">imread</span>(left_file, cv::IMREAD_GRAYSCALE);</span><br><span class="line">    cv::Mat disparity_img = cv::<span class="built_in">imread</span>(disparity_file, cv::IMREAD_GRAYSCALE);</span><br><span class="line"></span><br><span class="line">    cv::RNG rng;</span><br><span class="line">    <span class="type">int</span> nPoints = <span class="number">2000</span>;</span><br><span class="line">    <span class="type">int</span> boarder = <span class="number">20</span>;</span><br><span class="line">    VecVector2d pixels_ref;</span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; depth_ref;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nPoints; i++) &#123;</span><br><span class="line">        <span class="type">int</span> x = rng.<span class="built_in">uniform</span>(boarder, left_img.cols - boarder);</span><br><span class="line">        <span class="type">int</span> y = rng.<span class="built_in">uniform</span>(boarder, left_img.rows - boarder);</span><br><span class="line">        <span class="type">int</span> disparity = disparity_img.<span class="built_in">at</span>&lt;uchar&gt;(y, x);</span><br><span class="line">        <span class="keyword">if</span> (disparity == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">double</span> depth = camera.fx * camera.baseline / disparity;</span><br><span class="line">        depth_ref.<span class="built_in">push_back</span>(depth);</span><br><span class="line">        pixels_ref.<span class="built_in">push_back</span>(Eigen::<span class="built_in">Vector2d</span>(x, y));</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Generated &quot;</span> &lt;&lt; pixels_ref.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; reference points.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    SE3d T_cur_ref;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        <span class="type">char</span> filename[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="built_in">sizeof</span>(filename), other_files_fmt.<span class="built_in">c_str</span>(), i);</span><br><span class="line">        cv::Mat img = cv::<span class="built_in">imread</span>(filename, cv::IMREAD_GRAYSCALE);</span><br><span class="line">        <span class="keyword">if</span> (img.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Could not load image &quot;</span> &lt;&lt; filename &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;\n--- Tracking frame &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; ---&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">DirectPoseEstimationMultiLayer</span>(left_img, img, pixels_ref, depth_ref, camera, T_cur_ref);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationSingleLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> iterations = <span class="number">10</span>;</span><br><span class="line">    <span class="type">double</span> cost = <span class="number">0</span>, lastCost = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="function">JacobianAccumulator <span class="title">jaco_accu</span><span class="params">(img1, img2, px_ref, depth_ref, camera, T21)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; iterations; iter++) &#123;</span><br><span class="line">        jaco_accu.<span class="built_in">reset</span>();</span><br><span class="line">        cv::<span class="built_in">parallel_for_</span>(cv::<span class="built_in">Range</span>(<span class="number">0</span>, px_ref.<span class="built_in">size</span>()),</span><br><span class="line">                          [&amp;](<span class="type">const</span> cv::Range&amp; range)&#123;</span><br><span class="line">                              jaco_accu.<span class="built_in">accumulate_jacobian</span>(range);</span><br><span class="line">                          &#125;);</span><br><span class="line">        Matrix6d H = jaco_accu.<span class="built_in">hessian</span>();</span><br><span class="line">        Vector6d b = jaco_accu.<span class="built_in">bias</span>();</span><br><span class="line"></span><br><span class="line">        Vector6d update = H.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(b);</span><br><span class="line">        T21 = SE3d::<span class="built_in">exp</span>(update) * T21;</span><br><span class="line">        cost = jaco_accu.<span class="built_in">cost_func</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (std::<span class="built_in">isnan</span>(update[<span class="number">0</span>])) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;update is nan&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (iter &gt; <span class="number">0</span> &amp;&amp; cost &gt; lastCost) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;cost increased: &quot;</span> &lt;&lt; cost &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; lastCost &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (update.<span class="built_in">norm</span>() &lt; <span class="number">1e-3</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastCost = cost;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;iteration: &quot;</span> &lt;&lt; iter &lt;&lt; <span class="string">&quot;, cost: &quot;</span> &lt;&lt; cost &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;T21 = \n&quot;</span> &lt;&lt; T<span class="number">21.</span><span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">auto</span> t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;direct method for single layer time: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// plot the projected pixels</span></span><br><span class="line">    cv::Mat img2_show;</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_show, cv::COLOR_GRAY2BGR);</span><br><span class="line">    VecVector2d projection = jaco_accu.<span class="built_in">projected_points</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; px_ref.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        <span class="keyword">auto</span> p_ref = px_ref[i];</span><br><span class="line">        <span class="keyword">auto</span> p_cur = projection[i];</span><br><span class="line">        <span class="keyword">if</span> (p_cur[<span class="number">0</span>] &gt; <span class="number">0</span> &amp;&amp; p_cur[<span class="number">1</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_show, cv::<span class="built_in">Point2f</span>(p_cur[<span class="number">0</span>], p_cur[<span class="number">1</span>]), <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_show, cv::<span class="built_in">Point2f</span>(p_ref[<span class="number">0</span>], p_ref[<span class="number">1</span>]), cv::<span class="built_in">Point2f</span>(p_cur[<span class="number">0</span>], p_cur[<span class="number">1</span>]),</span><br><span class="line">                     cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;current&quot;</span>, img2_show);</span><br><span class="line">    <span class="comment">// 【修改】将 waitKey(1) 改为 waitKey(0)，程序会在此暂停等待用户按键</span></span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">JacobianAccumulator::accumulate_jacobian</span><span class="params">(<span class="type">const</span> cv::Range &amp;range)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> half_patch_size = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> cnt_good = <span class="number">0</span>;</span><br><span class="line">    Matrix6d hessian_local = Matrix6d::<span class="built_in">Zero</span>();</span><br><span class="line">    Vector6d bias_local = Vector6d::<span class="built_in">Zero</span>();</span><br><span class="line">    <span class="type">double</span> cost_tmp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = range.start; i &lt; range.end; i++) &#123;</span><br><span class="line">        Eigen::Vector3d point_ref =</span><br><span class="line">            depth_ref[i] * Eigen::<span class="built_in">Vector3d</span>((px_ref[i][<span class="number">0</span>] - camera.cx) / camera.fx,</span><br><span class="line">                                           (px_ref[i][<span class="number">1</span>] - camera.cy) / camera.fy, <span class="number">1</span>);</span><br><span class="line">        Eigen::Vector3d point_cur = T21 * point_ref;</span><br><span class="line">        <span class="keyword">if</span> (point_cur[<span class="number">2</span>] &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> u = camera.fx * point_cur[<span class="number">0</span>] / point_cur[<span class="number">2</span>] + camera.cx;</span><br><span class="line">        <span class="type">float</span> v = camera.fy * point_cur[<span class="number">1</span>] / point_cur[<span class="number">2</span>] + camera.cy;</span><br><span class="line">        <span class="keyword">if</span> (u &lt; half_patch_size || u &gt; img<span class="number">2.</span>cols - half_patch_size ||</span><br><span class="line">            v &lt; half_patch_size || v &gt; img<span class="number">2.</span>rows - half_patch_size) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        projection[i] = Eigen::<span class="built_in">Vector2d</span>(u, v);</span><br><span class="line">        <span class="type">double</span> X = point_cur[<span class="number">0</span>], Y = point_cur[<span class="number">1</span>], Z = point_cur[<span class="number">2</span>];</span><br><span class="line">        <span class="type">double</span> Z_inv = <span class="number">1.0</span> / Z, Z2_inv = Z_inv * Z_inv;</span><br><span class="line">        cnt_good++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = -half_patch_size; x &lt;= half_patch_size; x++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> y = -half_patch_size; y &lt;= half_patch_size; y++) &#123;</span><br><span class="line">                <span class="type">double</span> error = <span class="built_in">GetPixelValue</span>(img1, px_ref[i][<span class="number">0</span>] + x, px_ref[i][<span class="number">1</span>] + y) -</span><br><span class="line">                               <span class="built_in">GetPixelValue</span>(img2, u + x, v + y);</span><br><span class="line">                Matrix26d J_pixel_xi;</span><br><span class="line">                Eigen::Vector2d J_img_pixel;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">0</span>) = camera.fx * Z_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">2</span>) = -camera.fx * X * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">3</span>) = -camera.fx * X * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">4</span>) = camera.fx + camera.fx * X * X * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">5</span>) = -camera.fx * Y * Z_inv;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">0</span>) = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">1</span>) = camera.fy * Z_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">2</span>) = -camera.fy * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">3</span>) = -camera.fy - camera.fy * Y * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">4</span>) = camera.fy * X * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">5</span>) = camera.fy * X * Z_inv;</span><br><span class="line"></span><br><span class="line">                J_img_pixel = Eigen::<span class="built_in">Vector2d</span>(</span><br><span class="line">                    <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, u + <span class="number">1</span> + x, v + y) - <span class="built_in">GetPixelValue</span>(img2, u - <span class="number">1</span> + x, v + y)),</span><br><span class="line">                    <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, u + x, v + <span class="number">1</span> + y) - <span class="built_in">GetPixelValue</span>(img2, u + x, v - <span class="number">1</span> + y))</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                Vector6d J = <span class="number">-1.0</span> * (J_img_pixel.<span class="built_in">transpose</span>() * J_pixel_xi).<span class="built_in">transpose</span>();</span><br><span class="line">                hessian_local += J * J.<span class="built_in">transpose</span>();</span><br><span class="line">                bias_local += -error * J;</span><br><span class="line">                cost_tmp += error * error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cnt_good) &#123;</span><br><span class="line">        <span class="function">unique_lock&lt;mutex&gt; <span class="title">lck</span><span class="params">(hessian_mutex)</span></span>;</span><br><span class="line">        H += hessian_local;</span><br><span class="line">        b += bias_local;</span><br><span class="line">        cost += cost_tmp / cnt_good;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationMultiLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera_master,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pyramids = <span class="number">4</span>;</span><br><span class="line">    <span class="type">double</span> pyramid_scale = <span class="number">0.5</span>;</span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; scales = &#123;<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.25</span>, <span class="number">0.125</span>&#125;;</span><br><span class="line"></span><br><span class="line">    vector&lt;cv::Mat&gt; pyr1, pyr2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pyramids; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cv::Mat img1_pyr, img2_pyr;</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr1[i - <span class="number">1</span>], img1_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr1[i - <span class="number">1</span>].cols * pyramid_scale, pyr1[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr2[i - <span class="number">1</span>], img2_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr2[i - <span class="number">1</span>].cols * pyramid_scale, pyr2[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1_pyr);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2_pyr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CameraIntrinsics camera_pyr = camera_master;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> level = pyramids - <span class="number">1</span>; level &gt;= <span class="number">0</span>; level--) &#123;</span><br><span class="line">        VecVector2d px_ref_pyr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;px: px_ref) &#123;</span><br><span class="line">            px_ref_pyr.<span class="built_in">push_back</span>(scales[level] * px);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        camera_pyr.fx = camera_master.fx * scales[level];</span><br><span class="line">        camera_pyr.fy = camera_master.fy * scales[level];</span><br><span class="line">        camera_pyr.cx = camera_master.cx * scales[level];</span><br><span class="line">        camera_pyr.cy = camera_master.cy * scales[level];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">DirectPoseEstimationSingleLayer</span>(pyr1[level], pyr2[level], px_ref_pyr, depth_ref, camera_pyr, T21);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch8/build$ ./direct_method </span><br><span class="line">Generated 2000 reference points.</span><br><span class="line"></span><br><span class="line">--- Tracking frame 1 ---</span><br><span class="line">iteration: 0, cost: 1.3471e+07</span><br><span class="line">iteration: 1, cost: 5.51357e+06</span><br><span class="line">iteration: 2, cost: 2.05839e+06</span><br><span class="line">iteration: 3, cost: 1.4464e+06</span><br><span class="line">cost increased: 1.44682e+06, 1.4464e+06</span><br><span class="line">T21 = </span><br><span class="line">   0.999991  0.00227962  0.00349265 -0.00108759</span><br><span class="line">-0.00228906    0.999994  0.00270175 0.000362411</span><br><span class="line">-0.00348647 -0.00270972     0.99999     -0.7297</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.0482883s</span><br><span class="line">iteration: 0, cost: 1.87757e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999989   0.00302426   0.00350356 -8.65681e-05</span><br><span class="line"> -0.00303232     0.999993   0.00229621    0.0054432</span><br><span class="line"> -0.00349659   -0.0023068     0.999991    -0.728436</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.0139432s</span><br><span class="line">iteration: 0, cost: 2.60309e+06</span><br><span class="line">iteration: 1, cost: 2.17855e+06</span><br><span class="line">cost increased: 2.38003e+06, 2.17855e+06</span><br><span class="line">T21 = </span><br><span class="line">   0.999991   0.0025115  0.00346968 -0.00289651</span><br><span class="line">-0.00251964    0.999994  0.00234158  0.00227251</span><br><span class="line">-0.00346378  -0.0023503    0.999991   -0.734471</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.0226829s</span><br><span class="line">iteration: 0, cost: 3.28428e+06</span><br><span class="line">cost increased: 3.50009e+06, 3.28428e+06</span><br><span class="line">T21 = </span><br><span class="line">   0.999991  0.00247928  0.00343485 -0.00376434</span><br><span class="line">-0.00248683    0.999994  0.00219501  0.00304134</span><br><span class="line">-0.00342939 -0.00220353    0.999992   -0.732337</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.0151728s</span><br><span class="line"></span><br><span class="line">--- Tracking frame 2 ---</span><br><span class="line">iteration: 0, cost: 1.16978e+07</span><br><span class="line">iteration: 1, cost: 7.92955e+06</span><br><span class="line">iteration: 2, cost: 3.99292e+06</span><br><span class="line">iteration: 3, cost: 2.62454e+06</span><br><span class="line">iteration: 4, cost: 2.38463e+06</span><br><span class="line">iteration: 5, cost: 2.27323e+06</span><br><span class="line">iteration: 6, cost: 2.16749e+06</span><br><span class="line">......</span><br><span class="line">--- Tracking frame 5 ---</span><br><span class="line">iteration: 0, cost: 1.21048e+07</span><br><span class="line">iteration: 1, cost: 1.04308e+07</span><br><span class="line">iteration: 2, cost: 7.52323e+06</span><br><span class="line">iteration: 3, cost: 6.06915e+06</span><br><span class="line">iteration: 4, cost: 5.22205e+06</span><br><span class="line">iteration: 5, cost: 5.10158e+06</span><br><span class="line">iteration: 6, cost: 4.88033e+06</span><br><span class="line">iteration: 7, cost: 4.63755e+06</span><br><span class="line">cost increased: 4.69869e+06, 4.63755e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999803  0.000619207    0.0198397    0.0421073</span><br><span class="line">-0.000761828     0.999974   0.00718192    0.0117245</span><br><span class="line">  -0.0198347  -0.00719562     0.999777      -3.7619</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.0497371s</span><br><span class="line">iteration: 0, cost: 7.16515e+06</span><br><span class="line">iteration: 1, cost: 6.18497e+06</span><br><span class="line">cost increased: 6.3539e+06, 6.18497e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999784  0.000773241    0.0207706   0.00636215</span><br><span class="line">-0.000915734     0.999976   0.00685172   0.00514185</span><br><span class="line">  -0.0207648  -0.00686926     0.999761      -3.8278</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.0140251s</span><br><span class="line">iteration: 0, cost: 8.39277e+06</span><br><span class="line">cost increased: 8.62659e+06, 8.39277e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999781  0.000735254    0.0209358  -0.00402205</span><br><span class="line">-0.000868872     0.999979   0.00637387    0.0088492</span><br><span class="line">  -0.0209307  -0.00639066     0.999761     -3.84657</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.00886143s</span><br><span class="line">iteration: 0, cost: 1.06391e+07</span><br><span class="line">cost increased: 1.07386e+07, 1.06391e+07</span><br><span class="line">T21 = </span><br><span class="line">   0.999787 0.000976808   0.0205927 -0.00158126</span><br><span class="line">-0.00110271    0.999981  0.00610343   0.0103151</span><br><span class="line"> -0.0205864 -0.00612484    0.999769    -3.85441</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.00941341s</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828165648850.png" alt="image-20250828165648850"></p>
<p>会依次输出金字塔0-3的直接法所展示的像素运动图片。并且依次在终端输出四层金字塔的其次变换矩阵，会变得更加精准。会输出5个循环。</p>
<p>最终第五张图片显示大约是相机向前运动了3.8米。</p>
<hr>
<blockquote>
<p>直接法迭代过程</p>
</blockquote>
<p>直接法完全依靠优化来求解相机位姿，像素梯度引导着优化的方向，，所以必须保证大部分像素梯度能够把优化引导到正确的地方。假设对于参考图像，我们测量到了一个灰度值是229的像素，并且知道深度，就可以图短处空间点p的位置，此时我们又得到了一幅新的图像，需要估计它的相机位姿，需要不断迭代。假设初始值比较大，空间点p投影后像素灰度值是126。于是此像素的误差值是103，为了减少误差，希望调整相机的位姿，使得像素更亮一些。</p>
<p>那么怎么知道往哪里微调像素会更亮？所以就需要局部像素梯度，在一个局部区域，我们可以得到一个梯度$[-3,-18]$，所以为了提高亮度，我们会建议优化算法微调相机，是P的像素往左上方移动，这个迭代过程中，我们用像素的局部梯度近似它附近的灰度分布。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-6850c4e4acb75faa5e52010975d41686_r.jpg" alt="【读书笔记-视觉SLAM十四讲-第8讲】视觉里程计 2：直接法 - 知乎"></p>
<p>综合了其他像素的意见之后，优化算法会选择一个和我们建议的方向偏移不远的地方，计算出一个更新量$exp(ξ∧)$,加上更新量之后，图像发生对应移动，像素投影位置会变到一个更亮的地方。在理想情况下，误差会逐渐变小，直至收敛。</p>
<p>总的来说，一次迭代有如下步骤：</p>
<p>首先假设</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828173323922.png" alt="image-20250828173323922"></p>
<ol>
<li>计算当前位姿下的投影和误差</li>
<li>线性化——求误差如何随位姿变化</li>
<li>通过高斯牛顿法来求解得到迭代的最优位姿增量$δξ$</li>
<li>更新位姿</li>
</ol>
<hr>
<p>但是直接法的梯度是由图像梯度确定的，<strong>必须保证沿着图像梯度走时，灰度误差会不断下降</strong>，但是沿着图像梯度走时，很容易落入一个局部极小值之中，无法继续优化，所以只有当相机运动很小的时候，图像中的梯度不会有很强的非凸性，直接法才能成立。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-22736e7053e97845983719468bb27613_r.jpg" alt="【读书笔记-视觉SLAM十四讲-第8讲】视觉里程计 2：直接法 - 知乎"></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E4%BA%8C%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%BB%BA%E5%9B%BE/" rel="prev" title="第十二讲-建图">
                  <i class="fa fa-angle-left"></i> 第十二讲-建图
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/" rel="next" title="第七讲-视觉里程计1">
                  第七讲-视觉里程计1 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Hita</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
