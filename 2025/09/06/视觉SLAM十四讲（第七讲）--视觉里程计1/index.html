<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gen2710.netlify.app","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":100},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="视觉SLAM十四讲（第七讲）–视觉里程计1特征点法一个SLAM系统分为前端后端，其中前端称为视觉里程计，根据相邻图像信息估计出粗略的相机运动，给后端提供较好的初始值。视觉里程计算法分为两个大类：特征点法和直接法。 特征点视觉里程计的核心问题是如何根据图像估计相机运动，图像本身是一个由亮度和色彩组成的矩阵。从矩阵考虑运动估计，比较困难，所以首先从图像中选取比较有代表性的点，这些点在相机视角发生少量变">
<meta property="og:type" content="article">
<meta property="og:title" content="第七讲-视觉里程计1">
<meta property="og:url" content="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/index.html">
<meta property="og:site_name" content="U.N.O">
<meta property="og:description" content="视觉SLAM十四讲（第七讲）–视觉里程计1特征点法一个SLAM系统分为前端后端，其中前端称为视觉里程计，根据相邻图像信息估计出粗略的相机运动，给后端提供较好的初始值。视觉里程计算法分为两个大类：特征点法和直接法。 特征点视觉里程计的核心问题是如何根据图像估计相机运动，图像本身是一个由亮度和色彩组成的矩阵。从矩阵考虑运动估计，比较困难，所以首先从图像中选取比较有代表性的点，这些点在相机视角发生少量变">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-217cfcb3eb1a1e1f8a7660b769ab2d64_r.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153656107.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153733677.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153823141.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827155518212.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-001a34da8a921ed05fe5b0d753991fb1_1440w.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827165450871.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-ab9b8efbec920fc566c4b9a05a7d3e96_r.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827194058967.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827194814134.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827205426113.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827205748538.png">
<meta property="article:published_time" content="2025-09-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-06T03:28:57.847Z">
<meta property="article:author" content="Hita">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-217cfcb3eb1a1e1f8a7660b769ab2d64_r.jpg">


<link rel="canonical" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/","path":"2025/09/06/视觉SLAM十四讲（第七讲）--视觉里程计1/","title":"第七讲-视觉里程计1"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>第七讲-视觉里程计1 | U.N.O</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">U.N.O</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89%E2%80%93%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11"><span class="nav-number">1.</span> <span class="nav-text">视觉SLAM十四讲（第七讲）–视觉里程计1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E7%82%B9%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">特征点法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E7%82%B9"><span class="nav-number">1.1.1.</span> <span class="nav-text">特征点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ORB%E7%89%B9%E5%BE%81"><span class="nav-number">1.1.2.</span> <span class="nav-text">ORB特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E5%8C%B9%E9%85%8D"><span class="nav-number">1.1.3.</span> <span class="nav-text">特征匹配</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E7%89%B9%E5%BE%81%E6%8F%90%E5%8F%96%E5%92%8C%E5%8C%B9%E9%85%8D"><span class="nav-number">1.2.</span> <span class="nav-text">实践：特征提取和匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenCV%E7%9A%84ORB%E7%89%B9%E5%BE%81"><span class="nav-number">1.2.1.</span> <span class="nav-text">OpenCV的ORB特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%86%99ORB%E7%89%B9%E5%BE%81"><span class="nav-number">1.2.2.</span> <span class="nav-text">手写ORB特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E7%9B%B8%E6%9C%BA%E8%BF%90%E5%8A%A8"><span class="nav-number">1.2.3.</span> <span class="nav-text">计算相机运动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2D-2D%EF%BC%9A%E5%AF%B9%E6%9E%81%E5%87%A0%E4%BD%95"><span class="nav-number">1.3.</span> <span class="nav-text">2D-2D：对极几何</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%9E%81%E7%BA%A6%E6%9D%9F"><span class="nav-number">1.3.1.</span> <span class="nav-text">对极约束</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E8%B4%A8%E7%9F%A9%E9%98%B5"><span class="nav-number">1.3.2.</span> <span class="nav-text">本质矩阵</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5"><span class="nav-number">1.3.3.</span> <span class="nav-text">单应矩阵</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%AF%B9%E6%9E%81%E7%BA%A6%E6%9D%9F%E6%B1%82%E8%A7%A3%E7%9B%B8%E6%9C%BA%E8%BF%90%E5%8A%A8"><span class="nav-number">1.4.</span> <span class="nav-text">实践：对极约束求解相机运动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E8%A7%92%E6%B5%8B%E9%87%8F"><span class="nav-number">1.5.</span> <span class="nav-text">三角测量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E4%B8%89%E8%A7%92%E6%B5%8B%E9%87%8F"><span class="nav-number">1.6.</span> <span class="nav-text">实践：三角测量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E8%A7%92%E6%B5%8B%E9%87%8F%E4%BB%A3%E7%A0%81"><span class="nav-number">1.6.1.</span> <span class="nav-text">三角测量代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3D-2D-PnP"><span class="nav-number">1.7.</span> <span class="nav-text">3D-2D: PnP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E7%BA%BF%E6%80%A7%E5%8F%98%E6%8D%A2"><span class="nav-number">1.7.1.</span> <span class="nav-text">直接线性变换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#P3P"><span class="nav-number">1.7.2.</span> <span class="nav-text">P3P</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%B0%8F%E5%8C%96%E9%87%8D%E6%8A%95%E5%BD%B1%E8%AF%AF%E5%B7%AE%E6%B1%82%E8%A7%A3PnP"><span class="nav-number">1.7.3.</span> <span class="nav-text">最小化重投影误差求解PnP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%B1%82%E8%A7%A3PnP"><span class="nav-number">1.8.</span> <span class="nav-text">实践：求解PnP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3D-3D-ICP"><span class="nav-number">1.9.</span> <span class="nav-text">3D-3D: ICP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SVD%E6%96%B9%E6%B3%95"><span class="nav-number">1.9.1.</span> <span class="nav-text">SVD方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95"><span class="nav-number">1.9.2.</span> <span class="nav-text">非线性优化方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%B1%82%E8%A7%A3ICP"><span class="nav-number">1.10.</span> <span class="nav-text">实践：求解ICP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9ASVD%E6%96%B9%E6%B3%95%E5%8F%8A%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95"><span class="nav-number">1.10.1.</span> <span class="nav-text">实践：SVD方法及非线性优化方法</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hita"
      src="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
  <p class="site-author-name" itemprop="name">Hita</p>
  <div class="site-description" itemprop="description">Gains Don't Stop!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiangbaoaaa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiangbaoaaa" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:n13155609602@163.com" title="E-mail → mailto:n13155609602@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="第七讲-视觉里程计1 | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第七讲-视觉里程计1
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:28:57" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="视觉SLAM十四讲（第七讲）–视觉里程计1"><a href="#视觉SLAM十四讲（第七讲）–视觉里程计1" class="headerlink" title="视觉SLAM十四讲（第七讲）–视觉里程计1"></a>视觉SLAM十四讲（第七讲）–视觉里程计1</h1><h2 id="特征点法"><a href="#特征点法" class="headerlink" title="特征点法"></a>特征点法</h2><p>一个SLAM系统分为前端后端，其中前端称为视觉里程计，<strong>根据相邻图像信息估计出粗略的相机运动</strong>，给后端提供较好的初始值。视觉里程计算法分为两个大类：<strong>特征点法和直接法</strong>。</p>
<h3 id="特征点"><a href="#特征点" class="headerlink" title="特征点"></a>特征点</h3><p>视觉里程计的核心问题是<strong>如何根据图像估计相机运动</strong>，图像本身是一个由亮度和色彩组成的矩阵。从矩阵考虑运动估计，比较困难，所以首先从图像中选取比较有代表性的点，这些点在相机视角发生少量变化后保持不变，于是能够在各个图像中找到相同的点，在经典SLAM模型中，称为<strong>路标</strong>。然而在视觉SLAM中路标就是指图像特征。<strong>特征是图像信息的另一种数字表达形式</strong>。希望特征点在相机运动之后保持稳定，但是灰度值受光照、形变、物体材质的影响严重，所以还需要对图像提取<strong>特征点</strong>。</p>
<p>我们可以把图像中的角点、边缘和区块都当成图像中有代表性的地方，但是图像中的角点、边缘相比较于像素区块更加特别，所以可以在不同图像中辨别角点，确定它们的对应关系。角点就是所谓的特征，提取角点的算法有很多，例如Harris角点、Fast角点等等。</p>
<p>但是单纯的角点在大多数应用中，并不能满足需求，可能会因为相机远近的问题发生变化，因此，提出了SIFT、SURF、ORB等局部特征。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-217cfcb3eb1a1e1f8a7660b769ab2d64_r.jpg" alt="img"></p>
<h3 id="ORB特征"><a href="#ORB特征" class="headerlink" title="ORB特征"></a>ORB特征</h3><blockquote>
<p>ORB(Oriented FAST and Rotated BRIEF)</p>
</blockquote>
<p>特征点由<strong>关键点</strong>、<strong>描述子</strong>两部分组成，关键点是指该特征点在图像中的位置，描述子是按照<strong>外观相似的特征该有相似的描述子</strong>的原则设计的。因此，只要两个特征点描述子在向量空间上距离相近，就可以认为是同样的关键点。这样就能使得连续两帧图片中的关键点能够正确匹配。ORB(Oriented FAST and Rotated BRIEF)融合了两种已有的高效算法——FAST特征点检测和BRIEF特征描述，并通过一系列创新性的改进，克服了它们各自的局限性，实现了速度与性能的完美平衡。</p>
<ul>
<li>关键点检测：带方向的FAST（Oriented FAST）</li>
</ul>
<p>传统的FAST (Features from Accelerated Segment Test) 算法以其惊人的检测速度而闻名。它通过<strong>比较像素点与其邻域像素的灰度值来快速识别角点</strong>。然而，FAST算法本身不具备方向性，这意味着即使是同一个角点，在图像旋转后也会被视为不同的特征点，这限制了其在旋转场景下的应用。然而ORB对此进行优化，引入方向信息，并且使用Harris角点检测。</p>
<ul>
<li>描述子：可旋转的BRIEF（Rotated BRIEF）</li>
</ul>
<p>BRIEF (Binary Robust Independent Elementary Features) 是一种二进制特征描述子。它<strong>通过在特征点周围的图像块内选取若干个点对，比较它们的灰度值大小，并将比较结果（0或1）串联起来形成一个二进制字符串，作为该特征点的描述符</strong>。由于描述子是二进制的，因此在存储和匹配时都极为高效，通常使用汉明距离进行度量。ORB会在生成BRIEF之前，利用上一步计算出的<strong>特征点主方向</strong>，将BRIEF采用时所使用的点对模型旋转到与主方向一致，实现了旋转不变性，同时优化了选取的BRIEF点对的方法，从而能够提供更具区分度和鲁棒性的特征描述。</p>
<hr>
<h3 id="特征匹配"><a href="#特征匹配" class="headerlink" title="特征匹配"></a>特征匹配</h3><p>描述子与特征匹配并非两个独立的步骤，而这时因果相连、密不可分的。类似于描述子是生成嫌疑人的特征档案，而特征匹配就是按照档案去寻找嫌疑人。至于为什么不去找完全相同的，是因为同一个三维空间点在两张不同照片上提取的描述子，几乎不可能完全相同。特征匹配其实本质上是寻找最近邻而非寻找等同者的问题。因此后续需要一些筛选策略来剔除虽然相近但是不够确信的模糊匹配。（RANSAC等）</p>
<p>特征匹配解决了SLAM中数据关联问题，即确定当前看到的路标与之前的对应关系，如果在两个图像中提取到了特征点，如何去寻找这两个集合元素的对应关系呢？最简单的时暴力匹配，<strong>测量每一个特征点到所有另外一组特征点的描述子的距离，取最近的为匹配点</strong>。对于浮点型的描述子，选择欧氏距离进行度量，对于二进制的描述子，选择汉明距离作为度量——不同位数的个数。但是，当特征点数量很大时，就需要很大的运算量，所以**快速近似最近邻（FLANN）**算法更适合匹配点数量多的情况。已经集成到OpenCV中了。</p>
<hr>
<h2 id="实践：特征提取和匹配"><a href="#实践：特征提取和匹配" class="headerlink" title="实践：特征提取和匹配"></a>实践：特征提取和匹配</h2><h3 id="OpenCV的ORB特征"><a href="#OpenCV的ORB特征" class="headerlink" title="OpenCV的ORB特征"></a>OpenCV的ORB特征</h3><p>第一个实验通过两张带有微小移动的图片来演示如何通过ORB来得到匹配结果估算相机的运动。</p>
<p>首先先保存源代码的两张图片到<code>slambook/ch7/</code></p>
<p>新建文件：<code>slambook/ch7/orb_cv.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;usage: feature_extraction img1 img2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//-- 读取图像</span></span><br><span class="line">  <span class="comment">// 【修改1】: CV_LOAD_IMAGE_COLOR 替换为 IMREAD_COLOR</span></span><br><span class="line">  Mat img_1 = <span class="built_in">imread</span>(argv[<span class="number">1</span>], IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = <span class="built_in">imread</span>(argv[<span class="number">2</span>], IMREAD_COLOR);</span><br><span class="line">  <span class="built_in">assert</span>(img_<span class="number">1.</span>data != <span class="literal">nullptr</span> &amp;&amp; img_<span class="number">2.</span>data != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 初始化</span></span><br><span class="line">  std::vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  <span class="comment">// 【修改2】: 将 detector 和 descriptor 合并为一个 ORB 对象</span></span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">1.2f</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, ORB::HARRIS_SCORE, <span class="number">31</span>, <span class="number">20</span>);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第一步:检测 Oriented FAST 角点位置</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="comment">// 使用统一的 orb 对象进行检测</span></span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_1, keypoints_1);</span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_2, keypoints_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第二步:根据角点位置计算 BRIEF 描述子</span></span><br><span class="line">  <span class="comment">// 使用统一的 orb 对象进行计算</span></span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_1, keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_2, keypoints_2, descriptors_2);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;extract ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  Mat outimg1;</span><br><span class="line">  <span class="built_in">drawKeypoints</span>(img_1, keypoints_1, outimg1, Scalar::<span class="built_in">all</span>(<span class="number">-1</span>), DrawMatchesFlags::DEFAULT);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;ORB features&quot;</span>, outimg1);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span></span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  matcher-&gt;<span class="built_in">match</span>(descriptors_1, descriptors_2, matches);</span><br><span class="line">  t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;match ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第四步:匹配点对筛选</span></span><br><span class="line">  <span class="comment">// 计算最小距离和最大距离</span></span><br><span class="line">  <span class="keyword">auto</span> min_max = <span class="built_in">minmax_element</span>(matches.<span class="built_in">begin</span>(), matches.<span class="built_in">end</span>(),</span><br><span class="line">                                [](<span class="type">const</span> DMatch &amp;m1, <span class="type">const</span> DMatch &amp;m2) &#123; <span class="keyword">return</span> m<span class="number">1.</span>distance &lt; m<span class="number">2.</span>distance; &#125;);</span><br><span class="line">  <span class="type">double</span> min_dist = min_max.first-&gt;distance;</span><br><span class="line">  <span class="type">double</span> max_dist = min_max.second-&gt;distance;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Max dist : %f \n&quot;</span>, max_dist);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Min dist : %f \n&quot;</span>, min_dist);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//当描述子之间的距离大于两倍的最小距离时,即认为匹配有误.但有时候最小距离会非常小,设置一个经验值30作为下限.</span></span><br><span class="line">  std::vector&lt;DMatch&gt; good_matches;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (matches[i].distance &lt;= <span class="built_in">max</span>(<span class="number">2</span> * min_dist, <span class="number">30.0</span>)) &#123;</span><br><span class="line">      good_matches.<span class="built_in">push_back</span>(matches[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第五步:绘制匹配结果</span></span><br><span class="line">  Mat img_match;</span><br><span class="line">  Mat img_goodmatch;</span><br><span class="line">  <span class="built_in">drawMatches</span>(img_1, keypoints_1, img_2, keypoints_2, matches, img_match);</span><br><span class="line">  <span class="built_in">drawMatches</span>(img_1, keypoints_1, img_2, keypoints_2, good_matches, img_goodmatch);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;all matches&quot;</span>, img_match);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;good matches&quot;</span>, img_goodmatch);</span><br><span class="line">  <span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line">add_definitions(<span class="string">&quot;-DENABLE_SSE&quot;</span>)</span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++11 -O2 $&#123;SSE_FLAGS&#125; -msse4&quot;</span>)</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line">include_directories(</span><br><span class="line">        $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">        <span class="string">&quot;/usr/include/eigen3/&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv $&#123;OpenCV_LIBS&#125;)</span><br></pre></td></tr></table></figure>

<p>终端输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ cmake ..</span><br><span class="line">......</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch7/build</span><br><span class="line">hita@hita-vm:~/slambook/ch7/build$ make</span><br><span class="line">[100%] Built target orb_cv</span><br><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./orb_cv ../1</span><br><span class="line">1_depth.png  1.png        </span><br><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./orb_cv ../1.png ../2.png </span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p>ORB关键点：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153656107.png" alt="image-20250827153656107"></p>
<p>未筛选的匹配</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153733677.png" alt="image-20250827153733677"></p>
<p>筛选后的匹配：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153823141.png" alt="image-20250827153823141"></p>
<p>筛选的依据是<strong>汉明距离小于最小距离的两倍</strong>，这是工程上的经验方法。</p>
<h3 id="手写ORB特征"><a href="#手写ORB特征" class="headerlink" title="手写ORB特征"></a>手写ORB特征</h3><p>新建文件:<code>slambook/ch7/orb_self.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xiang on 18-11-25.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;nmmintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// global variables</span></span><br><span class="line">string first_file = <span class="string">&quot;../1.png&quot;</span>;</span><br><span class="line">string second_file = <span class="string">&quot;../2.png&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 32 bit unsigned int, will have 8, 8x32=256</span></span><br><span class="line"><span class="keyword">typedef</span> vector&lt;<span class="type">uint32_t</span>&gt; DescType; <span class="comment">// Descriptor type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * compute descriptor of orb keypoints</span></span><br><span class="line"><span class="comment"> * @param img input image</span></span><br><span class="line"><span class="comment"> * @param keypoints detected fast keypoints</span></span><br><span class="line"><span class="comment"> * @param descriptors descriptors</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> if a keypoint goes outside the image boundary (8 pixels), descriptors will not be computed and will be left as</span></span><br><span class="line"><span class="comment"> * empty</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ComputeORB</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, vector&lt;cv::KeyPoint&gt; &amp;keypoints, vector&lt;DescType&gt; &amp;descriptors)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * brute-force match two sets of descriptors</span></span><br><span class="line"><span class="comment"> * @param desc1 the first descriptor</span></span><br><span class="line"><span class="comment"> * @param desc2 the second descriptor</span></span><br><span class="line"><span class="comment"> * @param matches matches of two images</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BfMatch</span><span class="params">(<span class="type">const</span> vector&lt;DescType&gt; &amp;desc1, <span class="type">const</span> vector&lt;DescType&gt; &amp;desc2, vector&lt;cv::DMatch&gt; &amp;matches)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// load image</span></span><br><span class="line">  cv::Mat first_image = cv::<span class="built_in">imread</span>(first_file, <span class="number">0</span>);</span><br><span class="line">  cv::Mat second_image = cv::<span class="built_in">imread</span>(second_file, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">assert</span>(first_image.data != <span class="literal">nullptr</span> &amp;&amp; second_image.data != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// detect FAST keypoints1 using threshold=40</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  vector&lt;cv::KeyPoint&gt; keypoints1;</span><br><span class="line">  cv::<span class="built_in">FAST</span>(first_image, keypoints1, <span class="number">40</span>);</span><br><span class="line">  vector&lt;DescType&gt; descriptor1;</span><br><span class="line">  <span class="built_in">ComputeORB</span>(first_image, keypoints1, descriptor1);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// same for the second</span></span><br><span class="line">  vector&lt;cv::KeyPoint&gt; keypoints2;</span><br><span class="line">  vector&lt;DescType&gt; descriptor2;</span><br><span class="line">  cv::<span class="built_in">FAST</span>(second_image, keypoints2, <span class="number">40</span>);</span><br><span class="line">  <span class="built_in">ComputeORB</span>(second_image, keypoints2, descriptor2);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;extract ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// find matches</span></span><br><span class="line">  vector&lt;cv::DMatch&gt; matches;</span><br><span class="line">  t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="built_in">BfMatch</span>(descriptor1, descriptor2, matches);</span><br><span class="line">  t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;match ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;matches: &quot;</span> &lt;&lt; matches.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// plot the matches</span></span><br><span class="line">  cv::Mat image_show;</span><br><span class="line">  cv::<span class="built_in">drawMatches</span>(first_image, keypoints1, second_image, keypoints2, matches, image_show);</span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;matches&quot;</span>, image_show);</span><br><span class="line">  cv::<span class="built_in">imwrite</span>(<span class="string">&quot;matches.png&quot;</span>, image_show);</span><br><span class="line">  cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;done.&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------------------------------------------------------------------------------------------- //</span></span><br><span class="line"><span class="comment">// ORB pattern</span></span><br><span class="line"><span class="type">int</span> ORB_pattern[<span class="number">256</span> * <span class="number">4</span>] = &#123;</span><br><span class="line">  <span class="number">8</span>, <span class="number">-3</span>, <span class="number">9</span>, <span class="number">5</span><span class="comment">/*mean (0), correlation (0)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">-12</span><span class="comment">/*mean (1.12461e-05), correlation (0.0437584)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">9</span>, <span class="number">-8</span>, <span class="number">2</span><span class="comment">/*mean (3.37382e-05), correlation (0.0617409)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-12</span>, <span class="number">12</span>, <span class="number">-13</span><span class="comment">/*mean (5.62303e-05), correlation (0.0636977)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-13</span>, <span class="number">2</span>, <span class="number">12</span><span class="comment">/*mean (0.000134953), correlation (0.085099)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-7</span>, <span class="number">1</span>, <span class="number">6</span><span class="comment">/*mean (0.000528565), correlation (0.0857175)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-10</span>, <span class="number">-2</span>, <span class="number">-4</span><span class="comment">/*mean (0.0188821), correlation (0.0985774)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-13</span>, <span class="number">-11</span>, <span class="number">-8</span><span class="comment">/*mean (0.0363135), correlation (0.0899616)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-3</span>, <span class="number">-12</span>, <span class="number">-9</span><span class="comment">/*mean (0.121806), correlation (0.099849)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span><span class="comment">/*mean (0.122065), correlation (0.093285)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-8</span>, <span class="number">-8</span>, <span class="number">-9</span><span class="comment">/*mean (0.162787), correlation (0.0942748)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">7</span>, <span class="number">-9</span>, <span class="number">12</span><span class="comment">/*mean (0.21561), correlation (0.0974438)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">6</span><span class="comment">/*mean (0.160583), correlation (0.130064)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-5</span>, <span class="number">-3</span>, <span class="number">0</span><span class="comment">/*mean (0.228171), correlation (0.132998)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">2</span>, <span class="number">-12</span>, <span class="number">-3</span><span class="comment">/*mean (0.00997526), correlation (0.145926)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">0</span>, <span class="number">-7</span>, <span class="number">5</span><span class="comment">/*mean (0.198234), correlation (0.143636)*/</span>,</span><br><span class="line">  <span class="number">12</span>, <span class="number">-6</span>, <span class="number">12</span>, <span class="number">-1</span><span class="comment">/*mean (0.0676226), correlation (0.16689)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">6</span>, <span class="number">-2</span>, <span class="number">12</span><span class="comment">/*mean (0.166847), correlation (0.171682)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">-8</span><span class="comment">/*mean (0.101215), correlation (0.179716)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-8</span><span class="comment">/*mean (0.200641), correlation (0.192279)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">1</span><span class="comment">/*mean (0.205106), correlation (0.186848)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-3</span>, <span class="number">10</span>, <span class="number">-3</span><span class="comment">/*mean (0.234908), correlation (0.192319)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-7</span>, <span class="number">6</span>, <span class="number">12</span><span class="comment">/*mean (0.0709964), correlation (0.210872)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-7</span>, <span class="number">-6</span>, <span class="number">-2</span><span class="comment">/*mean (0.0939834), correlation (0.212589)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">11</span>, <span class="number">-1</span>, <span class="number">-10</span><span class="comment">/*mean (0.127778), correlation (0.20866)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-8</span>, <span class="number">10</span><span class="comment">/*mean (0.14783), correlation (0.206356)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">3</span>, <span class="number">-5</span>, <span class="number">-3</span><span class="comment">/*mean (0.182141), correlation (0.198942)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">7</span><span class="comment">/*mean (0.188237), correlation (0.21384)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-12</span>, <span class="number">-6</span>, <span class="number">11</span><span class="comment">/*mean (0.14865), correlation (0.23571)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-12</span>, <span class="number">6</span>, <span class="number">-7</span><span class="comment">/*mean (0.222312), correlation (0.23324)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-6</span>, <span class="number">7</span>, <span class="number">-1</span><span class="comment">/*mean (0.229082), correlation (0.23389)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">-5</span><span class="comment">/*mean (0.241577), correlation (0.215286)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">11</span>, <span class="number">11</span>, <span class="number">-13</span><span class="comment">/*mean (0.00338507), correlation (0.251373)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span><span class="comment">/*mean (0.131005), correlation (0.257622)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-1</span>, <span class="number">4</span>, <span class="number">4</span><span class="comment">/*mean (0.152755), correlation (0.255205)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-12</span>, <span class="number">-2</span>, <span class="number">7</span><span class="comment">/*mean (0.182771), correlation (0.244867)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-5</span>, <span class="number">-7</span>, <span class="number">-10</span><span class="comment">/*mean (0.186898), correlation (0.23901)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span><span class="comment">/*mean (0.226226), correlation (0.258255)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">-8</span>, <span class="number">1</span>, <span class="number">-13</span><span class="comment">/*mean (0.0897886), correlation (0.274827)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-2</span>, <span class="number">-8</span>, <span class="number">2</span><span class="comment">/*mean (0.148774), correlation (0.28065)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-2</span>, <span class="number">3</span><span class="comment">/*mean (0.153048), correlation (0.283063)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">9</span>, <span class="number">-4</span>, <span class="number">-9</span><span class="comment">/*mean (0.169523), correlation (0.278248)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">12</span>, <span class="number">10</span>, <span class="number">7</span><span class="comment">/*mean (0.225337), correlation (0.282851)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">3</span><span class="comment">/*mean (0.226687), correlation (0.278734)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-5</span>, <span class="number">11</span>, <span class="number">-10</span><span class="comment">/*mean (0.00693882), correlation (0.305161)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-6</span>, <span class="number">-11</span>, <span class="number">0</span><span class="comment">/*mean (0.0227283), correlation (0.300181)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">1</span><span class="comment">/*mean (0.125517), correlation (0.31089)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-3</span>, <span class="number">-6</span>, <span class="number">12</span><span class="comment">/*mean (0.131748), correlation (0.312779)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">-9</span>, <span class="number">12</span>, <span class="number">-4</span><span class="comment">/*mean (0.144827), correlation (0.292797)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">8</span>, <span class="number">-8</span>, <span class="number">-12</span><span class="comment">/*mean (0.149202), correlation (0.308918)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-8</span>, <span class="number">-4</span><span class="comment">/*mean (0.160909), correlation (0.310013)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">8</span><span class="comment">/*mean (0.177755), correlation (0.309394)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">-7</span><span class="comment">/*mean (0.212337), correlation (0.310315)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">-12</span><span class="comment">/*mean (0.214429), correlation (0.311933)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-10</span>, <span class="number">5</span>, <span class="number">6</span><span class="comment">/*mean (0.235807), correlation (0.313104)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-4</span>, <span class="number">3</span>, <span class="number">-10</span><span class="comment">/*mean (0.00494827), correlation (0.344948)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-13</span>, <span class="number">5</span><span class="comment">/*mean (0.0549145), correlation (0.344675)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-7</span>, <span class="number">-12</span>, <span class="number">12</span><span class="comment">/*mean (0.103385), correlation (0.342715)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">3</span>, <span class="number">-11</span>, <span class="number">8</span><span class="comment">/*mean (0.134222), correlation (0.322922)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">12</span>, <span class="number">-4</span>, <span class="number">7</span><span class="comment">/*mean (0.153284), correlation (0.337061)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-10</span>, <span class="number">12</span>, <span class="number">8</span><span class="comment">/*mean (0.154881), correlation (0.329257)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-1</span>, <span class="number">-7</span>, <span class="number">-6</span><span class="comment">/*mean (0.200967), correlation (0.33312)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-5</span>, <span class="number">0</span>, <span class="number">12</span><span class="comment">/*mean (0.201518), correlation (0.340635)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">5</span>, <span class="number">-7</span>, <span class="number">5</span><span class="comment">/*mean (0.207805), correlation (0.335631)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-10</span>, <span class="number">8</span>, <span class="number">-13</span><span class="comment">/*mean (0.224438), correlation (0.34504)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-7</span>, <span class="number">-4</span>, <span class="number">5</span><span class="comment">/*mean (0.239361), correlation (0.338053)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">-7</span><span class="comment">/*mean (0.240744), correlation (0.344322)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">-11</span><span class="comment">/*mean (0.242949), correlation (0.34145)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">-13</span>, <span class="number">-5</span>, <span class="number">-13</span><span class="comment">/*mean (0.244028), correlation (0.336861)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">-1</span><span class="comment">/*mean (0.247571), correlation (0.343684)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-3</span>, <span class="number">5</span>, <span class="number">2</span><span class="comment">/*mean (0.000697256), correlation (0.357265)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">12</span><span class="comment">/*mean (0.00213675), correlation (0.373827)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-6</span>, <span class="number">-9</span>, <span class="number">6</span><span class="comment">/*mean (0.0126856), correlation (0.373938)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">-10</span>, <span class="number">-8</span>, <span class="number">-4</span><span class="comment">/*mean (0.0152497), correlation (0.364237)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">-3</span><span class="comment">/*mean (0.0299933), correlation (0.345292)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.0307242), correlation (0.366299)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-13</span>, <span class="number">-6</span>, <span class="number">5</span><span class="comment">/*mean (0.0534975), correlation (0.368357)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">9</span>, <span class="number">-3</span>, <span class="number">4</span><span class="comment">/*mean (0.099865), correlation (0.372276)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-1</span>, <span class="number">12</span>, <span class="number">2</span><span class="comment">/*mean (0.117083), correlation (0.364529)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">6</span>, <span class="number">-5</span>, <span class="number">1</span><span class="comment">/*mean (0.126125), correlation (0.369606)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">11</span>, <span class="number">-12</span>, <span class="number">5</span><span class="comment">/*mean (0.130364), correlation (0.358502)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">7</span>, <span class="number">-2</span>, <span class="number">-6</span><span class="comment">/*mean (0.131691), correlation (0.375531)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-8</span>, <span class="number">12</span>, <span class="number">-7</span><span class="comment">/*mean (0.160166), correlation (0.379508)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-7</span>, <span class="number">-11</span>, <span class="number">-12</span><span class="comment">/*mean (0.167848), correlation (0.353343)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-3</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.183378), correlation (0.371916)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-6</span>, <span class="number">3</span>, <span class="number">0</span><span class="comment">/*mean (0.228711), correlation (0.371761)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">3</span>, <span class="number">-2</span>, <span class="number">-13</span><span class="comment">/*mean (0.247211), correlation (0.364063)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-13</span>, <span class="number">1</span>, <span class="number">9</span><span class="comment">/*mean (0.249325), correlation (0.378139)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">-6</span><span class="comment">/*mean (0.000652272), correlation (0.411682)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-1</span>, <span class="number">3</span>, <span class="number">12</span><span class="comment">/*mean (0.00248538), correlation (0.392988)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">6</span><span class="comment">/*mean (0.0206815), correlation (0.386106)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-9</span>, <span class="number">-1</span>, <span class="number">3</span><span class="comment">/*mean (0.0364485), correlation (0.410752)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-13</span>, <span class="number">-10</span>, <span class="number">5</span><span class="comment">/*mean (0.0376068), correlation (0.398374)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">12</span><span class="comment">/*mean (0.0424202), correlation (0.405663)*/</span>,</span><br><span class="line">  <span class="number">12</span>, <span class="number">-5</span>, <span class="number">12</span>, <span class="number">9</span><span class="comment">/*mean (0.0942645), correlation (0.410422)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">11</span><span class="comment">/*mean (0.1074), correlation (0.413224)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-13</span>, <span class="number">6</span>, <span class="number">10</span><span class="comment">/*mean (0.109256), correlation (0.408646)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-12</span>, <span class="number">2</span>, <span class="number">3</span><span class="comment">/*mean (0.131691), correlation (0.416076)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">-6</span><span class="comment">/*mean (0.165081), correlation (0.417569)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">-13</span><span class="comment">/*mean (0.171874), correlation (0.408471)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">-12</span>, <span class="number">10</span>, <span class="number">3</span><span class="comment">/*mean (0.175146), correlation (0.41296)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">4</span>, <span class="number">-7</span>, <span class="number">9</span><span class="comment">/*mean (0.183682), correlation (0.402956)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">12</span>, <span class="number">-4</span>, <span class="number">-6</span><span class="comment">/*mean (0.184672), correlation (0.416125)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">-8</span><span class="comment">/*mean (0.191487), correlation (0.386696)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-9</span>, <span class="number">7</span>, <span class="number">-4</span><span class="comment">/*mean (0.192668), correlation (0.394771)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">-2</span><span class="comment">/*mean (0.200157), correlation (0.408303)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">0</span><span class="comment">/*mean (0.204588), correlation (0.411762)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-3</span>, <span class="number">8</span>, <span class="number">-8</span><span class="comment">/*mean (0.205904), correlation (0.416294)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">3</span><span class="comment">/*mean (0.213237), correlation (0.409306)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">-5</span>, <span class="number">-6</span>, <span class="number">-4</span><span class="comment">/*mean (0.243444), correlation (0.395069)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">11</span>, <span class="number">-5</span>, <span class="number">10</span><span class="comment">/*mean (0.247672), correlation (0.413392)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-8</span>, <span class="number">-3</span>, <span class="number">12</span><span class="comment">/*mean (0.24774), correlation (0.411416)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">5</span>, <span class="number">-9</span>, <span class="number">0</span><span class="comment">/*mean (0.00213675), correlation (0.454003)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-1</span>, <span class="number">12</span>, <span class="number">-6</span><span class="comment">/*mean (0.0293635), correlation (0.455368)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-6</span>, <span class="number">6</span>, <span class="number">-11</span><span class="comment">/*mean (0.0404971), correlation (0.457393)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">12</span>, <span class="number">-8</span>, <span class="number">7</span><span class="comment">/*mean (0.0481107), correlation (0.448364)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-2</span>, <span class="number">6</span>, <span class="number">7</span><span class="comment">/*mean (0.050641), correlation (0.455019)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">0</span>, <span class="number">-2</span>, <span class="number">12</span><span class="comment">/*mean (0.0525978), correlation (0.44338)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-8</span>, <span class="number">-5</span>, <span class="number">2</span><span class="comment">/*mean (0.0629667), correlation (0.457096)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-6</span>, <span class="number">10</span>, <span class="number">12</span><span class="comment">/*mean (0.0653846), correlation (0.445623)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-13</span>, <span class="number">-8</span>, <span class="number">-8</span><span class="comment">/*mean (0.0858749), correlation (0.449789)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-13</span>, <span class="number">-5</span>, <span class="number">-2</span><span class="comment">/*mean (0.122402), correlation (0.450201)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-8</span>, <span class="number">9</span>, <span class="number">-13</span><span class="comment">/*mean (0.125416), correlation (0.453224)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-11</span>, <span class="number">-9</span>, <span class="number">0</span><span class="comment">/*mean (0.130128), correlation (0.458724)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-8</span>, <span class="number">1</span>, <span class="number">-2</span><span class="comment">/*mean (0.132467), correlation (0.440133)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-4</span>, <span class="number">9</span>, <span class="number">1</span><span class="comment">/*mean (0.132692), correlation (0.454)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">-4</span><span class="comment">/*mean (0.135695), correlation (0.455739)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-6</span>, <span class="number">12</span>, <span class="number">-11</span><span class="comment">/*mean (0.142904), correlation (0.446114)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">-9</span>, <span class="number">-6</span>, <span class="number">4</span><span class="comment">/*mean (0.146165), correlation (0.451473)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">12</span><span class="comment">/*mean (0.147627), correlation (0.456643)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">8</span><span class="comment">/*mean (0.152901), correlation (0.455036)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">-4</span>, <span class="number">2</span>, <span class="number">8</span><span class="comment">/*mean (0.167083), correlation (0.459315)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">12</span>, <span class="number">-5</span>, <span class="number">-13</span><span class="comment">/*mean (0.173234), correlation (0.454706)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span><span class="comment">/*mean (0.18312), correlation (0.433855)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">7</span><span class="comment">/*mean (0.185504), correlation (0.443838)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">-9</span><span class="comment">/*mean (0.185706), correlation (0.451123)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">-8</span><span class="comment">/*mean (0.188968), correlation (0.455808)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">-8</span>, <span class="number">9</span><span class="comment">/*mean (0.191667), correlation (0.459128)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">9</span>, <span class="number">-3</span>, <span class="number">-3</span><span class="comment">/*mean (0.193196), correlation (0.458364)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-7</span>, <span class="number">-3</span>, <span class="number">-12</span><span class="comment">/*mean (0.196536), correlation (0.455782)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">0</span><span class="comment">/*mean (0.1972), correlation (0.450481)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">6</span>, <span class="number">-6</span>, <span class="number">12</span><span class="comment">/*mean (0.199438), correlation (0.458156)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">6</span>, <span class="number">-5</span>, <span class="number">-2</span><span class="comment">/*mean (0.211224), correlation (0.449548)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-10</span>, <span class="number">3</span>, <span class="number">10</span><span class="comment">/*mean (0.211718), correlation (0.440606)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">-4</span><span class="comment">/*mean (0.213034), correlation (0.443177)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-2</span>, <span class="number">2</span>, <span class="number">-13</span><span class="comment">/*mean (0.234334), correlation (0.455304)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-12</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.235684), correlation (0.443436)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-6</span><span class="comment">/*mean (0.237674), correlation (0.452525)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">3</span><span class="comment">/*mean (0.23962), correlation (0.444824)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-10</span>, <span class="number">-3</span>, <span class="number">-5</span><span class="comment">/*mean (0.248459), correlation (0.439621)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-13</span>, <span class="number">-1</span>, <span class="number">1</span><span class="comment">/*mean (0.249505), correlation (0.456666)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">-11</span><span class="comment">/*mean (0.00119208), correlation (0.495466)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-2</span>, <span class="number">5</span>, <span class="number">-7</span><span class="comment">/*mean (0.00372245), correlation (0.484214)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">9</span>, <span class="number">-9</span>, <span class="number">-5</span><span class="comment">/*mean (0.00741116), correlation (0.499854)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">6</span><span class="comment">/*mean (0.0208952), correlation (0.499773)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-8</span>, <span class="number">7</span>, <span class="number">6</span><span class="comment">/*mean (0.0220085), correlation (0.501609)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-4</span>, <span class="number">-7</span>, <span class="number">1</span><span class="comment">/*mean (0.0233806), correlation (0.496568)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">11</span>, <span class="number">-7</span>, <span class="number">-8</span><span class="comment">/*mean (0.0236505), correlation (0.489719)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">6</span>, <span class="number">-12</span>, <span class="number">-8</span><span class="comment">/*mean (0.0268781), correlation (0.503487)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">9</span><span class="comment">/*mean (0.0323324), correlation (0.501938)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">-5</span>, <span class="number">12</span>, <span class="number">3</span><span class="comment">/*mean (0.0399235), correlation (0.494029)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-5</span>, <span class="number">-6</span>, <span class="number">7</span><span class="comment">/*mean (0.0420153), correlation (0.486579)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-3</span>, <span class="number">9</span>, <span class="number">-8</span><span class="comment">/*mean (0.0548021), correlation (0.484237)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-12</span>, <span class="number">2</span>, <span class="number">8</span><span class="comment">/*mean (0.0616622), correlation (0.496642)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">-2</span>, <span class="number">-10</span>, <span class="number">3</span><span class="comment">/*mean (0.0627755), correlation (0.498563)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">-13</span>, <span class="number">-7</span>, <span class="number">-9</span><span class="comment">/*mean (0.0829622), correlation (0.495491)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">0</span>, <span class="number">-10</span>, <span class="number">-5</span><span class="comment">/*mean (0.0843342), correlation (0.487146)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-3</span>, <span class="number">11</span>, <span class="number">8</span><span class="comment">/*mean (0.0929937), correlation (0.502315)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-13</span>, <span class="number">-1</span>, <span class="number">12</span><span class="comment">/*mean (0.113327), correlation (0.48941)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-8</span>, <span class="number">0</span>, <span class="number">9</span><span class="comment">/*mean (0.132119), correlation (0.467268)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-11</span>, <span class="number">-12</span>, <span class="number">-5</span><span class="comment">/*mean (0.136269), correlation (0.498771)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-2</span>, <span class="number">-10</span>, <span class="number">11</span><span class="comment">/*mean (0.142173), correlation (0.498714)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">9</span>, <span class="number">-2</span>, <span class="number">-13</span><span class="comment">/*mean (0.144141), correlation (0.491973)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-3</span>, <span class="number">3</span>, <span class="number">2</span><span class="comment">/*mean (0.14892), correlation (0.500782)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">0</span><span class="comment">/*mean (0.150371), correlation (0.498211)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">6</span>, <span class="number">-3</span>, <span class="number">-10</span><span class="comment">/*mean (0.152159), correlation (0.495547)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">12</span>, <span class="number">-2</span>, <span class="number">-7</span><span class="comment">/*mean (0.156152), correlation (0.496925)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-11</span>, <span class="number">-4</span>, <span class="number">9</span><span class="comment">/*mean (0.15749), correlation (0.499222)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-3</span>, <span class="number">6</span>, <span class="number">11</span><span class="comment">/*mean (0.159211), correlation (0.503821)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">11</span>, <span class="number">-5</span>, <span class="number">5</span><span class="comment">/*mean (0.162427), correlation (0.501907)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">6</span><span class="comment">/*mean (0.16652), correlation (0.497632)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-5</span>, <span class="number">12</span>, <span class="number">-2</span><span class="comment">/*mean (0.169141), correlation (0.484474)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">7</span><span class="comment">/*mean (0.169456), correlation (0.495339)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-8</span>, <span class="number">-3</span>, <span class="number">-2</span><span class="comment">/*mean (0.171457), correlation (0.487251)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">1</span>, <span class="number">-6</span>, <span class="number">7</span><span class="comment">/*mean (0.175), correlation (0.500024)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-12</span>, <span class="number">-8</span>, <span class="number">-13</span><span class="comment">/*mean (0.175866), correlation (0.497523)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-2</span>, <span class="number">-6</span>, <span class="number">-8</span><span class="comment">/*mean (0.178273), correlation (0.501854)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">5</span>, <span class="number">-6</span>, <span class="number">-9</span><span class="comment">/*mean (0.181107), correlation (0.494888)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-1</span>, <span class="number">-4</span>, <span class="number">5</span><span class="comment">/*mean (0.190227), correlation (0.482557)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">7</span>, <span class="number">-8</span>, <span class="number">10</span><span class="comment">/*mean (0.196739), correlation (0.496503)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">-13</span><span class="comment">/*mean (0.19973), correlation (0.499759)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">-13</span><span class="comment">/*mean (0.204465), correlation (0.49873)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">12</span>, <span class="number">10</span>, <span class="number">-1</span><span class="comment">/*mean (0.209334), correlation (0.49063)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-8</span>, <span class="number">10</span>, <span class="number">-9</span><span class="comment">/*mean (0.211134), correlation (0.503011)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">-13</span><span class="comment">/*mean (0.212), correlation (0.499414)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-3</span>, <span class="number">-6</span>, <span class="number">2</span><span class="comment">/*mean (0.212168), correlation (0.480739)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-10</span>, <span class="number">1</span>, <span class="number">12</span><span class="comment">/*mean (0.212731), correlation (0.502523)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">1</span>, <span class="number">-8</span>, <span class="number">-10</span><span class="comment">/*mean (0.21327), correlation (0.489786)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-11</span>, <span class="number">10</span>, <span class="number">-6</span><span class="comment">/*mean (0.214159), correlation (0.488246)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-13</span>, <span class="number">3</span>, <span class="number">-6</span><span class="comment">/*mean (0.216993), correlation (0.50287)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-9</span><span class="comment">/*mean (0.223639), correlation (0.470502)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-10</span>, <span class="number">-5</span>, <span class="number">-7</span><span class="comment">/*mean (0.224089), correlation (0.500852)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-8</span>, <span class="number">-8</span>, <span class="number">-13</span><span class="comment">/*mean (0.228666), correlation (0.502629)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-6</span>, <span class="number">8</span>, <span class="number">5</span><span class="comment">/*mean (0.22906), correlation (0.498305)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">-13</span><span class="comment">/*mean (0.233378), correlation (0.503825)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">-3</span><span class="comment">/*mean (0.234323), correlation (0.476692)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-13</span>, <span class="number">10</span>, <span class="number">-12</span><span class="comment">/*mean (0.236392), correlation (0.475462)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-13</span>, <span class="number">5</span>, <span class="number">-1</span><span class="comment">/*mean (0.236842), correlation (0.504132)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">9</span>, <span class="number">-4</span>, <span class="number">3</span><span class="comment">/*mean (0.236977), correlation (0.497739)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">-9</span><span class="comment">/*mean (0.24314), correlation (0.499398)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">1</span>, <span class="number">-6</span>, <span class="number">1</span><span class="comment">/*mean (0.243297), correlation (0.489447)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">-8</span><span class="comment">/*mean (0.00155196), correlation (0.553496)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-10</span>, <span class="number">-10</span>, <span class="number">9</span><span class="comment">/*mean (0.00239541), correlation (0.54297)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-13</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.0034413), correlation (0.544361)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-12</span>, <span class="number">-6</span>, <span class="number">-5</span><span class="comment">/*mean (0.003565), correlation (0.551225)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">7</span><span class="comment">/*mean (0.00835583), correlation (0.55285)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">-8</span><span class="comment">/*mean (0.00885065), correlation (0.540913)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">-12</span><span class="comment">/*mean (0.0101552), correlation (0.551085)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">10</span>, <span class="number">-6</span>, <span class="number">5</span><span class="comment">/*mean (0.0102227), correlation (0.533635)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-9</span>, <span class="number">-3</span>, <span class="number">9</span><span class="comment">/*mean (0.0110211), correlation (0.543121)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-13</span>, <span class="number">-1</span>, <span class="number">5</span><span class="comment">/*mean (0.0113473), correlation (0.550173)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-7</span>, <span class="number">-3</span>, <span class="number">4</span><span class="comment">/*mean (0.0140913), correlation (0.554774)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-2</span>, <span class="number">-8</span>, <span class="number">3</span><span class="comment">/*mean (0.017049), correlation (0.55461)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.01778), correlation (0.546921)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-5</span>, <span class="number">3</span>, <span class="number">11</span><span class="comment">/*mean (0.0224022), correlation (0.549667)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-9</span>, <span class="number">11</span>, <span class="number">-13</span><span class="comment">/*mean (0.029161), correlation (0.546295)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-1</span>, <span class="number">7</span>, <span class="number">12</span><span class="comment">/*mean (0.0303081), correlation (0.548599)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-1</span>, <span class="number">12</span>, <span class="number">4</span><span class="comment">/*mean (0.0355151), correlation (0.523943)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">0</span>, <span class="number">-3</span>, <span class="number">6</span><span class="comment">/*mean (0.0417904), correlation (0.543395)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-11</span>, <span class="number">4</span>, <span class="number">12</span><span class="comment">/*mean (0.0487292), correlation (0.542818)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-4</span>, <span class="number">2</span>, <span class="number">1</span><span class="comment">/*mean (0.0575124), correlation (0.554888)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-6</span>, <span class="number">-8</span>, <span class="number">1</span><span class="comment">/*mean (0.0594242), correlation (0.544026)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">7</span>, <span class="number">-11</span>, <span class="number">1</span><span class="comment">/*mean (0.0597391), correlation (0.550524)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-11</span>, <span class="number">-13</span><span class="comment">/*mean (0.0608974), correlation (0.55383)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">-13</span><span class="comment">/*mean (0.065126), correlation (0.552006)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">4</span><span class="comment">/*mean (0.074224), correlation (0.546372)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">3</span>, <span class="number">-9</span>, <span class="number">-2</span><span class="comment">/*mean (0.0808592), correlation (0.554875)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">8</span>, <span class="number">-6</span>, <span class="number">-3</span><span class="comment">/*mean (0.0883378), correlation (0.551178)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-6</span>, <span class="number">-8</span>, <span class="number">-2</span><span class="comment">/*mean (0.0901035), correlation (0.548446)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-9</span>, <span class="number">8</span>, <span class="number">10</span><span class="comment">/*mean (0.0949843), correlation (0.554694)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">-9</span><span class="comment">/*mean (0.0994152), correlation (0.550979)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-6</span>, <span class="number">-1</span>, <span class="number">-1</span><span class="comment">/*mean (0.10045), correlation (0.552714)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">-2</span><span class="comment">/*mean (0.100686), correlation (0.552594)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-3</span>, <span class="number">12</span>, <span class="number">-8</span><span class="comment">/*mean (0.101091), correlation (0.532394)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span><span class="comment">/*mean (0.101147), correlation (0.525576)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">10</span><span class="comment">/*mean (0.105263), correlation (0.531498)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-6</span>, <span class="number">4</span>, <span class="number">5</span><span class="comment">/*mean (0.110785), correlation (0.540491)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-10</span>, <span class="number">5</span><span class="comment">/*mean (0.112798), correlation (0.536582)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">11</span><span class="comment">/*mean (0.114181), correlation (0.555793)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">-6</span><span class="comment">/*mean (0.117431), correlation (0.553763)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-4</span>, <span class="number">8</span>, <span class="number">-12</span><span class="comment">/*mean (0.118522), correlation (0.553452)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">4</span>, <span class="number">-10</span>, <span class="number">9</span><span class="comment">/*mean (0.12094), correlation (0.554785)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">4</span><span class="comment">/*mean (0.122582), correlation (0.555825)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">-7</span>, <span class="number">10</span>, <span class="number">-2</span><span class="comment">/*mean (0.124978), correlation (0.549846)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">-2</span><span class="comment">/*mean (0.127002), correlation (0.537452)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-6</span>, <span class="number">0</span>, <span class="number">-11</span><span class="comment">/*mean (0.127148), correlation (0.547401)*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compute the descriptor</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ComputeORB</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, vector&lt;cv::KeyPoint&gt; &amp;keypoints, vector&lt;DescType&gt; &amp;descriptors)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> half_patch_size = <span class="number">8</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> half_boundary = <span class="number">16</span>;</span><br><span class="line">  <span class="type">int</span> bad_points = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: keypoints) &#123;</span><br><span class="line">    <span class="keyword">if</span> (kp.pt.x &lt; half_boundary || kp.pt.y &lt; half_boundary ||</span><br><span class="line">        kp.pt.x &gt;= img.cols - half_boundary || kp.pt.y &gt;= img.rows - half_boundary) &#123;</span><br><span class="line">      <span class="comment">// outside</span></span><br><span class="line">      bad_points++;</span><br><span class="line">      descriptors.<span class="built_in">push_back</span>(&#123;&#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> m01 = <span class="number">0</span>, m10 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> dx = -half_patch_size; dx &lt; half_patch_size; ++dx) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> dy = -half_patch_size; dy &lt; half_patch_size; ++dy) &#123;</span><br><span class="line">        uchar pixel = img.<span class="built_in">at</span>&lt;uchar&gt;(kp.pt.y + dy, kp.pt.x + dx);</span><br><span class="line">        m10 += dx * pixel;</span><br><span class="line">        m01 += dy * pixel;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// angle should be arc tan(m01/m10);</span></span><br><span class="line">    <span class="type">float</span> m_sqrt = <span class="built_in">sqrt</span>(m01 * m01 + m10 * m10) + <span class="number">1e-18</span>; <span class="comment">// avoid divide by zero</span></span><br><span class="line">    <span class="type">float</span> sin_theta = m01 / m_sqrt;</span><br><span class="line">    <span class="type">float</span> cos_theta = m10 / m_sqrt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compute the angle of this point</span></span><br><span class="line">    <span class="function">DescType <span class="title">desc</span><span class="params">(<span class="number">8</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">      <span class="type">uint32_t</span> d = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">32</span>; k++) &#123;</span><br><span class="line">        <span class="type">int</span> idx_pq = i * <span class="number">32</span> + k;</span><br><span class="line">        <span class="function">cv::Point2f <span class="title">p</span><span class="params">(ORB_pattern[idx_pq * <span class="number">4</span>], ORB_pattern[idx_pq * <span class="number">4</span> + <span class="number">1</span>])</span></span>;</span><br><span class="line">        <span class="function">cv::Point2f <span class="title">q</span><span class="params">(ORB_pattern[idx_pq * <span class="number">4</span> + <span class="number">2</span>], ORB_pattern[idx_pq * <span class="number">4</span> + <span class="number">3</span>])</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rotate with theta</span></span><br><span class="line">        cv::Point2f pp = cv::<span class="built_in">Point2f</span>(cos_theta * p.x - sin_theta * p.y, sin_theta * p.x + cos_theta * p.y)</span><br><span class="line">                         + kp.pt;</span><br><span class="line">        cv::Point2f qq = cv::<span class="built_in">Point2f</span>(cos_theta * q.x - sin_theta * q.y, sin_theta * q.x + cos_theta * q.y)</span><br><span class="line">                         + kp.pt;</span><br><span class="line">        <span class="keyword">if</span> (img.<span class="built_in">at</span>&lt;uchar&gt;(pp.y, pp.x) &lt; img.<span class="built_in">at</span>&lt;uchar&gt;(qq.y, qq.x)) &#123;</span><br><span class="line">          d |= <span class="number">1</span> &lt;&lt; k;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      desc[i] = d;</span><br><span class="line">    &#125;</span><br><span class="line">    descriptors.<span class="built_in">push_back</span>(desc);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;bad/total: &quot;</span> &lt;&lt; bad_points &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; keypoints.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// brute-force matching</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BfMatch</span><span class="params">(<span class="type">const</span> vector&lt;DescType&gt; &amp;desc1, <span class="type">const</span> vector&lt;DescType&gt; &amp;desc2, vector&lt;cv::DMatch&gt; &amp;matches)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> d_max = <span class="number">40</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i1 = <span class="number">0</span>; i1 &lt; desc<span class="number">1.</span><span class="built_in">size</span>(); ++i1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (desc1[i1].<span class="built_in">empty</span>()) <span class="keyword">continue</span>;</span><br><span class="line">    cv::DMatch m&#123;i1, <span class="number">0</span>, <span class="number">256</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i2 = <span class="number">0</span>; i2 &lt; desc<span class="number">2.</span><span class="built_in">size</span>(); ++i2) &#123;</span><br><span class="line">      <span class="keyword">if</span> (desc2[i2].<span class="built_in">empty</span>()) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="type">int</span> distance = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">8</span>; k++) &#123;</span><br><span class="line">        distance += _mm_popcnt_u32(desc1[i1][k] ^ desc2[i2][k]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (distance &lt; d_max &amp;&amp; distance &lt; m.distance) &#123;</span><br><span class="line">        m.distance = distance;</span><br><span class="line">        m.trainIdx = i2;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m.distance &lt; d_max) &#123;</span><br><span class="line">      matches.<span class="built_in">push_back</span>(m);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE &quot;Release&quot;)</span><br><span class="line">add_definitions(&quot;-DENABLE_SSE&quot;)</span><br><span class="line">set(CMAKE_CXX_FLAGS &quot;-std=c++11 -O2 $&#123;SSE_FLAGS&#125; -msse4&quot;)</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line">include_directories(</span><br><span class="line">        $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">        &quot;/usr/include/eigen3/&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(orb_self orb_self.cpp)</span><br><span class="line">target_link_libraries(orb_self $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># # add_executable( pose_estimation_2d2d pose_estimation_2d2d.cpp extra.cpp ) # use this if in OpenCV2 </span><br><span class="line"># add_executable(pose_estimation_2d2d pose_estimation_2d2d.cpp)</span><br><span class="line"># target_link_libraries(pose_estimation_2d2d $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># # add_executable( triangulation triangulation.cpp extra.cpp) # use this if in opencv2</span><br><span class="line"># add_executable(triangulation triangulation.cpp)</span><br><span class="line"># target_link_libraries(triangulation $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># add_executable(pose_estimation_3d2d pose_estimation_3d2d.cpp)</span><br><span class="line"># target_link_libraries(pose_estimation_3d2d</span><br><span class="line">#         g2o_core g2o_stuff</span><br><span class="line">#         $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># add_executable(pose_estimation_3d3d pose_estimation_3d3d.cpp)</span><br><span class="line"># target_link_libraries(pose_estimation_3d3d</span><br><span class="line">#         g2o_core g2o_stuff</span><br><span class="line">#         $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./orb_self </span><br><span class="line">bad/total: 43/638</span><br><span class="line">bad/total: 8/595</span><br><span class="line">extract ORB cost = 0.00315124 seconds. </span><br><span class="line">match ORB cost = 0.000610558 seconds. </span><br><span class="line">matches: 41</span><br><span class="line">done.</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827155518212.png" alt="image-20250827155518212"></p>
<h3 id="计算相机运动"><a href="#计算相机运动" class="headerlink" title="计算相机运动"></a>计算相机运动</h3><p>既然已经有了匹配好的点对，接下来要根据点对估计相机的运动，根据相机的原理不同，有以下几种情况：</p>
<ol>
<li>单目相机：只知道2D的像素坐标，因而问题时根据两组2D点估计运动，该问题使用对极几何解决</li>
<li>双目相机、RGB-D：根据两组3D点估计运动，问题通常是ICP解决。</li>
<li>如果是一组3D一组2D，可以得到一些3D点和他们在相机的投影位置，也能估计相机的运动，通过PNP求解</li>
</ol>
<hr>
<h2 id="2D-2D：对极几何"><a href="#2D-2D：对极几何" class="headerlink" title="2D-2D：对极几何"></a>2D-2D：对极几何</h2><h3 id="对极约束"><a href="#对极约束" class="headerlink" title="对极约束"></a>对极约束</h3><p>具体见教材，对极约束简洁地给出了两个匹配点的空间位置关系，于是相机位姿估计问题变成以下两步：</p>
<ol>
<li>根据配对点的像素位置求出<strong>基础矩阵</strong>$F$或者<strong>本质矩阵</strong>$E$。</li>
<li>根据$E$或者$F$求出$R, t$.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-001a34da8a921ed05fe5b0d753991fb1_1440w.jpg" alt="对极几何 Epipolar Geometry - 知乎"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827165450871.png" alt="image-20250827165450871"></p>
<p>由于$E$和$F$只是相差相机内参，所以实践中往往使用形式更简单的$E$。</p>
<hr>
<h3 id="本质矩阵"><a href="#本质矩阵" class="headerlink" title="本质矩阵"></a>本质矩阵</h3><p>本质矩阵是一个3X3矩阵，总共有5个自由度，使用8对点来估计$E$——<strong>八点法</strong>。八点法只利用了$E$的线性性质，可以在线性代数的框架下求解。会得到4个可能的解，但是只有一种解中$P$在两个相机中都有正的深度，因此只需要把任意一点带入4种解中，检测该点在两个相机下的深度，就可以确定正确的解了。</p>
<h3 id="单应矩阵"><a href="#单应矩阵" class="headerlink" title="单应矩阵"></a>单应矩阵</h3><p>除了基本矩阵和本质矩阵，二视图几何中还存在另一种常见矩阵：单应矩阵$H$，描述两个平面之间的映射关系，如果场景中特征点都落在同一平面上，可以通过单应性进行运动估计。</p>
<p>单应性在SLAM中具有重要意义，当特征点共面或者相机发生纯旋转，基础矩阵自由度下降，出现退化，这时候就需要使用基础矩阵和单应矩阵，选择误差较小的作为最终的运动估计矩阵。</p>
<hr>
<h2 id="实践：对极约束求解相机运动"><a href="#实践：对极约束求解相机运动" class="headerlink" title="实践：对极约束求解相机运动"></a>实践：对极约束求解相机运动</h2><p>新建文件<code>slambook/ch7/pose_estimation_2d2d.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/calib3d/calib3d.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;DMatch&gt; &amp;matches)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_2d2d</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;DMatch&gt; matches,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;usage: pose_estimation_2d2d img1 img2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//-- 读取图像</span></span><br><span class="line">  <span class="comment">// 【修改1】使用 cv::IMREAD_COLOR 替换 CV_LOAD_IMAGE_COLOR</span></span><br><span class="line">  Mat img_1 = <span class="built_in">imread</span>(argv[<span class="number">1</span>], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = <span class="built_in">imread</span>(argv[<span class="number">2</span>], cv::IMREAD_COLOR);</span><br><span class="line">  <span class="built_in">assert</span>(img_<span class="number">1.</span>data &amp;&amp; img_<span class="number">2.</span>data &amp;&amp; <span class="string">&quot;Can not load images!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  <span class="built_in">find_feature_matches</span>(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;一共找到了&quot;</span> &lt;&lt; matches.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;组匹配点&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 估计两张图像间运动</span></span><br><span class="line">  Mat R, t;</span><br><span class="line">  <span class="built_in">pose_estimation_2d2d</span>(keypoints_1, keypoints_2, matches, R, t);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 验证E=t^R*scale</span></span><br><span class="line">  Mat t_x =</span><br><span class="line">    (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">0</span>, -t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>, <span class="number">0</span>), t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">      t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>, <span class="number">0</span>), <span class="number">0</span>, -t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">      -t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">0</span>), t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t^R=&quot;</span> &lt;&lt; endl &lt;&lt; t_x * R &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 验证对极约束</span></span><br><span class="line">  Mat K = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span> (DMatch m: matches) &#123;</span><br><span class="line">    Point2d pt1 = <span class="built_in">pixel2cam</span>(keypoints_1[m.queryIdx].pt, K);</span><br><span class="line">    Mat y1 = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; pt<span class="number">1.</span>x, pt<span class="number">1.</span>y, <span class="number">1</span>);</span><br><span class="line">    Point2d pt2 = <span class="built_in">pixel2cam</span>(keypoints_2[m.trainIdx].pt, K);</span><br><span class="line">    Mat y2 = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; pt<span class="number">2.</span>x, pt<span class="number">2.</span>y, <span class="number">1</span>);</span><br><span class="line">    Mat d = y<span class="number">2.</span><span class="built_in">t</span>() * t_x * R * y1;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;epipolar constraint = &quot;</span> &lt;&lt; d &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(<span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;DMatch&gt; &amp;matches)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//-- 初始化</span></span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  <span class="comment">// 【修改3】使用统一的 ORB 对象</span></span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">1.2f</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, ORB::HARRIS_SCORE, <span class="number">31</span>, <span class="number">20</span>);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第一步:检测 Oriented FAST 角点位置</span></span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_1, keypoints_1);</span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_2, keypoints_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第二步:根据角点位置计算 BRIEF 描述子</span></span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_1, keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_2, keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span></span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;<span class="built_in">match</span>(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第四步:匹配点对筛选</span></span><br><span class="line">  <span class="type">double</span> min_dist = <span class="number">10000</span>, max_dist = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="type">double</span> dist = match[i].distance;</span><br><span class="line">    <span class="keyword">if</span> (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    <span class="keyword">if</span> (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Max dist : %f \n&quot;</span>, max_dist);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Min dist : %f \n&quot;</span>, min_dist);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (match[i].distance &lt;= <span class="built_in">max</span>(<span class="number">2</span> * min_dist, <span class="number">30.0</span>)) &#123;</span><br><span class="line">      matches.<span class="built_in">push_back</span>(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Point2d</span>(</span><br><span class="line">    (p.x - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    (p.y - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_2d2d</span><span class="params">(std::vector&lt;KeyPoint&gt; keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;DMatch&gt; matches,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Mat &amp;R, Mat &amp;t)</span> </span>&#123;</span><br><span class="line">  Mat K = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  vector&lt;Point2f&gt; points1;</span><br><span class="line">  vector&lt;Point2f&gt; points2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>) matches.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    points<span class="number">1.</span><span class="built_in">push_back</span>(keypoints_1[matches[i].queryIdx].pt);</span><br><span class="line">    points<span class="number">2.</span><span class="built_in">push_back</span>(keypoints_2[matches[i].trainIdx].pt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 计算基础矩阵</span></span><br><span class="line">  Mat fundamental_matrix;</span><br><span class="line">  <span class="comment">// 【修改2】使用 cv::FM_8POINT 替换 CV_FM_8POINT</span></span><br><span class="line">  fundamental_matrix = <span class="built_in">findFundamentalMat</span>(points1, points2, cv::FM_8POINT);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;fundamental_matrix is &quot;</span> &lt;&lt; endl &lt;&lt; fundamental_matrix &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 计算本质矩阵</span></span><br><span class="line">  <span class="function">Point2d <span class="title">principal_point</span><span class="params">(<span class="number">325.1</span>, <span class="number">249.7</span>)</span></span>;</span><br><span class="line">  <span class="type">double</span> focal_length = <span class="number">521</span>;</span><br><span class="line">  Mat essential_matrix;</span><br><span class="line">  essential_matrix = <span class="built_in">findEssentialMat</span>(points1, points2, focal_length, principal_point);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;essential_matrix is &quot;</span> &lt;&lt; endl &lt;&lt; essential_matrix &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 计算单应矩阵</span></span><br><span class="line">  Mat homography_matrix;</span><br><span class="line">  homography_matrix = <span class="built_in">findHomography</span>(points1, points2, RANSAC, <span class="number">3</span>);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;homography_matrix is &quot;</span> &lt;&lt; endl &lt;&lt; homography_matrix &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 从本质矩阵中恢复旋转和平移信息.</span></span><br><span class="line">  <span class="built_in">recoverPose</span>(essential_matrix, points1, points2, R, t, focal_length, principal_point);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;R is &quot;</span> &lt;&lt; endl &lt;&lt; R &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t is &quot;</span> &lt;&lt; endl &lt;&lt; t &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改一下CmakeLists.txt</p>
<p>输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./pose_estimation_2d2d ../1.png ../2.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">fundamental_matrix is </span><br><span class="line">[4.54443750398184e-06, 0.0001333855576992603, -0.01798499246479044;</span><br><span class="line"> -0.0001275657012964255, 2.266794804645652e-05, -0.01416678429206633;</span><br><span class="line"> 0.01814994639971766, 0.004146055870980492, 1]</span><br><span class="line">essential_matrix is </span><br><span class="line">[-0.008455114492964278, 0.05451570701059781, 0.1546375809484052;</span><br><span class="line"> -0.008287154708445212, 0.03351311565984172, -0.6896472136971504;</span><br><span class="line"> -0.1153993974485718, 0.6945899967012867, 0.02159624094256633]</span><br><span class="line">homography_matrix is </span><br><span class="line">[0.926121428117554, -0.1445322024509823, 33.26921085699323;</span><br><span class="line"> 0.04535424464910425, 0.9386696693816733, 8.570979966717408;</span><br><span class="line"> -1.006197561051851e-05, -3.008140280167667e-05, 1]</span><br><span class="line">R is </span><br><span class="line">[0.9956584940813579, -0.05615340406690447, 0.07423582945816433;</span><br><span class="line"> 0.05268846331440004, 0.9974645001566195, 0.04783823534446425;</span><br><span class="line"> -0.07673388428334535, -0.0437191735855581, 0.9960926386957119]</span><br><span class="line">t is </span><br><span class="line">[-0.9726703113454949;</span><br><span class="line"> -0.2153829834753195;</span><br><span class="line"> 0.08673313009645391]</span><br><span class="line">t^R=</span><br><span class="line">[0.01195733758736675, -0.07709685221674556, -0.2186905642298021;</span><br><span class="line"> 0.01171980658216709, -0.04739470268352609, 0.9753084428633267;</span><br><span class="line"> 0.1631993929614534, -0.9822985936236425, -0.03054169683725466]</span><br><span class="line">epipolar constraint = [-0.0005617285518606241]</span><br><span class="line">epipolar constraint = [0.002891683190146016]</span><br><span class="line">epipolar constraint = [-0.0001941259398173245]</span><br><span class="line">epipolar constraint = [0.003462947761727536]</span><br><span class="line">epipolar constraint = [8.120001470268701e-06]</span><br><span class="line">epipolar constraint = [0.002710644239222917]</span><br><span class="line">epipolar constraint = [-0.001869251694575136]</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>输出计算好的$E F H$还有$R, t$​还有对极约束精度。</p>
<p>由于$E$本身具有尺度等价性，它分解得到的$t,R$有一个尺度等价性，也就是说，结果只是一个尺度，通常是归一化的结果，所以会导致单目视觉的尺度不确定性，并且<strong>单目初始化不能只有旋转，必须有一定程度上的平移</strong>，否则就无法求解$R$。</p>
<hr>
<h2 id="三角测量"><a href="#三角测量" class="headerlink" title="三角测量"></a>三角测量</h2><p>上一步已经使用对极几何约束估计了相机的运动，在得到运动之后，下一步需要采用相机的运动估计特征点的空间位置。在单目SLAM中，无法使用单张图片获得像素的深度信息，需要通过<strong>三角测量</strong>的方法估计地图点的深度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-ab9b8efbec920fc566c4b9a05a7d3e96_r.jpg" alt="视觉SLAM十四讲学习笔记-第七讲-视觉里程计-三角测量和实践 - 知乎"></p>
<hr>
<h2 id="实践：三角测量"><a href="#实践：三角测量" class="headerlink" title="实践：三角测量"></a>实践：三角测量</h2><h3 id="三角测量代码"><a href="#三角测量代码" class="headerlink" title="三角测量代码"></a>三角测量代码</h3><p>新建文件<code>slambook/ch7/triangulation.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;opencv2/opencv.hpp&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line">using namespace cv;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(</span><br><span class="line">  const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  std::vector&lt;DMatch&gt; &amp;matches);</span><br><span class="line"></span><br><span class="line">void pose_estimation_2d2d(</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  Mat &amp;R, Mat &amp;t);</span><br><span class="line"></span><br><span class="line">void triangulation(</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_1,</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  const Mat &amp;R, const Mat &amp;t,</span><br><span class="line">  vector&lt;Point3d&gt; &amp;points</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">/// 作图用</span><br><span class="line">inline cv::Scalar get_color(float depth) &#123;</span><br><span class="line">  float up_th = 50, low_th = 10, th_range = up_th - low_th;</span><br><span class="line">  if (depth &gt; up_th) depth = up_th;</span><br><span class="line">  if (depth &lt; low_th) depth = low_th;</span><br><span class="line">  return cv::Scalar(255 * depth / th_range, 0, 255 * (1 - depth / th_range));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 像素坐标转相机归一化坐标</span><br><span class="line">Point2f pixel2cam(const Point2d &amp;p, const Mat &amp;K);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  if (argc != 3) &#123;</span><br><span class="line">    cout &lt;&lt; &quot;usage: triangulation img1 img2&quot; &lt;&lt; endl;</span><br><span class="line">    return 1;</span><br><span class="line">  &#125;</span><br><span class="line">  //-- 读取图像</span><br><span class="line">  // 【修改1】使用 cv::IMREAD_COLOR 替换旧的宏</span><br><span class="line">  Mat img_1 = imread(argv[1], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = imread(argv[2], cv::IMREAD_COLOR);</span><br><span class="line"></span><br><span class="line">  if (img_1.empty() || img_2.empty()) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;Could not open or find the images!&quot; &lt;&lt; endl;</span><br><span class="line">      return 1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  find_feature_matches(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; &quot;一共找到了&quot; &lt;&lt; matches.size() &lt;&lt; &quot;组匹配点&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  //-- 估计两张图像间运动</span><br><span class="line">  Mat R, t;</span><br><span class="line">  pose_estimation_2d2d(keypoints_1, keypoints_2, matches, R, t);</span><br><span class="line"></span><br><span class="line">  //-- 三角化</span><br><span class="line">  vector&lt;Point3d&gt; points;</span><br><span class="line">  triangulation(keypoints_1, keypoints_2, matches, R, t, points);</span><br><span class="line"></span><br><span class="line">  //-- 验证三角化点与特征点的重投影关系</span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line">  Mat img1_plot = img_1.clone();</span><br><span class="line">  Mat img2_plot = img_2.clone();</span><br><span class="line">  for (size_t i = 0; i &lt; matches.size(); i++) &#123;</span><br><span class="line">    // 第一个图</span><br><span class="line">    float depth1 = points[i].z;</span><br><span class="line">    if (depth1 &gt; 0) &#123; // 只显示深度为正的点</span><br><span class="line">        cout &lt;&lt; &quot;depth: &quot; &lt;&lt; depth1 &lt;&lt; endl;</span><br><span class="line">        cv::circle(img1_plot, keypoints_1[matches[i].queryIdx].pt, 2, get_color(depth1), 2);</span><br><span class="line"></span><br><span class="line">        // 第二个图</span><br><span class="line">        Mat pt2_trans = R * (Mat_&lt;double&gt;(3, 1) &lt;&lt; points[i].x, points[i].y, points[i].z) + t;</span><br><span class="line">        float depth2 = pt2_trans.at&lt;double&gt;(2, 0);</span><br><span class="line">        cv::circle(img2_plot, keypoints_2[matches[i].trainIdx].pt, 2, get_color(depth2), 2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cv::imshow(&quot;img 1&quot;, img1_plot);</span><br><span class="line">  cv::imshow(&quot;img 2&quot;, img2_plot);</span><br><span class="line">  cv::waitKey();</span><br><span class="line"></span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">                          std::vector&lt;DMatch&gt; &amp;matches) &#123;</span><br><span class="line">  //-- 初始化</span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  // 【修改2】使用统一的 ORB 对象以兼容 OpenCV 4</span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::create(500, 1.2f, 8, 31, 0, 2, ORB::HARRIS_SCORE, 31, 20);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::create(&quot;BruteForce-Hamming&quot;);</span><br><span class="line">  </span><br><span class="line">  //-- 第一步:检测 Oriented FAST 角点位置</span><br><span class="line">  orb-&gt;detect(img_1, keypoints_1);</span><br><span class="line">  orb-&gt;detect(img_2, keypoints_2);</span><br><span class="line"></span><br><span class="line">  //-- 第二步:根据角点位置计算 BRIEF 描述子</span><br><span class="line">  orb-&gt;compute(img_1, keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;compute(img_2, keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  //-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;match(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  //-- 第四步:匹配点对筛选</span><br><span class="line">  double min_dist = 10000, max_dist = 0;</span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    double dist = match[i].distance;</span><br><span class="line">    if (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    if (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printf(&quot;-- Max dist : %f \n&quot;, max_dist);</span><br><span class="line">  printf(&quot;-- Min dist : %f \n&quot;, min_dist);</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    if (match[i].distance &lt;= max(2 * min_dist, 30.0)) &#123;</span><br><span class="line">      matches.push_back(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void pose_estimation_2d2d(</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  Mat &amp;R, Mat &amp;t) &#123;</span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line"></span><br><span class="line">  vector&lt;Point2f&gt; points1;</span><br><span class="line">  vector&lt;Point2f&gt; points2;</span><br><span class="line"></span><br><span class="line">  for (size_t i = 0; i &lt; matches.size(); i++) &#123;</span><br><span class="line">    points1.push_back(keypoints_1[matches[i].queryIdx].pt);</span><br><span class="line">    points2.push_back(keypoints_2[matches[i].trainIdx].pt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Point2d principal_point(325.1, 249.7);</span><br><span class="line">  double focal_length = 521;</span><br><span class="line">  Mat essential_matrix;</span><br><span class="line">  essential_matrix = findEssentialMat(points1, points2, focal_length, principal_point);</span><br><span class="line"></span><br><span class="line">  recoverPose(essential_matrix, points1, points2, R, t, focal_length, principal_point);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void triangulation(</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_1,</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  const Mat &amp;R, const Mat &amp;t,</span><br><span class="line">  vector&lt;Point3d&gt; &amp;points) &#123;</span><br><span class="line">  // 注意 T1 和 T2 的数据类型应与 R, t 一致 (double)</span><br><span class="line">  Mat T1 = (Mat_&lt;double&gt;(3, 4) &lt;&lt;</span><br><span class="line">    1, 0, 0, 0,</span><br><span class="line">    0, 1, 0, 0,</span><br><span class="line">    0, 0, 1, 0);</span><br><span class="line">  Mat T2 = (Mat_&lt;double&gt;(3, 4) &lt;&lt;</span><br><span class="line">    R.at&lt;double&gt;(0, 0), R.at&lt;double&gt;(0, 1), R.at&lt;double&gt;(0, 2), t.at&lt;double&gt;(0, 0),</span><br><span class="line">    R.at&lt;double&gt;(1, 0), R.at&lt;double&gt;(1, 1), R.at&lt;double&gt;(1, 2), t.at&lt;double&gt;(1, 0),</span><br><span class="line">    R.at&lt;double&gt;(2, 0), R.at&lt;double&gt;(2, 1), R.at&lt;double&gt;(2, 2), t.at&lt;double&gt;(2, 0)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line">  vector&lt;Point2f&gt; pts_1, pts_2;</span><br><span class="line">  for (const DMatch &amp;m:matches) &#123;</span><br><span class="line">    pts_1.push_back(pixel2cam(keypoint_1[m.queryIdx].pt, K));</span><br><span class="line">    pts_2.push_back(pixel2cam(keypoint_2[m.trainIdx].pt, K));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Mat pts_4d;</span><br><span class="line">  cv::triangulatePoints(T1, T2, pts_1, pts_2, pts_4d);</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; pts_4d.cols; i++) &#123;</span><br><span class="line">    Mat x = pts_4d.col(i);</span><br><span class="line">    x /= x.at&lt;double&gt;(3, 0); // 归一化，注意数据类型为 double</span><br><span class="line">    Point3d p(</span><br><span class="line">      x.at&lt;double&gt;(0, 0),</span><br><span class="line">      x.at&lt;double&gt;(1, 0),</span><br><span class="line">      x.at&lt;double&gt;(2, 0)</span><br><span class="line">    );</span><br><span class="line">    points.push_back(p);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Point2f pixel2cam(const Point2d &amp;p, const Mat &amp;K) &#123;</span><br><span class="line">  return Point2f(</span><br><span class="line">    (p.x - K.at&lt;double&gt;(0, 2)) / K.at&lt;double&gt;(0, 0),</span><br><span class="line">    (p.y - K.at&lt;double&gt;(1, 2)) / K.at&lt;double&gt;(1, 1)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./triangulation ../1.png ../2.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">depth: inf</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827194058967.png" alt="image-20250827194058967"></p>
<p>当平移很小时，像素上的不确定性将导致较大的深度的不确定性，即平移越大，同样的相机分辨率下，三角化测量将更为精确。在单目视觉中，由于三角化存在视差，需要等待特征点被追踪几帧之后，产生足够的视角，再利用三角化来确定新增的特征点的深度值，这被称为：<strong>延迟三角化</strong>，但是最好相机不要发生原地旋转的情况。往往会导致追踪失败、尺度不正确等问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827194814134.png" alt="image-20250827194814134"></p>
<h2 id="3D-2D-PnP"><a href="#3D-2D-PnP" class="headerlink" title="3D-2D: PnP"></a>3D-2D: PnP</h2><p>PnP（Perspective-n-Point）是求解3D到2D点对运动的方法，描述当知道n个3D空间点及其投影位置时，如何估计相机的位姿。如果两张图像中的一张特征点的3D位置一直，那么最少需要3个点对就可以估计相机运动。特征点的3D位置可以由三角化或者RGB-D相机的深度图获取。所以可以直接在双目或者RGB-D的视觉里程计中使用PnP估计相机运动，但是在单目视觉里程计中，需要先进行初始化，才能使用PnP。</p>
<p>PnP有多种求解方法，P3P、直接线性变换(DLT)、EPnP、UPnP等等。还有光束法平差BA。</p>
<h3 id="直接线性变换"><a href="#直接线性变换" class="headerlink" title="直接线性变换"></a>直接线性变换</h3><h3 id="P3P"><a href="#P3P" class="headerlink" title="P3P"></a>P3P</h3><h3 id="最小化重投影误差求解PnP"><a href="#最小化重投影误差求解PnP" class="headerlink" title="最小化重投影误差求解PnP"></a>最小化重投影误差求解PnP</h3><hr>
<h2 id="实践：求解PnP"><a href="#实践：求解PnP" class="headerlink" title="实践：求解PnP"></a>实践：求解PnP</h2><p>新建文件<code>slambook/ch7/pose_estimation_3d2d.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;opencv2/core/core.hpp&gt;</span><br><span class="line">#include &lt;opencv2/features2d/features2d.hpp&gt;</span><br><span class="line">#include &lt;opencv2/highgui/highgui.hpp&gt;</span><br><span class="line">#include &lt;opencv2/calib3d/calib3d.hpp&gt;</span><br><span class="line">#include &lt;Eigen/Core&gt;</span><br><span class="line">#include &lt;g2o/core/base_vertex.h&gt;</span><br><span class="line">#include &lt;g2o/core/base_unary_edge.h&gt;</span><br><span class="line">#include &lt;g2o/core/sparse_optimizer.h&gt;</span><br><span class="line">#include &lt;g2o/core/block_solver.h&gt;</span><br><span class="line">#include &lt;g2o/core/solver.h&gt;</span><br><span class="line">#include &lt;g2o/core/optimization_algorithm_gauss_newton.h&gt;</span><br><span class="line">#include &lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span><br><span class="line">#include &lt;sophus/se3.hpp&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line">#include &lt;memory&gt; // 包含 &lt;memory&gt; 以使用 std::make_unique</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line">using namespace cv;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(</span><br><span class="line">  const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  std::vector&lt;DMatch&gt; &amp;matches);</span><br><span class="line"></span><br><span class="line">// 像素坐标转相机归一化坐标</span><br><span class="line">Point2d pixel2cam(const Point2d &amp;p, const Mat &amp;K);</span><br><span class="line"></span><br><span class="line">// BA by g2o</span><br><span class="line">typedef vector&lt;Eigen::Vector2d, Eigen::aligned_allocator&lt;Eigen::Vector2d&gt;&gt; VecVector2d;</span><br><span class="line">typedef vector&lt;Eigen::Vector3d, Eigen::aligned_allocator&lt;Eigen::Vector3d&gt;&gt; VecVector3d;</span><br><span class="line"></span><br><span class="line">void bundleAdjustmentG2O(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// BA by gauss-newton</span><br><span class="line">void bundleAdjustmentGaussNewton(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  if (argc != 5) &#123;</span><br><span class="line">    cout &lt;&lt; &quot;usage: pose_estimation_3d2d img1 img2 depth1 depth2&quot; &lt;&lt; endl;</span><br><span class="line">    return 1;</span><br><span class="line">  &#125;</span><br><span class="line">  //-- 读取图像</span><br><span class="line">  Mat img_1 = imread(argv[1], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = imread(argv[2], cv::IMREAD_COLOR);</span><br><span class="line">  Mat d1 = imread(argv[3], cv::IMREAD_UNCHANGED);       // 深度图为16位无符号数，单通道图像</span><br><span class="line">  </span><br><span class="line">  if (img_1.empty() || img_2.empty() || d1.empty()) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;Could not open or find the images!&quot; &lt;&lt; endl;</span><br><span class="line">      return 1;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  find_feature_matches(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; &quot;一共找到了&quot; &lt;&lt; matches.size() &lt;&lt; &quot;组匹配点&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  // 建立3D点</span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line">  vector&lt;Point3f&gt; pts_3d;</span><br><span class="line">  vector&lt;Point2f&gt; pts_2d;</span><br><span class="line">  for (DMatch m:matches) &#123;</span><br><span class="line">    ushort d = d1.ptr&lt;unsigned short&gt;(int(keypoints_1[m.queryIdx].pt.y))[int(keypoints_1[m.queryIdx].pt.x)];</span><br><span class="line">    if (d == 0)   // bad depth</span><br><span class="line">      continue;</span><br><span class="line">    float dd = d / 5000.0;</span><br><span class="line">    Point2d p1 = pixel2cam(keypoints_1[m.queryIdx].pt, K);</span><br><span class="line">    pts_3d.push_back(Point3f(p1.x * dd, p1.y * dd, dd));</span><br><span class="line">    pts_2d.push_back(keypoints_2[m.trainIdx].pt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;3d-2d pairs: &quot; &lt;&lt; pts_3d.size() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">  Mat r, t;</span><br><span class="line">  solvePnP(pts_3d, pts_2d, K, Mat(), r, t, false); // 调用OpenCV 的 PnP 求解</span><br><span class="line">  Mat R;</span><br><span class="line">  cv::Rodrigues(r, R); // r为旋转向量形式，用Rodrigues公式转换为矩阵</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">  chrono::duration&lt;double&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;solve pnp in opencv cost time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;R=&quot; &lt;&lt; endl &lt;&lt; R &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; &quot;t=&quot; &lt;&lt; endl &lt;&lt; t &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  VecVector3d pts_3d_eigen;</span><br><span class="line">  VecVector2d pts_2d_eigen;</span><br><span class="line">  for (size_t i = 0; i &lt; pts_3d.size(); ++i) &#123;</span><br><span class="line">    pts_3d_eigen.push_back(Eigen::Vector3d(pts_3d[i].x, pts_3d[i].y, pts_3d[i].z));</span><br><span class="line">    pts_2d_eigen.push_back(Eigen::Vector2d(pts_2d[i].x, pts_2d[i].y));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;calling bundle adjustment by gauss newton&quot; &lt;&lt; endl;</span><br><span class="line">  Sophus::SE3d pose_gn;</span><br><span class="line">  t1 = chrono::steady_clock::now();</span><br><span class="line">  bundleAdjustmentGaussNewton(pts_3d_eigen, pts_2d_eigen, K, pose_gn);</span><br><span class="line">  t2 = chrono::steady_clock::now();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;solve pnp by gauss newton cost time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;calling bundle adjustment by g2o&quot; &lt;&lt; endl;</span><br><span class="line">  Sophus::SE3d pose_g2o;</span><br><span class="line">  t1 = chrono::steady_clock::now();</span><br><span class="line">  bundleAdjustmentG2O(pts_3d_eigen, pts_2d_eigen, K, pose_g2o);</span><br><span class="line">  t2 = chrono::steady_clock::now();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;solve pnp by g2o cost time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">                          std::vector&lt;DMatch&gt; &amp;matches) &#123;</span><br><span class="line">  //-- 初始化</span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::create(500, 1.2f, 8, 31, 0, 2, ORB::HARRIS_SCORE, 31, 20);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::create(&quot;BruteForce-Hamming&quot;);</span><br><span class="line">  </span><br><span class="line">  //-- 检测和计算</span><br><span class="line">  orb-&gt;detectAndCompute(img_1, Mat(), keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;detectAndCompute(img_2, Mat(), keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  //-- 匹配</span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;match(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  //-- 筛选</span><br><span class="line">  double min_dist = 10000, max_dist = 0;</span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    double dist = match[i].distance;</span><br><span class="line">    if (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    if (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printf(&quot;-- Max dist : %f \n&quot;, max_dist);</span><br><span class="line">  printf(&quot;-- Min dist : %f \n&quot;, min_dist);</span><br><span class="line">  </span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    if (match[i].distance &lt;= max(2 * min_dist, 30.0)) &#123;</span><br><span class="line">      matches.push_back(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Point2d pixel2cam(const Point2d &amp;p, const Mat &amp;K) &#123;</span><br><span class="line">  return Point2d(</span><br><span class="line">    (p.x - K.at&lt;double&gt;(0, 2)) / K.at&lt;double&gt;(0, 0),</span><br><span class="line">    (p.y - K.at&lt;double&gt;(1, 2)) / K.at&lt;double&gt;(1, 1)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void bundleAdjustmentGaussNewton(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose) &#123;</span><br><span class="line">  typedef Eigen::Matrix&lt;double, 6, 1&gt; Vector6d;</span><br><span class="line">  const int iterations = 10;</span><br><span class="line">  double cost = 0, lastCost = 0;</span><br><span class="line">  double fx = K.at&lt;double&gt;(0, 0);</span><br><span class="line">  double fy = K.at&lt;double&gt;(1, 1);</span><br><span class="line">  double cx = K.at&lt;double&gt;(0, 2);</span><br><span class="line">  double cy = K.at&lt;double&gt;(1, 2);</span><br><span class="line"></span><br><span class="line">  for (int iter = 0; iter &lt; iterations; iter++) &#123;</span><br><span class="line">    Eigen::Matrix&lt;double, 6, 6&gt; H = Eigen::Matrix&lt;double, 6, 6&gt;::Zero();</span><br><span class="line">    Vector6d b = Vector6d::Zero();</span><br><span class="line"></span><br><span class="line">    cost = 0;</span><br><span class="line">    for (int i = 0; i &lt; points_3d.size(); i++) &#123;</span><br><span class="line">      Eigen::Vector3d pc = pose * points_3d[i];</span><br><span class="line">      double inv_z = 1.0 / pc[2];</span><br><span class="line">      double inv_z2 = inv_z * inv_z;</span><br><span class="line">      Eigen::Vector2d proj(fx * pc[0] * inv_z + cx, fy * pc[1] * inv_z + cy);</span><br><span class="line">      Eigen::Vector2d e = points_2d[i] - proj;</span><br><span class="line">      cost += e.squaredNorm();</span><br><span class="line">      Eigen::Matrix&lt;double, 2, 6&gt; J;</span><br><span class="line">      J &lt;&lt; -fx * inv_z, 0, fx * pc[0] * inv_z2, fx * pc[0] * pc[1] * inv_z2, -fx - fx * pc[0] * pc[0] * inv_z2, fx * pc[1] * inv_z,</span><br><span class="line">           0, -fy * inv_z, fy * pc[1] * inv_z2, fy + fy * pc[1] * pc[1] * inv_z2, -fy * pc[0] * pc[1] * inv_z2, -fy * pc[0] * inv_z;</span><br><span class="line">      H += J.transpose() * J;</span><br><span class="line">      b += -J.transpose() * e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector6d dx = H.ldlt().solve(b);</span><br><span class="line">    if (isnan(dx[0])) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;result is nan!&quot; &lt;&lt; endl;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    if (iter &gt; 0 &amp;&amp; cost &gt;= lastCost) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;cost: &quot; &lt;&lt; cost &lt;&lt; &quot;, last cost: &quot; &lt;&lt; lastCost &lt;&lt; endl;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    pose = Sophus::SE3d::exp(dx) * pose;</span><br><span class="line">    lastCost = cost;</span><br><span class="line">    cout &lt;&lt; &quot;iteration &quot; &lt;&lt; iter &lt;&lt; &quot; cost=&quot; &lt;&lt; std::setprecision(12) &lt;&lt; cost &lt;&lt; endl;</span><br><span class="line">    if (dx.norm() &lt; 1e-6) break;</span><br><span class="line">  &#125;</span><br><span class="line">  cout &lt;&lt; &quot;pose by g-n: \n&quot; &lt;&lt; pose.matrix() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// g2o 自定义顶点和边</span><br><span class="line">class VertexPose : public g2o::BaseVertex&lt;6, Sophus::SE3d&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line">  virtual void setToOriginImpl() override &#123; _estimate = Sophus::SE3d(); &#125;</span><br><span class="line">  virtual void oplusImpl(const double *update) override &#123;</span><br><span class="line">    Eigen::Matrix&lt;double, 6, 1&gt; update_eigen;</span><br><span class="line">    update_eigen &lt;&lt; update[0], update[1], update[2], update[3], update[4], update[5];</span><br><span class="line">    _estimate = Sophus::SE3d::exp(update_eigen) * _estimate;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line">  virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class EdgeProjection : public g2o::BaseUnaryEdge&lt;2, Eigen::Vector2d, VertexPose&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line">  EdgeProjection(const Eigen::Vector3d &amp;pos, const Eigen::Matrix3d &amp;K) : _pos3d(pos), _K(K) &#123;&#125;</span><br><span class="line">  virtual void computeError() override &#123;</span><br><span class="line">    const auto *v = static_cast&lt;const VertexPose *&gt;(_vertices[0]);</span><br><span class="line">    Sophus::SE3d T = v-&gt;estimate();</span><br><span class="line">    Eigen::Vector3d pos_pixel = _K * (T * _pos3d);</span><br><span class="line">    pos_pixel /= pos_pixel[2];</span><br><span class="line">    _error = _measurement - pos_pixel.head&lt;2&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  virtual void linearizeOplus() override &#123;</span><br><span class="line">    const auto *v = static_cast&lt;const VertexPose *&gt;(_vertices[0]);</span><br><span class="line">    Sophus::SE3d T = v-&gt;estimate();</span><br><span class="line">    Eigen::Vector3d pos_cam = T * _pos3d;</span><br><span class="line">    double fx = _K(0, 0);</span><br><span class="line">    double fy = _K(1, 1);</span><br><span class="line">    double X = pos_cam[0];</span><br><span class="line">    double Y = pos_cam[1];</span><br><span class="line">    double Z = pos_cam[2];</span><br><span class="line">    double Z2 = Z * Z;</span><br><span class="line">    _jacobianOplusXi &lt;&lt; -fx / Z, 0, fx * X / Z2, fx * X * Y / Z2, -fx - fx * X * X / Z2, fx * Y / Z,</span><br><span class="line">                      0, -fy / Z, fy * Y / Z2, fy + fy * Y * Y / Z2, -fy * X * Y / Z2, -fy * X / Z;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line">  virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line">private:</span><br><span class="line">  Eigen::Vector3d _pos3d;</span><br><span class="line">  Eigen::Matrix3d _K;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void bundleAdjustmentG2O(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose) &#123;</span><br><span class="line"></span><br><span class="line">  typedef g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;6, 3&gt;&gt; BlockSolverType;</span><br><span class="line">  typedef g2o::LinearSolverDense&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType;</span><br><span class="line">  </span><br><span class="line">  // 【修改】将 g2o::make_unique 改为 std::make_unique</span><br><span class="line">  auto solver = new g2o::OptimizationAlgorithmGaussNewton(</span><br><span class="line">    std::make_unique&lt;BlockSolverType&gt;(std::make_unique&lt;LinearSolverType&gt;()));</span><br><span class="line">  g2o::SparseOptimizer optimizer;</span><br><span class="line">  optimizer.setAlgorithm(solver);</span><br><span class="line">  optimizer.setVerbose(true);</span><br><span class="line"></span><br><span class="line">  VertexPose *vertex_pose = new VertexPose();</span><br><span class="line">  vertex_pose-&gt;setId(0);</span><br><span class="line">  vertex_pose-&gt;setEstimate(Sophus::SE3d());</span><br><span class="line">  optimizer.addVertex(vertex_pose);</span><br><span class="line"></span><br><span class="line">  Eigen::Matrix3d K_eigen;</span><br><span class="line">  K_eigen &lt;&lt; K.at&lt;double&gt;(0, 0), K.at&lt;double&gt;(0, 1), K.at&lt;double&gt;(0, 2),</span><br><span class="line">             K.at&lt;double&gt;(1, 0), K.at&lt;double&gt;(1, 1), K.at&lt;double&gt;(1, 2),</span><br><span class="line">             K.at&lt;double&gt;(2, 0), K.at&lt;double&gt;(2, 1), K.at&lt;double&gt;(2, 2);</span><br><span class="line"></span><br><span class="line">  int index = 1;</span><br><span class="line">  for (size_t i = 0; i &lt; points_2d.size(); ++i) &#123;</span><br><span class="line">    auto p2d = points_2d[i];</span><br><span class="line">    auto p3d = points_3d[i];</span><br><span class="line">    EdgeProjection *edge = new EdgeProjection(p3d, K_eigen);</span><br><span class="line">    edge-&gt;setId(index);</span><br><span class="line">    edge-&gt;setVertex(0, vertex_pose);</span><br><span class="line">    edge-&gt;setMeasurement(p2d);</span><br><span class="line">    edge-&gt;setInformation(Eigen::Matrix2d::Identity());</span><br><span class="line">    optimizer.addEdge(edge);</span><br><span class="line">    index++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">  optimizer.initializeOptimization();</span><br><span class="line">  optimizer.optimize(10);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">  chrono::duration&lt;double&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;optimization costs time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; &quot;pose estimated by g2o =\n&quot; &lt;&lt; vertex_pose-&gt;estimate().matrix() &lt;&lt; endl;</span><br><span class="line">  pose = vertex_pose-&gt;estimate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># 设置最低 CMake 版本要求</span><br><span class="line">cmake_minimum_required(VERSION 3.12)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line"># 设置 C++ 标准为 17</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># 添加自定义 Find 模块的路径</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"># --- 查找依赖包 ---</span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED) # 仍然保留以检查g2o是否存在</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- 定义所有可执行文件目标 ---</span><br><span class="line"></span><br><span class="line"># 目标 1: orb_cv</span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 2: orb_self</span><br><span class="line">add_executable(orb_self orb_self.cpp)</span><br><span class="line">target_link_libraries(orb_self PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line">target_compile_options(orb_self PRIVATE -msse4.2)</span><br><span class="line"></span><br><span class="line"># 目标 3: pose_estimation_2d2d</span><br><span class="line">add_executable(pose_estimation_2d2d pose_estimation_2d2d.cpp)</span><br><span class="line">target_link_libraries(pose_estimation_2d2d PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 4: triangulation</span><br><span class="line">add_executable(triangulation triangulation.cpp)</span><br><span class="line">target_link_libraries(triangulation PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 5: pose_estimation_3d2d</span><br><span class="line">add_executable(pose_estimation_3d2d pose_estimation_3d2d.cpp)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接为目标添加 g2o 和其他库的头文件目录</span><br><span class="line">target_include_directories(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;   # 尽管它可能是空的，但以防万一</span><br><span class="line">    /usr/local/include/g2o # 手动添加 g2o 的默认安装头文件路径</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接链接 g2o 的核心模块库</span><br><span class="line">target_link_libraries(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    # 手动指定 g2o 的核心模块</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_stuff</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    # 链接其他库</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 目标 6 (已注释): pose_estimation_3d3d</span><br><span class="line"># add_executable(pose_estimation_3d3d pose_estimation_3d3d.cpp)</span><br><span class="line"># target_include_directories(pose_estimation_3d3d</span><br><span class="line">#     PRIVATE</span><br><span class="line">#     $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">#     $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line"># )</span><br><span class="line"># target_link_libraries(pose_estimation_3d3d</span><br><span class="line">#     PRIVATE</span><br><span class="line">#     $&#123;g2o_LIBRARIES&#125;</span><br><span class="line">#     $&#123;OpenCV_LIBS&#125;</span><br><span class="line"># )</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./pose_estimation_3d2d ../1.png ../2.png ../1_depth.png ../2_depth.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">3d-2d pairs: 75</span><br><span class="line">solve pnp in opencv cost time: 0.0108756 seconds.</span><br><span class="line">R=</span><br><span class="line">[0.9979059095501517, -0.05091940089119591, 0.03988747043579327;</span><br><span class="line"> 0.04981866254262534, 0.9983623157437967, 0.02812094175427922;</span><br><span class="line"> -0.04125404886006491, -0.02607491352939112, 0.9988083912027803]</span><br><span class="line">t=</span><br><span class="line">[-0.1267821389545255;</span><br><span class="line"> -0.00843949681832986;</span><br><span class="line"> 0.06034935748864372]</span><br><span class="line">calling bundle adjustment by gauss newton</span><br><span class="line">iteration 0 cost=40517.7576706</span><br><span class="line">iteration 1 cost=410.547029116</span><br><span class="line">iteration 2 cost=299.76468142</span><br><span class="line">iteration 3 cost=299.763574327</span><br><span class="line">pose by g-n: </span><br><span class="line">   0.997905909549  -0.0509194008562   0.0398874705187   -0.126782139096</span><br><span class="line">   0.049818662505    0.998362315745   0.0281209417649 -0.00843949683874</span><br><span class="line"> -0.0412540489424  -0.0260749135374    0.998808391199   0.0603493575229</span><br><span class="line">                0                 0                 0                 1</span><br><span class="line">solve pnp by gauss newton cost time: 0.009116205 seconds.</span><br><span class="line">calling bundle adjustment by g2o</span><br><span class="line">iteration= 0     chi2= 410.547029        time= 0.00147405        cumTime= 0.00147405     edges= 75       schur= 0</span><br><span class="line">iteration= 1     chi2= 299.764681        time= 0.00139111        cumTime= 0.00286515     edges= 75       schur= 0</span><br><span class="line">iteration= 2     chi2= 299.763574        time= 0.00122962        cumTime= 0.00409478     edges= 75       schur= 0</span><br><span class="line">iteration= 3     chi2= 299.763574        time= 0.00106202        cumTime= 0.00515679     edges= 75       schur= 0</span><br><span class="line">iteration= 4     chi2= 299.763574        time= 0.00113331        cumTime= 0.00629011     edges= 75       schur= 0</span><br><span class="line">iteration= 5     chi2= 299.763574        time= 0.00103069        cumTime= 0.00732079     edges= 75       schur= 0</span><br><span class="line">iteration= 6     chi2= 299.763574        time= 0.00106611        cumTime= 0.0083869      edges= 75       schur= 0</span><br><span class="line">iteration= 7     chi2= 299.763574        time= 0.00100701        cumTime= 0.00939391     edges= 75       schur= 0</span><br><span class="line">iteration= 8     chi2= 299.763574        time= 0.001034  cumTime= 0.0104279      edges= 75       schur= 0</span><br><span class="line">iteration= 9     chi2= 299.763574        time= 0.00103463        cumTime= 0.0114625      edges= 75       schur= 0</span><br><span class="line">optimization costs time: 0.014154345 seconds.</span><br><span class="line">pose estimated by g2o =</span><br><span class="line">    0.99790590955  -0.0509194008911   0.0398874704367   -0.126782138956</span><br><span class="line">  0.0498186625425    0.998362315744   0.0281209417542 -0.00843949681823</span><br><span class="line"> -0.0412540488609  -0.0260749135293    0.998808391203   0.0603493574888</span><br><span class="line">                0                 0                 0                 1</span><br><span class="line">solve pnp by g2o cost time: 0.014431543 seconds.</span><br></pre></td></tr></table></figure>

<p>在前端，通常考虑局部相机位姿和特征点的小型BA问题，希望对它进行实时求解和优化。</p>
<hr>
<h2 id="3D-3D-ICP"><a href="#3D-3D-ICP" class="headerlink" title="3D-3D: ICP"></a>3D-3D: ICP</h2><p>假设有一组配好的3D点，现在，想要找一个欧式变换$R,t$​实现配准，这个问题可以使用迭代最近点(Iterative Closest Point,ICP)求解。ICP求解分为两种：利用线性代数求解(SVD)，以及利用非线性优化方式求解(类似BA)。</p>
<p>ICP 的工作流程通常分为四步，并不断迭代：</p>
<ol>
<li><strong>匹配 (Matching)</strong>：为源点云 P’ 中的每个点，在目标点云 P 中寻找一个最近的对应点。</li>
<li><strong>计算变换 (Compute Transformation)</strong>：假设上一步的匹配是完全正确的，计算出能让这些对应点之间误差最小的 R 和 t。<strong>这就是 SVD 和非线性优化方法发挥作用的地方</strong>。</li>
<li><strong>应用变换 (Apply Transformation)</strong>：将计算出的 R 和 t 应用于源点云 P’，得到一个新的点云。</li>
<li><strong>迭代 (Iterate)</strong>：重复以上步骤，直到满足某个停止条件（例如，R 和 t 的变化量足够小，或者误差不再下降）。</li>
</ol>
<h3 id="SVD方法"><a href="#SVD方法" class="headerlink" title="SVD方法"></a>SVD方法</h3><p>SVD方法旨在寻找一个解析解，也就是说通过一系列精确的数学公式，直接计算处最优解，不需要迭代猜测。</p>
<p><strong>核心思想</strong></p>
<p>将求解的$R,t$​的问题，转换为一个最小二乘问题，假设有n对匹配点，我们要最小化他们的欧氏距离平方和。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827205426113.png" alt="image-20250827205426113"></p>
<h3 id="非线性优化方法"><a href="#非线性优化方法" class="headerlink" title="非线性优化方法"></a>非线性优化方法</h3><p>该方法使用迭代的方式去寻找最优值，与之前描述的PnP十分相似，将位姿用李代数表述，然后定义一个误差函数，通过高斯牛顿法或者列文伯格-马夸尔特法迭代，寻找使得误差函数最小化的位姿增量。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827205748538.png" alt="image-20250827205748538"></p>
<h2 id="实践：求解ICP"><a href="#实践：求解ICP" class="headerlink" title="实践：求解ICP"></a>实践：求解ICP</h2><h3 id="实践：SVD方法及非线性优化方法"><a href="#实践：SVD方法及非线性优化方法" class="headerlink" title="实践：SVD方法及非线性优化方法"></a>实践：SVD方法及非线性优化方法</h3><p>新建文件<code>slambook/ch7/pose_estimation_3d3d.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/calib3d/calib3d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/SVD&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_vertex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_unary_edge.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_gauss_newton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sophus/se3.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span> <span class="comment">// 【修改】为使用 std::make_unique 添加头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;DMatch&gt; &amp;matches)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 像素坐标转相机归一化坐标</span></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_3d3d</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bundleAdjustment</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// vertex and edges used in g2o ba</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VertexPose</span> : <span class="keyword">public</span> g2o::BaseVertex&lt;<span class="number">6</span>, Sophus::SE3d&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">setToOriginImpl</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    _estimate = Sophus::<span class="built_in">SE3d</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// left multiplication on SE3</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">oplusImpl</span><span class="params">(<span class="type">const</span> <span class="type">double</span> *update)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">6</span>, <span class="number">1</span>&gt; update_eigen;</span><br><span class="line">    update_eigen &lt;&lt; update[<span class="number">0</span>], update[<span class="number">1</span>], update[<span class="number">2</span>], update[<span class="number">3</span>], update[<span class="number">4</span>], update[<span class="number">5</span>];</span><br><span class="line">    _estimate = Sophus::SE3d::<span class="built_in">exp</span>(update_eigen) * _estimate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// g2o edge</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EdgeProjectXYZRGBDPoseOnly</span> : <span class="keyword">public</span> g2o::BaseUnaryEdge&lt;<span class="number">3</span>, Eigen::Vector3d, VertexPose&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">EdgeProjectXYZRGBDPoseOnly</span>(<span class="type">const</span> Eigen::Vector3d &amp;point) : _point(point) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">computeError</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> VertexPose *pose = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> VertexPose *&gt; ( _vertices[<span class="number">0</span>] );</span><br><span class="line">    _error = _measurement - pose-&gt;<span class="built_in">estimate</span>() * _point;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">linearizeOplus</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    VertexPose *pose = <span class="built_in">static_cast</span>&lt;VertexPose *&gt;(_vertices[<span class="number">0</span>]);</span><br><span class="line">    Sophus::SE3d T = pose-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">    Eigen::Vector3d xyz_trans = T * _point;</span><br><span class="line">    _jacobianOplusXi.<span class="built_in">block</span>&lt;<span class="number">3</span>, <span class="number">3</span>&gt;(<span class="number">0</span>, <span class="number">0</span>) = -Eigen::Matrix3d::<span class="built_in">Identity</span>();</span><br><span class="line">    _jacobianOplusXi.<span class="built_in">block</span>&lt;<span class="number">3</span>, <span class="number">3</span>&gt;(<span class="number">0</span>, <span class="number">3</span>) = Sophus::SO3d::<span class="built_in">hat</span>(xyz_trans);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  Eigen::Vector3d _point;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">5</span>) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;usage: pose_estimation_3d3d img1 img2 depth1 depth2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//-- 读取图像</span></span><br><span class="line">  <span class="comment">// 【修改】使用 OpenCV 4 的枚举类型</span></span><br><span class="line">  Mat img_1 = <span class="built_in">imread</span>(argv[<span class="number">1</span>], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = <span class="built_in">imread</span>(argv[<span class="number">2</span>], cv::IMREAD_COLOR);</span><br><span class="line"></span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  <span class="built_in">find_feature_matches</span>(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;一共找到了&quot;</span> &lt;&lt; matches.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;组匹配点&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 建立3D点</span></span><br><span class="line">  Mat depth1 = <span class="built_in">imread</span>(argv[<span class="number">3</span>], cv::IMREAD_UNCHANGED);       <span class="comment">// 深度图为16位无符号数，单通道图像</span></span><br><span class="line">  Mat depth2 = <span class="built_in">imread</span>(argv[<span class="number">4</span>], cv::IMREAD_UNCHANGED);       <span class="comment">// 深度图为16位无符号数，单通道图像</span></span><br><span class="line">  Mat K = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">  vector&lt;Point3f&gt; pts1, pts2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (DMatch m:matches) &#123;</span><br><span class="line">    ushort d1 = depth<span class="number">1.</span><span class="built_in">ptr</span>&lt;<span class="type">unsigned</span> <span class="type">short</span>&gt;(<span class="built_in">int</span>(keypoints_1[m.queryIdx].pt.y))[<span class="built_in">int</span>(keypoints_1[m.queryIdx].pt.x)];</span><br><span class="line">    ushort d2 = depth<span class="number">2.</span><span class="built_in">ptr</span>&lt;<span class="type">unsigned</span> <span class="type">short</span>&gt;(<span class="built_in">int</span>(keypoints_2[m.trainIdx].pt.y))[<span class="built_in">int</span>(keypoints_2[m.trainIdx].pt.x)];</span><br><span class="line">    <span class="keyword">if</span> (d1 == <span class="number">0</span> || d2 == <span class="number">0</span>)   <span class="comment">// bad depth</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    Point2d p1 = <span class="built_in">pixel2cam</span>(keypoints_1[m.queryIdx].pt, K);</span><br><span class="line">    Point2d p2 = <span class="built_in">pixel2cam</span>(keypoints_2[m.trainIdx].pt, K);</span><br><span class="line">    <span class="type">float</span> dd1 = <span class="built_in">float</span>(d1) / <span class="number">5000.0</span>;</span><br><span class="line">    <span class="type">float</span> dd2 = <span class="built_in">float</span>(d2) / <span class="number">5000.0</span>;</span><br><span class="line">    pts<span class="number">1.</span><span class="built_in">push_back</span>(<span class="built_in">Point3f</span>(p<span class="number">1.</span>x * dd1, p<span class="number">1.</span>y * dd1, dd1));</span><br><span class="line">    pts<span class="number">2.</span><span class="built_in">push_back</span>(<span class="built_in">Point3f</span>(p<span class="number">2.</span>x * dd2, p<span class="number">2.</span>y * dd2, dd2));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;3d-3d pairs: &quot;</span> &lt;&lt; pts<span class="number">1.</span><span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">  Mat R, t;</span><br><span class="line">  <span class="built_in">pose_estimation_3d3d</span>(pts1, pts2, R, t);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;ICP via SVD results: &quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;R = &quot;</span> &lt;&lt; R &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t = &quot;</span> &lt;&lt; t &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;R_inv = &quot;</span> &lt;&lt; R.<span class="built_in">t</span>() &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t_inv = &quot;</span> &lt;&lt; -R.<span class="built_in">t</span>() * t &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;calling bundle adjustment&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bundleAdjustment</span>(pts1, pts2, R, t);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// verify p1 = R * p2 + t</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 = &quot;</span> &lt;&lt; pts1[i] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 = &quot;</span> &lt;&lt; pts2[i] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;(R*p2+t) = &quot;</span> &lt;&lt;</span><br><span class="line">         R * (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; pts2[i].x, pts2[i].y, pts2[i].z) + t</span><br><span class="line">         &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(<span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;DMatch&gt; &amp;matches)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//-- 初始化</span></span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  <span class="comment">// 【修改】使用统一的 ORB 对象</span></span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">1.2f</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, ORB::HARRIS_SCORE, <span class="number">31</span>, <span class="number">20</span>);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//-- 检测和计算</span></span><br><span class="line">  orb-&gt;<span class="built_in">detectAndCompute</span>(img_1, <span class="built_in">Mat</span>(), keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;<span class="built_in">detectAndCompute</span>(img_2, <span class="built_in">Mat</span>(), keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 匹配</span></span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;<span class="built_in">match</span>(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 筛选</span></span><br><span class="line">  <span class="type">double</span> min_dist = <span class="number">10000</span>, max_dist = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="type">double</span> dist = match[i].distance;</span><br><span class="line">    <span class="keyword">if</span> (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    <span class="keyword">if</span> (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Max dist : %f \n&quot;</span>, max_dist);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Min dist : %f \n&quot;</span>, min_dist);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (match[i].distance &lt;= <span class="built_in">max</span>(<span class="number">2</span> * min_dist, <span class="number">30.0</span>)) &#123;</span><br><span class="line">      matches.<span class="built_in">push_back</span>(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Point2d</span>(</span><br><span class="line">    (p.x - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    (p.y - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_3d3d</span><span class="params">(<span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Mat &amp;R, Mat &amp;t)</span> </span>&#123;</span><br><span class="line">  Point3f p1, p2;     <span class="comment">// center of mass</span></span><br><span class="line">  <span class="type">int</span> N = pts<span class="number">1.</span><span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    p1 += pts1[i];</span><br><span class="line">    p2 += pts2[i];</span><br><span class="line">  &#125;</span><br><span class="line">  p1 = <span class="built_in">Point3f</span>(<span class="built_in">Vec3f</span>(p1) / N);</span><br><span class="line">  p2 = <span class="built_in">Point3f</span>(<span class="built_in">Vec3f</span>(p2) / N);</span><br><span class="line">  <span class="function">vector&lt;Point3f&gt; <span class="title">q1</span><span class="params">(N)</span>, <span class="title">q2</span><span class="params">(N)</span></span>; <span class="comment">// remove the center</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    q1[i] = pts1[i] - p1;</span><br><span class="line">    q2[i] = pts2[i] - p2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compute q1*q2^T</span></span><br><span class="line">  Eigen::Matrix3d W = Eigen::Matrix3d::<span class="built_in">Zero</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    W += Eigen::<span class="built_in">Vector3d</span>(q1[i].x, q1[i].y, q1[i].z) * Eigen::<span class="built_in">Vector3d</span>(q2[i].x, q2[i].y, q2[i].z).<span class="built_in">transpose</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;W=&quot;</span> &lt;&lt; W &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SVD on W</span></span><br><span class="line">  <span class="function">Eigen::JacobiSVD&lt;Eigen::Matrix3d&gt; <span class="title">svd</span><span class="params">(W, Eigen::ComputeFullU | Eigen::ComputeFullV)</span></span>;</span><br><span class="line">  Eigen::Matrix3d U = svd.<span class="built_in">matrixU</span>();</span><br><span class="line">  Eigen::Matrix3d V = svd.<span class="built_in">matrixV</span>();</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;U=&quot;</span> &lt;&lt; U &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;V=&quot;</span> &lt;&lt; V &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  Eigen::Matrix3d R_ = U * (V.<span class="built_in">transpose</span>());</span><br><span class="line">  <span class="keyword">if</span> (R_.<span class="built_in">determinant</span>() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    R_ = -R_;</span><br><span class="line">  &#125;</span><br><span class="line">  Eigen::Vector3d t_ = Eigen::<span class="built_in">Vector3d</span>(p<span class="number">1.</span>x, p<span class="number">1.</span>y, p<span class="number">1.</span>z) - R_ * Eigen::<span class="built_in">Vector3d</span>(p<span class="number">2.</span>x, p<span class="number">2.</span>y, p<span class="number">2.</span>z);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// convert to cv::Mat</span></span><br><span class="line">  R = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt;</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    );</span><br><span class="line">  t = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; <span class="built_in">t_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bundleAdjustment</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 构建图优化，先设定g2o</span></span><br><span class="line">  <span class="keyword">typedef</span> g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;<span class="number">6</span>,<span class="number">3</span>&gt;&gt; BlockSolverType;</span><br><span class="line">  <span class="keyword">typedef</span> g2o::LinearSolverDense&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType; <span class="comment">// 线性求解器类型</span></span><br><span class="line">  <span class="comment">// 梯度下降方法，可以从GN, LM, DogLeg 中选</span></span><br><span class="line">  <span class="comment">// 【修改】将 g2o::make_unique 改为 std::make_unique</span></span><br><span class="line">  <span class="keyword">auto</span> solver = <span class="keyword">new</span> g2o::<span class="built_in">OptimizationAlgorithmLevenberg</span>(</span><br><span class="line">    std::<span class="built_in">make_unique</span>&lt;BlockSolverType&gt;(std::<span class="built_in">make_unique</span>&lt;LinearSolverType&gt;()));</span><br><span class="line">  g2o::SparseOptimizer optimizer;     <span class="comment">// 图模型</span></span><br><span class="line">  optimizer.<span class="built_in">setAlgorithm</span>(solver);   <span class="comment">// 设置求解器</span></span><br><span class="line">  optimizer.<span class="built_in">setVerbose</span>(<span class="literal">true</span>);       <span class="comment">// 打开调试输出</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// vertex</span></span><br><span class="line">  VertexPose *pose = <span class="keyword">new</span> <span class="built_in">VertexPose</span>(); <span class="comment">// camera pose</span></span><br><span class="line">  pose-&gt;<span class="built_in">setId</span>(<span class="number">0</span>);</span><br><span class="line">  pose-&gt;<span class="built_in">setEstimate</span>(Sophus::<span class="built_in">SE3d</span>());</span><br><span class="line">  optimizer.<span class="built_in">addVertex</span>(pose);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// edges</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pts<span class="number">1.</span><span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    EdgeProjectXYZRGBDPoseOnly *edge = <span class="keyword">new</span> <span class="built_in">EdgeProjectXYZRGBDPoseOnly</span>(</span><br><span class="line">      Eigen::<span class="built_in">Vector3d</span>(pts2[i].x, pts2[i].y, pts2[i].z));</span><br><span class="line">    edge-&gt;<span class="built_in">setVertex</span>(<span class="number">0</span>, pose);</span><br><span class="line">    edge-&gt;<span class="built_in">setMeasurement</span>(Eigen::<span class="built_in">Vector3d</span>(</span><br><span class="line">      pts1[i].x, pts1[i].y, pts1[i].z));</span><br><span class="line">    edge-&gt;<span class="built_in">setInformation</span>(Eigen::Matrix3d::<span class="built_in">Identity</span>());</span><br><span class="line">    optimizer.<span class="built_in">addEdge</span>(edge);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  optimizer.<span class="built_in">initializeOptimization</span>();</span><br><span class="line">  optimizer.<span class="built_in">optimize</span>(<span class="number">10</span>);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;optimization costs time: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;after optimization:&quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;T=\n&quot;</span> &lt;&lt; pose-&gt;<span class="built_in">estimate</span>().<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// convert to cv::Mat</span></span><br><span class="line">  Eigen::Matrix3d R_ = pose-&gt;<span class="built_in">estimate</span>().<span class="built_in">rotationMatrix</span>();</span><br><span class="line">  Eigen::Vector3d t_ = pose-&gt;<span class="built_in">estimate</span>().<span class="built_in">translation</span>();</span><br><span class="line">  R = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt;</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    );</span><br><span class="line">  t = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; <span class="built_in">t_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"># 设置最低 CMake 版本要求</span><br><span class="line">cmake_minimum_required(VERSION 3.12)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line"># 设置 C++ 标准为 17</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># 添加自定义 Find 模块的路径</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"># --- 查找依赖包 ---</span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED) # 仍然保留以检查g2o是否存在</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- 定义所有可执行文件目标 ---</span><br><span class="line"></span><br><span class="line"># 目标 1: orb_cv</span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 2: orb_self</span><br><span class="line">add_executable(orb_self orb_self.cpp)</span><br><span class="line">target_link_libraries(orb_self PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line">target_compile_options(orb_self PRIVATE -msse4.2)</span><br><span class="line"></span><br><span class="line"># 目标 3: pose_estimation_2d2d</span><br><span class="line">add_executable(pose_estimation_2d2d pose_estimation_2d2d.cpp)</span><br><span class="line">target_link_libraries(pose_estimation_2d2d PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 4: triangulation</span><br><span class="line">add_executable(triangulation triangulation.cpp)</span><br><span class="line">target_link_libraries(triangulation PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 5: pose_estimation_3d2d</span><br><span class="line">add_executable(pose_estimation_3d2d pose_estimation_3d2d.cpp)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接为目标添加 g2o 和其他库的头文件目录</span><br><span class="line">target_include_directories(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;   # 尽管它可能是空的，但以防万一</span><br><span class="line">    /usr/local/include/g2o # 手动添加 g2o 的默认安装头文件路径</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接链接 g2o 的核心模块库</span><br><span class="line">target_link_libraries(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    # 手动指定 g2o 的核心模块</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_stuff</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    # 链接其他库</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 目标 6 (已注释): pose_estimation_3d3d</span><br><span class="line">add_executable(pose_estimation_3d3d pose_estimation_3d3d.cpp)</span><br><span class="line">target_include_directories(pose_estimation_3d3d</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">    /usr/local/include/g2o</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">)</span><br><span class="line">target_link_libraries(pose_estimation_3d3d</span><br><span class="line">    PRIVATE</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_stuff</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    # 链接其他库</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./pose_estimation_3d3d ../1.png ../2.png ../1_depth.png ../2_depth.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">3d-3d pairs: 72</span><br><span class="line">W=  10.871 -1.01948  2.54771</span><br><span class="line">-2.16033  3.85307 -5.77742</span><br><span class="line"> 3.94738 -5.79979  9.62203</span><br><span class="line">U=  0.558087  -0.829399 -0.0252034</span><br><span class="line"> -0.428009  -0.313755   0.847565</span><br><span class="line">  0.710878   0.462228   0.530093</span><br><span class="line">V=  0.617887  -0.784771 -0.0484806</span><br><span class="line"> -0.399894  -0.366747   0.839989</span><br><span class="line">  0.676979   0.499631   0.540434</span><br><span class="line">ICP via SVD results: </span><br><span class="line">R = [0.9969452351705235, 0.0598334759429696, -0.05020112774999549;</span><br><span class="line"> -0.05932607556034211, 0.9981719680327525, 0.01153858709846634;</span><br><span class="line"> 0.05079975225724825, -0.008525103530306, 0.9986724727258676]</span><br><span class="line">t = [0.1441598281917405;</span><br><span class="line"> -0.06667849447794799;</span><br><span class="line"> -0.03009747343724256]</span><br><span class="line">R_inv = [0.9969452351705235, -0.05932607556034211, 0.05079975225724825;</span><br><span class="line"> 0.0598334759429696, 0.9981719680327525, -0.008525103530306;</span><br><span class="line"> -0.05020112774999549, 0.01153858709846634, 0.9986724727258676]</span><br><span class="line">t_inv = [-0.1461462830262246;</span><br><span class="line"> 0.0576744363694081;</span><br><span class="line"> 0.03806387978797152]</span><br><span class="line">calling bundle adjustment</span><br><span class="line">iteration= 0     chi2= 1.816112  <span class="keyword">time</span>= 0.00143625        cumTime= 0.00143625     edges= 72       schur= 0        lambda= 0.000758        levenbergIter= 1</span><br><span class="line">iteration= 1     chi2= 1.815514  <span class="keyword">time</span>= 0.00142032        cumTime= 0.00285657     edges= 72       schur= 0        lambda= 0.000505        levenbergIter= 1</span><br><span class="line">iteration= 2     chi2= 1.815514  <span class="keyword">time</span>= 0.00139409        cumTime= 0.00425066     edges= 72       schur= 0        lambda= 0.000337        levenbergIter= 1</span><br><span class="line">iteration= 3     chi2= 1.815514  <span class="keyword">time</span>= 0.00151481        cumTime= 0.00576547     edges= 72       schur= 0        lambda= 0.000225        levenbergIter= 1</span><br><span class="line">iteration= 4     chi2= 1.815514  <span class="keyword">time</span>= 0.001556  cumTime= 0.00732147     edges= 72       schur= 0        lambda= 0.000150        levenbergIter= 1</span><br><span class="line">iteration= 5     chi2= 1.815514  <span class="keyword">time</span>= 0.00141224        cumTime= 0.00873371     edges= 72       schur= 0        lambda= 0.000299        levenbergIter= 1</span><br><span class="line">optimization costs <span class="keyword">time</span>: 0.0101066 seconds.</span><br><span class="line"></span><br><span class="line">after optimization:</span><br><span class="line">T=</span><br><span class="line">  0.996945  0.0598335 -0.0502011    0.14416</span><br><span class="line">-0.0593261   0.998172  0.0115386 -0.0666785</span><br><span class="line"> 0.0507998 -0.0085251   0.998672 -0.0300979</span><br><span class="line">         0          0          0          1</span><br><span class="line">p1 = [-0.243698, -0.117719, 1.5848]</span><br><span class="line">p2 = [-0.297211, -0.0956614, 1.6558]</span><br><span class="line">(R*p2+t) = [-0.2409901495364605;</span><br><span class="line"> -0.1254270500587826;</span><br><span class="line"> 1.609221205029395]</span><br><span class="line"></span><br><span class="line">p1 = [0.402045, -0.341821, 2.2068]</span><br><span class="line">p2 = [0.378811, -0.262859, 2.2196]</span><br><span class="line">(R*p2+t) = [0.3946591022539743;</span><br><span class="line"> -0.3259188829495218;</span><br><span class="line"> 2.20803983035825]</span><br><span class="line"></span><br><span class="line">p1 = [-0.522843, -0.214436, 1.4956]</span><br><span class="line">p2 = [-0.58581, -0.208584, 1.6052]</span><br><span class="line">(R*p2+t) = [-0.532923946912698;</span><br><span class="line"> -0.2216052393093164;</span><br><span class="line"> 1.54499035805527]</span><br><span class="line"></span><br><span class="line">p1 = [-0.627753, 0.160186, 1.3396]</span><br><span class="line">p2 = [-0.709645, 0.159033, 1.4212]</span><br><span class="line">(R*p2+t) = [-0.6251478068660965;</span><br><span class="line"> 0.1505624195985039;</span><br><span class="line"> 1.351809862638435]</span><br><span class="line"></span><br><span class="line">p1 = [0.594266, -0.0256024, 1.5332]</span><br><span class="line">p2 = [0.514795, 0.0391393, 1.5332]</span><br><span class="line">(R*p2+t) = [0.582755696243957;</span><br><span class="line"> -0.04046060384335358;</span><br><span class="line"> 1.526884519595548]</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" rel="prev" title="第八讲-视觉里程计2">
                  <i class="fa fa-angle-left"></i> 第八讲-视觉里程计2
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM14%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AF2/" rel="next" title="第十讲-后端2">
                  第十讲-后端2 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Hita</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
