<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gen2710.netlify.app","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":100},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="视觉SLAM十四讲（第六讲）–非线性优化由于噪声存在，运动方程和观测方程的等式必定不是精确成立的，所以与其假设数据必须符合方程，不如讨论如何在有噪声的数据中进行准确的状态估计。非线性优化的核心就是构建一个总误差（代价函数），然后寻找一组状态变量（相机的位姿和路标点坐标），使得总误差最小。本节介绍基本的无约束非线性优化方法，同时介绍优化库g2o Ceres的使用。 状态估计问题批量状态估计与最大后验">
<meta property="og:type" content="article">
<meta property="og:title" content="第六讲-非线性优化">
<meta property="og:url" content="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89--%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="U.N.O">
<meta property="og:description" content="视觉SLAM十四讲（第六讲）–非线性优化由于噪声存在，运动方程和观测方程的等式必定不是精确成立的，所以与其假设数据必须符合方程，不如讨论如何在有噪声的数据中进行准确的状态估计。非线性优化的核心就是构建一个总误差（代价函数），然后寻找一组状态变量（相机的位姿和路标点坐标），使得总误差最小。本节介绍基本的无约束非线性优化方法，同时介绍优化库g2o Ceres的使用。 状态估计问题批量状态估计与最大后验">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829103331874.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829104447523.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829104505181.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829105859126.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826203637438.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826204413348.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826204434100.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826095039537.png">
<meta property="article:published_time" content="2025-09-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-06T03:28:15.160Z">
<meta property="article:author" content="Hita">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829103331874.png">


<link rel="canonical" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89--%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89--%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96/","path":"2025/09/06/视觉SLAM十四讲（第六讲）--非线性优化/","title":"第六讲-非线性优化"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>第六讲-非线性优化 | U.N.O</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">U.N.O</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89%E2%80%93%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">视觉SLAM十四讲（第六讲）–非线性优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E4%BC%B0%E8%AE%A1%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">状态估计问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E7%8A%B6%E6%80%81%E4%BC%B0%E8%AE%A1%E4%B8%8E%E6%9C%80%E5%A4%A7%E5%90%8E%E9%AA%8C%E4%BC%B0%E8%AE%A1"><span class="nav-number">1.1.1.</span> <span class="nav-text">批量状态估计与最大后验估计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E7%9A%84%E5%BC%95%E5%87%BA"><span class="nav-number">1.1.2.</span> <span class="nav-text">最小二乘的引出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%9E%E7%BA%BF%E6%80%A7%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98"><span class="nav-number">1.2.</span> <span class="nav-text">非线性最小二乘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E9%98%B6%E5%92%8C%E4%BA%8C%E9%98%B6%E6%A2%AF%E5%BA%A6%E6%B3%95"><span class="nav-number">1.2.1.</span> <span class="nav-text">一阶和二阶梯度法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E6%96%AF%E7%89%9B%E9%A1%BF%E6%B3%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">高斯牛顿法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E6%96%87%E4%BC%AF%E6%A0%BC-%E9%A9%AC%E5%A4%B8%E5%B0%94%E7%89%B9%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.3.</span> <span class="nav-text">列文伯格-马夸尔特方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%9B%B2%E7%BA%BF%E6%8B%9F%E5%90%88%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.</span> <span class="nav-text">实践：曲线拟合问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%86%99%E9%AB%98%E6%96%AF%E7%89%9B%E9%A1%BF%E6%B3%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">手写高斯牛顿法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Ceres%E8%BF%9B%E8%A1%8C%E6%9B%B2%E7%BA%BF%E6%8B%9F%E5%90%88"><span class="nav-number">1.3.2.</span> <span class="nav-text">使用Ceres进行曲线拟合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8g2o%E8%BF%9B%E8%A1%8C%E6%9B%B2%E7%BA%BF%E6%8B%9F%E5%90%88"><span class="nav-number">1.3.3.</span> <span class="nav-text">使用g2o进行曲线拟合</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hita"
      src="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
  <p class="site-author-name" itemprop="name">Hita</p>
  <div class="site-description" itemprop="description">Gains Don't Stop!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiangbaoaaa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiangbaoaaa" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:n13155609602@163.com" title="E-mail → mailto:n13155609602@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89--%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="第六讲-非线性优化 | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第六讲-非线性优化
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:28:15" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="视觉SLAM十四讲（第六讲）–非线性优化"><a href="#视觉SLAM十四讲（第六讲）–非线性优化" class="headerlink" title="视觉SLAM十四讲（第六讲）–非线性优化"></a>视觉SLAM十四讲（第六讲）–非线性优化</h1><p>由于噪声存在，运动方程和观测方程的等式必定不是精确成立的，所以与其假设数据必须符合方程，不如讨论如何在有噪声的数据中进行准确的状态估计。非线性优化的核心就是构建一个总误差（代价函数），然后寻找一组状态变量（相机的位姿和路标点坐标），使得总误差最小。本节介绍基本的无约束非线性优化方法，同时介绍优化库<code>g2o Ceres</code>的使用。</p>
<h2 id="状态估计问题"><a href="#状态估计问题" class="headerlink" title="状态估计问题"></a>状态估计问题</h2><h3 id="批量状态估计与最大后验估计"><a href="#批量状态估计与最大后验估计" class="headerlink" title="批量状态估计与最大后验估计"></a>批量状态估计与最大后验估计</h3><p>回顾经典的SLAM模型，是由一个运动方程和一个观测方程构成，如下图所示<br>$$<br>\begin{cases} \mathbf{x}<em>{k} &#x3D; f(\mathbf{x}</em>{k-1}, \mathbf{u}<em>{k}) + \mathbf{w}</em>{k} \ \mathbf{z}<em>{k,j} &#x3D; h(\mathbf{y}</em>{j}, \mathbf{x}<em>{k}) + \mathbf{v}</em>{k,j} \end{cases}<br>$$</p>
<blockquote>
<p>运动方程和观测方程和状态方程</p>
</blockquote>
<ol>
<li><p>状态方程</p>
<p>状态方程描述了系统在内部状态上的宴会规律，是一个数学表达式，通常以微分方程、差分方程的形式，说明系统当前状态如何决定下一时刻的状态。是系统动态特性的数学模型，反映了系统如何相应输入，以及其自身的内在变化。</p>
</li>
<li><p>运动方程</p>
<p>运动方程是物理学中用来描述物体或系统运动状态变化的方程，通常是状态方程的一种特殊形式，其状态变量是与位置和速度相关的物理量，它的作用是讲作用在系统上的力、力矩等外部因素与系统的加速度等运动状态的变化联系起来。</p>
</li>
<li><p>观测方程</p>
<p>观测方程描述了系统内部状态与我们能够进行外部测量之间的关系，它将不可直接访问或者难以直接测量的状态变量，与可以从传感器等设备获得的测量数据联系起来，是连接模型内部与现实世界数据的桥梁，在状态估计（如卡尔曼滤波）中，可以利用观测方程来修正对系统状态的估计。</p>
</li>
</ol>
<hr>
<p>其中这里$x_k$是相机的位姿，可以由$T_k \in SE(3)$描述，假设在$x_k$处对路标$y_i$进行一次观测，对应到图像上的像素位置$z_{k,j}$，那么观测方程可以表示为：<br>$$<br>s\mathbf{z}<em>{k,j} &#x3D; \mathbf{K}(\mathbf{R}</em>{k}\mathbf{y}<em>{j} + \mathbf{t}</em>{k})<br>$$<br>其中$K$是相机内参，$s$是像素点的距离，也是$(\mathbf{R}<em>{k}\mathbf{y}</em>{j} + \mathbf{t}_{k})$的第三个分量。使用变换矩阵$T_k$描述位姿，那么路标点$y_i$必须以齐次坐标来描述，计算完成后要转换为非齐次坐标。等式左边表示带有深度信息的像素坐标，而右边代表了从三维转换而来的二维坐标的相机成像原理。理论上应该严格满足等式，左边是图像像素位置，右边是根据三维坐标推算出的像素位置。</p>
<p>现在，假设两个噪声项$w_k,v_{k,j}$满足零均值的高斯分布，像这样：<br>$$<br>\mathbf{w}<em>{k} \sim N(\mathbf{0}, \mathbf{R}</em>{k}), \quad \mathbf{v}<em>{k} \sim N(\mathbf{0}, \mathbf{Q}</em>{k,j})<br>$$<br>其中$N$表示高斯分布，$0$表示零均值，$R_k,Q_{k,j}$是协方差矩阵。希望通过带噪声的数据$z$和$u$推断位姿$x$和地图$y$，构成一个状态估计问题。</p>
<p>处理状态估计问题的方法有两种，由于数据是随时间逐渐到来的，所以应该持有一个当前的估计状态，使用新的数据来更新，这个方式称为<strong>增量&#x2F;渐进</strong>，或者是<strong>滤波器</strong>。另一种方式，则是把数据攒起来，称为<strong>批量</strong>。</p>
<p>其实批量和增量都是为了解决同一个问题：如何利用一系列带有噪声的观测数据，来最优地估计一个系统随时间变化的状态。它们的主要区别在于如何处理和利用这些数据。</p>
<hr>
<p>先介绍<strong>批量方法</strong>：</p>
<p>考虑从1到N的所有时刻，假设有M个路标点。定义所有时刻的机器人位姿和路标点的坐标为：<br>$$<br>\mathbf{x} &#x3D; {\mathbf{x}<em>{1}, \dots, \mathbf{x}</em>{N}}, \quad \mathbf{y} &#x3D; {\mathbf{y}<em>{1}, \dots, \mathbf{y}</em>{M}}<br>$$<br>用不带下标的u表示所有时刻的输入，z表示所有时刻的观测数据。已知了输入数据u和观测数据z的条件下，求x,y的条件概率分布：<br>$$<br>P(x, y | z, u)<br>$$<br><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829103331874.png" alt="image-20250829103331874"></p>
<hr>
<h3 id="最小二乘的引出"><a href="#最小二乘的引出" class="headerlink" title="最小二乘的引出"></a>最小二乘的引出</h3><p>由于真实的观测值与模型的预测值之间存在误差（<strong>重投影误差</strong>），所以就可以讲观测的误差的平方加起来，形成总的代价函数，来寻找一组最优的$T,P$​使得代价最小。这样就构成了一个最小二乘问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829104447523.png" alt="image-20250829104447523"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829104505181.png" alt="image-20250829104505181"></p>
<p>由于该式等价于最小化噪声项（误差）的一个二次型。这个二次型称为马哈拉诺比斯距离，称为<strong>马氏距离</strong>。最后，最小化所有时刻估计值与真实度数的马氏距离，等价于求最大似然估计。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829105859126.png" alt="image-20250829105859126"></p>
<hr>
<h2 id="非线性最小二乘"><a href="#非线性最小二乘" class="headerlink" title="非线性最小二乘"></a>非线性最小二乘</h2><p>其实是为了算极值，优化联合优化函数，计算最小值，就可以求出想要的位姿了。一般有两种思路，一种是固定搜索方向，沿着方向寻找步长，称为<strong>line search</strong>,另一种是固定搜索区域，从区域中找最优点，称为<strong>Trust Reigion</strong>.</p>
<p>如何求解$x$的最优值呢，如果方程较为简单，很容易想到可以对方程进行求导，就可以求出极值，比较极值即可求出最优值。但是方程比较复杂，求导不方便，或者求导结果不容易求得的情况下，就需要采用另外一种方式——<strong>迭代</strong>，从一个初始值开始，不断更新当前的优化变量，使得目标函数下降，这样的话，就把求解导函数为0的问题，转换为了求下降增量$\Delta x_k$的问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826203637438.png" alt="image-20250826203637438"></p>
<p>同时可以对$f$进行线性化，可以更方便求解增量，当函数下降知道增量很小的时候，就认为算法收敛，目标函数达到了一个极小值。接下来只要考虑如何去寻找这个增量。常见的有几种方法</p>
<h3 id="一阶和二阶梯度法"><a href="#一阶和二阶梯度法" class="headerlink" title="一阶和二阶梯度法"></a>一阶和二阶梯度法</h3><p>最速下降法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826204413348.png" alt="image-20250826204413348"></p>
<p>将目标函数进行泰勒展开，保留一阶和二阶项，只要沿着反向梯度前进，目标函数一定会下降，但是最速下降法过于贪心，会走出锯齿路线，增加迭代次数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826204434100.png" alt="image-20250826204434100"></p>
<p>牛顿法需要计算目标函数的$H$矩阵（二阶导数，海塞矩阵），计算比较困难。</p>
<h3 id="高斯牛顿法"><a href="#高斯牛顿法" class="headerlink" title="高斯牛顿法"></a>高斯牛顿法</h3><p>由于$H$矩阵很难求解，所以就出现了高斯牛顿法，本质就是利用$JJ^T$作为牛顿法中二阶$H$矩阵的近似，从而求解增量。</p>
<h3 id="列文伯格-马夸尔特方法"><a href="#列文伯格-马夸尔特方法" class="headerlink" title="列文伯格-马夸尔特方法"></a>列文伯格-马夸尔特方法</h3><p>如果$J J^T$ 是非奇异矩阵或者病态的，稳定性就较差，可能需要考虑给$\Delta x$增加一个范围，称为信赖区域，这个范围定义了在什么情况下二阶近似是有效的。这样就渐渐引出了该方法，列文伯格-马夸尔特方法，可以在一定程度上避免方程组的系数矩阵的非奇异和病态问题。具体怎么求解可以查看教材，这里还没有研究明白。</p>
<hr>
<p><strong>总结</strong></p>
<p>通过最大似然估计计算位姿，分别由两大方法，line search 和 trust region 。</p>
<h2 id="实践：曲线拟合问题"><a href="#实践：曲线拟合问题" class="headerlink" title="实践：曲线拟合问题"></a>实践：曲线拟合问题</h2><h3 id="手写高斯牛顿法"><a href="#手写高斯牛顿法" class="headerlink" title="手写高斯牛顿法"></a>手写高斯牛顿法</h3><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826095039537.png" alt="image-20250826095039537"></p>
<p>新建文件夹及文件<code>slambook/ch6/gaussNewton.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="type">double</span> ar = <span class="number">1.0</span>, br = <span class="number">2.0</span>, cr = <span class="number">1.0</span>;         <span class="comment">// 真实参数值</span></span><br><span class="line">  <span class="type">double</span> ae = <span class="number">2.0</span>, be = <span class="number">-1.0</span>, ce = <span class="number">5.0</span>;        <span class="comment">// 估计参数值</span></span><br><span class="line">  <span class="type">int</span> N = <span class="number">100</span>;                                 <span class="comment">// 数据点</span></span><br><span class="line">  <span class="type">double</span> w_sigma = <span class="number">1.0</span>;                        <span class="comment">// 噪声Sigma值</span></span><br><span class="line">  <span class="type">double</span> inv_sigma = <span class="number">1.0</span> / w_sigma;</span><br><span class="line">  cv::RNG rng;                                 <span class="comment">// OpenCV随机数产生器</span></span><br><span class="line"></span><br><span class="line">  vector&lt;<span class="type">double</span>&gt; x_data, y_data;      <span class="comment">// 数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="type">double</span> x = i / <span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(ar * x * x + br * x + cr) + rng.<span class="built_in">gaussian</span>(w_sigma * w_sigma));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始Gauss-Newton迭代</span></span><br><span class="line">  <span class="type">int</span> iterations = <span class="number">100</span>;    <span class="comment">// 迭代次数</span></span><br><span class="line">  <span class="type">double</span> cost = <span class="number">0</span>, lastCost = <span class="number">0</span>;  <span class="comment">// 本次迭代的cost和上一次迭代的cost</span></span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; iterations; iter++) &#123;</span><br><span class="line"></span><br><span class="line">    Matrix3d H = Matrix3d::<span class="built_in">Zero</span>();             <span class="comment">// Hessian = J^T W^&#123;-1&#125; J in Gauss-Newton</span></span><br><span class="line">    Vector3d b = Vector3d::<span class="built_in">Zero</span>();             <span class="comment">// bias</span></span><br><span class="line">    cost = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">      <span class="type">double</span> xi = x_data[i], yi = y_data[i];  <span class="comment">// 第i个数据点</span></span><br><span class="line">      <span class="type">double</span> error = yi - <span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);</span><br><span class="line">      Vector3d J; <span class="comment">// 雅可比矩阵</span></span><br><span class="line">      J[<span class="number">0</span>] = -xi * xi * <span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);  <span class="comment">// de/da</span></span><br><span class="line">      J[<span class="number">1</span>] = -xi * <span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);  <span class="comment">// de/db</span></span><br><span class="line">      J[<span class="number">2</span>] = -<span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);  <span class="comment">// de/dc</span></span><br><span class="line"></span><br><span class="line">      H += inv_sigma * inv_sigma * J * J.<span class="built_in">transpose</span>();</span><br><span class="line">      b += -inv_sigma * inv_sigma * error * J;</span><br><span class="line"></span><br><span class="line">      cost += error * error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 求解线性方程 Hx=b</span></span><br><span class="line">    Vector3d dx = H.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(b);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isnan</span>(dx[<span class="number">0</span>])) &#123;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;result is nan!&quot;</span> &lt;&lt; endl;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iter &gt; <span class="number">0</span> &amp;&amp; cost &gt;= lastCost) &#123;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;cost: &quot;</span> &lt;&lt; cost &lt;&lt; <span class="string">&quot;&gt;= last cost: &quot;</span> &lt;&lt; lastCost &lt;&lt; <span class="string">&quot;, break.&quot;</span> &lt;&lt; endl;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ae += dx[<span class="number">0</span>];</span><br><span class="line">    be += dx[<span class="number">1</span>];</span><br><span class="line">    ce += dx[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    lastCost = cost;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;total cost: &quot;</span> &lt;&lt; cost &lt;&lt; <span class="string">&quot;, \t\tupdate: &quot;</span> &lt;&lt; dx.<span class="built_in">transpose</span>() &lt;&lt;</span><br><span class="line">         <span class="string">&quot;\t\testimated params: &quot;</span> &lt;&lt; ae &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; be &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; ce &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;solve time cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;estimated abc = &quot;</span> &lt;&lt; ae &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; be &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; ce &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建cmakelists.txt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cmake<span class="emphasis">_minimum_</span>required(VERSION 2.8)</span><br><span class="line">project(ch6)</span><br><span class="line"></span><br><span class="line">set(CMAKE<span class="emphasis">_BUILD_</span>TYPE Release)</span><br><span class="line">set(CMAKE<span class="emphasis">_CXX_</span>FLAGS &quot;-std=c++14 -O3&quot;)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE<span class="emphasis">_MODULE_</span>PATH $&#123;PROJECT<span class="emphasis">_SOURCE_</span>DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="section"># OpenCV</span></span><br><span class="line">find<span class="emphasis">_package(OpenCV REQUIRED)</span></span><br><span class="line"><span class="emphasis">include_</span>directories($&#123;OpenCV<span class="emphasis">_INCLUDE_</span>DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="section"># Eigen</span></span><br><span class="line">include<span class="emphasis">_directories(&quot;/usr/include/eigen3&quot;)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">add_</span>executable(gaussNewton gaussNewton.cpp)</span><br><span class="line">target<span class="emphasis">_link_</span>libraries(gaussNewton $&#123;OpenCV<span class="emphasis">_LIBS&#125;)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span></span><br></pre></td></tr></table></figure>

<p>终端输入输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ cmake ..</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch6/build</span><br><span class="line">hita@hita-vm:~/slambook/ch6/build$ make</span><br><span class="line">[100%] Built target gaussNewton</span><br><span class="line">hita@hita-vm:~/slambook/ch6/build$ ./gaussNewton </span><br><span class="line">total cost: 3.19575e+06,                update: 0.0455771  0.078164 -0.985329           estimated params: 2.04558,-0.921836,4.01467</span><br><span class="line">total cost: 376785,             update:  0.065762  0.224972 -0.962521           estimated params: 2.11134,-0.696864,3.05215</span><br><span class="line">total cost: 35673.6,            update: -0.0670241   0.617616  -0.907497                estimated params: 2.04432,-0.0792484,2.14465</span><br><span class="line">total cost: 2195.01,            update: -0.522767   1.19192 -0.756452           estimated params: 1.52155,1.11267,1.3882</span><br><span class="line">total cost: 174.853,            update: -0.537502  0.909933 -0.386395           estimated params: 0.984045,2.0226,1.00181</span><br><span class="line">total cost: 102.78,             update: -0.0919666   0.147331 -0.0573675                estimated params: 0.892079,2.16994,0.944438</span><br><span class="line">total cost: 101.937,            update: -0.00117081  0.00196749 -0.00081055             estimated params: 0.890908,2.1719,0.943628</span><br><span class="line">total cost: 101.937,            update:   3.4312e-06 -4.28555e-06  1.08348e-06          estimated params: 0.890912,2.1719,0.943629</span><br><span class="line">total cost: 101.937,            update: -2.01204e-08  2.68928e-08 -7.86602e-09          estimated params: 0.890912,2.1719,0.943629</span><br><span class="line">cost: 101.937&gt;= last cost: 101.937, <span class="built_in">break</span>.</span><br><span class="line">solve <span class="keyword">time</span> cost = 0.000200972 seconds. </span><br><span class="line">estimated abc = 0.890912, 2.1719, 0.943629</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="使用Ceres进行曲线拟合"><a href="#使用Ceres进行曲线拟合" class="headerlink" title="使用Ceres进行曲线拟合"></a>使用Ceres进行曲线拟合</h3><p>Ceres是一个最小二乘问题求解库</p>
<blockquote>
<p>安装Ceres</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://ceres-solver.googlesource.com/ceres-solver</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install libgogle-glog-dev libgflags-dev libatlas-base-dev libsuitespares-dev</span><br><span class="line"><span class="built_in">cd</span> ceres-solver</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make </span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>这样通过测试之后就安装成功了</p>
<p>新建文件<code>slambook/ch/ceresCurveFitting.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xiang on 18-11-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ceres/ceres.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代价函数的计算模型</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CURVE_FITTING_COST</span> &#123;</span><br><span class="line">  <span class="built_in">CURVE_FITTING_COST</span>(<span class="type">double</span> x, <span class="type">double</span> y) : _x(x), _y(y) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 残差的计算</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">  <span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> T *<span class="type">const</span> abc, <span class="comment">// 模型参数，有3维</span></span></span></span><br><span class="line"><span class="params"><span class="function">    T *residual)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    residual[<span class="number">0</span>] = <span class="built_in">T</span>(_y) - ceres::<span class="built_in">exp</span>(abc[<span class="number">0</span>] * <span class="built_in">T</span>(_x) * <span class="built_in">T</span>(_x) + abc[<span class="number">1</span>] * <span class="built_in">T</span>(_x) + abc[<span class="number">2</span>]); <span class="comment">// y-exp(ax^2+bx+c)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> _x, _y;    <span class="comment">// x,y数据</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="type">double</span> ar = <span class="number">1.0</span>, br = <span class="number">2.0</span>, cr = <span class="number">1.0</span>;         <span class="comment">// 真实参数值</span></span><br><span class="line">  <span class="type">double</span> ae = <span class="number">2.0</span>, be = <span class="number">-1.0</span>, ce = <span class="number">5.0</span>;        <span class="comment">// 估计参数值</span></span><br><span class="line">  <span class="type">int</span> N = <span class="number">100</span>;                                 <span class="comment">// 数据点</span></span><br><span class="line">  <span class="type">double</span> w_sigma = <span class="number">1.0</span>;                        <span class="comment">// 噪声Sigma值</span></span><br><span class="line">  <span class="type">double</span> inv_sigma = <span class="number">1.0</span> / w_sigma;</span><br><span class="line">  cv::RNG rng;                                 <span class="comment">// OpenCV随机数产生器</span></span><br><span class="line"></span><br><span class="line">  vector&lt;<span class="type">double</span>&gt; x_data, y_data;      <span class="comment">// 数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="type">double</span> x = i / <span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(ar * x * x + br * x + cr) + rng.<span class="built_in">gaussian</span>(w_sigma * w_sigma));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> abc[<span class="number">3</span>] = &#123;ae, be, ce&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建最小二乘问题</span></span><br><span class="line">  ceres::Problem problem;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    problem.<span class="built_in">AddResidualBlock</span>(     <span class="comment">// 向问题中添加误差项</span></span><br><span class="line">      <span class="comment">// 使用自动求导，模板参数：误差类型，输出维度，输入维度，维数要与前面struct中一致</span></span><br><span class="line">      <span class="keyword">new</span> ceres::<span class="built_in">AutoDiffCostFunction</span>&lt;CURVE_FITTING_COST, <span class="number">1</span>, <span class="number">3</span>&gt;(</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">CURVE_FITTING_COST</span>(x_data[i], y_data[i])</span><br><span class="line">      ),</span><br><span class="line">      <span class="literal">nullptr</span>,            <span class="comment">// 核函数，这里不使用，为空</span></span><br><span class="line">      abc                 <span class="comment">// 待估计参数</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置求解器</span></span><br><span class="line">  ceres::Solver::Options options;     <span class="comment">// 这里有很多配置项可以填</span></span><br><span class="line">  options.linear_solver_type = ceres::DENSE_NORMAL_CHOLESKY;  <span class="comment">// 增量方程如何求解</span></span><br><span class="line">  options.minimizer_progress_to_stdout = <span class="literal">true</span>;   <span class="comment">// 输出到cout</span></span><br><span class="line"></span><br><span class="line">  ceres::Solver::Summary summary;                <span class="comment">// 优化信息</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  ceres::<span class="built_in">Solve</span>(options, &amp;problem, &amp;summary);  <span class="comment">// 开始优化</span></span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;solve time cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出结果</span></span><br><span class="line">  cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;estimated a,b,c = &quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> a:abc) cout &lt;&lt; a &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">  cout &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(ch6)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE Release)</span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++14 -O3&quot;</span>)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenCV</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ceres</span></span><br><span class="line">find_package(Ceres REQUIRED)</span><br><span class="line">include_directories($&#123;CERES_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # g2o</span></span><br><span class="line"><span class="comment"># find_package(G2O REQUIRED)</span></span><br><span class="line"><span class="comment"># include_directories($&#123;G2O_INCLUDE_DIRS&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eigen</span></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line"></span><br><span class="line">add_executable(gaussNewton gaussNewton.cpp)</span><br><span class="line">target_link_libraries(gaussNewton $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(ceresCurveFitting ceresCurveFitting.cpp)</span><br><span class="line">target_link_libraries(ceresCurveFitting $&#123;OpenCV_LIBS&#125; $&#123;CERES_LIBRARIES&#125;)</span><br></pre></td></tr></table></figure>

<p>终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch6/build</span><br><span class="line">hita@hita-vm:~/slambook/ch6/build$ make -j8</span><br><span class="line">[ 50%] Built target ceresCurveFitting</span><br><span class="line">[100%] Built target gaussNewton</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ ./ceresCurveFitting </span><br><span class="line">iter      cost      cost_change  |gradient|   |step|    tr_ratio  tr_radius  ls_iter  iter_time  total_time</span><br><span class="line">   0  1.597873e+06    0.00e+00    3.52e+06   0.00e+00   0.00e+00  1.00e+04        0    1.05e-05    4.74e-05</span><br><span class="line">   1  1.884440e+05    1.41e+06    4.86e+05   0.00e+00   8.82e-01  1.81e+04        1    7.48e-05    1.66e-04</span><br><span class="line">   2  1.784821e+04    1.71e+05    6.78e+04   9.89e-01   9.06e-01  3.87e+04        1    1.10e-05    1.92e-04</span><br><span class="line">   3  1.099631e+03    1.67e+04    8.58e+03   1.10e+00   9.41e-01  1.16e+05        1    1.04e-05    2.14e-04</span><br><span class="line">   4  8.784938e+01    1.01e+03    6.53e+02   1.51e+00   9.67e-01  3.48e+05        1    1.03e-05    2.37e-04</span><br><span class="line">   5  5.141230e+01    3.64e+01    2.72e+01   1.13e+00   9.90e-01  1.05e+06        1    1.03e-05    2.59e-04</span><br><span class="line">   6  5.096862e+01    4.44e-01    4.27e-01   1.89e-01   9.98e-01  3.14e+06        1    1.02e-05    2.81e-04</span><br><span class="line">   7  5.096851e+01    1.10e-04    9.53e-04   2.84e-03   9.99e-01  9.41e+06        1    1.01e-05    3.03e-04</span><br><span class="line">solve time cost = 0.000338185 seconds. </span><br><span class="line">Ceres Solver Report: Iterations: 8, Initial cost: 1.597873e+06, Final cost: 5.096851e+01, Termination: CONVERGENCE</span><br><span class="line">estimated a,b,c = 0.890908 2.1719 0.943628 </span><br></pre></td></tr></table></figure>

<hr>
<h3 id="使用g2o进行曲线拟合"><a href="#使用g2o进行曲线拟合" class="headerlink" title="使用g2o进行曲线拟合"></a>使用g2o进行曲线拟合</h3><p>g2o(General Graphic Optimization,$G^2O$)这是一个基于图优化的库，这是一种将非线性优化与图论结合起来的理论。</p>
<blockquote>
<p>图优化理论简介</p>
</blockquote>
<p><strong>组成</strong></p>
<ul>
<li><p>节点</p>
<p>表示需要估计的未知变量，通常是机器人的位姿</p>
</li>
<li><p>边</p>
<p>边代表节点之间的关系，也就是获得的观测数据或约束</p>
</li>
</ul>
<hr>
<p><strong>原理</strong></p>
<p>图优化的目标就是找到一组位姿的估计值，使得所有边的误差和最小。</p>
<ol>
<li>定义误差函数</li>
<li>构建总代价函数</li>
<li>求解：高斯牛顿、列文伯格法。</li>
</ol>
<blockquote>
<p>g2o的编译安装</p>
</blockquote>
<p>根据：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RainerKuemmerle/g2o">RainerKuemmerle&#x2F;g2o: g2o: A General Framework for Graph Optimization</a></p>
<p>安装即可。</p>
<p>新建文件<code>slambook/ch6/g2oCurveFitting.cpp</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/g2o_core_api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_vertex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_unary_edge.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_gauss_newton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_dogleg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 曲线模型的顶点，模板参数：优化变量维度和数据类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CurveFittingVertex</span> : <span class="keyword">public</span> g2o::BaseVertex&lt;<span class="number">3</span>, Eigen::Vector3d&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">setToOriginImpl</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        _estimate &lt;&lt; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">oplusImpl</span><span class="params">(<span class="type">const</span> <span class="type">double</span> *update)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        _estimate += Eigen::<span class="built_in">Vector3d</span>(update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存盘和读盘：留空，但需要返回值</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 误差模型 模板参数：观测值维度，类型，连接顶点类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CurveFittingEdge</span> : <span class="keyword">public</span> g2o::BaseUnaryEdge&lt;<span class="number">1</span>, <span class="type">double</span>, CurveFittingVertex&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">CurveFittingEdge</span><span class="params">(<span class="type">double</span> x)</span> : BaseUnaryEdge(), _x(x) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算曲线模型误差</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">computeError</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="type">const</span> CurveFittingVertex *v = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> CurveFittingVertex *&gt; (_vertices[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">const</span> Eigen::Vector3d abc = v-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">        _error(<span class="number">0</span>, <span class="number">0</span>) = _measurement - std::<span class="built_in">exp</span>(<span class="built_in">abc</span>(<span class="number">0</span>, <span class="number">0</span>) * _x * _x + <span class="built_in">abc</span>(<span class="number">1</span>, <span class="number">0</span>) * _x + <span class="built_in">abc</span>(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算雅可比矩阵</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">linearizeOplus</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="type">const</span> CurveFittingVertex *v = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> CurveFittingVertex *&gt; (_vertices[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">const</span> Eigen::Vector3d abc = v-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">        <span class="type">double</span> y = <span class="built_in">exp</span>(abc[<span class="number">0</span>] * _x * _x + abc[<span class="number">1</span>] * _x + abc[<span class="number">2</span>]);</span><br><span class="line">        _jacobianOplusXi[<span class="number">0</span>] = -_x * _x * y;</span><br><span class="line">        _jacobianOplusXi[<span class="number">1</span>] = -_x * y;</span><br><span class="line">        _jacobianOplusXi[<span class="number">2</span>] = -y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> _x;  <span class="comment">// x 值， y 值为 _measurement</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">double</span> ar = <span class="number">1.0</span>, br = <span class="number">2.0</span>, cr = <span class="number">1.0</span>;          <span class="comment">// 真实参数值</span></span><br><span class="line">    <span class="type">double</span> ae = <span class="number">2.0</span>, be = <span class="number">-1.0</span>, ce = <span class="number">5.0</span>;         <span class="comment">// 估计参数值</span></span><br><span class="line">    <span class="type">int</span> N = <span class="number">100</span>;                                   <span class="comment">// 数据点</span></span><br><span class="line">    <span class="type">double</span> w_sigma = <span class="number">1.0</span>;                         <span class="comment">// 噪声Sigma值</span></span><br><span class="line">    <span class="type">double</span> inv_sigma = <span class="number">1.0</span> / w_sigma;</span><br><span class="line">    cv::RNG rng;                                   <span class="comment">// OpenCV随机数产生器</span></span><br><span class="line"></span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; x_data, y_data;      <span class="comment">// 数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="type">double</span> x = i / <span class="number">100.0</span>;</span><br><span class="line">        x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">        y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(ar * x * x + br * x + cr) + rng.<span class="built_in">gaussian</span>(w_sigma * w_sigma));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建图优化，先设定g2o</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;<span class="number">3</span>, <span class="number">1</span>&gt;&gt; BlockSolverType;  <span class="comment">// 每个误差项优化变量维度为3，误差值维度为1</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::LinearSolverDense&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType; <span class="comment">// 线性求解器类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 梯度下降方法，可以从GN, LM, DogLeg 中选</span></span><br><span class="line">    <span class="comment">// 已修正：使用 std::make_unique</span></span><br><span class="line">    <span class="keyword">auto</span> solver = <span class="keyword">new</span> g2o::<span class="built_in">OptimizationAlgorithmGaussNewton</span>(</span><br><span class="line">        std::<span class="built_in">make_unique</span>&lt;BlockSolverType&gt;(std::<span class="built_in">make_unique</span>&lt;LinearSolverType&gt;()));</span><br><span class="line">    g2o::SparseOptimizer optimizer;     <span class="comment">// 图模型</span></span><br><span class="line">    optimizer.<span class="built_in">setAlgorithm</span>(solver);    <span class="comment">// 设置求解器</span></span><br><span class="line">    optimizer.<span class="built_in">setVerbose</span>(<span class="literal">true</span>);        <span class="comment">// 打开调试输出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往图中增加顶点</span></span><br><span class="line">    CurveFittingVertex *v = <span class="keyword">new</span> <span class="built_in">CurveFittingVertex</span>();</span><br><span class="line">    v-&gt;<span class="built_in">setEstimate</span>(Eigen::<span class="built_in">Vector3d</span>(ae, be, ce));</span><br><span class="line">    v-&gt;<span class="built_in">setId</span>(<span class="number">0</span>);</span><br><span class="line">    optimizer.<span class="built_in">addVertex</span>(v);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往图中增加边</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        CurveFittingEdge *edge = <span class="keyword">new</span> <span class="built_in">CurveFittingEdge</span>(x_data[i]);</span><br><span class="line">        edge-&gt;<span class="built_in">setId</span>(i);</span><br><span class="line">        edge-&gt;<span class="built_in">setVertex</span>(<span class="number">0</span>, v);                 <span class="comment">// 设置连接的顶点</span></span><br><span class="line">        edge-&gt;<span class="built_in">setMeasurement</span>(y_data[i]);       <span class="comment">// 观测数值</span></span><br><span class="line">        edge-&gt;<span class="built_in">setInformation</span>(Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">1</span>, <span class="number">1</span>&gt;::<span class="built_in">Identity</span>() * <span class="number">1</span> / (w_sigma * w_sigma)); <span class="comment">// 信息矩阵：协方差矩阵之逆</span></span><br><span class="line">        optimizer.<span class="built_in">addEdge</span>(edge);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行优化</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;start optimization&quot;</span> &lt;&lt; endl;</span><br><span class="line">    chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    optimizer.<span class="built_in">initializeOptimization</span>();</span><br><span class="line">    optimizer.<span class="built_in">optimize</span>(<span class="number">10</span>);</span><br><span class="line">    chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;solve time cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出优化值</span></span><br><span class="line">    Eigen::Vector3d abc_estimate = v-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;estimated model: &quot;</span> &lt;&lt; abc_estimate.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(ch6)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE Release)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++17 -O3&quot;</span>)</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenCV</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ceres</span></span><br><span class="line">find_package(Ceres REQUIRED)</span><br><span class="line">include_directories($&#123;CERES_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # g2o</span></span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">include_directories($&#123;g2o_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Eigen</span></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line"></span><br><span class="line">add_executable(gaussNewton gaussNewton.cpp)</span><br><span class="line">target_link_libraries(gaussNewton $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(ceresCurveFitting ceresCurveFitting.cpp)</span><br><span class="line">target_link_libraries(ceresCurveFitting $&#123;OpenCV_LIBS&#125; $&#123;CERES_LIBRARIES&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(g2oCurveFitting g2oCurveFitting.cpp)</span><br><span class="line"><span class="comment"># target_link_libraries(g2oCurveFitting $&#123;OpenCV_LIBS&#125; $&#123;g2o_LIBRARIES&#125;)</span></span><br><span class="line">target_link_libraries(g2oCurveFitting</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    g2o_stuff</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ ./g2oCurveFitting </span><br><span class="line">start optimization</span><br><span class="line">iteration= 0     chi2= 376785.128234     time= 1.0607e-05        cumTime= 1.0607e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 1     chi2= 35673.566018      time= 2.992e-06         cumTime= 1.3599e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 2     chi2= 2195.012304       time= 2.785e-06         cumTime= 1.6384e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 3     chi2= 174.853126        time= 2.811e-06         cumTime= 1.9195e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 4     chi2= 102.779695        time= 3.413e-06         cumTime= 2.2608e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 5     chi2= 101.937194        time= 2.985e-06         cumTime= 2.5593e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 6     chi2= 101.937020        time= 2.965e-06         cumTime= 2.8558e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 7     chi2= 101.937020        time= 2.605e-06         cumTime= 3.1163e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 8     chi2= 101.937020        time= 2.901e-06         cumTime= 3.4064e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 9     chi2= 101.937020        time= 2.797e-06         cumTime= 3.6861e-05     edges= 100      schur= 0</span><br><span class="line">solve time cost = 0.000727411 seconds. </span><br><span class="line">estimated model: 0.890912   2.1719 0.943629</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/08/25/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%BA%94%E8%AE%B2%EF%BC%89--%E7%9B%B8%E6%9C%BA%E4%B8%8E%E5%9B%BE%E5%83%8F/" rel="prev" title="第五讲-相机与图像">
                  <i class="fa fa-angle-left"></i> 第五讲-相机与图像
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E4%B8%80%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%9B%9E%E7%8E%AF%E6%A3%80%E6%B5%8B/" rel="next" title="第十一讲-回环检测">
                  第十一讲-回环检测 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Hita</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
