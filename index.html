<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gen2710.netlify.app","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":100},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Gains Don&#39;t Stop!">
<meta property="og:type" content="website">
<meta property="og:title" content="U.N.O">
<meta property="og:url" content="http://gen2710.netlify.app/index.html">
<meta property="og:site_name" content="U.N.O">
<meta property="og:description" content="Gains Don&#39;t Stop!">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Hita">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://gen2710.netlify.app/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>U.N.O</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">U.N.O</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hita"
      src="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
  <p class="site-author-name" itemprop="name">Hita</p>
  <div class="site-description" itemprop="description">Gains Don't Stop!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jiangbaoaaa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jiangbaoaaa" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:n13155609602@163.com" title="E-mail → mailto:n13155609602@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM14%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B9%9D%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AF1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM14%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B9%9D%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AF1/" class="post-title-link" itemprop="url">第九讲-后端1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:29:44" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM14讲（第九讲）——后端1"><a href="#视觉SLAM14讲（第九讲）——后端1" class="headerlink" title="视觉SLAM14讲（第九讲）——后端1"></a>视觉SLAM14讲（第九讲）——后端1</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>前端后端的数据流向交互</strong></p>
<p>前端处理连续的图像帧，并且当前端积累一定数据，并认为某个时刻的图像帧（关键帧）具有代表性时，会将这个关键帧的位姿，在该帧下观测的地图点（路标点），以及它们之间的几何约束关系，发送给后端，这些数据带有噪声和漂移。</p>
<p>后端在进行全局优化后，会得到一个更加准确的<strong>相机轨迹和地图</strong>。这个优化结果可以反馈给前端。它的核心任务是处理前端传入的带有累计误差的数据，通过复杂数学优化方法，得到一个最优的相机轨迹和地图结构。主要包括两大核心技术：<strong>非线性优化和回环检测</strong>。</p>
<h3 id="状态估计的概率解释"><a href="#状态估计的概率解释" class="headerlink" title="状态估计的概率解释"></a>状态估计的概率解释</h3><p>$$<br>\begin{cases} \mathbf{x}<em>{k} &#x3D; f(\mathbf{x}</em>{k-1}, \mathbf{u}<em>{k}) + \mathbf{w}</em>{k} \ \mathbf{z}<em>{k,j} &#x3D; h(\mathbf{y}</em>{j}, \mathbf{x}<em>{k}) + \mathbf{v}</em>{k,j} \end{cases}<br>$$</p>
<p>上述两个方程共同描述了机器人如何在环境中运动以及如何观测环境的问题。</p>
<p>第一个方程也就是描述了：<strong>相机现在的位置是在上一秒位置的基础上，执行一个动作($u_k$)之后到达的但是执行动作可能不是很准确，所以存在一个误差（$w_{k,j}$​）</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829100005426.png" alt="image-20250829100005426"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829100601642.png" alt="image-20250829100601642"></p>
<p>我们要<strong>把位姿$x$和路标$y$看成服从某种概率分布的随机变量</strong>。要做的就是当我们拥有运动数据$u$和观测数据$z$时，如何确定状态量$x$和$y$的分布？通常假设两个噪声服从零均值高斯分布，在这些噪声的影响下，我们希望带噪声的数据$u,z$推断$x,y$，这就构成了一个状态估计问题。分为两种处理方式：批量式（Batch）和增量&#x2F;渐进式（Incremental），也称为<strong>滤波器</strong>。</p>
<p>如果我们考虑$k$时刻状态以及之前所有的状态关系，此时将得到<strong>非线性优化</strong>为主体的优化框架。这是之前第六章的知识。现在这章主要介绍第二种思路：从某时刻的状态估计，推导到下一个时刻。假设马尔可夫性，就会得到**扩展卡尔曼滤波（EKF）**为代表的滤波器方法。</p>
<hr>
<h3 id="线性系统和KF"><a href="#线性系统和KF" class="headerlink" title="线性系统和KF"></a>线性系统和KF</h3><p>核心目标：在一个充满不确定（噪声）的动态系统中，根据一系列不完美的测量数据，推断出系统内部最可能真实的状态。</p>
<p>当我们假设马尔可夫性，那么就认为当前时刻状态只和上一个时刻有关，即未来只与现在有关，与过去无关。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829155910052.png" alt="image-20250829155910052"></p>
<p>第二个公式说明未来的输入与过去的状态无关。左边部分表明在知道了直到$k$时刻的控制输入和$k-1$时刻的观测信息的条件下，$k-1$时刻的状态的概率分布，而右边部分是在知道了直到$k-1$时刻的控制输入和观测等信息 ，$k-1$​时刻状态的概率分布。</p>
<p>为什么等式成立，是因为$k$时刻的控制输入$u <em>k$是在$k-1$时刻之后才发生的事件。一个未来的动作，不可能影响一个已经过去的、在$k-1$时刻就已经确定了的状态。因此，在推断$x</em>{k-1}$的概率时，条件中是否包含$u_ k$是无关紧要的。所以可以把$u _k$​从条件中移除，等式成立。</p>
<p>第一个式子将复杂的状态转移模型简化为只依赖前一时刻状态的运动模型，第二个等式说了在推断过去状态是，可以忽略未来的控制输入。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829192311140.png" alt="image-20250829192311140"></p>
<p>首先统一一下符号含义</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829192349967.png" alt="image-20250829192349967"></p>
<p>假设已经知道了$k-1$时刻的后验状态估计以及协方差，现在需要根据$k$时刻的输入和观测数据，确定$x_k$​后验分布。先验是指基于历史经验或者背景对某件事的初始判断，而后验是指在观测之后的结论。</p>
<blockquote>
<p>卡尔曼滤波完整过程</p>
</blockquote>
<ol>
<li>预测</li>
</ol>
<p>根据对系统规律的理解，推测无人机现在应该所处的位置，完全基于内部模型，不依赖任何外部测量。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829194707571.png" alt="image-20250829194707571"></p>
<ol start="2">
<li>更新</li>
</ol>
<p>这一步我们拿出雷达，对无人机进行一次实际的测量，然后用真实测量数据修正刚才的预测。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829195134145.png" alt="image-20250829195134145"></p>
<p><strong>更新估计值和不确定性</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829195329841.png" alt="image-20250829195329841"></p>
<p><strong>循环</strong></p>
<p>接下来，输出又会作为新一轮的输入带入到下一步的预测公式中，开始新一轮的循环。</p>
<hr>
<h3 id="非线性系统和扩展卡尔曼滤波（Extended-Kalman-Filter-EKF）"><a href="#非线性系统和扩展卡尔曼滤波（Extended-Kalman-Filter-EKF）" class="headerlink" title="非线性系统和扩展卡尔曼滤波（Extended Kalman Filter, EKF）"></a>非线性系统和扩展卡尔曼滤波（Extended Kalman Filter, EKF）</h3><p>在标准的卡尔曼滤波处理的线性系统中，状态转移和观测都是线性变换的，意味着我们可以直接对服从高斯分布的随机变量进行线性运算，得到的结果依然是高斯分布。但是在现实世界中绝大多数系统都是非线性的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829202351654.png" alt="image-20250829202351654"></p>
<p><strong>EKF核心思想</strong>：<strong>局部线性化</strong></p>
<p>在当前最可信的点附近，用一个线性函数去近似这个非线性函数。这个过程叫做线性化，通过一阶泰勒展开实现</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829204447094.png" alt="image-20250829204447094"></p>
<p>EKF的完整过程与KF结构几乎一样，只是把线性运算换成了非线性函数，并且把固定的变换矩阵（$A,C$）换成动态计算的雅可比矩阵（$F,H$）</p>
<ol>
<li>预测</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829205420386.png" alt="image-20250829205420386"></p>
<ol start="2">
<li>更新</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829205548784.png" alt="image-20250829205548784"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829210224209.png" alt="image-20250829210224209"></p>
<p>EKF的本质就是<strong>计算一点，展开一片</strong>：在当前估计值这个点上，假装系统是线性的，然后用标准KF流程走一步，移动到下一个估计点后，在重新假装是线性的，依次循环。</p>
<hr>
<h3 id="EKF的讨论"><a href="#EKF的讨论" class="headerlink" title="EKF的讨论"></a>EKF的讨论</h3><p>EKF<strong>局限性</strong></p>
<ol>
<li>与非线性优化相比，滤波器会很难处理当前帧与很久之前的数据（在回环检测的时候）</li>
<li>线性化误差</li>
</ol>
<p>EKF通过一阶泰勒展开（使用雅可比矩阵）来将非线性函数近似为线性函数。这个近似只在展开点（即当前的状态估计值）的<strong>一个很小的邻域内</strong>是准确的。</p>
<ol start="3">
<li>EKF需要存储状态量的均值和方差，并对它们进行维护更新，所以并不适用于大型场景</li>
<li>EKF没有异常检测机制，导致系统存在异常值的时候容易发散。</li>
</ol>
<p>由于EKF存在明显缺点，所以在同等计算量的情况下，非线性优化能取得更好效果。</p>
<hr>
<h2 id="捆绑调整与图优化"><a href="#捆绑调整与图优化" class="headerlink" title="捆绑调整与图优化"></a>捆绑调整与图优化</h2><p>所谓 **捆绑调整（Bundle Adjustment, BA）**其实是一种联合优化方法，其目标是同时优化所有相机位姿和所有有三维地图点的坐标，以最小化重投影误差。</p>
<ul>
<li>Bundle(一捆)：指的是从每个相机位置射向空间中的一系列三维点的光线</li>
<li>Adjustment（调整）：指的是通过同时调整相机位姿和三维点坐标，使得这些光线最终能够最好地汇集到对应的三维点上。</li>
</ul>
<h3 id="投影模型和BA代价函数"><a href="#投影模型和BA代价函数" class="headerlink" title="投影模型和BA代价函数"></a>投影模型和BA代价函数</h3><h4 id="相机投影模型"><a href="#相机投影模型" class="headerlink" title="相机投影模型"></a>相机投影模型</h4><p>先回顾一下相机投影模型</p>
<ol>
<li>从世界坐标系到相机坐标系</li>
</ol>
<p><img src="C:/Users/Hita/AppData/Roaming/Typora/typora-user-images/image-20250830101304467.png" alt="image-20250830101304467"></p>
<ol start="2">
<li>从相机坐标系到归一化成像平台</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830101346447.png"></p>
<ol start="3">
<li>畸变矫正</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830101412206.png" alt="image-20250830101412206"></p>
<ol start="4">
<li>从归一化成像平面到像素坐标系</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830101512835.png" alt="image-20250830101512835"></p>
<h4 id="BA代价函数"><a href="#BA代价函数" class="headerlink" title="BA代价函数"></a>BA代价函数</h4><p>捆绑调整的代价函数是建立在上述投影模型之上的，目标是找到最优的相机位姿和三维点坐标，使得所有观测的<strong>重投影误差之和</strong>最小。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830102256634.png" alt="image-20250830102256634"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830102356151.png" alt="image-20250830102356151"></p>
<h3 id="BA的求解"><a href="#BA的求解" class="headerlink" title="BA的求解"></a>BA的求解</h3><p>求解问题实际上是一个非线性最小二乘问题，需要依赖迭代优化的方法，主流思路是采用高斯牛顿法或者列文伯格-马夸尔特方法。</p>
<h4 id="构建增量方程"><a href="#构建增量方程" class="headerlink" title="构建增量方程"></a>构建增量方程</h4><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830104223116.png" alt="image-20250830104223116"></p>
<h3 id="稀疏性和边缘化"><a href="#稀疏性和边缘化" class="headerlink" title="稀疏性和边缘化"></a>稀疏性和边缘化</h3><p>BA问题中的雅可比矩阵与海森矩阵具有稀疏结构。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830104812542.png" alt="image-20250830104812542"></p>
<p><strong>利用舒尔补进行降维求解</strong></p>
<p>舒尔补提供了一种巧妙地方法：<strong>边缘化</strong>数量庞大的路标点变量，从而减少求解的规模。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830105351541.png" alt="image-20250830105351541"></p>
<p>完整步骤：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830105422965.png" alt="image-20250830105422965"></p>
<h3 id="鲁棒核函数"><a href="#鲁棒核函数" class="headerlink" title="鲁棒核函数"></a>鲁棒核函数</h3><p>在最小二乘问题中，我们的目标是最小化所有误差的平方和，这种方法有一个巨大缺陷：<strong>对于离群点极其敏感</strong></p>
<p><strong>鲁棒核函数作用</strong></p>
<p>目标：</p>
<ul>
<li>对于误差较小的数据点：其作用基本等同于平方和，保留最小二乘优良性</li>
<li>对于误差较大的数据点：<strong>减小</strong>其在总代价函数中的权重，使其代价增长比平方慢，从而抑制对于整体优化结果的破坏性影响。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250830110627175.png" alt="image-20250830110627175"></p>
<p>这样做的好处是：</p>
<p>视觉SLAM中存在一定比例的误匹配，会产生巨大的重投影误差，<strong>使用鲁棒核函数可以降低离群点在计算BA代价函数的时候的影响权重</strong>。</p>
<hr>
<h2 id="实践：Ceres-BA"><a href="#实践：Ceres-BA" class="headerlink" title="实践：Ceres BA"></a>实践：Ceres BA</h2><h3 id="BAL数据集"><a href="#BAL数据集" class="headerlink" title="BAL数据集"></a>BAL数据集</h3><p>使用BAL数据集进行BA演示实验。</p>
<h3 id="Ceres-BA-的书写"><a href="#Ceres-BA-的书写" class="headerlink" title="Ceres BA 的书写"></a>Ceres BA 的书写</h3><p>新建文件夹及文件<code>slambook/ch9/bundle_adjustment_ceres.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ceres/ceres.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SnavelyReprojectionError.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SolveBA</span><span class="params">(BALProblem &amp;bal_problem)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;usage: bundle_adjustment_ceres bal_data.txt&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">BALProblem <span class="title">bal_problem</span><span class="params">(argv[<span class="number">1</span>])</span></span>;</span><br><span class="line">    bal_problem.<span class="built_in">Normalize</span>();</span><br><span class="line">    bal_problem.<span class="built_in">Perturb</span>(<span class="number">0.1</span>, <span class="number">0.5</span>, <span class="number">0.5</span>);</span><br><span class="line">    bal_problem.<span class="built_in">WriteToPLYFile</span>(<span class="string">&quot;initial.ply&quot;</span>);</span><br><span class="line">    <span class="built_in">SolveBA</span>(bal_problem);</span><br><span class="line">    bal_problem.<span class="built_in">WriteToPLYFile</span>(<span class="string">&quot;final.ply&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SolveBA</span><span class="params">(BALProblem &amp;bal_problem)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> point_block_size = bal_problem.<span class="built_in">point_block_size</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> camera_block_size = bal_problem.<span class="built_in">camera_block_size</span>();</span><br><span class="line">    <span class="type">double</span> *points = bal_problem.<span class="built_in">mutable_points</span>();</span><br><span class="line">    <span class="type">double</span> *cameras = bal_problem.<span class="built_in">mutable_cameras</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Observations is 2 * num_observations long array observations</span></span><br><span class="line">    <span class="comment">// [u_1, u_2, ... u_n], where each u_i is two dimensional, the x</span></span><br><span class="line">    <span class="comment">// and y position of the observation.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">double</span> *observations = bal_problem.<span class="built_in">observations</span>();</span><br><span class="line">    ceres::Problem problem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; bal_problem.<span class="built_in">num_observations</span>(); ++i) &#123;</span><br><span class="line">        ceres::CostFunction *cost_function;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Each Residual block takes a point and a camera as input</span></span><br><span class="line">        <span class="comment">// and outputs a 2 dimensional Residual</span></span><br><span class="line">        cost_function = SnavelyReprojectionError::<span class="built_in">Create</span>(observations[<span class="number">2</span> * i + <span class="number">0</span>], observations[<span class="number">2</span> * i + <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If enabled use Huber&#x27;s loss function.</span></span><br><span class="line">        ceres::LossFunction *loss_function = <span class="keyword">new</span> ceres::<span class="built_in">HuberLoss</span>(<span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Each observation corresponds to a pair of a camera and a point</span></span><br><span class="line">        <span class="comment">// which are identified by camera_index()[i] and point_index()[i]</span></span><br><span class="line">        <span class="comment">// respectively.</span></span><br><span class="line">        <span class="type">double</span> *camera = cameras + camera_block_size * bal_problem.<span class="built_in">camera_index</span>()[i];</span><br><span class="line">        <span class="type">double</span> *point = points + point_block_size * bal_problem.<span class="built_in">point_index</span>()[i];</span><br><span class="line"></span><br><span class="line">        problem.<span class="built_in">AddResidualBlock</span>(cost_function, loss_function, camera, point);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// show some information here ...</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;bal problem file loaded...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;bal problem have &quot;</span> &lt;&lt; bal_problem.<span class="built_in">num_cameras</span>() &lt;&lt; <span class="string">&quot; cameras and &quot;</span></span><br><span class="line">              &lt;&lt; bal_problem.<span class="built_in">num_points</span>() &lt;&lt; <span class="string">&quot; points. &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Forming &quot;</span> &lt;&lt; bal_problem.<span class="built_in">num_observations</span>() &lt;&lt; <span class="string">&quot; observations. &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Solving ceres BA ... &quot;</span> &lt;&lt; endl;</span><br><span class="line">    ceres::Solver::Options options;</span><br><span class="line">    options.linear_solver_type = ceres::LinearSolverType::SPARSE_SCHUR;</span><br><span class="line">    options.minimizer_progress_to_stdout = <span class="literal">true</span>;</span><br><span class="line">    ceres::Solver::Summary summary;</span><br><span class="line">    ceres::<span class="built_in">Solve</span>(options, &amp;problem, &amp;summary);</span><br><span class="line">    std::cout &lt;&lt; summary.<span class="built_in">FullReport</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时新建文件CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.1)</span><br><span class="line">project(bundle_adjustment)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 使用现代 CMake 方式设置 C++17 标准</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line">set(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有必需的包</span></span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line">find_package(Ceres REQUIRED)</span><br><span class="line"><span class="comment"># 2. 使用小写的 &#x27;g2o&#x27;</span></span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置包含目录</span></span><br><span class="line"><span class="comment"># find_package 会自动处理大部分包含目录，但我们也可以手动添加</span></span><br><span class="line">include_directories(</span><br><span class="line">    $&#123;PROJECT_SOURCE_DIR&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;CERES_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">    <span class="comment"># Sophus 通常也是 find_package 自动处理</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建通用库</span></span><br><span class="line">add_library(bal_common common.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 Ceres 可执行文件</span></span><br><span class="line">add_executable(bundle_adjustment_ceres bundle_adjustment_ceres.cpp)</span><br><span class="line">target_link_libraries(bundle_adjustment_ceres</span><br><span class="line">    PRIVATE</span><br><span class="line">    Ceres::ceres  <span class="comment"># 使用 Ceres 提供的现代化 CMake target</span></span><br><span class="line">    bal_common</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 构建 G2O 可执行文件</span></span><br><span class="line"><span class="comment"># add_executable(bundle_adjustment_g2o bundle_adjustment_g2o.cpp)</span></span><br><span class="line"><span class="comment"># # 3. 使用 find_package 提供的 $&#123;g2o_LIBRARIES&#125; 变量，而不是手动列表</span></span><br><span class="line"><span class="comment"># target_link_libraries(bundle_adjustment_g2o</span></span><br><span class="line"><span class="comment">#     PRIVATE</span></span><br><span class="line"><span class="comment">#     $&#123;g2o_LIBRARIES&#125;</span></span><br><span class="line"><span class="comment">#     bal_common</span></span><br><span class="line"><span class="comment"># )</span></span><br></pre></td></tr></table></figure>

<p>同时把源文件的其他文件复制到该文件夹下</p>
<p>终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch9/build$ ./bundle_adjustment_ceres ../problem-16-22106-pre.txt </span><br><span class="line">Header: 16 22106 83718bal problem file loaded...</span><br><span class="line">bal problem have 16 cameras and 22106 points. </span><br><span class="line">Forming 83718 observations. </span><br><span class="line">Solving ceres BA ... </span><br><span class="line">iter      cost      cost_change  |gradient|   |step|    tr_ratio  tr_radius  ls_iter  iter_time  total_time</span><br><span class="line">   0  1.842900e+07    0.00e+00    2.04e+06   0.00e+00   0.00e+00  1.00e+04        0    3.43e-02    1.09e-01</span><br><span class="line">   1  1.449093e+06    1.70e+07    1.75e+06   0.00e+00   1.84e+00  3.00e+04        1    8.84e-02    1.97e-01</span><br></pre></td></tr></table></figure>

<p>最后会在build文件夹下输出两个点云文件：initial.ply和final.ply.</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901154902241.png" alt="image-20250901154902241"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901154950597.png" alt="image-20250901154950597"></p>
<hr>
<h2 id="实践：g2o求解BA"><a href="#实践：g2o求解BA" class="headerlink" title="实践：g2o求解BA"></a>实践：g2o求解BA</h2><p>新建文件：<code>slambook/ch9/bundle_adjustment_g2o.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;g2o/core/base_vertex.h&gt;</span><br><span class="line">#include &lt;g2o/core/base_binary_edge.h&gt;</span><br><span class="line">#include &lt;g2o/core/block_solver.h&gt;</span><br><span class="line">#include &lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span><br><span class="line">#include &lt;g2o/solvers/csparse/linear_solver_csparse.h&gt;</span><br><span class="line">#include &lt;g2o/core/robust_kernel_impl.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;memory&gt; // 已添加：为了使用 std::make_unique</span><br><span class="line"></span><br><span class="line">#include &quot;common.h&quot;</span><br><span class="line">#include &quot;sophus/se3.hpp&quot;</span><br><span class="line"></span><br><span class="line">using namespace Sophus;</span><br><span class="line">using namespace Eigen;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">/// 姿态和内参的结构</span><br><span class="line">struct PoseAndIntrinsics &#123;</span><br><span class="line">    PoseAndIntrinsics() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    /// set from given data address</span><br><span class="line">    explicit PoseAndIntrinsics(double *data_addr) &#123;</span><br><span class="line">        rotation = SO3d::exp(Vector3d(data_addr[0], data_addr[1], data_addr[2]));</span><br><span class="line">        translation = Vector3d(data_addr[3], data_addr[4], data_addr[5]);</span><br><span class="line">        focal = data_addr[6];</span><br><span class="line">        k1 = data_addr[7];</span><br><span class="line">        k2 = data_addr[8];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// 将估计值放入内存</span><br><span class="line">    void set_to(double *data_addr) &#123;</span><br><span class="line">        auto r = rotation.log();</span><br><span class="line">        for (int i = 0; i &lt; 3; ++i) data_addr[i] = r[i];</span><br><span class="line">        for (int i = 0; i &lt; 3; ++i) data_addr[i + 3] = translation[i];</span><br><span class="line">        data_addr[6] = focal;</span><br><span class="line">        data_addr[7] = k1;</span><br><span class="line">        data_addr[8] = k2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SO3d rotation;</span><br><span class="line">    Vector3d translation = Vector3d::Zero();</span><br><span class="line">    double focal = 0;</span><br><span class="line">    double k1 = 0, k2 = 0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// 位姿加相机内参的顶点，9维，前三维为so3，接下去为t, f, k1, k2</span><br><span class="line">class VertexPoseAndIntrinsics : public g2o::BaseVertex&lt;9, PoseAndIntrinsics&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">    VertexPoseAndIntrinsics() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    virtual void setToOriginImpl() override &#123;</span><br><span class="line">        _estimate = PoseAndIntrinsics();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void oplusImpl(const double *update) override &#123;</span><br><span class="line">        _estimate.rotation = SO3d::exp(Vector3d(update[0], update[1], update[2])) * _estimate.rotation;</span><br><span class="line">        _estimate.translation += Vector3d(update[3], update[4], update[5]);</span><br><span class="line">        _estimate.focal += update[6];</span><br><span class="line">        _estimate.k1 += update[7];</span><br><span class="line">        _estimate.k2 += update[8];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// 根据估计值投影一个点</span><br><span class="line">    Vector2d project(const Vector3d &amp;point) const &#123; // 已修正：添加 const</span><br><span class="line">        Vector3d pc = _estimate.rotation * point + _estimate.translation;</span><br><span class="line">        pc = -pc / pc[2];</span><br><span class="line">        double r2 = pc.squaredNorm();</span><br><span class="line">        double distortion = 1.0 + r2 * (_estimate.k1 + _estimate.k2 * r2);</span><br><span class="line">        return Vector2d(_estimate.focal * distortion * pc[0],</span><br><span class="line">                        _estimate.focal * distortion * pc[1]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 已修正：添加返回值</span><br><span class="line">    virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line"></span><br><span class="line">    virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class VertexPoint : public g2o::BaseVertex&lt;3, Vector3d&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">    VertexPoint() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    virtual void setToOriginImpl() override &#123;</span><br><span class="line">        _estimate = Vector3d(0, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void oplusImpl(const double *update) override &#123;</span><br><span class="line">        _estimate += Vector3d(update[0], update[1], update[2]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 已修正：添加返回值</span><br><span class="line">    virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line"></span><br><span class="line">    virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class EdgeProjection :</span><br><span class="line">    public g2o::BaseBinaryEdge&lt;2, Vector2d, VertexPoseAndIntrinsics, VertexPoint&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">    virtual void computeError() override &#123;</span><br><span class="line">        // 已修正：使用 static_cast</span><br><span class="line">        auto v0 = static_cast&lt;const VertexPoseAndIntrinsics *&gt;(_vertices[0]);</span><br><span class="line">        auto v1 = static_cast&lt;const VertexPoint *&gt;(_vertices[1]);</span><br><span class="line">        auto proj = v0-&gt;project(v1-&gt;estimate());</span><br><span class="line">        _error = proj - _measurement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // use numeric derivatives</span><br><span class="line">    // 已修正：添加返回值</span><br><span class="line">    virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line"></span><br><span class="line">    virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void SolveBA(BALProblem &amp;bal_problem);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line"></span><br><span class="line">    if (argc != 2) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;usage: bundle_adjustment_g2o bal_data.txt&quot; &lt;&lt; endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BALProblem bal_problem(argv[1]);</span><br><span class="line">    bal_problem.Normalize();</span><br><span class="line">    bal_problem.Perturb(0.1, 0.5, 0.5);</span><br><span class="line">    bal_problem.WriteToPLYFile(&quot;initial.ply&quot;);</span><br><span class="line">    SolveBA(bal_problem);</span><br><span class="line">    bal_problem.WriteToPLYFile(&quot;final.ply&quot;);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void SolveBA(BALProblem &amp;bal_problem) &#123;</span><br><span class="line">    const int point_block_size = bal_problem.point_block_size();</span><br><span class="line">    const int camera_block_size = bal_problem.camera_block_size();</span><br><span class="line">    double *points = bal_problem.mutable_points();</span><br><span class="line">    double *cameras = bal_problem.mutable_cameras();</span><br><span class="line"></span><br><span class="line">    // pose dimension 9, landmark is 3</span><br><span class="line">    typedef g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;9, 3&gt;&gt; BlockSolverType;</span><br><span class="line">    typedef g2o::LinearSolverCSparse&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType;</span><br><span class="line">    // use LM</span><br><span class="line">    // 已修正：使用 std::make_unique</span><br><span class="line">    auto solver = new g2o::OptimizationAlgorithmLevenberg(</span><br><span class="line">        std::make_unique&lt;BlockSolverType&gt;(std::make_unique&lt;LinearSolverType&gt;()));</span><br><span class="line">    g2o::SparseOptimizer optimizer;</span><br><span class="line">    optimizer.setAlgorithm(solver);</span><br><span class="line">    optimizer.setVerbose(true);</span><br><span class="line"></span><br><span class="line">    /// build g2o problem</span><br><span class="line">    const double *observations = bal_problem.observations();</span><br><span class="line">    // vertex</span><br><span class="line">    vector&lt;VertexPoseAndIntrinsics *&gt; vertex_pose_intrinsics;</span><br><span class="line">    vector&lt;VertexPoint *&gt; vertex_points;</span><br><span class="line">    for (int i = 0; i &lt; bal_problem.num_cameras(); ++i) &#123;</span><br><span class="line">        VertexPoseAndIntrinsics *v = new VertexPoseAndIntrinsics();</span><br><span class="line">        double *camera = cameras + camera_block_size * i;</span><br><span class="line">        v-&gt;setId(i);</span><br><span class="line">        v-&gt;setEstimate(PoseAndIntrinsics(camera));</span><br><span class="line">        optimizer.addVertex(v);</span><br><span class="line">        vertex_pose_intrinsics.push_back(v);</span><br><span class="line">    &#125;</span><br><span class="line">    for (int i = 0; i &lt; bal_problem.num_points(); ++i) &#123;</span><br><span class="line">        VertexPoint *v = new VertexPoint();</span><br><span class="line">        double *point = points + point_block_size * i;</span><br><span class="line">        v-&gt;setId(i + bal_problem.num_cameras());</span><br><span class="line">        v-&gt;setEstimate(Vector3d(point[0], point[1], point[2]));</span><br><span class="line">        // g2o在BA中需要手动设置待Marg的顶点</span><br><span class="line">        v-&gt;setMarginalized(true);</span><br><span class="line">        optimizer.addVertex(v);</span><br><span class="line">        vertex_points.push_back(v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // edge</span><br><span class="line">    for (int i = 0; i &lt; bal_problem.num_observations(); ++i) &#123;</span><br><span class="line">        EdgeProjection *edge = new EdgeProjection;</span><br><span class="line">        edge-&gt;setVertex(0, vertex_pose_intrinsics[bal_problem.camera_index()[i]]);</span><br><span class="line">        edge-&gt;setVertex(1, vertex_points[bal_problem.point_index()[i]]);</span><br><span class="line">        edge-&gt;setMeasurement(Vector2d(observations[2 * i + 0], observations[2 * i + 1]));</span><br><span class="line">        edge-&gt;setInformation(Matrix2d::Identity());</span><br><span class="line">        edge-&gt;setRobustKernel(new g2o::RobustKernelHuber());</span><br><span class="line">        optimizer.addEdge(edge);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    optimizer.initializeOptimization();</span><br><span class="line">    optimizer.optimize(40);</span><br><span class="line"></span><br><span class="line">    // set to bal problem</span><br><span class="line">    for (int i = 0; i &lt; bal_problem.num_cameras(); ++i) &#123;</span><br><span class="line">        double *camera = cameras + camera_block_size * i;</span><br><span class="line">        auto vertex = vertex_pose_intrinsics[i];</span><br><span class="line">        auto estimate = vertex-&gt;estimate();</span><br><span class="line">        estimate.set_to(camera);</span><br><span class="line">    &#125;</span><br><span class="line">    for (int i = 0; i &lt; bal_problem.num_points(); ++i) &#123;</span><br><span class="line">        double *point = points + point_block_size * i;</span><br><span class="line">        auto vertex = vertex_points[i];</span><br><span class="line">        for (int k = 0; k &lt; 3; ++k) point[k] = vertex-&gt;estimate()[k];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.1)</span><br><span class="line">project(bundle_adjustment)</span><br><span class="line"></span><br><span class="line">link_directories(/usr/lib/x86_64-linux-gnu)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line">set(CMAKE_BUILD_TYPE &quot;Release&quot;)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"># 查找所有必需的包</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line">find_package(Ceres REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line"># 设置包含目录</span><br><span class="line"># SuiteSparse 的头文件 (包含 csparse.h) 位于 /usr/include/suitesparse</span><br><span class="line">include_directories(</span><br><span class="line">    $&#123;PROJECT_SOURCE_DIR&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;CERES_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">    /usr/include/suitesparse</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 构建通用库</span><br><span class="line">add_library(bal_common common.cpp)</span><br><span class="line"></span><br><span class="line"># 构建 Ceres 可执行文件</span><br><span class="line">add_executable(bundle_adjustment_ceres bundle_adjustment_ceres.cpp)</span><br><span class="line">target_link_libraries(bundle_adjustment_ceres</span><br><span class="line">    PRIVATE</span><br><span class="line">    Ceres::ceres</span><br><span class="line">    bal_common</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 构建 G2O 可执行文件</span><br><span class="line">add_executable(bundle_adjustment_g2o bundle_adjustment_g2o.cpp)</span><br><span class="line"># 直接链接 g2o 和 csparse 库</span><br><span class="line">target_link_libraries(bundle_adjustment_g2o</span><br><span class="line">    PRIVATE</span><br><span class="line">    g2o::core</span><br><span class="line">    g2o::stuff</span><br><span class="line">    g2o::solver_csparse # 这是与 csparse 求解器直接相关的目标</span><br><span class="line">    g2o::csparse_extension</span><br><span class="line">    bal_common</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>同样也会输出两个优化前后点云数据，这里不过多介绍。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM14%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AF2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM14%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AF2/" class="post-title-link" itemprop="url">第十讲-后端2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:30:15" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM14讲（第十讲）——后端2"><a href="#视觉SLAM14讲（第十讲）——后端2" class="headerlink" title="视觉SLAM14讲（第十讲）——后端2"></a>视觉SLAM14讲（第十讲）——后端2</h1><h2 id="滑动窗口滤波和优化"><a href="#滑动窗口滤波和优化" class="headerlink" title="滑动窗口滤波和优化"></a>滑动窗口滤波和优化</h2><h3 id="实际环境下的BA结构"><a href="#实际环境下的BA结构" class="headerlink" title="实际环境下的BA结构"></a>实际环境下的BA结构</h3><p>如果规模太大的建图任务，使用BA会花费大量算力。所以必须控制计算规模，控制计算规模的做法有很多，比如从连续的视频中抽出一部分作为关键帧，但是即便如此，关键帧数量也会越来越多，计算效率会不断下降。所以最简单控制BA规模的思路，是保留当前时刻最近的N个关键帧，去掉时间上更早的关键帧。于是BA将被固定在一个时间窗口内，离开窗口的则会被丢弃，这个方法称为<strong>滑动窗口法</strong>。</p>
<p>当然也有所谓的“共视图”的结构。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901185535684.png" alt="image-20250901185535684"></p>
<p>在滑动窗口中，当窗口结构发生改变，这些状态变量应该如何改变：</p>
<ol>
<li>需要在窗口新增一个关键帧，以及它观测的路标点</li>
<li>需要把窗口中的一个旧的关键帧删除，也可能删除它观测的路标点</li>
</ol>
<p><strong>新增一个关键帧</strong></p>
<p>在滑动窗口建立了N个关键帧之后，此时，新来一个关键帧，那么就需要把整个N+1个关键帧和更多路标点的集合作为变量，按照正常的BA流程处理即可，对所有的点进行边缘化，得到这个N+1个关键帧的高斯分布参数。</p>
<p><strong>删除一个旧的关键帧</strong></p>
<p>当考虑删除旧的关键帧的时候，一个问题是要删除的那个关键帧并非孤立的，会和其他帧观测到同样的路标，所以把旧的关键帧转化为一个先验约束，施加在窗口内与其相关的变量上。</p>
<hr>
<h2 id="位姿图"><a href="#位姿图" class="headerlink" title="位姿图"></a>位姿图</h2><h3 id="位姿图的意义"><a href="#位姿图的意义" class="headerlink" title="位姿图的意义"></a>位姿图的意义</h3><p>我们可以构建一个只有轨迹的图优化，位姿节点之间的边，可以由两个关键帧之间通过特殊匹配之后得到的运动估计来给定初始值。一旦初始估计完成，我们就不再优化那些路标点的位置，只关心所有的相机位姿之间的联系。省去大量的特征点优化的计算，只保留关键帧的轨迹，从而构建所谓的位姿图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901192345951.png" alt="image-20250901192345951"></p>
<p>上图中三角形为位姿，圆形为路标点。可以把这个问题简化成为一个只关心相机轨迹本身一致性的问题。</p>
<h3 id="位姿图的优化"><a href="#位姿图的优化" class="headerlink" title="位姿图的优化"></a>位姿图的优化</h3><p>位姿图优化中的节点表示相机位姿，边是两个位姿节点之间相对运动的估计。该估计可以来自于特征点或者直接法，也可以来自GPS或IMU积分。所有的位姿顶点和位姿——位姿边构成了一个图优化，本质上是一个最小二乘问题。也可以使用非线性优化的相关方法。</p>
<h3 id="实践：位姿图优化"><a href="#实践：位姿图优化" class="headerlink" title="实践：位姿图优化"></a>实践：位姿图优化</h3><h3 id="g2o原生位姿图"><a href="#g2o原生位姿图" class="headerlink" title="g2o原生位姿图"></a>g2o原生位姿图</h3><p>首先运行g2o_viewer</p>
<p>打开之前安装g2o的文件夹，我的位置在：<code>slambook/3rdparty/g2o/build/bin </code></p>
<p>打开终端输入：<code>./g2o_viewer</code></p>
<p>打开源文件中的：<code>sphere.g2o</code>文件，显示如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901200211301.png" alt="image-20250901200211301"></p>
<p>点击优化之后，会生成一个球体。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901200359505.png" alt="image-20250901200359505"></p>
<p>新建文件夹及文件：<code>slambook/ch10/pose_graph_g2o_SE3.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span> <span class="comment">// 为了 std::unique_ptr</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/types/slam3d/types_slam3d.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/solvers/eigen/linear_solver_eigen.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************</span></span><br><span class="line"><span class="comment"> * 本程序演示如何用g2o solver进行位姿图优化</span></span><br><span class="line"><span class="comment"> * sphere.g2o是人工生成的一个Pose graph，我们来优化它。</span></span><br><span class="line"><span class="comment"> * 尽管可以直接通过load函数读取整个图，但我们还是自己来实现读取代码，以期获得更深刻的理解</span></span><br><span class="line"><span class="comment"> * 这里使用g2o/types/slam3d/中的SE3表示位姿，它实质上是四元数而非李代数.</span></span><br><span class="line"><span class="comment"> * **********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Usage: pose_graph_g2o_SE3 sphere.g2o&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ifstream <span class="title">fin</span><span class="params">(argv[<span class="number">1</span>])</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!fin) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;file &quot;</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; does not exist.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 设定g2o ---</span></span><br><span class="line">    <span class="comment">// 1. 定义求解器类型</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;<span class="number">6</span>, <span class="number">6</span>&gt;&gt; BlockSolverType;</span><br><span class="line">    <span class="keyword">typedef</span> g2o::LinearSolverEigen&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 创建求解器</span></span><br><span class="line">    <span class="comment">// 【修改点1】: 使用智能指针管理求解器，防止内存泄漏</span></span><br><span class="line"><span class="comment">// 正确的代码</span></span><br><span class="line">    <span class="keyword">auto</span> linearSolver = std::<span class="built_in">make_unique</span>&lt;LinearSolverType&gt;();</span><br><span class="line">    <span class="keyword">auto</span> blockSolver = std::<span class="built_in">make_unique</span>&lt;BlockSolverType&gt;(std::<span class="built_in">move</span>(linearSolver));</span><br><span class="line">    <span class="keyword">auto</span> solver = <span class="keyword">new</span> g2o::<span class="built_in">OptimizationAlgorithmLevenberg</span>(std::<span class="built_in">move</span>(blockSolver));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 创建图模型和设置求解器</span></span><br><span class="line">    g2o::SparseOptimizer optimizer;</span><br><span class="line">    optimizer.<span class="built_in">setAlgorithm</span>(solver);</span><br><span class="line">    optimizer.<span class="built_in">setVerbose</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> vertexCnt = <span class="number">0</span>, edgeCnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 读取文件中的顶点和边 ---</span></span><br><span class="line">    <span class="comment">// 【修改点2】: 使用更健壮的文件读取循环</span></span><br><span class="line">    string name;</span><br><span class="line">    <span class="keyword">while</span> (fin &gt;&gt; name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="string">&quot;VERTEX_SE3:QUAT&quot;</span>) &#123;</span><br><span class="line">            g2o::VertexSE3 *v = <span class="keyword">new</span> g2o::<span class="built_in">VertexSE3</span>();</span><br><span class="line">            <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">            fin &gt;&gt; index;</span><br><span class="line">            v-&gt;<span class="built_in">setId</span>(index);</span><br><span class="line">            v-&gt;<span class="built_in">read</span>(fin);</span><br><span class="line">            optimizer.<span class="built_in">addVertex</span>(v);</span><br><span class="line">            vertexCnt++;</span><br><span class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>)</span><br><span class="line">                v-&gt;<span class="built_in">setFixed</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="string">&quot;EDGE_SE3:QUAT&quot;</span>) &#123;</span><br><span class="line">            g2o::EdgeSE3 *e = <span class="keyword">new</span> g2o::<span class="built_in">EdgeSE3</span>();</span><br><span class="line">            <span class="type">int</span> idx1, idx2;</span><br><span class="line">            fin &gt;&gt; idx1 &gt;&gt; idx2;</span><br><span class="line">            e-&gt;<span class="built_in">setId</span>(edgeCnt++);</span><br><span class="line">            <span class="comment">// 【可选优化】: 使用更安全的 vertex() 方法查找顶点</span></span><br><span class="line">            g2o::OptimizableGraph::Vertex* v1 = optimizer.<span class="built_in">vertex</span>(idx1);</span><br><span class="line">            g2o::OptimizableGraph::Vertex* v2 = optimizer.<span class="built_in">vertex</span>(idx2);</span><br><span class="line">            <span class="keyword">if</span> (!v1 || !v2) &#123;</span><br><span class="line">                 cerr &lt;&lt; <span class="string">&quot;Warning: Unable to find vertices &quot;</span> &lt;&lt; idx1 &lt;&lt; <span class="string">&quot; and/or &quot;</span> &lt;&lt; idx2 &lt;&lt; <span class="string">&quot; for edge &quot;</span> &lt;&lt; edgeCnt<span class="number">-1</span> &lt;&lt; endl;</span><br><span class="line">                 <span class="keyword">delete</span> e; <span class="comment">// 如果顶点没找到，这条边就没用了，需要释放内存</span></span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            e-&gt;<span class="built_in">setVertex</span>(<span class="number">0</span>, v1);</span><br><span class="line">            e-&gt;<span class="built_in">setVertex</span>(<span class="number">1</span>, v2);</span><br><span class="line">            e-&gt;<span class="built_in">read</span>(fin);</span><br><span class="line">            optimizer.<span class="built_in">addEdge</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;read total &quot;</span> &lt;&lt; vertexCnt &lt;&lt; <span class="string">&quot; vertices, &quot;</span> &lt;&lt; edgeCnt &lt;&lt; <span class="string">&quot; edges.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;optimizing ...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    optimizer.<span class="built_in">initializeOptimization</span>();</span><br><span class="line">    optimizer.<span class="built_in">optimize</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;saving optimization results ...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    optimizer.<span class="built_in">save</span>(<span class="string">&quot;result.g2o&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建议使用更新的CMake版本</span></span><br><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(pose_graph)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用变量设置C++标准，而不是直接修改 CXX_FLAGS</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Release模式下自动添加优化选项</span></span><br><span class="line"><span class="comment"># set(CMAKE_BUILD_TYPE &quot;Release&quot;) # 可以通过 cmake -DCMAKE_BUILD_TYPE=Release 指定</span></span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake_modules)</span><br><span class="line"></span><br><span class="line"><span class="comment"># find_package 命令寻找依赖</span></span><br><span class="line">find_package(Eigen3 3.3 REQUIRED NO_MODULE)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Target: pose_graph_g2o_SE3 ---</span></span><br><span class="line">add_executable(pose_graph_g2o_SE3 pose_graph_g2o_SE3.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 target_... 的现代CMake语法</span></span><br><span class="line">target_include_directories(pose_graph_g2o_SE3 PUBLIC</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接到CMake目标，而不是库名。这会自动处理依赖和头文件路径。</span></span><br><span class="line"><span class="comment"># g2o::core, g2o::types_slam3d 等是g2o安装时导出的CMake目标。</span></span><br><span class="line">target_link_libraries(pose_graph_g2o_SE3 PRIVATE</span><br><span class="line">    g2o::core</span><br><span class="line">    g2o::stuff</span><br><span class="line">    g2o::types_slam3d</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Target: pose_graph_g2o_lie ---</span></span><br><span class="line"><span class="comment"># add_executable(pose_graph_g2o_lie pose_graph_g2o_lie_algebra.cpp)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># target_include_directories(pose_graph_g2o_lie PUBLIC</span></span><br><span class="line"><span class="comment">#     $&#123;EIGEN3_INCLUDE_DIR&#125;</span></span><br><span class="line"><span class="comment">#     $&#123;Sophus_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment">#     $&#123;G2O_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># target_link_libraries(pose_graph_g2o_lie PRIVATE</span></span><br><span class="line"><span class="comment">#     g2o::core</span></span><br><span class="line"><span class="comment">#     g2o::stuff</span></span><br><span class="line"><span class="comment">#     Sophus::Sophus</span></span><br><span class="line"><span class="comment"># )</span></span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch10/build$ ./pose_graph_g2o_SE3 ../sphere.g2o </span><br><span class="line">read total 2500 vertices, 9799 edges.</span><br><span class="line">optimizing ...</span><br><span class="line">iteration= 0     chi2= 1023011093.967642         time= 1.48151   cumTime= 1.48151        edges= 9799     schur= 0        lambda= 805.622433      levenbergIter= 1</span><br><span class="line">iteration= 1     chi2= 385118688.233188  time= 1.20841   cumTime= 2.68992        edges= 9799     schur= 0        lambda= 537.081622      levenbergIter= 1</span><br><span class="line">iteration= 2     chi2= 166223726.693658  time= 1.21449   cumTime= 3.90441        edges= 9799     schur= 0        lambda= 358.054415      levenbergIter= 1</span><br></pre></td></tr></table></figure>

<p>这样会在build文件夹下新生成一个文件：result.g2o</p>
<p>在g2o_viewer中打开结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250901202546851.png" alt="image-20250901202546851"></p>
<p>其实结果就是之前一样的。</p>
<hr>
<h3 id="李代数上的位姿图优化"><a href="#李代数上的位姿图优化" class="headerlink" title="李代数上的位姿图优化"></a>李代数上的位姿图优化</h3><p>新建文件<code>slambook/ch10/pose_graph_g20_lie_algebra.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;fstream&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;memory&gt; // 为了 std::unique_ptr</span><br><span class="line"></span><br><span class="line">#include &lt;Eigen/Core&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;g2o/core/base_vertex.h&gt;</span><br><span class="line">#include &lt;g2o/core/base_binary_edge.h&gt;</span><br><span class="line">#include &lt;g2o/core/block_solver.h&gt;</span><br><span class="line">#include &lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span><br><span class="line">#include &lt;g2o/solvers/eigen/linear_solver_eigen.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;sophus/se3.hpp&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line">using namespace Eigen;</span><br><span class="line">using Sophus::SE3d;</span><br><span class="line">using Sophus::SO3d;</span><br><span class="line"></span><br><span class="line">/************************************************</span><br><span class="line"> * 本程序演示如何用g2o solver进行位姿图优化</span><br><span class="line"> * sphere.g2o是人工生成的一个Pose graph，我们来优化它。</span><br><span class="line"> * 尽管可以直接通过load函数读取整个图，但我们还是自己来实现读取代码，以期获得更深刻的理解</span><br><span class="line"> * 本节使用李代数表达位姿图，节点和边的方式为自定义</span><br><span class="line"> * **********************************************/</span><br><span class="line"></span><br><span class="line">typedef Matrix&lt;double, 6, 6&gt; Matrix6d;</span><br><span class="line">typedef Matrix&lt;double, 6, 1&gt; Vector6d;</span><br><span class="line"></span><br><span class="line">// 给定误差 e, 计算右雅可比的逆 J_r(e)^&#123;-1&#125; 的近似</span><br><span class="line">// 在g2o中，雅可比矩阵的计算需要这个量</span><br><span class="line">Matrix6d JRInv(const SE3d &amp;e) &#123;</span><br><span class="line">    Matrix6d J;</span><br><span class="line">    J.block&lt;3, 3&gt;(0, 0) = SO3d::hat(e.so3().log());</span><br><span class="line">    J.block&lt;3, 3&gt;(0, 3) = SO3d::hat(e.translation());</span><br><span class="line">    J.block&lt;3, 3&gt;(3, 0) = Matrix3d::Zero(3, 3);</span><br><span class="line">    J.block&lt;3, 3&gt;(3, 3) = SO3d::hat(e.so3().log());</span><br><span class="line">    // 当误差 e 接近零时, J_r(e) 接近单位阵 I。</span><br><span class="line">    // 在优化后期，通常使用单位阵作为近似，可以加速计算。</span><br><span class="line">    return Matrix6d::Identity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 李代数顶点</span><br><span class="line">class VertexSE3LieAlgebra : public g2o::BaseVertex&lt;6, SE3d&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><br><span class="line"></span><br><span class="line">    // 从文件中读取数据</span><br><span class="line">    virtual bool read(istream &amp;is) override &#123;</span><br><span class="line">        double data[7];</span><br><span class="line">        for (int i = 0; i &lt; 7; i++)</span><br><span class="line">            is &gt;&gt; data[i];</span><br><span class="line">        // 注意g2o文件格式中四元数顺序是 qx, qy, qz, qw</span><br><span class="line">        // Eigen的构造函数需要 w, x, y, z</span><br><span class="line">        setEstimate(SE3d(</span><br><span class="line">            Quaterniond(data[6], data[3], data[4], data[5]),</span><br><span class="line">            Vector3d(data[0], data[1], data[2])</span><br><span class="line">        ));</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 将数据写入文件</span><br><span class="line">    virtual bool write(ostream &amp;os) const override &#123;</span><br><span class="line">        os &lt;&lt; id() &lt;&lt; &quot; &quot;;</span><br><span class="line">        Quaterniond q = _estimate.unit_quaternion();</span><br><span class="line">        os &lt;&lt; _estimate.translation().transpose() &lt;&lt; &quot; &quot;;</span><br><span class="line">        // Eigen四元数内部存储顺序是 x, y, z, w</span><br><span class="line">        os &lt;&lt; q.x() &lt;&lt; &quot; &quot; &lt;&lt; q.y() &lt;&lt; &quot; &quot; &lt;&lt; q.z() &lt;&lt; &quot; &quot; &lt;&lt; q.w() &lt;&lt; endl;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void setToOriginImpl() override &#123;</span><br><span class="line">        _estimate = SE3d();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 增量更新（左乘扰动模型）</span><br><span class="line">    virtual void oplusImpl(const double *update) override &#123;</span><br><span class="line">        Vector6d upd;</span><br><span class="line">        upd &lt;&lt; update[0], update[1], update[2], update[3], update[4], update[5];</span><br><span class="line">        _estimate = SE3d::exp(upd) * _estimate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 两个李代数节点之间的边</span><br><span class="line">class EdgeSE3LieAlgebra : public g2o::BaseBinaryEdge&lt;6, SE3d, VertexSE3LieAlgebra, VertexSE3LieAlgebra&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><br><span class="line"></span><br><span class="line">    virtual bool read(istream &amp;is) override &#123;</span><br><span class="line">        double data[7];</span><br><span class="line">        for (int i = 0; i &lt; 7; i++)</span><br><span class="line">            is &gt;&gt; data[i];</span><br><span class="line">        Quaterniond q(data[6], data[3], data[4], data[5]);</span><br><span class="line">        q.normalize();</span><br><span class="line">        setMeasurement(SE3d(q, Vector3d(data[0], data[1], data[2])));</span><br><span class="line">        // 读取信息矩阵</span><br><span class="line">        for (int i = 0; i &lt; information().rows() &amp;&amp; is.good(); i++)</span><br><span class="line">            for (int j = i; j &lt; information().cols() &amp;&amp; is.good(); j++) &#123;</span><br><span class="line">                is &gt;&gt; information()(i, j);</span><br><span class="line">                if (i != j)</span><br><span class="line">                    information()(j, i) = information()(i, j);</span><br><span class="line">            &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual bool write(ostream &amp;os) const override &#123;</span><br><span class="line">        auto v1 = static_cast&lt;const VertexSE3LieAlgebra *&gt;(_vertices[0]);</span><br><span class="line">        auto v2 = static_cast&lt;const VertexSE3LieAlgebra *&gt;(_vertices[1]);</span><br><span class="line">        os &lt;&lt; v1-&gt;id() &lt;&lt; &quot; &quot; &lt;&lt; v2-&gt;id() &lt;&lt; &quot; &quot;;</span><br><span class="line">        SE3d m = _measurement;</span><br><span class="line">        Eigen::Quaterniond q = m.unit_quaternion();</span><br><span class="line">        os &lt;&lt; m.translation().transpose() &lt;&lt; &quot; &quot;;</span><br><span class="line">        os &lt;&lt; q.x() &lt;&lt; &quot; &quot; &lt;&lt; q.y() &lt;&lt; &quot; &quot; &lt;&lt; q.z() &lt;&lt; &quot; &quot; &lt;&lt; q.w() &lt;&lt; &quot; &quot;;</span><br><span class="line"></span><br><span class="line">        // 写入信息矩阵</span><br><span class="line">        for (int i = 0; i &lt; information().rows(); i++)</span><br><span class="line">            for (int j = i; j &lt; information().cols(); j++) &#123;</span><br><span class="line">                os &lt;&lt; information()(i, j) &lt;&lt; &quot; &quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        os &lt;&lt; endl;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 误差计算，与书中推导一致: e = ln( (T_ij * T_i)^&#123;-1&#125; * T_j )</span><br><span class="line">    virtual void computeError() override &#123;</span><br><span class="line">        SE3d v1 = (static_cast&lt;const VertexSE3LieAlgebra *&gt;(_vertices[0]))-&gt;estimate();</span><br><span class="line">        SE3d v2 = (static_cast&lt;const VertexSE3LieAlgebra *&gt;(_vertices[1]))-&gt;estimate();</span><br><span class="line">        _error = (_measurement.inverse() * v1.inverse() * v2).log();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 雅可比计算</span><br><span class="line">    // 【关键修正】: 修正了雅可比矩阵的计算公式</span><br><span class="line">    virtual void linearizeOplus() override &#123;</span><br><span class="line">        SE3d v1 = (static_cast&lt;const VertexSE3LieAlgebra *&gt;(_vertices[0]))-&gt;estimate();</span><br><span class="line">        SE3d v2 = (static_cast&lt;const VertexSE3LieAlgebra *&gt;(_vertices[1]))-&gt;estimate();</span><br><span class="line">        Matrix6d J = JRInv(SE3d::exp(_error));</span><br><span class="line">        // 根据左扰动模型的推导，雅可比矩阵为:</span><br><span class="line">        // de/d_delta_xi = -J_r(e)^&#123;-1&#125; * Adj(T_j^&#123;-1&#125; * T_i)</span><br><span class="line">        // de/d_delta_xj = J_r(e)^&#123;-1&#125;</span><br><span class="line">        // ...</span><br><span class="line">        _jacobianOplusXi = -J * v2.inverse().Adj(); // 修正后</span><br><span class="line">        _jacobianOplusXj = J * v2.inverse().Adj();  // 保持不变</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">    if (argc != 2) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;Usage: pose_graph_g2o_lie_algebra sphere.g2o&quot; &lt;&lt; endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    ifstream fin(argv[1]);</span><br><span class="line">    if (!fin) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;file &quot; &lt;&lt; argv[1] &lt;&lt; &quot; does not exist.&quot; &lt;&lt; endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 设定g2o</span><br><span class="line">    typedef g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;6, 6&gt;&gt; BlockSolverType;</span><br><span class="line">    typedef g2o::LinearSolverEigen&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType;</span><br><span class="line">    </span><br><span class="line">    // 【修改点】: 使用 std::make_unique</span><br><span class="line">    auto linearSolver = std::make_unique&lt;LinearSolverType&gt;();</span><br><span class="line">    auto blockSolver = std::make_unique&lt;BlockSolverType&gt;(std::move(linearSolver));</span><br><span class="line">    auto solver = new g2o::OptimizationAlgorithmLevenberg(std::move(blockSolver));</span><br><span class="line">    </span><br><span class="line">    g2o::SparseOptimizer optimizer;</span><br><span class="line">    optimizer.setAlgorithm(solver);</span><br><span class="line">    optimizer.setVerbose(true);</span><br><span class="line"></span><br><span class="line">    int vertexCnt = 0, edgeCnt = 0;</span><br><span class="line"></span><br><span class="line">    // 【修改点】: 使用更健壮的文件读取循环</span><br><span class="line">    string name;</span><br><span class="line">    while (fin &gt;&gt; name) &#123;</span><br><span class="line">        if (name == &quot;VERTEX_SE3:QUAT&quot;) &#123;</span><br><span class="line">            VertexSE3LieAlgebra *v = new VertexSE3LieAlgebra();</span><br><span class="line">            int index = 0;</span><br><span class="line">            fin &gt;&gt; index;</span><br><span class="line">            v-&gt;setId(index);</span><br><span class="line">            v-&gt;read(fin);</span><br><span class="line">            optimizer.addVertex(v);</span><br><span class="line">            vertexCnt++;</span><br><span class="line">            if (index == 0)</span><br><span class="line">                v-&gt;setFixed(true);</span><br><span class="line">        &#125; else if (name == &quot;EDGE_SE3:QUAT&quot;) &#123;</span><br><span class="line">            EdgeSE3LieAlgebra *e = new EdgeSE3LieAlgebra();</span><br><span class="line">            int idx1, idx2;</span><br><span class="line">            fin &gt;&gt; idx1 &gt;&gt; idx2;</span><br><span class="line">            e-&gt;setId(edgeCnt++);</span><br><span class="line">            e-&gt;setVertex(0, optimizer.vertex(idx1));</span><br><span class="line">            e-&gt;setVertex(1, optimizer.vertex(idx2));</span><br><span class="line">            e-&gt;read(fin);</span><br><span class="line">            optimizer.addEdge(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;read total &quot; &lt;&lt; vertexCnt &lt;&lt; &quot; vertices, &quot; &lt;&lt; edgeCnt &lt;&lt; &quot; edges.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;optimizing ...&quot; &lt;&lt; endl;</span><br><span class="line">    optimizer.initializeOptimization();</span><br><span class="line">    optimizer.optimize(30);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;saving optimization results ...&quot; &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    // 【修改点】: 保存结果时直接遍历optimizer，不再使用额外的vector</span><br><span class="line">    ofstream fout(&quot;result_lie.g2o&quot;);</span><br><span class="line">    // 保存顶点</span><br><span class="line">    for (auto const&amp; [id, v_ptr] : optimizer.vertices()) &#123;</span><br><span class="line">        fout &lt;&lt; &quot;VERTEX_SE3:QUAT &quot;;</span><br><span class="line">        // 需要将基类指针转换为派生类指针来调用write</span><br><span class="line">        auto v = static_cast&lt;VertexSE3LieAlgebra*&gt;(v_ptr);</span><br><span class="line">        v-&gt;write(fout);</span><br><span class="line">    &#125;</span><br><span class="line">    // 保存边</span><br><span class="line">    for (const auto&amp; edge_ptr : optimizer.edges()) &#123;</span><br><span class="line">        fout &lt;&lt; &quot;EDGE_SE3:QUAT &quot;;</span><br><span class="line">        auto e = static_cast&lt;EdgeSE3LieAlgebra*&gt;(edge_ptr);</span><br><span class="line">        e-&gt;write(fout);</span><br><span class="line">    &#125;</span><br><span class="line">    fout.close();</span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; &quot;Done. Results saved to result_lie.g2o&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 建议使用更新的CMake版本</span><br><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(pose_graph)</span><br><span class="line"></span><br><span class="line"># 使用变量设置C++标准，而不是直接修改 CXX_FLAGS</span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># 在Release模式下自动添加优化选项</span><br><span class="line"># set(CMAKE_BUILD_TYPE &quot;Release&quot;) # 可以通过 cmake -DCMAKE_BUILD_TYPE=Release 指定</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake_modules)</span><br><span class="line"></span><br><span class="line"># find_package 命令寻找依赖</span><br><span class="line">find_package(Eigen3 3.3 REQUIRED NO_MODULE)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- Target: pose_graph_g2o_SE3 ---</span><br><span class="line">add_executable(pose_graph_g2o_SE3 pose_graph_g2o_SE3.cpp)</span><br><span class="line"></span><br><span class="line"># 使用 target_... 的现代CMake语法</span><br><span class="line">target_include_directories(pose_graph_g2o_SE3 PUBLIC</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 链接到CMake目标，而不是库名。这会自动处理依赖和头文件路径。</span><br><span class="line"># g2o::core, g2o::types_slam3d 等是g2o安装时导出的CMake目标。</span><br><span class="line">target_link_libraries(pose_graph_g2o_SE3 PRIVATE</span><br><span class="line">    g2o::core</span><br><span class="line">    g2o::stuff</span><br><span class="line">    g2o::types_slam3d</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># --- Target: pose_graph_g2o_lie ---</span><br><span class="line">add_executable(pose_graph_g2o_lie pose_graph_g2o_lie_algebra.cpp)</span><br><span class="line"></span><br><span class="line">target_include_directories(pose_graph_g2o_lie PUBLIC</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_link_libraries(pose_graph_g2o_lie PRIVATE</span><br><span class="line">    g2o::core</span><br><span class="line">    g2o::stuff</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch10/build$ ./pose_graph_g2o_lie ../sphere.g2o </span><br><span class="line">read total 2500 vertices, 9799 edges.</span><br><span class="line">optimizing ...</span><br><span class="line">iteration= 0     chi2= 9525282235.918398         time= 10.4865   cumTime= 10.4865        edges= 9799     schur= 0        lambda= 306499924.174889        levenbergIter= 7</span><br><span class="line">iteration= 1     chi2= 9469638479.905460         time= 2.18911   cumTime= 12.6756        edges= 9799     schur= 0        lambda= 102166641.391630        levenbergIter= 1</span><br></pre></td></tr></table></figure>

<p>同样会生成一个result_lie.g2o文件</p>
<p>结果如下</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%83%E8%AE%B2%EF%BC%89--%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/" class="post-title-link" itemprop="url">第七讲-视觉里程计1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:28:57" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第七讲）–视觉里程计1"><a href="#视觉SLAM十四讲（第七讲）–视觉里程计1" class="headerlink" title="视觉SLAM十四讲（第七讲）–视觉里程计1"></a>视觉SLAM十四讲（第七讲）–视觉里程计1</h1><h2 id="特征点法"><a href="#特征点法" class="headerlink" title="特征点法"></a>特征点法</h2><p>一个SLAM系统分为前端后端，其中前端称为视觉里程计，<strong>根据相邻图像信息估计出粗略的相机运动</strong>，给后端提供较好的初始值。视觉里程计算法分为两个大类：<strong>特征点法和直接法</strong>。</p>
<h3 id="特征点"><a href="#特征点" class="headerlink" title="特征点"></a>特征点</h3><p>视觉里程计的核心问题是<strong>如何根据图像估计相机运动</strong>，图像本身是一个由亮度和色彩组成的矩阵。从矩阵考虑运动估计，比较困难，所以首先从图像中选取比较有代表性的点，这些点在相机视角发生少量变化后保持不变，于是能够在各个图像中找到相同的点，在经典SLAM模型中，称为<strong>路标</strong>。然而在视觉SLAM中路标就是指图像特征。<strong>特征是图像信息的另一种数字表达形式</strong>。希望特征点在相机运动之后保持稳定，但是灰度值受光照、形变、物体材质的影响严重，所以还需要对图像提取<strong>特征点</strong>。</p>
<p>我们可以把图像中的角点、边缘和区块都当成图像中有代表性的地方，但是图像中的角点、边缘相比较于像素区块更加特别，所以可以在不同图像中辨别角点，确定它们的对应关系。角点就是所谓的特征，提取角点的算法有很多，例如Harris角点、Fast角点等等。</p>
<p>但是单纯的角点在大多数应用中，并不能满足需求，可能会因为相机远近的问题发生变化，因此，提出了SIFT、SURF、ORB等局部特征。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-217cfcb3eb1a1e1f8a7660b769ab2d64_r.jpg" alt="img"></p>
<h3 id="ORB特征"><a href="#ORB特征" class="headerlink" title="ORB特征"></a>ORB特征</h3><blockquote>
<p>ORB(Oriented FAST and Rotated BRIEF)</p>
</blockquote>
<p>特征点由<strong>关键点</strong>、<strong>描述子</strong>两部分组成，关键点是指该特征点在图像中的位置，描述子是按照<strong>外观相似的特征该有相似的描述子</strong>的原则设计的。因此，只要两个特征点描述子在向量空间上距离相近，就可以认为是同样的关键点。这样就能使得连续两帧图片中的关键点能够正确匹配。ORB(Oriented FAST and Rotated BRIEF)融合了两种已有的高效算法——FAST特征点检测和BRIEF特征描述，并通过一系列创新性的改进，克服了它们各自的局限性，实现了速度与性能的完美平衡。</p>
<ul>
<li>关键点检测：带方向的FAST（Oriented FAST）</li>
</ul>
<p>传统的FAST (Features from Accelerated Segment Test) 算法以其惊人的检测速度而闻名。它通过<strong>比较像素点与其邻域像素的灰度值来快速识别角点</strong>。然而，FAST算法本身不具备方向性，这意味着即使是同一个角点，在图像旋转后也会被视为不同的特征点，这限制了其在旋转场景下的应用。然而ORB对此进行优化，引入方向信息，并且使用Harris角点检测。</p>
<ul>
<li>描述子：可旋转的BRIEF（Rotated BRIEF）</li>
</ul>
<p>BRIEF (Binary Robust Independent Elementary Features) 是一种二进制特征描述子。它<strong>通过在特征点周围的图像块内选取若干个点对，比较它们的灰度值大小，并将比较结果（0或1）串联起来形成一个二进制字符串，作为该特征点的描述符</strong>。由于描述子是二进制的，因此在存储和匹配时都极为高效，通常使用汉明距离进行度量。ORB会在生成BRIEF之前，利用上一步计算出的<strong>特征点主方向</strong>，将BRIEF采用时所使用的点对模型旋转到与主方向一致，实现了旋转不变性，同时优化了选取的BRIEF点对的方法，从而能够提供更具区分度和鲁棒性的特征描述。</p>
<hr>
<h3 id="特征匹配"><a href="#特征匹配" class="headerlink" title="特征匹配"></a>特征匹配</h3><p>描述子与特征匹配并非两个独立的步骤，而这时因果相连、密不可分的。类似于描述子是生成嫌疑人的特征档案，而特征匹配就是按照档案去寻找嫌疑人。至于为什么不去找完全相同的，是因为同一个三维空间点在两张不同照片上提取的描述子，几乎不可能完全相同。特征匹配其实本质上是寻找最近邻而非寻找等同者的问题。因此后续需要一些筛选策略来剔除虽然相近但是不够确信的模糊匹配。（RANSAC等）</p>
<p>特征匹配解决了SLAM中数据关联问题，即确定当前看到的路标与之前的对应关系，如果在两个图像中提取到了特征点，如何去寻找这两个集合元素的对应关系呢？最简单的时暴力匹配，<strong>测量每一个特征点到所有另外一组特征点的描述子的距离，取最近的为匹配点</strong>。对于浮点型的描述子，选择欧氏距离进行度量，对于二进制的描述子，选择汉明距离作为度量——不同位数的个数。但是，当特征点数量很大时，就需要很大的运算量，所以**快速近似最近邻（FLANN）**算法更适合匹配点数量多的情况。已经集成到OpenCV中了。</p>
<hr>
<h2 id="实践：特征提取和匹配"><a href="#实践：特征提取和匹配" class="headerlink" title="实践：特征提取和匹配"></a>实践：特征提取和匹配</h2><h3 id="OpenCV的ORB特征"><a href="#OpenCV的ORB特征" class="headerlink" title="OpenCV的ORB特征"></a>OpenCV的ORB特征</h3><p>第一个实验通过两张带有微小移动的图片来演示如何通过ORB来得到匹配结果估算相机的运动。</p>
<p>首先先保存源代码的两张图片到<code>slambook/ch7/</code></p>
<p>新建文件：<code>slambook/ch7/orb_cv.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;usage: feature_extraction img1 img2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//-- 读取图像</span></span><br><span class="line">  <span class="comment">// 【修改1】: CV_LOAD_IMAGE_COLOR 替换为 IMREAD_COLOR</span></span><br><span class="line">  Mat img_1 = <span class="built_in">imread</span>(argv[<span class="number">1</span>], IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = <span class="built_in">imread</span>(argv[<span class="number">2</span>], IMREAD_COLOR);</span><br><span class="line">  <span class="built_in">assert</span>(img_<span class="number">1.</span>data != <span class="literal">nullptr</span> &amp;&amp; img_<span class="number">2.</span>data != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 初始化</span></span><br><span class="line">  std::vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  <span class="comment">// 【修改2】: 将 detector 和 descriptor 合并为一个 ORB 对象</span></span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">1.2f</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, ORB::HARRIS_SCORE, <span class="number">31</span>, <span class="number">20</span>);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第一步:检测 Oriented FAST 角点位置</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="comment">// 使用统一的 orb 对象进行检测</span></span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_1, keypoints_1);</span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_2, keypoints_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第二步:根据角点位置计算 BRIEF 描述子</span></span><br><span class="line">  <span class="comment">// 使用统一的 orb 对象进行计算</span></span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_1, keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_2, keypoints_2, descriptors_2);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;extract ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  Mat outimg1;</span><br><span class="line">  <span class="built_in">drawKeypoints</span>(img_1, keypoints_1, outimg1, Scalar::<span class="built_in">all</span>(<span class="number">-1</span>), DrawMatchesFlags::DEFAULT);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;ORB features&quot;</span>, outimg1);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span></span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  matcher-&gt;<span class="built_in">match</span>(descriptors_1, descriptors_2, matches);</span><br><span class="line">  t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;match ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第四步:匹配点对筛选</span></span><br><span class="line">  <span class="comment">// 计算最小距离和最大距离</span></span><br><span class="line">  <span class="keyword">auto</span> min_max = <span class="built_in">minmax_element</span>(matches.<span class="built_in">begin</span>(), matches.<span class="built_in">end</span>(),</span><br><span class="line">                                [](<span class="type">const</span> DMatch &amp;m1, <span class="type">const</span> DMatch &amp;m2) &#123; <span class="keyword">return</span> m<span class="number">1.</span>distance &lt; m<span class="number">2.</span>distance; &#125;);</span><br><span class="line">  <span class="type">double</span> min_dist = min_max.first-&gt;distance;</span><br><span class="line">  <span class="type">double</span> max_dist = min_max.second-&gt;distance;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Max dist : %f \n&quot;</span>, max_dist);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Min dist : %f \n&quot;</span>, min_dist);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//当描述子之间的距离大于两倍的最小距离时,即认为匹配有误.但有时候最小距离会非常小,设置一个经验值30作为下限.</span></span><br><span class="line">  std::vector&lt;DMatch&gt; good_matches;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (matches[i].distance &lt;= <span class="built_in">max</span>(<span class="number">2</span> * min_dist, <span class="number">30.0</span>)) &#123;</span><br><span class="line">      good_matches.<span class="built_in">push_back</span>(matches[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第五步:绘制匹配结果</span></span><br><span class="line">  Mat img_match;</span><br><span class="line">  Mat img_goodmatch;</span><br><span class="line">  <span class="built_in">drawMatches</span>(img_1, keypoints_1, img_2, keypoints_2, matches, img_match);</span><br><span class="line">  <span class="built_in">drawMatches</span>(img_1, keypoints_1, img_2, keypoints_2, good_matches, img_goodmatch);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;all matches&quot;</span>, img_match);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;good matches&quot;</span>, img_goodmatch);</span><br><span class="line">  <span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line">add_definitions(<span class="string">&quot;-DENABLE_SSE&quot;</span>)</span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++11 -O2 $&#123;SSE_FLAGS&#125; -msse4&quot;</span>)</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line">include_directories(</span><br><span class="line">        $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">        <span class="string">&quot;/usr/include/eigen3/&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv $&#123;OpenCV_LIBS&#125;)</span><br></pre></td></tr></table></figure>

<p>终端输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ cmake ..</span><br><span class="line">......</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch7/build</span><br><span class="line">hita@hita-vm:~/slambook/ch7/build$ make</span><br><span class="line">[100%] Built target orb_cv</span><br><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./orb_cv ../1</span><br><span class="line">1_depth.png  1.png        </span><br><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./orb_cv ../1.png ../2.png </span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p>ORB关键点：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153656107.png" alt="image-20250827153656107"></p>
<p>未筛选的匹配</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153733677.png" alt="image-20250827153733677"></p>
<p>筛选后的匹配：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827153823141.png" alt="image-20250827153823141"></p>
<p>筛选的依据是<strong>汉明距离小于最小距离的两倍</strong>，这是工程上的经验方法。</p>
<h3 id="手写ORB特征"><a href="#手写ORB特征" class="headerlink" title="手写ORB特征"></a>手写ORB特征</h3><p>新建文件:<code>slambook/ch7/orb_self.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xiang on 18-11-25.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;nmmintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// global variables</span></span><br><span class="line">string first_file = <span class="string">&quot;../1.png&quot;</span>;</span><br><span class="line">string second_file = <span class="string">&quot;../2.png&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 32 bit unsigned int, will have 8, 8x32=256</span></span><br><span class="line"><span class="keyword">typedef</span> vector&lt;<span class="type">uint32_t</span>&gt; DescType; <span class="comment">// Descriptor type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * compute descriptor of orb keypoints</span></span><br><span class="line"><span class="comment"> * @param img input image</span></span><br><span class="line"><span class="comment"> * @param keypoints detected fast keypoints</span></span><br><span class="line"><span class="comment"> * @param descriptors descriptors</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> if a keypoint goes outside the image boundary (8 pixels), descriptors will not be computed and will be left as</span></span><br><span class="line"><span class="comment"> * empty</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ComputeORB</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, vector&lt;cv::KeyPoint&gt; &amp;keypoints, vector&lt;DescType&gt; &amp;descriptors)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * brute-force match two sets of descriptors</span></span><br><span class="line"><span class="comment"> * @param desc1 the first descriptor</span></span><br><span class="line"><span class="comment"> * @param desc2 the second descriptor</span></span><br><span class="line"><span class="comment"> * @param matches matches of two images</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BfMatch</span><span class="params">(<span class="type">const</span> vector&lt;DescType&gt; &amp;desc1, <span class="type">const</span> vector&lt;DescType&gt; &amp;desc2, vector&lt;cv::DMatch&gt; &amp;matches)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// load image</span></span><br><span class="line">  cv::Mat first_image = cv::<span class="built_in">imread</span>(first_file, <span class="number">0</span>);</span><br><span class="line">  cv::Mat second_image = cv::<span class="built_in">imread</span>(second_file, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">assert</span>(first_image.data != <span class="literal">nullptr</span> &amp;&amp; second_image.data != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// detect FAST keypoints1 using threshold=40</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  vector&lt;cv::KeyPoint&gt; keypoints1;</span><br><span class="line">  cv::<span class="built_in">FAST</span>(first_image, keypoints1, <span class="number">40</span>);</span><br><span class="line">  vector&lt;DescType&gt; descriptor1;</span><br><span class="line">  <span class="built_in">ComputeORB</span>(first_image, keypoints1, descriptor1);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// same for the second</span></span><br><span class="line">  vector&lt;cv::KeyPoint&gt; keypoints2;</span><br><span class="line">  vector&lt;DescType&gt; descriptor2;</span><br><span class="line">  cv::<span class="built_in">FAST</span>(second_image, keypoints2, <span class="number">40</span>);</span><br><span class="line">  <span class="built_in">ComputeORB</span>(second_image, keypoints2, descriptor2);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;extract ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// find matches</span></span><br><span class="line">  vector&lt;cv::DMatch&gt; matches;</span><br><span class="line">  t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="built_in">BfMatch</span>(descriptor1, descriptor2, matches);</span><br><span class="line">  t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;match ORB cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;matches: &quot;</span> &lt;&lt; matches.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// plot the matches</span></span><br><span class="line">  cv::Mat image_show;</span><br><span class="line">  cv::<span class="built_in">drawMatches</span>(first_image, keypoints1, second_image, keypoints2, matches, image_show);</span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;matches&quot;</span>, image_show);</span><br><span class="line">  cv::<span class="built_in">imwrite</span>(<span class="string">&quot;matches.png&quot;</span>, image_show);</span><br><span class="line">  cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;done.&quot;</span> &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------------------------------------------------------------------------------------------- //</span></span><br><span class="line"><span class="comment">// ORB pattern</span></span><br><span class="line"><span class="type">int</span> ORB_pattern[<span class="number">256</span> * <span class="number">4</span>] = &#123;</span><br><span class="line">  <span class="number">8</span>, <span class="number">-3</span>, <span class="number">9</span>, <span class="number">5</span><span class="comment">/*mean (0), correlation (0)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">-12</span><span class="comment">/*mean (1.12461e-05), correlation (0.0437584)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">9</span>, <span class="number">-8</span>, <span class="number">2</span><span class="comment">/*mean (3.37382e-05), correlation (0.0617409)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-12</span>, <span class="number">12</span>, <span class="number">-13</span><span class="comment">/*mean (5.62303e-05), correlation (0.0636977)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-13</span>, <span class="number">2</span>, <span class="number">12</span><span class="comment">/*mean (0.000134953), correlation (0.085099)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-7</span>, <span class="number">1</span>, <span class="number">6</span><span class="comment">/*mean (0.000528565), correlation (0.0857175)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-10</span>, <span class="number">-2</span>, <span class="number">-4</span><span class="comment">/*mean (0.0188821), correlation (0.0985774)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-13</span>, <span class="number">-11</span>, <span class="number">-8</span><span class="comment">/*mean (0.0363135), correlation (0.0899616)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-3</span>, <span class="number">-12</span>, <span class="number">-9</span><span class="comment">/*mean (0.121806), correlation (0.099849)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span><span class="comment">/*mean (0.122065), correlation (0.093285)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-8</span>, <span class="number">-8</span>, <span class="number">-9</span><span class="comment">/*mean (0.162787), correlation (0.0942748)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">7</span>, <span class="number">-9</span>, <span class="number">12</span><span class="comment">/*mean (0.21561), correlation (0.0974438)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">6</span><span class="comment">/*mean (0.160583), correlation (0.130064)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-5</span>, <span class="number">-3</span>, <span class="number">0</span><span class="comment">/*mean (0.228171), correlation (0.132998)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">2</span>, <span class="number">-12</span>, <span class="number">-3</span><span class="comment">/*mean (0.00997526), correlation (0.145926)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">0</span>, <span class="number">-7</span>, <span class="number">5</span><span class="comment">/*mean (0.198234), correlation (0.143636)*/</span>,</span><br><span class="line">  <span class="number">12</span>, <span class="number">-6</span>, <span class="number">12</span>, <span class="number">-1</span><span class="comment">/*mean (0.0676226), correlation (0.16689)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">6</span>, <span class="number">-2</span>, <span class="number">12</span><span class="comment">/*mean (0.166847), correlation (0.171682)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">-8</span><span class="comment">/*mean (0.101215), correlation (0.179716)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-8</span><span class="comment">/*mean (0.200641), correlation (0.192279)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">1</span><span class="comment">/*mean (0.205106), correlation (0.186848)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-3</span>, <span class="number">10</span>, <span class="number">-3</span><span class="comment">/*mean (0.234908), correlation (0.192319)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-7</span>, <span class="number">6</span>, <span class="number">12</span><span class="comment">/*mean (0.0709964), correlation (0.210872)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-7</span>, <span class="number">-6</span>, <span class="number">-2</span><span class="comment">/*mean (0.0939834), correlation (0.212589)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">11</span>, <span class="number">-1</span>, <span class="number">-10</span><span class="comment">/*mean (0.127778), correlation (0.20866)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-8</span>, <span class="number">10</span><span class="comment">/*mean (0.14783), correlation (0.206356)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">3</span>, <span class="number">-5</span>, <span class="number">-3</span><span class="comment">/*mean (0.182141), correlation (0.198942)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">7</span><span class="comment">/*mean (0.188237), correlation (0.21384)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-12</span>, <span class="number">-6</span>, <span class="number">11</span><span class="comment">/*mean (0.14865), correlation (0.23571)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-12</span>, <span class="number">6</span>, <span class="number">-7</span><span class="comment">/*mean (0.222312), correlation (0.23324)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-6</span>, <span class="number">7</span>, <span class="number">-1</span><span class="comment">/*mean (0.229082), correlation (0.23389)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">-5</span><span class="comment">/*mean (0.241577), correlation (0.215286)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">11</span>, <span class="number">11</span>, <span class="number">-13</span><span class="comment">/*mean (0.00338507), correlation (0.251373)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span><span class="comment">/*mean (0.131005), correlation (0.257622)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-1</span>, <span class="number">4</span>, <span class="number">4</span><span class="comment">/*mean (0.152755), correlation (0.255205)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-12</span>, <span class="number">-2</span>, <span class="number">7</span><span class="comment">/*mean (0.182771), correlation (0.244867)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-5</span>, <span class="number">-7</span>, <span class="number">-10</span><span class="comment">/*mean (0.186898), correlation (0.23901)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span><span class="comment">/*mean (0.226226), correlation (0.258255)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">-8</span>, <span class="number">1</span>, <span class="number">-13</span><span class="comment">/*mean (0.0897886), correlation (0.274827)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-2</span>, <span class="number">-8</span>, <span class="number">2</span><span class="comment">/*mean (0.148774), correlation (0.28065)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-2</span>, <span class="number">3</span><span class="comment">/*mean (0.153048), correlation (0.283063)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">9</span>, <span class="number">-4</span>, <span class="number">-9</span><span class="comment">/*mean (0.169523), correlation (0.278248)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">12</span>, <span class="number">10</span>, <span class="number">7</span><span class="comment">/*mean (0.225337), correlation (0.282851)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">3</span><span class="comment">/*mean (0.226687), correlation (0.278734)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-5</span>, <span class="number">11</span>, <span class="number">-10</span><span class="comment">/*mean (0.00693882), correlation (0.305161)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-6</span>, <span class="number">-11</span>, <span class="number">0</span><span class="comment">/*mean (0.0227283), correlation (0.300181)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">1</span><span class="comment">/*mean (0.125517), correlation (0.31089)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-3</span>, <span class="number">-6</span>, <span class="number">12</span><span class="comment">/*mean (0.131748), correlation (0.312779)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">-9</span>, <span class="number">12</span>, <span class="number">-4</span><span class="comment">/*mean (0.144827), correlation (0.292797)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">8</span>, <span class="number">-8</span>, <span class="number">-12</span><span class="comment">/*mean (0.149202), correlation (0.308918)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-8</span>, <span class="number">-4</span><span class="comment">/*mean (0.160909), correlation (0.310013)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">8</span><span class="comment">/*mean (0.177755), correlation (0.309394)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">-7</span><span class="comment">/*mean (0.212337), correlation (0.310315)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">-12</span><span class="comment">/*mean (0.214429), correlation (0.311933)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-10</span>, <span class="number">5</span>, <span class="number">6</span><span class="comment">/*mean (0.235807), correlation (0.313104)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-4</span>, <span class="number">3</span>, <span class="number">-10</span><span class="comment">/*mean (0.00494827), correlation (0.344948)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-13</span>, <span class="number">5</span><span class="comment">/*mean (0.0549145), correlation (0.344675)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-7</span>, <span class="number">-12</span>, <span class="number">12</span><span class="comment">/*mean (0.103385), correlation (0.342715)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">3</span>, <span class="number">-11</span>, <span class="number">8</span><span class="comment">/*mean (0.134222), correlation (0.322922)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">12</span>, <span class="number">-4</span>, <span class="number">7</span><span class="comment">/*mean (0.153284), correlation (0.337061)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-10</span>, <span class="number">12</span>, <span class="number">8</span><span class="comment">/*mean (0.154881), correlation (0.329257)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-1</span>, <span class="number">-7</span>, <span class="number">-6</span><span class="comment">/*mean (0.200967), correlation (0.33312)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-5</span>, <span class="number">0</span>, <span class="number">12</span><span class="comment">/*mean (0.201518), correlation (0.340635)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">5</span>, <span class="number">-7</span>, <span class="number">5</span><span class="comment">/*mean (0.207805), correlation (0.335631)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-10</span>, <span class="number">8</span>, <span class="number">-13</span><span class="comment">/*mean (0.224438), correlation (0.34504)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-7</span>, <span class="number">-4</span>, <span class="number">5</span><span class="comment">/*mean (0.239361), correlation (0.338053)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">-7</span><span class="comment">/*mean (0.240744), correlation (0.344322)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">-11</span><span class="comment">/*mean (0.242949), correlation (0.34145)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">-13</span>, <span class="number">-5</span>, <span class="number">-13</span><span class="comment">/*mean (0.244028), correlation (0.336861)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">-1</span><span class="comment">/*mean (0.247571), correlation (0.343684)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-3</span>, <span class="number">5</span>, <span class="number">2</span><span class="comment">/*mean (0.000697256), correlation (0.357265)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">12</span><span class="comment">/*mean (0.00213675), correlation (0.373827)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-6</span>, <span class="number">-9</span>, <span class="number">6</span><span class="comment">/*mean (0.0126856), correlation (0.373938)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">-10</span>, <span class="number">-8</span>, <span class="number">-4</span><span class="comment">/*mean (0.0152497), correlation (0.364237)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">-3</span><span class="comment">/*mean (0.0299933), correlation (0.345292)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.0307242), correlation (0.366299)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-13</span>, <span class="number">-6</span>, <span class="number">5</span><span class="comment">/*mean (0.0534975), correlation (0.368357)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">9</span>, <span class="number">-3</span>, <span class="number">4</span><span class="comment">/*mean (0.099865), correlation (0.372276)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-1</span>, <span class="number">12</span>, <span class="number">2</span><span class="comment">/*mean (0.117083), correlation (0.364529)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">6</span>, <span class="number">-5</span>, <span class="number">1</span><span class="comment">/*mean (0.126125), correlation (0.369606)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">11</span>, <span class="number">-12</span>, <span class="number">5</span><span class="comment">/*mean (0.130364), correlation (0.358502)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">7</span>, <span class="number">-2</span>, <span class="number">-6</span><span class="comment">/*mean (0.131691), correlation (0.375531)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-8</span>, <span class="number">12</span>, <span class="number">-7</span><span class="comment">/*mean (0.160166), correlation (0.379508)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-7</span>, <span class="number">-11</span>, <span class="number">-12</span><span class="comment">/*mean (0.167848), correlation (0.353343)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-3</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.183378), correlation (0.371916)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-6</span>, <span class="number">3</span>, <span class="number">0</span><span class="comment">/*mean (0.228711), correlation (0.371761)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">3</span>, <span class="number">-2</span>, <span class="number">-13</span><span class="comment">/*mean (0.247211), correlation (0.364063)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-13</span>, <span class="number">1</span>, <span class="number">9</span><span class="comment">/*mean (0.249325), correlation (0.378139)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">-6</span><span class="comment">/*mean (0.000652272), correlation (0.411682)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-1</span>, <span class="number">3</span>, <span class="number">12</span><span class="comment">/*mean (0.00248538), correlation (0.392988)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">6</span><span class="comment">/*mean (0.0206815), correlation (0.386106)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-9</span>, <span class="number">-1</span>, <span class="number">3</span><span class="comment">/*mean (0.0364485), correlation (0.410752)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-13</span>, <span class="number">-10</span>, <span class="number">5</span><span class="comment">/*mean (0.0376068), correlation (0.398374)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">12</span><span class="comment">/*mean (0.0424202), correlation (0.405663)*/</span>,</span><br><span class="line">  <span class="number">12</span>, <span class="number">-5</span>, <span class="number">12</span>, <span class="number">9</span><span class="comment">/*mean (0.0942645), correlation (0.410422)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">11</span><span class="comment">/*mean (0.1074), correlation (0.413224)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-13</span>, <span class="number">6</span>, <span class="number">10</span><span class="comment">/*mean (0.109256), correlation (0.408646)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-12</span>, <span class="number">2</span>, <span class="number">3</span><span class="comment">/*mean (0.131691), correlation (0.416076)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">-6</span><span class="comment">/*mean (0.165081), correlation (0.417569)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">-13</span><span class="comment">/*mean (0.171874), correlation (0.408471)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">-12</span>, <span class="number">10</span>, <span class="number">3</span><span class="comment">/*mean (0.175146), correlation (0.41296)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">4</span>, <span class="number">-7</span>, <span class="number">9</span><span class="comment">/*mean (0.183682), correlation (0.402956)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">12</span>, <span class="number">-4</span>, <span class="number">-6</span><span class="comment">/*mean (0.184672), correlation (0.416125)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">-8</span><span class="comment">/*mean (0.191487), correlation (0.386696)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-9</span>, <span class="number">7</span>, <span class="number">-4</span><span class="comment">/*mean (0.192668), correlation (0.394771)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">-2</span><span class="comment">/*mean (0.200157), correlation (0.408303)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">0</span><span class="comment">/*mean (0.204588), correlation (0.411762)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-3</span>, <span class="number">8</span>, <span class="number">-8</span><span class="comment">/*mean (0.205904), correlation (0.416294)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">3</span><span class="comment">/*mean (0.213237), correlation (0.409306)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">-5</span>, <span class="number">-6</span>, <span class="number">-4</span><span class="comment">/*mean (0.243444), correlation (0.395069)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">11</span>, <span class="number">-5</span>, <span class="number">10</span><span class="comment">/*mean (0.247672), correlation (0.413392)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-8</span>, <span class="number">-3</span>, <span class="number">12</span><span class="comment">/*mean (0.24774), correlation (0.411416)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">5</span>, <span class="number">-9</span>, <span class="number">0</span><span class="comment">/*mean (0.00213675), correlation (0.454003)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-1</span>, <span class="number">12</span>, <span class="number">-6</span><span class="comment">/*mean (0.0293635), correlation (0.455368)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-6</span>, <span class="number">6</span>, <span class="number">-11</span><span class="comment">/*mean (0.0404971), correlation (0.457393)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">12</span>, <span class="number">-8</span>, <span class="number">7</span><span class="comment">/*mean (0.0481107), correlation (0.448364)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-2</span>, <span class="number">6</span>, <span class="number">7</span><span class="comment">/*mean (0.050641), correlation (0.455019)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">0</span>, <span class="number">-2</span>, <span class="number">12</span><span class="comment">/*mean (0.0525978), correlation (0.44338)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-8</span>, <span class="number">-5</span>, <span class="number">2</span><span class="comment">/*mean (0.0629667), correlation (0.457096)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-6</span>, <span class="number">10</span>, <span class="number">12</span><span class="comment">/*mean (0.0653846), correlation (0.445623)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-13</span>, <span class="number">-8</span>, <span class="number">-8</span><span class="comment">/*mean (0.0858749), correlation (0.449789)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-13</span>, <span class="number">-5</span>, <span class="number">-2</span><span class="comment">/*mean (0.122402), correlation (0.450201)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-8</span>, <span class="number">9</span>, <span class="number">-13</span><span class="comment">/*mean (0.125416), correlation (0.453224)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-11</span>, <span class="number">-9</span>, <span class="number">0</span><span class="comment">/*mean (0.130128), correlation (0.458724)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-8</span>, <span class="number">1</span>, <span class="number">-2</span><span class="comment">/*mean (0.132467), correlation (0.440133)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-4</span>, <span class="number">9</span>, <span class="number">1</span><span class="comment">/*mean (0.132692), correlation (0.454)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">1</span>, <span class="number">-1</span>, <span class="number">-4</span><span class="comment">/*mean (0.135695), correlation (0.455739)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-6</span>, <span class="number">12</span>, <span class="number">-11</span><span class="comment">/*mean (0.142904), correlation (0.446114)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">-9</span>, <span class="number">-6</span>, <span class="number">4</span><span class="comment">/*mean (0.146165), correlation (0.451473)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">12</span><span class="comment">/*mean (0.147627), correlation (0.456643)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">8</span><span class="comment">/*mean (0.152901), correlation (0.455036)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">-4</span>, <span class="number">2</span>, <span class="number">8</span><span class="comment">/*mean (0.167083), correlation (0.459315)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">12</span>, <span class="number">-5</span>, <span class="number">-13</span><span class="comment">/*mean (0.173234), correlation (0.454706)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span><span class="comment">/*mean (0.18312), correlation (0.433855)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">7</span><span class="comment">/*mean (0.185504), correlation (0.443838)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">-9</span><span class="comment">/*mean (0.185706), correlation (0.451123)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">-8</span><span class="comment">/*mean (0.188968), correlation (0.455808)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">-8</span>, <span class="number">9</span><span class="comment">/*mean (0.191667), correlation (0.459128)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">9</span>, <span class="number">-3</span>, <span class="number">-3</span><span class="comment">/*mean (0.193196), correlation (0.458364)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-7</span>, <span class="number">-3</span>, <span class="number">-12</span><span class="comment">/*mean (0.196536), correlation (0.455782)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">0</span><span class="comment">/*mean (0.1972), correlation (0.450481)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">6</span>, <span class="number">-6</span>, <span class="number">12</span><span class="comment">/*mean (0.199438), correlation (0.458156)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">6</span>, <span class="number">-5</span>, <span class="number">-2</span><span class="comment">/*mean (0.211224), correlation (0.449548)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">-10</span>, <span class="number">3</span>, <span class="number">10</span><span class="comment">/*mean (0.211718), correlation (0.440606)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">-4</span><span class="comment">/*mean (0.213034), correlation (0.443177)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-2</span>, <span class="number">2</span>, <span class="number">-13</span><span class="comment">/*mean (0.234334), correlation (0.455304)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-12</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.235684), correlation (0.443436)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-6</span><span class="comment">/*mean (0.237674), correlation (0.452525)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">3</span><span class="comment">/*mean (0.23962), correlation (0.444824)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-10</span>, <span class="number">-3</span>, <span class="number">-5</span><span class="comment">/*mean (0.248459), correlation (0.439621)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-13</span>, <span class="number">-1</span>, <span class="number">1</span><span class="comment">/*mean (0.249505), correlation (0.456666)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">-11</span><span class="comment">/*mean (0.00119208), correlation (0.495466)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-2</span>, <span class="number">5</span>, <span class="number">-7</span><span class="comment">/*mean (0.00372245), correlation (0.484214)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">9</span>, <span class="number">-9</span>, <span class="number">-5</span><span class="comment">/*mean (0.00741116), correlation (0.499854)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">6</span><span class="comment">/*mean (0.0208952), correlation (0.499773)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-8</span>, <span class="number">7</span>, <span class="number">6</span><span class="comment">/*mean (0.0220085), correlation (0.501609)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-4</span>, <span class="number">-7</span>, <span class="number">1</span><span class="comment">/*mean (0.0233806), correlation (0.496568)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">11</span>, <span class="number">-7</span>, <span class="number">-8</span><span class="comment">/*mean (0.0236505), correlation (0.489719)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">6</span>, <span class="number">-12</span>, <span class="number">-8</span><span class="comment">/*mean (0.0268781), correlation (0.503487)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">9</span><span class="comment">/*mean (0.0323324), correlation (0.501938)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">-5</span>, <span class="number">12</span>, <span class="number">3</span><span class="comment">/*mean (0.0399235), correlation (0.494029)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-5</span>, <span class="number">-6</span>, <span class="number">7</span><span class="comment">/*mean (0.0420153), correlation (0.486579)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-3</span>, <span class="number">9</span>, <span class="number">-8</span><span class="comment">/*mean (0.0548021), correlation (0.484237)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-12</span>, <span class="number">2</span>, <span class="number">8</span><span class="comment">/*mean (0.0616622), correlation (0.496642)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">-2</span>, <span class="number">-10</span>, <span class="number">3</span><span class="comment">/*mean (0.0627755), correlation (0.498563)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">-13</span>, <span class="number">-7</span>, <span class="number">-9</span><span class="comment">/*mean (0.0829622), correlation (0.495491)*/</span>,</span><br><span class="line">  <span class="number">-11</span>, <span class="number">0</span>, <span class="number">-10</span>, <span class="number">-5</span><span class="comment">/*mean (0.0843342), correlation (0.487146)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-3</span>, <span class="number">11</span>, <span class="number">8</span><span class="comment">/*mean (0.0929937), correlation (0.502315)*/</span>,</span><br><span class="line">  <span class="number">-2</span>, <span class="number">-13</span>, <span class="number">-1</span>, <span class="number">12</span><span class="comment">/*mean (0.113327), correlation (0.48941)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-8</span>, <span class="number">0</span>, <span class="number">9</span><span class="comment">/*mean (0.132119), correlation (0.467268)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-11</span>, <span class="number">-12</span>, <span class="number">-5</span><span class="comment">/*mean (0.136269), correlation (0.498771)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-2</span>, <span class="number">-10</span>, <span class="number">11</span><span class="comment">/*mean (0.142173), correlation (0.498714)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">9</span>, <span class="number">-2</span>, <span class="number">-13</span><span class="comment">/*mean (0.144141), correlation (0.491973)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-3</span>, <span class="number">3</span>, <span class="number">2</span><span class="comment">/*mean (0.14892), correlation (0.500782)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-13</span>, <span class="number">-4</span>, <span class="number">0</span><span class="comment">/*mean (0.150371), correlation (0.498211)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">6</span>, <span class="number">-3</span>, <span class="number">-10</span><span class="comment">/*mean (0.152159), correlation (0.495547)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">12</span>, <span class="number">-2</span>, <span class="number">-7</span><span class="comment">/*mean (0.156152), correlation (0.496925)*/</span>,</span><br><span class="line">  <span class="number">-6</span>, <span class="number">-11</span>, <span class="number">-4</span>, <span class="number">9</span><span class="comment">/*mean (0.15749), correlation (0.499222)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-3</span>, <span class="number">6</span>, <span class="number">11</span><span class="comment">/*mean (0.159211), correlation (0.503821)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">11</span>, <span class="number">-5</span>, <span class="number">5</span><span class="comment">/*mean (0.162427), correlation (0.501907)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">6</span><span class="comment">/*mean (0.16652), correlation (0.497632)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-5</span>, <span class="number">12</span>, <span class="number">-2</span><span class="comment">/*mean (0.169141), correlation (0.484474)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">7</span><span class="comment">/*mean (0.169456), correlation (0.495339)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">-8</span>, <span class="number">-3</span>, <span class="number">-2</span><span class="comment">/*mean (0.171457), correlation (0.487251)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">1</span>, <span class="number">-6</span>, <span class="number">7</span><span class="comment">/*mean (0.175), correlation (0.500024)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-12</span>, <span class="number">-8</span>, <span class="number">-13</span><span class="comment">/*mean (0.175866), correlation (0.497523)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">-2</span>, <span class="number">-6</span>, <span class="number">-8</span><span class="comment">/*mean (0.178273), correlation (0.501854)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">5</span>, <span class="number">-6</span>, <span class="number">-9</span><span class="comment">/*mean (0.181107), correlation (0.494888)*/</span>,</span><br><span class="line">  <span class="number">-5</span>, <span class="number">-1</span>, <span class="number">-4</span>, <span class="number">5</span><span class="comment">/*mean (0.190227), correlation (0.482557)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">7</span>, <span class="number">-8</span>, <span class="number">10</span><span class="comment">/*mean (0.196739), correlation (0.496503)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">-13</span><span class="comment">/*mean (0.19973), correlation (0.499759)*/</span>,</span><br><span class="line">  <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">-13</span><span class="comment">/*mean (0.204465), correlation (0.49873)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">12</span>, <span class="number">10</span>, <span class="number">-1</span><span class="comment">/*mean (0.209334), correlation (0.49063)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-8</span>, <span class="number">10</span>, <span class="number">-9</span><span class="comment">/*mean (0.211134), correlation (0.503011)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">-13</span><span class="comment">/*mean (0.212), correlation (0.499414)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">-3</span>, <span class="number">-6</span>, <span class="number">2</span><span class="comment">/*mean (0.212168), correlation (0.480739)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-10</span>, <span class="number">1</span>, <span class="number">12</span><span class="comment">/*mean (0.212731), correlation (0.502523)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">1</span>, <span class="number">-8</span>, <span class="number">-10</span><span class="comment">/*mean (0.21327), correlation (0.489786)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-11</span>, <span class="number">10</span>, <span class="number">-6</span><span class="comment">/*mean (0.214159), correlation (0.488246)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-13</span>, <span class="number">3</span>, <span class="number">-6</span><span class="comment">/*mean (0.216993), correlation (0.50287)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-9</span><span class="comment">/*mean (0.223639), correlation (0.470502)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-10</span>, <span class="number">-5</span>, <span class="number">-7</span><span class="comment">/*mean (0.224089), correlation (0.500852)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-8</span>, <span class="number">-8</span>, <span class="number">-13</span><span class="comment">/*mean (0.228666), correlation (0.502629)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-6</span>, <span class="number">8</span>, <span class="number">5</span><span class="comment">/*mean (0.22906), correlation (0.498305)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">-13</span><span class="comment">/*mean (0.233378), correlation (0.503825)*/</span>,</span><br><span class="line">  <span class="number">-4</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">-3</span><span class="comment">/*mean (0.234323), correlation (0.476692)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-13</span>, <span class="number">10</span>, <span class="number">-12</span><span class="comment">/*mean (0.236392), correlation (0.475462)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-13</span>, <span class="number">5</span>, <span class="number">-1</span><span class="comment">/*mean (0.236842), correlation (0.504132)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">9</span>, <span class="number">-4</span>, <span class="number">3</span><span class="comment">/*mean (0.236977), correlation (0.497739)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">-9</span><span class="comment">/*mean (0.24314), correlation (0.499398)*/</span>,</span><br><span class="line">  <span class="number">-12</span>, <span class="number">1</span>, <span class="number">-6</span>, <span class="number">1</span><span class="comment">/*mean (0.243297), correlation (0.489447)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">-8</span><span class="comment">/*mean (0.00155196), correlation (0.553496)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-10</span>, <span class="number">-10</span>, <span class="number">9</span><span class="comment">/*mean (0.00239541), correlation (0.54297)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">-13</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.0034413), correlation (0.544361)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-12</span>, <span class="number">-6</span>, <span class="number">-5</span><span class="comment">/*mean (0.003565), correlation (0.551225)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">7</span><span class="comment">/*mean (0.00835583), correlation (0.55285)*/</span>,</span><br><span class="line">  <span class="number">10</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">-8</span><span class="comment">/*mean (0.00885065), correlation (0.540913)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">-12</span><span class="comment">/*mean (0.0101552), correlation (0.551085)*/</span>,</span><br><span class="line">  <span class="number">-7</span>, <span class="number">10</span>, <span class="number">-6</span>, <span class="number">5</span><span class="comment">/*mean (0.0102227), correlation (0.533635)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-9</span>, <span class="number">-3</span>, <span class="number">9</span><span class="comment">/*mean (0.0110211), correlation (0.543121)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-13</span>, <span class="number">-1</span>, <span class="number">5</span><span class="comment">/*mean (0.0113473), correlation (0.550173)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">-7</span>, <span class="number">-3</span>, <span class="number">4</span><span class="comment">/*mean (0.0140913), correlation (0.554774)*/</span>,</span><br><span class="line">  <span class="number">-8</span>, <span class="number">-2</span>, <span class="number">-8</span>, <span class="number">3</span><span class="comment">/*mean (0.017049), correlation (0.55461)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">12</span><span class="comment">/*mean (0.01778), correlation (0.546921)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-5</span>, <span class="number">3</span>, <span class="number">11</span><span class="comment">/*mean (0.0224022), correlation (0.549667)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">-9</span>, <span class="number">11</span>, <span class="number">-13</span><span class="comment">/*mean (0.029161), correlation (0.546295)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-1</span>, <span class="number">7</span>, <span class="number">12</span><span class="comment">/*mean (0.0303081), correlation (0.548599)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-1</span>, <span class="number">12</span>, <span class="number">4</span><span class="comment">/*mean (0.0355151), correlation (0.523943)*/</span>,</span><br><span class="line">  <span class="number">-3</span>, <span class="number">0</span>, <span class="number">-3</span>, <span class="number">6</span><span class="comment">/*mean (0.0417904), correlation (0.543395)*/</span>,</span><br><span class="line">  <span class="number">4</span>, <span class="number">-11</span>, <span class="number">4</span>, <span class="number">12</span><span class="comment">/*mean (0.0487292), correlation (0.542818)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">-4</span>, <span class="number">2</span>, <span class="number">1</span><span class="comment">/*mean (0.0575124), correlation (0.554888)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">-6</span>, <span class="number">-8</span>, <span class="number">1</span><span class="comment">/*mean (0.0594242), correlation (0.544026)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">7</span>, <span class="number">-11</span>, <span class="number">1</span><span class="comment">/*mean (0.0597391), correlation (0.550524)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">12</span>, <span class="number">-11</span>, <span class="number">-13</span><span class="comment">/*mean (0.0608974), correlation (0.55383)*/</span>,</span><br><span class="line">  <span class="number">6</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">-13</span><span class="comment">/*mean (0.065126), correlation (0.552006)*/</span>,</span><br><span class="line">  <span class="number">0</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">4</span><span class="comment">/*mean (0.074224), correlation (0.546372)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">3</span>, <span class="number">-9</span>, <span class="number">-2</span><span class="comment">/*mean (0.0808592), correlation (0.554875)*/</span>,</span><br><span class="line">  <span class="number">-9</span>, <span class="number">8</span>, <span class="number">-6</span>, <span class="number">-3</span><span class="comment">/*mean (0.0883378), correlation (0.551178)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">-6</span>, <span class="number">-8</span>, <span class="number">-2</span><span class="comment">/*mean (0.0901035), correlation (0.548446)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">-9</span>, <span class="number">8</span>, <span class="number">10</span><span class="comment">/*mean (0.0949843), correlation (0.554694)*/</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">-9</span><span class="comment">/*mean (0.0994152), correlation (0.550979)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-6</span>, <span class="number">-1</span>, <span class="number">-1</span><span class="comment">/*mean (0.10045), correlation (0.552714)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">-2</span><span class="comment">/*mean (0.100686), correlation (0.552594)*/</span>,</span><br><span class="line">  <span class="number">11</span>, <span class="number">-3</span>, <span class="number">12</span>, <span class="number">-8</span><span class="comment">/*mean (0.101091), correlation (0.532394)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span><span class="comment">/*mean (0.101147), correlation (0.525576)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">10</span><span class="comment">/*mean (0.105263), correlation (0.531498)*/</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">-6</span>, <span class="number">4</span>, <span class="number">5</span><span class="comment">/*mean (0.110785), correlation (0.540491)*/</span>,</span><br><span class="line">  <span class="number">-13</span>, <span class="number">0</span>, <span class="number">-10</span>, <span class="number">5</span><span class="comment">/*mean (0.112798), correlation (0.536582)*/</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">11</span><span class="comment">/*mean (0.114181), correlation (0.555793)*/</span>,</span><br><span class="line">  <span class="number">8</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">-6</span><span class="comment">/*mean (0.117431), correlation (0.553763)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">-4</span>, <span class="number">8</span>, <span class="number">-12</span><span class="comment">/*mean (0.118522), correlation (0.553452)*/</span>,</span><br><span class="line">  <span class="number">-10</span>, <span class="number">4</span>, <span class="number">-10</span>, <span class="number">9</span><span class="comment">/*mean (0.12094), correlation (0.554785)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">4</span><span class="comment">/*mean (0.122582), correlation (0.555825)*/</span>,</span><br><span class="line">  <span class="number">9</span>, <span class="number">-7</span>, <span class="number">10</span>, <span class="number">-2</span><span class="comment">/*mean (0.124978), correlation (0.549846)*/</span>,</span><br><span class="line">  <span class="number">7</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">-2</span><span class="comment">/*mean (0.127002), correlation (0.537452)*/</span>,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-6</span>, <span class="number">0</span>, <span class="number">-11</span><span class="comment">/*mean (0.127148), correlation (0.547401)*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compute the descriptor</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ComputeORB</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, vector&lt;cv::KeyPoint&gt; &amp;keypoints, vector&lt;DescType&gt; &amp;descriptors)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> half_patch_size = <span class="number">8</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> half_boundary = <span class="number">16</span>;</span><br><span class="line">  <span class="type">int</span> bad_points = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: keypoints) &#123;</span><br><span class="line">    <span class="keyword">if</span> (kp.pt.x &lt; half_boundary || kp.pt.y &lt; half_boundary ||</span><br><span class="line">        kp.pt.x &gt;= img.cols - half_boundary || kp.pt.y &gt;= img.rows - half_boundary) &#123;</span><br><span class="line">      <span class="comment">// outside</span></span><br><span class="line">      bad_points++;</span><br><span class="line">      descriptors.<span class="built_in">push_back</span>(&#123;&#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> m01 = <span class="number">0</span>, m10 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> dx = -half_patch_size; dx &lt; half_patch_size; ++dx) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> dy = -half_patch_size; dy &lt; half_patch_size; ++dy) &#123;</span><br><span class="line">        uchar pixel = img.<span class="built_in">at</span>&lt;uchar&gt;(kp.pt.y + dy, kp.pt.x + dx);</span><br><span class="line">        m10 += dx * pixel;</span><br><span class="line">        m01 += dy * pixel;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// angle should be arc tan(m01/m10);</span></span><br><span class="line">    <span class="type">float</span> m_sqrt = <span class="built_in">sqrt</span>(m01 * m01 + m10 * m10) + <span class="number">1e-18</span>; <span class="comment">// avoid divide by zero</span></span><br><span class="line">    <span class="type">float</span> sin_theta = m01 / m_sqrt;</span><br><span class="line">    <span class="type">float</span> cos_theta = m10 / m_sqrt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compute the angle of this point</span></span><br><span class="line">    <span class="function">DescType <span class="title">desc</span><span class="params">(<span class="number">8</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">      <span class="type">uint32_t</span> d = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">32</span>; k++) &#123;</span><br><span class="line">        <span class="type">int</span> idx_pq = i * <span class="number">32</span> + k;</span><br><span class="line">        <span class="function">cv::Point2f <span class="title">p</span><span class="params">(ORB_pattern[idx_pq * <span class="number">4</span>], ORB_pattern[idx_pq * <span class="number">4</span> + <span class="number">1</span>])</span></span>;</span><br><span class="line">        <span class="function">cv::Point2f <span class="title">q</span><span class="params">(ORB_pattern[idx_pq * <span class="number">4</span> + <span class="number">2</span>], ORB_pattern[idx_pq * <span class="number">4</span> + <span class="number">3</span>])</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rotate with theta</span></span><br><span class="line">        cv::Point2f pp = cv::<span class="built_in">Point2f</span>(cos_theta * p.x - sin_theta * p.y, sin_theta * p.x + cos_theta * p.y)</span><br><span class="line">                         + kp.pt;</span><br><span class="line">        cv::Point2f qq = cv::<span class="built_in">Point2f</span>(cos_theta * q.x - sin_theta * q.y, sin_theta * q.x + cos_theta * q.y)</span><br><span class="line">                         + kp.pt;</span><br><span class="line">        <span class="keyword">if</span> (img.<span class="built_in">at</span>&lt;uchar&gt;(pp.y, pp.x) &lt; img.<span class="built_in">at</span>&lt;uchar&gt;(qq.y, qq.x)) &#123;</span><br><span class="line">          d |= <span class="number">1</span> &lt;&lt; k;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      desc[i] = d;</span><br><span class="line">    &#125;</span><br><span class="line">    descriptors.<span class="built_in">push_back</span>(desc);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;bad/total: &quot;</span> &lt;&lt; bad_points &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; keypoints.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// brute-force matching</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BfMatch</span><span class="params">(<span class="type">const</span> vector&lt;DescType&gt; &amp;desc1, <span class="type">const</span> vector&lt;DescType&gt; &amp;desc2, vector&lt;cv::DMatch&gt; &amp;matches)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> d_max = <span class="number">40</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i1 = <span class="number">0</span>; i1 &lt; desc<span class="number">1.</span><span class="built_in">size</span>(); ++i1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (desc1[i1].<span class="built_in">empty</span>()) <span class="keyword">continue</span>;</span><br><span class="line">    cv::DMatch m&#123;i1, <span class="number">0</span>, <span class="number">256</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i2 = <span class="number">0</span>; i2 &lt; desc<span class="number">2.</span><span class="built_in">size</span>(); ++i2) &#123;</span><br><span class="line">      <span class="keyword">if</span> (desc2[i2].<span class="built_in">empty</span>()) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="type">int</span> distance = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">8</span>; k++) &#123;</span><br><span class="line">        distance += _mm_popcnt_u32(desc1[i1][k] ^ desc2[i2][k]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (distance &lt; d_max &amp;&amp; distance &lt; m.distance) &#123;</span><br><span class="line">        m.distance = distance;</span><br><span class="line">        m.trainIdx = i2;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m.distance &lt; d_max) &#123;</span><br><span class="line">      matches.<span class="built_in">push_back</span>(m);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE &quot;Release&quot;)</span><br><span class="line">add_definitions(&quot;-DENABLE_SSE&quot;)</span><br><span class="line">set(CMAKE_CXX_FLAGS &quot;-std=c++11 -O2 $&#123;SSE_FLAGS&#125; -msse4&quot;)</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line">include_directories(</span><br><span class="line">        $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">        $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">        &quot;/usr/include/eigen3/&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(orb_self orb_self.cpp)</span><br><span class="line">target_link_libraries(orb_self $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># # add_executable( pose_estimation_2d2d pose_estimation_2d2d.cpp extra.cpp ) # use this if in OpenCV2 </span><br><span class="line"># add_executable(pose_estimation_2d2d pose_estimation_2d2d.cpp)</span><br><span class="line"># target_link_libraries(pose_estimation_2d2d $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># # add_executable( triangulation triangulation.cpp extra.cpp) # use this if in opencv2</span><br><span class="line"># add_executable(triangulation triangulation.cpp)</span><br><span class="line"># target_link_libraries(triangulation $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># add_executable(pose_estimation_3d2d pose_estimation_3d2d.cpp)</span><br><span class="line"># target_link_libraries(pose_estimation_3d2d</span><br><span class="line">#         g2o_core g2o_stuff</span><br><span class="line">#         $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># add_executable(pose_estimation_3d3d pose_estimation_3d3d.cpp)</span><br><span class="line"># target_link_libraries(pose_estimation_3d3d</span><br><span class="line">#         g2o_core g2o_stuff</span><br><span class="line">#         $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./orb_self </span><br><span class="line">bad/total: 43/638</span><br><span class="line">bad/total: 8/595</span><br><span class="line">extract ORB cost = 0.00315124 seconds. </span><br><span class="line">match ORB cost = 0.000610558 seconds. </span><br><span class="line">matches: 41</span><br><span class="line">done.</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827155518212.png" alt="image-20250827155518212"></p>
<h3 id="计算相机运动"><a href="#计算相机运动" class="headerlink" title="计算相机运动"></a>计算相机运动</h3><p>既然已经有了匹配好的点对，接下来要根据点对估计相机的运动，根据相机的原理不同，有以下几种情况：</p>
<ol>
<li>单目相机：只知道2D的像素坐标，因而问题时根据两组2D点估计运动，该问题使用对极几何解决</li>
<li>双目相机、RGB-D：根据两组3D点估计运动，问题通常是ICP解决。</li>
<li>如果是一组3D一组2D，可以得到一些3D点和他们在相机的投影位置，也能估计相机的运动，通过PNP求解</li>
</ol>
<hr>
<h2 id="2D-2D：对极几何"><a href="#2D-2D：对极几何" class="headerlink" title="2D-2D：对极几何"></a>2D-2D：对极几何</h2><h3 id="对极约束"><a href="#对极约束" class="headerlink" title="对极约束"></a>对极约束</h3><p>具体见教材，对极约束简洁地给出了两个匹配点的空间位置关系，于是相机位姿估计问题变成以下两步：</p>
<ol>
<li>根据配对点的像素位置求出<strong>基础矩阵</strong>$F$或者<strong>本质矩阵</strong>$E$。</li>
<li>根据$E$或者$F$求出$R, t$.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-001a34da8a921ed05fe5b0d753991fb1_1440w.jpg" alt="对极几何 Epipolar Geometry - 知乎"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827165450871.png" alt="image-20250827165450871"></p>
<p>由于$E$和$F$只是相差相机内参，所以实践中往往使用形式更简单的$E$。</p>
<hr>
<h3 id="本质矩阵"><a href="#本质矩阵" class="headerlink" title="本质矩阵"></a>本质矩阵</h3><p>本质矩阵是一个3X3矩阵，总共有5个自由度，使用8对点来估计$E$——<strong>八点法</strong>。八点法只利用了$E$的线性性质，可以在线性代数的框架下求解。会得到4个可能的解，但是只有一种解中$P$在两个相机中都有正的深度，因此只需要把任意一点带入4种解中，检测该点在两个相机下的深度，就可以确定正确的解了。</p>
<h3 id="单应矩阵"><a href="#单应矩阵" class="headerlink" title="单应矩阵"></a>单应矩阵</h3><p>除了基本矩阵和本质矩阵，二视图几何中还存在另一种常见矩阵：单应矩阵$H$，描述两个平面之间的映射关系，如果场景中特征点都落在同一平面上，可以通过单应性进行运动估计。</p>
<p>单应性在SLAM中具有重要意义，当特征点共面或者相机发生纯旋转，基础矩阵自由度下降，出现退化，这时候就需要使用基础矩阵和单应矩阵，选择误差较小的作为最终的运动估计矩阵。</p>
<hr>
<h2 id="实践：对极约束求解相机运动"><a href="#实践：对极约束求解相机运动" class="headerlink" title="实践：对极约束求解相机运动"></a>实践：对极约束求解相机运动</h2><p>新建文件<code>slambook/ch7/pose_estimation_2d2d.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/calib3d/calib3d.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;DMatch&gt; &amp;matches)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_2d2d</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;DMatch&gt; matches,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;usage: pose_estimation_2d2d img1 img2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//-- 读取图像</span></span><br><span class="line">  <span class="comment">// 【修改1】使用 cv::IMREAD_COLOR 替换 CV_LOAD_IMAGE_COLOR</span></span><br><span class="line">  Mat img_1 = <span class="built_in">imread</span>(argv[<span class="number">1</span>], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = <span class="built_in">imread</span>(argv[<span class="number">2</span>], cv::IMREAD_COLOR);</span><br><span class="line">  <span class="built_in">assert</span>(img_<span class="number">1.</span>data &amp;&amp; img_<span class="number">2.</span>data &amp;&amp; <span class="string">&quot;Can not load images!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  <span class="built_in">find_feature_matches</span>(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;一共找到了&quot;</span> &lt;&lt; matches.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;组匹配点&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 估计两张图像间运动</span></span><br><span class="line">  Mat R, t;</span><br><span class="line">  <span class="built_in">pose_estimation_2d2d</span>(keypoints_1, keypoints_2, matches, R, t);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 验证E=t^R*scale</span></span><br><span class="line">  Mat t_x =</span><br><span class="line">    (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">0</span>, -t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>, <span class="number">0</span>), t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">      t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>, <span class="number">0</span>), <span class="number">0</span>, -t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">      -t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">0</span>), t.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t^R=&quot;</span> &lt;&lt; endl &lt;&lt; t_x * R &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 验证对极约束</span></span><br><span class="line">  Mat K = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span> (DMatch m: matches) &#123;</span><br><span class="line">    Point2d pt1 = <span class="built_in">pixel2cam</span>(keypoints_1[m.queryIdx].pt, K);</span><br><span class="line">    Mat y1 = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; pt<span class="number">1.</span>x, pt<span class="number">1.</span>y, <span class="number">1</span>);</span><br><span class="line">    Point2d pt2 = <span class="built_in">pixel2cam</span>(keypoints_2[m.trainIdx].pt, K);</span><br><span class="line">    Mat y2 = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; pt<span class="number">2.</span>x, pt<span class="number">2.</span>y, <span class="number">1</span>);</span><br><span class="line">    Mat d = y<span class="number">2.</span><span class="built_in">t</span>() * t_x * R * y1;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;epipolar constraint = &quot;</span> &lt;&lt; d &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(<span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;DMatch&gt; &amp;matches)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//-- 初始化</span></span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  <span class="comment">// 【修改3】使用统一的 ORB 对象</span></span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">1.2f</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, ORB::HARRIS_SCORE, <span class="number">31</span>, <span class="number">20</span>);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第一步:检测 Oriented FAST 角点位置</span></span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_1, keypoints_1);</span><br><span class="line">  orb-&gt;<span class="built_in">detect</span>(img_2, keypoints_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第二步:根据角点位置计算 BRIEF 描述子</span></span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_1, keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;<span class="built_in">compute</span>(img_2, keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span></span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;<span class="built_in">match</span>(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 第四步:匹配点对筛选</span></span><br><span class="line">  <span class="type">double</span> min_dist = <span class="number">10000</span>, max_dist = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="type">double</span> dist = match[i].distance;</span><br><span class="line">    <span class="keyword">if</span> (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    <span class="keyword">if</span> (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Max dist : %f \n&quot;</span>, max_dist);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Min dist : %f \n&quot;</span>, min_dist);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (match[i].distance &lt;= <span class="built_in">max</span>(<span class="number">2</span> * min_dist, <span class="number">30.0</span>)) &#123;</span><br><span class="line">      matches.<span class="built_in">push_back</span>(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Point2d</span>(</span><br><span class="line">    (p.x - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    (p.y - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_2d2d</span><span class="params">(std::vector&lt;KeyPoint&gt; keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;DMatch&gt; matches,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Mat &amp;R, Mat &amp;t)</span> </span>&#123;</span><br><span class="line">  Mat K = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  vector&lt;Point2f&gt; points1;</span><br><span class="line">  vector&lt;Point2f&gt; points2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="type">int</span>) matches.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    points<span class="number">1.</span><span class="built_in">push_back</span>(keypoints_1[matches[i].queryIdx].pt);</span><br><span class="line">    points<span class="number">2.</span><span class="built_in">push_back</span>(keypoints_2[matches[i].trainIdx].pt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 计算基础矩阵</span></span><br><span class="line">  Mat fundamental_matrix;</span><br><span class="line">  <span class="comment">// 【修改2】使用 cv::FM_8POINT 替换 CV_FM_8POINT</span></span><br><span class="line">  fundamental_matrix = <span class="built_in">findFundamentalMat</span>(points1, points2, cv::FM_8POINT);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;fundamental_matrix is &quot;</span> &lt;&lt; endl &lt;&lt; fundamental_matrix &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 计算本质矩阵</span></span><br><span class="line">  <span class="function">Point2d <span class="title">principal_point</span><span class="params">(<span class="number">325.1</span>, <span class="number">249.7</span>)</span></span>;</span><br><span class="line">  <span class="type">double</span> focal_length = <span class="number">521</span>;</span><br><span class="line">  Mat essential_matrix;</span><br><span class="line">  essential_matrix = <span class="built_in">findEssentialMat</span>(points1, points2, focal_length, principal_point);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;essential_matrix is &quot;</span> &lt;&lt; endl &lt;&lt; essential_matrix &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 计算单应矩阵</span></span><br><span class="line">  Mat homography_matrix;</span><br><span class="line">  homography_matrix = <span class="built_in">findHomography</span>(points1, points2, RANSAC, <span class="number">3</span>);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;homography_matrix is &quot;</span> &lt;&lt; endl &lt;&lt; homography_matrix &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 从本质矩阵中恢复旋转和平移信息.</span></span><br><span class="line">  <span class="built_in">recoverPose</span>(essential_matrix, points1, points2, R, t, focal_length, principal_point);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;R is &quot;</span> &lt;&lt; endl &lt;&lt; R &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t is &quot;</span> &lt;&lt; endl &lt;&lt; t &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改一下CmakeLists.txt</p>
<p>输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./pose_estimation_2d2d ../1.png ../2.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">fundamental_matrix is </span><br><span class="line">[4.54443750398184e-06, 0.0001333855576992603, -0.01798499246479044;</span><br><span class="line"> -0.0001275657012964255, 2.266794804645652e-05, -0.01416678429206633;</span><br><span class="line"> 0.01814994639971766, 0.004146055870980492, 1]</span><br><span class="line">essential_matrix is </span><br><span class="line">[-0.008455114492964278, 0.05451570701059781, 0.1546375809484052;</span><br><span class="line"> -0.008287154708445212, 0.03351311565984172, -0.6896472136971504;</span><br><span class="line"> -0.1153993974485718, 0.6945899967012867, 0.02159624094256633]</span><br><span class="line">homography_matrix is </span><br><span class="line">[0.926121428117554, -0.1445322024509823, 33.26921085699323;</span><br><span class="line"> 0.04535424464910425, 0.9386696693816733, 8.570979966717408;</span><br><span class="line"> -1.006197561051851e-05, -3.008140280167667e-05, 1]</span><br><span class="line">R is </span><br><span class="line">[0.9956584940813579, -0.05615340406690447, 0.07423582945816433;</span><br><span class="line"> 0.05268846331440004, 0.9974645001566195, 0.04783823534446425;</span><br><span class="line"> -0.07673388428334535, -0.0437191735855581, 0.9960926386957119]</span><br><span class="line">t is </span><br><span class="line">[-0.9726703113454949;</span><br><span class="line"> -0.2153829834753195;</span><br><span class="line"> 0.08673313009645391]</span><br><span class="line">t^R=</span><br><span class="line">[0.01195733758736675, -0.07709685221674556, -0.2186905642298021;</span><br><span class="line"> 0.01171980658216709, -0.04739470268352609, 0.9753084428633267;</span><br><span class="line"> 0.1631993929614534, -0.9822985936236425, -0.03054169683725466]</span><br><span class="line">epipolar constraint = [-0.0005617285518606241]</span><br><span class="line">epipolar constraint = [0.002891683190146016]</span><br><span class="line">epipolar constraint = [-0.0001941259398173245]</span><br><span class="line">epipolar constraint = [0.003462947761727536]</span><br><span class="line">epipolar constraint = [8.120001470268701e-06]</span><br><span class="line">epipolar constraint = [0.002710644239222917]</span><br><span class="line">epipolar constraint = [-0.001869251694575136]</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>输出计算好的$E F H$还有$R, t$​还有对极约束精度。</p>
<p>由于$E$本身具有尺度等价性，它分解得到的$t,R$有一个尺度等价性，也就是说，结果只是一个尺度，通常是归一化的结果，所以会导致单目视觉的尺度不确定性，并且<strong>单目初始化不能只有旋转，必须有一定程度上的平移</strong>，否则就无法求解$R$。</p>
<hr>
<h2 id="三角测量"><a href="#三角测量" class="headerlink" title="三角测量"></a>三角测量</h2><p>上一步已经使用对极几何约束估计了相机的运动，在得到运动之后，下一步需要采用相机的运动估计特征点的空间位置。在单目SLAM中，无法使用单张图片获得像素的深度信息，需要通过<strong>三角测量</strong>的方法估计地图点的深度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-ab9b8efbec920fc566c4b9a05a7d3e96_r.jpg" alt="视觉SLAM十四讲学习笔记-第七讲-视觉里程计-三角测量和实践 - 知乎"></p>
<hr>
<h2 id="实践：三角测量"><a href="#实践：三角测量" class="headerlink" title="实践：三角测量"></a>实践：三角测量</h2><h3 id="三角测量代码"><a href="#三角测量代码" class="headerlink" title="三角测量代码"></a>三角测量代码</h3><p>新建文件<code>slambook/ch7/triangulation.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;opencv2/opencv.hpp&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line">using namespace cv;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(</span><br><span class="line">  const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  std::vector&lt;DMatch&gt; &amp;matches);</span><br><span class="line"></span><br><span class="line">void pose_estimation_2d2d(</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  Mat &amp;R, Mat &amp;t);</span><br><span class="line"></span><br><span class="line">void triangulation(</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_1,</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  const Mat &amp;R, const Mat &amp;t,</span><br><span class="line">  vector&lt;Point3d&gt; &amp;points</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">/// 作图用</span><br><span class="line">inline cv::Scalar get_color(float depth) &#123;</span><br><span class="line">  float up_th = 50, low_th = 10, th_range = up_th - low_th;</span><br><span class="line">  if (depth &gt; up_th) depth = up_th;</span><br><span class="line">  if (depth &lt; low_th) depth = low_th;</span><br><span class="line">  return cv::Scalar(255 * depth / th_range, 0, 255 * (1 - depth / th_range));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 像素坐标转相机归一化坐标</span><br><span class="line">Point2f pixel2cam(const Point2d &amp;p, const Mat &amp;K);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  if (argc != 3) &#123;</span><br><span class="line">    cout &lt;&lt; &quot;usage: triangulation img1 img2&quot; &lt;&lt; endl;</span><br><span class="line">    return 1;</span><br><span class="line">  &#125;</span><br><span class="line">  //-- 读取图像</span><br><span class="line">  // 【修改1】使用 cv::IMREAD_COLOR 替换旧的宏</span><br><span class="line">  Mat img_1 = imread(argv[1], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = imread(argv[2], cv::IMREAD_COLOR);</span><br><span class="line"></span><br><span class="line">  if (img_1.empty() || img_2.empty()) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;Could not open or find the images!&quot; &lt;&lt; endl;</span><br><span class="line">      return 1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  find_feature_matches(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; &quot;一共找到了&quot; &lt;&lt; matches.size() &lt;&lt; &quot;组匹配点&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  //-- 估计两张图像间运动</span><br><span class="line">  Mat R, t;</span><br><span class="line">  pose_estimation_2d2d(keypoints_1, keypoints_2, matches, R, t);</span><br><span class="line"></span><br><span class="line">  //-- 三角化</span><br><span class="line">  vector&lt;Point3d&gt; points;</span><br><span class="line">  triangulation(keypoints_1, keypoints_2, matches, R, t, points);</span><br><span class="line"></span><br><span class="line">  //-- 验证三角化点与特征点的重投影关系</span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line">  Mat img1_plot = img_1.clone();</span><br><span class="line">  Mat img2_plot = img_2.clone();</span><br><span class="line">  for (size_t i = 0; i &lt; matches.size(); i++) &#123;</span><br><span class="line">    // 第一个图</span><br><span class="line">    float depth1 = points[i].z;</span><br><span class="line">    if (depth1 &gt; 0) &#123; // 只显示深度为正的点</span><br><span class="line">        cout &lt;&lt; &quot;depth: &quot; &lt;&lt; depth1 &lt;&lt; endl;</span><br><span class="line">        cv::circle(img1_plot, keypoints_1[matches[i].queryIdx].pt, 2, get_color(depth1), 2);</span><br><span class="line"></span><br><span class="line">        // 第二个图</span><br><span class="line">        Mat pt2_trans = R * (Mat_&lt;double&gt;(3, 1) &lt;&lt; points[i].x, points[i].y, points[i].z) + t;</span><br><span class="line">        float depth2 = pt2_trans.at&lt;double&gt;(2, 0);</span><br><span class="line">        cv::circle(img2_plot, keypoints_2[matches[i].trainIdx].pt, 2, get_color(depth2), 2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cv::imshow(&quot;img 1&quot;, img1_plot);</span><br><span class="line">  cv::imshow(&quot;img 2&quot;, img2_plot);</span><br><span class="line">  cv::waitKey();</span><br><span class="line"></span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">                          std::vector&lt;DMatch&gt; &amp;matches) &#123;</span><br><span class="line">  //-- 初始化</span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  // 【修改2】使用统一的 ORB 对象以兼容 OpenCV 4</span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::create(500, 1.2f, 8, 31, 0, 2, ORB::HARRIS_SCORE, 31, 20);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::create(&quot;BruteForce-Hamming&quot;);</span><br><span class="line">  </span><br><span class="line">  //-- 第一步:检测 Oriented FAST 角点位置</span><br><span class="line">  orb-&gt;detect(img_1, keypoints_1);</span><br><span class="line">  orb-&gt;detect(img_2, keypoints_2);</span><br><span class="line"></span><br><span class="line">  //-- 第二步:根据角点位置计算 BRIEF 描述子</span><br><span class="line">  orb-&gt;compute(img_1, keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;compute(img_2, keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  //-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;match(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  //-- 第四步:匹配点对筛选</span><br><span class="line">  double min_dist = 10000, max_dist = 0;</span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    double dist = match[i].distance;</span><br><span class="line">    if (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    if (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printf(&quot;-- Max dist : %f \n&quot;, max_dist);</span><br><span class="line">  printf(&quot;-- Min dist : %f \n&quot;, min_dist);</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    if (match[i].distance &lt;= max(2 * min_dist, 30.0)) &#123;</span><br><span class="line">      matches.push_back(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void pose_estimation_2d2d(</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  const std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  Mat &amp;R, Mat &amp;t) &#123;</span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line"></span><br><span class="line">  vector&lt;Point2f&gt; points1;</span><br><span class="line">  vector&lt;Point2f&gt; points2;</span><br><span class="line"></span><br><span class="line">  for (size_t i = 0; i &lt; matches.size(); i++) &#123;</span><br><span class="line">    points1.push_back(keypoints_1[matches[i].queryIdx].pt);</span><br><span class="line">    points2.push_back(keypoints_2[matches[i].trainIdx].pt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Point2d principal_point(325.1, 249.7);</span><br><span class="line">  double focal_length = 521;</span><br><span class="line">  Mat essential_matrix;</span><br><span class="line">  essential_matrix = findEssentialMat(points1, points2, focal_length, principal_point);</span><br><span class="line"></span><br><span class="line">  recoverPose(essential_matrix, points1, points2, R, t, focal_length, principal_point);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void triangulation(</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_1,</span><br><span class="line">  const vector&lt;KeyPoint&gt; &amp;keypoint_2,</span><br><span class="line">  const std::vector&lt;DMatch&gt; &amp;matches,</span><br><span class="line">  const Mat &amp;R, const Mat &amp;t,</span><br><span class="line">  vector&lt;Point3d&gt; &amp;points) &#123;</span><br><span class="line">  // 注意 T1 和 T2 的数据类型应与 R, t 一致 (double)</span><br><span class="line">  Mat T1 = (Mat_&lt;double&gt;(3, 4) &lt;&lt;</span><br><span class="line">    1, 0, 0, 0,</span><br><span class="line">    0, 1, 0, 0,</span><br><span class="line">    0, 0, 1, 0);</span><br><span class="line">  Mat T2 = (Mat_&lt;double&gt;(3, 4) &lt;&lt;</span><br><span class="line">    R.at&lt;double&gt;(0, 0), R.at&lt;double&gt;(0, 1), R.at&lt;double&gt;(0, 2), t.at&lt;double&gt;(0, 0),</span><br><span class="line">    R.at&lt;double&gt;(1, 0), R.at&lt;double&gt;(1, 1), R.at&lt;double&gt;(1, 2), t.at&lt;double&gt;(1, 0),</span><br><span class="line">    R.at&lt;double&gt;(2, 0), R.at&lt;double&gt;(2, 1), R.at&lt;double&gt;(2, 2), t.at&lt;double&gt;(2, 0)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line">  vector&lt;Point2f&gt; pts_1, pts_2;</span><br><span class="line">  for (const DMatch &amp;m:matches) &#123;</span><br><span class="line">    pts_1.push_back(pixel2cam(keypoint_1[m.queryIdx].pt, K));</span><br><span class="line">    pts_2.push_back(pixel2cam(keypoint_2[m.trainIdx].pt, K));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Mat pts_4d;</span><br><span class="line">  cv::triangulatePoints(T1, T2, pts_1, pts_2, pts_4d);</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; pts_4d.cols; i++) &#123;</span><br><span class="line">    Mat x = pts_4d.col(i);</span><br><span class="line">    x /= x.at&lt;double&gt;(3, 0); // 归一化，注意数据类型为 double</span><br><span class="line">    Point3d p(</span><br><span class="line">      x.at&lt;double&gt;(0, 0),</span><br><span class="line">      x.at&lt;double&gt;(1, 0),</span><br><span class="line">      x.at&lt;double&gt;(2, 0)</span><br><span class="line">    );</span><br><span class="line">    points.push_back(p);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Point2f pixel2cam(const Point2d &amp;p, const Mat &amp;K) &#123;</span><br><span class="line">  return Point2f(</span><br><span class="line">    (p.x - K.at&lt;double&gt;(0, 2)) / K.at&lt;double&gt;(0, 0),</span><br><span class="line">    (p.y - K.at&lt;double&gt;(1, 2)) / K.at&lt;double&gt;(1, 1)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./triangulation ../1.png ../2.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">depth: inf</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827194058967.png" alt="image-20250827194058967"></p>
<p>当平移很小时，像素上的不确定性将导致较大的深度的不确定性，即平移越大，同样的相机分辨率下，三角化测量将更为精确。在单目视觉中，由于三角化存在视差，需要等待特征点被追踪几帧之后，产生足够的视角，再利用三角化来确定新增的特征点的深度值，这被称为：<strong>延迟三角化</strong>，但是最好相机不要发生原地旋转的情况。往往会导致追踪失败、尺度不正确等问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827194814134.png" alt="image-20250827194814134"></p>
<h2 id="3D-2D-PnP"><a href="#3D-2D-PnP" class="headerlink" title="3D-2D: PnP"></a>3D-2D: PnP</h2><p>PnP（Perspective-n-Point）是求解3D到2D点对运动的方法，描述当知道n个3D空间点及其投影位置时，如何估计相机的位姿。如果两张图像中的一张特征点的3D位置一直，那么最少需要3个点对就可以估计相机运动。特征点的3D位置可以由三角化或者RGB-D相机的深度图获取。所以可以直接在双目或者RGB-D的视觉里程计中使用PnP估计相机运动，但是在单目视觉里程计中，需要先进行初始化，才能使用PnP。</p>
<p>PnP有多种求解方法，P3P、直接线性变换(DLT)、EPnP、UPnP等等。还有光束法平差BA。</p>
<h3 id="直接线性变换"><a href="#直接线性变换" class="headerlink" title="直接线性变换"></a>直接线性变换</h3><h3 id="P3P"><a href="#P3P" class="headerlink" title="P3P"></a>P3P</h3><h3 id="最小化重投影误差求解PnP"><a href="#最小化重投影误差求解PnP" class="headerlink" title="最小化重投影误差求解PnP"></a>最小化重投影误差求解PnP</h3><hr>
<h2 id="实践：求解PnP"><a href="#实践：求解PnP" class="headerlink" title="实践：求解PnP"></a>实践：求解PnP</h2><p>新建文件<code>slambook/ch7/pose_estimation_3d2d.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;opencv2/core/core.hpp&gt;</span><br><span class="line">#include &lt;opencv2/features2d/features2d.hpp&gt;</span><br><span class="line">#include &lt;opencv2/highgui/highgui.hpp&gt;</span><br><span class="line">#include &lt;opencv2/calib3d/calib3d.hpp&gt;</span><br><span class="line">#include &lt;Eigen/Core&gt;</span><br><span class="line">#include &lt;g2o/core/base_vertex.h&gt;</span><br><span class="line">#include &lt;g2o/core/base_unary_edge.h&gt;</span><br><span class="line">#include &lt;g2o/core/sparse_optimizer.h&gt;</span><br><span class="line">#include &lt;g2o/core/block_solver.h&gt;</span><br><span class="line">#include &lt;g2o/core/solver.h&gt;</span><br><span class="line">#include &lt;g2o/core/optimization_algorithm_gauss_newton.h&gt;</span><br><span class="line">#include &lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span><br><span class="line">#include &lt;sophus/se3.hpp&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line">#include &lt;memory&gt; // 包含 &lt;memory&gt; 以使用 std::make_unique</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line">using namespace cv;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(</span><br><span class="line">  const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">  std::vector&lt;DMatch&gt; &amp;matches);</span><br><span class="line"></span><br><span class="line">// 像素坐标转相机归一化坐标</span><br><span class="line">Point2d pixel2cam(const Point2d &amp;p, const Mat &amp;K);</span><br><span class="line"></span><br><span class="line">// BA by g2o</span><br><span class="line">typedef vector&lt;Eigen::Vector2d, Eigen::aligned_allocator&lt;Eigen::Vector2d&gt;&gt; VecVector2d;</span><br><span class="line">typedef vector&lt;Eigen::Vector3d, Eigen::aligned_allocator&lt;Eigen::Vector3d&gt;&gt; VecVector3d;</span><br><span class="line"></span><br><span class="line">void bundleAdjustmentG2O(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// BA by gauss-newton</span><br><span class="line">void bundleAdjustmentGaussNewton(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  if (argc != 5) &#123;</span><br><span class="line">    cout &lt;&lt; &quot;usage: pose_estimation_3d2d img1 img2 depth1 depth2&quot; &lt;&lt; endl;</span><br><span class="line">    return 1;</span><br><span class="line">  &#125;</span><br><span class="line">  //-- 读取图像</span><br><span class="line">  Mat img_1 = imread(argv[1], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = imread(argv[2], cv::IMREAD_COLOR);</span><br><span class="line">  Mat d1 = imread(argv[3], cv::IMREAD_UNCHANGED);       // 深度图为16位无符号数，单通道图像</span><br><span class="line">  </span><br><span class="line">  if (img_1.empty() || img_2.empty() || d1.empty()) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;Could not open or find the images!&quot; &lt;&lt; endl;</span><br><span class="line">      return 1;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  find_feature_matches(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; &quot;一共找到了&quot; &lt;&lt; matches.size() &lt;&lt; &quot;组匹配点&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  // 建立3D点</span><br><span class="line">  Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 520.9, 0, 325.1, 0, 521.0, 249.7, 0, 0, 1);</span><br><span class="line">  vector&lt;Point3f&gt; pts_3d;</span><br><span class="line">  vector&lt;Point2f&gt; pts_2d;</span><br><span class="line">  for (DMatch m:matches) &#123;</span><br><span class="line">    ushort d = d1.ptr&lt;unsigned short&gt;(int(keypoints_1[m.queryIdx].pt.y))[int(keypoints_1[m.queryIdx].pt.x)];</span><br><span class="line">    if (d == 0)   // bad depth</span><br><span class="line">      continue;</span><br><span class="line">    float dd = d / 5000.0;</span><br><span class="line">    Point2d p1 = pixel2cam(keypoints_1[m.queryIdx].pt, K);</span><br><span class="line">    pts_3d.push_back(Point3f(p1.x * dd, p1.y * dd, dd));</span><br><span class="line">    pts_2d.push_back(keypoints_2[m.trainIdx].pt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;3d-2d pairs: &quot; &lt;&lt; pts_3d.size() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">  Mat r, t;</span><br><span class="line">  solvePnP(pts_3d, pts_2d, K, Mat(), r, t, false); // 调用OpenCV 的 PnP 求解</span><br><span class="line">  Mat R;</span><br><span class="line">  cv::Rodrigues(r, R); // r为旋转向量形式，用Rodrigues公式转换为矩阵</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">  chrono::duration&lt;double&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;solve pnp in opencv cost time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;R=&quot; &lt;&lt; endl &lt;&lt; R &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; &quot;t=&quot; &lt;&lt; endl &lt;&lt; t &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  VecVector3d pts_3d_eigen;</span><br><span class="line">  VecVector2d pts_2d_eigen;</span><br><span class="line">  for (size_t i = 0; i &lt; pts_3d.size(); ++i) &#123;</span><br><span class="line">    pts_3d_eigen.push_back(Eigen::Vector3d(pts_3d[i].x, pts_3d[i].y, pts_3d[i].z));</span><br><span class="line">    pts_2d_eigen.push_back(Eigen::Vector2d(pts_2d[i].x, pts_2d[i].y));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;calling bundle adjustment by gauss newton&quot; &lt;&lt; endl;</span><br><span class="line">  Sophus::SE3d pose_gn;</span><br><span class="line">  t1 = chrono::steady_clock::now();</span><br><span class="line">  bundleAdjustmentGaussNewton(pts_3d_eigen, pts_2d_eigen, K, pose_gn);</span><br><span class="line">  t2 = chrono::steady_clock::now();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;solve pnp by gauss newton cost time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; &quot;calling bundle adjustment by g2o&quot; &lt;&lt; endl;</span><br><span class="line">  Sophus::SE3d pose_g2o;</span><br><span class="line">  t1 = chrono::steady_clock::now();</span><br><span class="line">  bundleAdjustmentG2O(pts_3d_eigen, pts_2d_eigen, K, pose_g2o);</span><br><span class="line">  t2 = chrono::steady_clock::now();</span><br><span class="line">  time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;solve pnp by g2o cost time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void find_feature_matches(const Mat &amp;img_1, const Mat &amp;img_2,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span><br><span class="line">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span><br><span class="line">                          std::vector&lt;DMatch&gt; &amp;matches) &#123;</span><br><span class="line">  //-- 初始化</span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::create(500, 1.2f, 8, 31, 0, 2, ORB::HARRIS_SCORE, 31, 20);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::create(&quot;BruteForce-Hamming&quot;);</span><br><span class="line">  </span><br><span class="line">  //-- 检测和计算</span><br><span class="line">  orb-&gt;detectAndCompute(img_1, Mat(), keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;detectAndCompute(img_2, Mat(), keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  //-- 匹配</span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;match(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  //-- 筛选</span><br><span class="line">  double min_dist = 10000, max_dist = 0;</span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    double dist = match[i].distance;</span><br><span class="line">    if (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    if (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printf(&quot;-- Max dist : %f \n&quot;, max_dist);</span><br><span class="line">  printf(&quot;-- Min dist : %f \n&quot;, min_dist);</span><br><span class="line">  </span><br><span class="line">  for (int i = 0; i &lt; descriptors_1.rows; i++) &#123;</span><br><span class="line">    if (match[i].distance &lt;= max(2 * min_dist, 30.0)) &#123;</span><br><span class="line">      matches.push_back(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Point2d pixel2cam(const Point2d &amp;p, const Mat &amp;K) &#123;</span><br><span class="line">  return Point2d(</span><br><span class="line">    (p.x - K.at&lt;double&gt;(0, 2)) / K.at&lt;double&gt;(0, 0),</span><br><span class="line">    (p.y - K.at&lt;double&gt;(1, 2)) / K.at&lt;double&gt;(1, 1)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void bundleAdjustmentGaussNewton(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose) &#123;</span><br><span class="line">  typedef Eigen::Matrix&lt;double, 6, 1&gt; Vector6d;</span><br><span class="line">  const int iterations = 10;</span><br><span class="line">  double cost = 0, lastCost = 0;</span><br><span class="line">  double fx = K.at&lt;double&gt;(0, 0);</span><br><span class="line">  double fy = K.at&lt;double&gt;(1, 1);</span><br><span class="line">  double cx = K.at&lt;double&gt;(0, 2);</span><br><span class="line">  double cy = K.at&lt;double&gt;(1, 2);</span><br><span class="line"></span><br><span class="line">  for (int iter = 0; iter &lt; iterations; iter++) &#123;</span><br><span class="line">    Eigen::Matrix&lt;double, 6, 6&gt; H = Eigen::Matrix&lt;double, 6, 6&gt;::Zero();</span><br><span class="line">    Vector6d b = Vector6d::Zero();</span><br><span class="line"></span><br><span class="line">    cost = 0;</span><br><span class="line">    for (int i = 0; i &lt; points_3d.size(); i++) &#123;</span><br><span class="line">      Eigen::Vector3d pc = pose * points_3d[i];</span><br><span class="line">      double inv_z = 1.0 / pc[2];</span><br><span class="line">      double inv_z2 = inv_z * inv_z;</span><br><span class="line">      Eigen::Vector2d proj(fx * pc[0] * inv_z + cx, fy * pc[1] * inv_z + cy);</span><br><span class="line">      Eigen::Vector2d e = points_2d[i] - proj;</span><br><span class="line">      cost += e.squaredNorm();</span><br><span class="line">      Eigen::Matrix&lt;double, 2, 6&gt; J;</span><br><span class="line">      J &lt;&lt; -fx * inv_z, 0, fx * pc[0] * inv_z2, fx * pc[0] * pc[1] * inv_z2, -fx - fx * pc[0] * pc[0] * inv_z2, fx * pc[1] * inv_z,</span><br><span class="line">           0, -fy * inv_z, fy * pc[1] * inv_z2, fy + fy * pc[1] * pc[1] * inv_z2, -fy * pc[0] * pc[1] * inv_z2, -fy * pc[0] * inv_z;</span><br><span class="line">      H += J.transpose() * J;</span><br><span class="line">      b += -J.transpose() * e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector6d dx = H.ldlt().solve(b);</span><br><span class="line">    if (isnan(dx[0])) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;result is nan!&quot; &lt;&lt; endl;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    if (iter &gt; 0 &amp;&amp; cost &gt;= lastCost) &#123;</span><br><span class="line">      cout &lt;&lt; &quot;cost: &quot; &lt;&lt; cost &lt;&lt; &quot;, last cost: &quot; &lt;&lt; lastCost &lt;&lt; endl;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">    pose = Sophus::SE3d::exp(dx) * pose;</span><br><span class="line">    lastCost = cost;</span><br><span class="line">    cout &lt;&lt; &quot;iteration &quot; &lt;&lt; iter &lt;&lt; &quot; cost=&quot; &lt;&lt; std::setprecision(12) &lt;&lt; cost &lt;&lt; endl;</span><br><span class="line">    if (dx.norm() &lt; 1e-6) break;</span><br><span class="line">  &#125;</span><br><span class="line">  cout &lt;&lt; &quot;pose by g-n: \n&quot; &lt;&lt; pose.matrix() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// g2o 自定义顶点和边</span><br><span class="line">class VertexPose : public g2o::BaseVertex&lt;6, Sophus::SE3d&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line">  virtual void setToOriginImpl() override &#123; _estimate = Sophus::SE3d(); &#125;</span><br><span class="line">  virtual void oplusImpl(const double *update) override &#123;</span><br><span class="line">    Eigen::Matrix&lt;double, 6, 1&gt; update_eigen;</span><br><span class="line">    update_eigen &lt;&lt; update[0], update[1], update[2], update[3], update[4], update[5];</span><br><span class="line">    _estimate = Sophus::SE3d::exp(update_eigen) * _estimate;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line">  virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class EdgeProjection : public g2o::BaseUnaryEdge&lt;2, Eigen::Vector2d, VertexPose&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line">  EdgeProjection(const Eigen::Vector3d &amp;pos, const Eigen::Matrix3d &amp;K) : _pos3d(pos), _K(K) &#123;&#125;</span><br><span class="line">  virtual void computeError() override &#123;</span><br><span class="line">    const auto *v = static_cast&lt;const VertexPose *&gt;(_vertices[0]);</span><br><span class="line">    Sophus::SE3d T = v-&gt;estimate();</span><br><span class="line">    Eigen::Vector3d pos_pixel = _K * (T * _pos3d);</span><br><span class="line">    pos_pixel /= pos_pixel[2];</span><br><span class="line">    _error = _measurement - pos_pixel.head&lt;2&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  virtual void linearizeOplus() override &#123;</span><br><span class="line">    const auto *v = static_cast&lt;const VertexPose *&gt;(_vertices[0]);</span><br><span class="line">    Sophus::SE3d T = v-&gt;estimate();</span><br><span class="line">    Eigen::Vector3d pos_cam = T * _pos3d;</span><br><span class="line">    double fx = _K(0, 0);</span><br><span class="line">    double fy = _K(1, 1);</span><br><span class="line">    double X = pos_cam[0];</span><br><span class="line">    double Y = pos_cam[1];</span><br><span class="line">    double Z = pos_cam[2];</span><br><span class="line">    double Z2 = Z * Z;</span><br><span class="line">    _jacobianOplusXi &lt;&lt; -fx / Z, 0, fx * X / Z2, fx * X * Y / Z2, -fx - fx * X * X / Z2, fx * Y / Z,</span><br><span class="line">                      0, -fy / Z, fy * Y / Z2, fy + fy * Y * Y / Z2, -fy * X * Y / Z2, -fy * X / Z;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual bool read(istream &amp;in) override &#123; return true; &#125;</span><br><span class="line">  virtual bool write(ostream &amp;out) const override &#123; return true; &#125;</span><br><span class="line">private:</span><br><span class="line">  Eigen::Vector3d _pos3d;</span><br><span class="line">  Eigen::Matrix3d _K;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void bundleAdjustmentG2O(</span><br><span class="line">  const VecVector3d &amp;points_3d,</span><br><span class="line">  const VecVector2d &amp;points_2d,</span><br><span class="line">  const Mat &amp;K,</span><br><span class="line">  Sophus::SE3d &amp;pose) &#123;</span><br><span class="line"></span><br><span class="line">  typedef g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;6, 3&gt;&gt; BlockSolverType;</span><br><span class="line">  typedef g2o::LinearSolverDense&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType;</span><br><span class="line">  </span><br><span class="line">  // 【修改】将 g2o::make_unique 改为 std::make_unique</span><br><span class="line">  auto solver = new g2o::OptimizationAlgorithmGaussNewton(</span><br><span class="line">    std::make_unique&lt;BlockSolverType&gt;(std::make_unique&lt;LinearSolverType&gt;()));</span><br><span class="line">  g2o::SparseOptimizer optimizer;</span><br><span class="line">  optimizer.setAlgorithm(solver);</span><br><span class="line">  optimizer.setVerbose(true);</span><br><span class="line"></span><br><span class="line">  VertexPose *vertex_pose = new VertexPose();</span><br><span class="line">  vertex_pose-&gt;setId(0);</span><br><span class="line">  vertex_pose-&gt;setEstimate(Sophus::SE3d());</span><br><span class="line">  optimizer.addVertex(vertex_pose);</span><br><span class="line"></span><br><span class="line">  Eigen::Matrix3d K_eigen;</span><br><span class="line">  K_eigen &lt;&lt; K.at&lt;double&gt;(0, 0), K.at&lt;double&gt;(0, 1), K.at&lt;double&gt;(0, 2),</span><br><span class="line">             K.at&lt;double&gt;(1, 0), K.at&lt;double&gt;(1, 1), K.at&lt;double&gt;(1, 2),</span><br><span class="line">             K.at&lt;double&gt;(2, 0), K.at&lt;double&gt;(2, 1), K.at&lt;double&gt;(2, 2);</span><br><span class="line"></span><br><span class="line">  int index = 1;</span><br><span class="line">  for (size_t i = 0; i &lt; points_2d.size(); ++i) &#123;</span><br><span class="line">    auto p2d = points_2d[i];</span><br><span class="line">    auto p3d = points_3d[i];</span><br><span class="line">    EdgeProjection *edge = new EdgeProjection(p3d, K_eigen);</span><br><span class="line">    edge-&gt;setId(index);</span><br><span class="line">    edge-&gt;setVertex(0, vertex_pose);</span><br><span class="line">    edge-&gt;setMeasurement(p2d);</span><br><span class="line">    edge-&gt;setInformation(Eigen::Matrix2d::Identity());</span><br><span class="line">    optimizer.addEdge(edge);</span><br><span class="line">    index++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">  optimizer.initializeOptimization();</span><br><span class="line">  optimizer.optimize(10);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">  chrono::duration&lt;double&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;double&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; &quot;optimization costs time: &quot; &lt;&lt; time_used.count() &lt;&lt; &quot; seconds.&quot; &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; &quot;pose estimated by g2o =\n&quot; &lt;&lt; vertex_pose-&gt;estimate().matrix() &lt;&lt; endl;</span><br><span class="line">  pose = vertex_pose-&gt;estimate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># 设置最低 CMake 版本要求</span><br><span class="line">cmake_minimum_required(VERSION 3.12)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line"># 设置 C++ 标准为 17</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># 添加自定义 Find 模块的路径</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"># --- 查找依赖包 ---</span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED) # 仍然保留以检查g2o是否存在</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- 定义所有可执行文件目标 ---</span><br><span class="line"></span><br><span class="line"># 目标 1: orb_cv</span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 2: orb_self</span><br><span class="line">add_executable(orb_self orb_self.cpp)</span><br><span class="line">target_link_libraries(orb_self PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line">target_compile_options(orb_self PRIVATE -msse4.2)</span><br><span class="line"></span><br><span class="line"># 目标 3: pose_estimation_2d2d</span><br><span class="line">add_executable(pose_estimation_2d2d pose_estimation_2d2d.cpp)</span><br><span class="line">target_link_libraries(pose_estimation_2d2d PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 4: triangulation</span><br><span class="line">add_executable(triangulation triangulation.cpp)</span><br><span class="line">target_link_libraries(triangulation PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 5: pose_estimation_3d2d</span><br><span class="line">add_executable(pose_estimation_3d2d pose_estimation_3d2d.cpp)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接为目标添加 g2o 和其他库的头文件目录</span><br><span class="line">target_include_directories(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;   # 尽管它可能是空的，但以防万一</span><br><span class="line">    /usr/local/include/g2o # 手动添加 g2o 的默认安装头文件路径</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接链接 g2o 的核心模块库</span><br><span class="line">target_link_libraries(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    # 手动指定 g2o 的核心模块</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_stuff</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    # 链接其他库</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 目标 6 (已注释): pose_estimation_3d3d</span><br><span class="line"># add_executable(pose_estimation_3d3d pose_estimation_3d3d.cpp)</span><br><span class="line"># target_include_directories(pose_estimation_3d3d</span><br><span class="line">#     PRIVATE</span><br><span class="line">#     $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">#     $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line"># )</span><br><span class="line"># target_link_libraries(pose_estimation_3d3d</span><br><span class="line">#     PRIVATE</span><br><span class="line">#     $&#123;g2o_LIBRARIES&#125;</span><br><span class="line">#     $&#123;OpenCV_LIBS&#125;</span><br><span class="line"># )</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./pose_estimation_3d2d ../1.png ../2.png ../1_depth.png ../2_depth.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">3d-2d pairs: 75</span><br><span class="line">solve pnp in opencv cost time: 0.0108756 seconds.</span><br><span class="line">R=</span><br><span class="line">[0.9979059095501517, -0.05091940089119591, 0.03988747043579327;</span><br><span class="line"> 0.04981866254262534, 0.9983623157437967, 0.02812094175427922;</span><br><span class="line"> -0.04125404886006491, -0.02607491352939112, 0.9988083912027803]</span><br><span class="line">t=</span><br><span class="line">[-0.1267821389545255;</span><br><span class="line"> -0.00843949681832986;</span><br><span class="line"> 0.06034935748864372]</span><br><span class="line">calling bundle adjustment by gauss newton</span><br><span class="line">iteration 0 cost=40517.7576706</span><br><span class="line">iteration 1 cost=410.547029116</span><br><span class="line">iteration 2 cost=299.76468142</span><br><span class="line">iteration 3 cost=299.763574327</span><br><span class="line">pose by g-n: </span><br><span class="line">   0.997905909549  -0.0509194008562   0.0398874705187   -0.126782139096</span><br><span class="line">   0.049818662505    0.998362315745   0.0281209417649 -0.00843949683874</span><br><span class="line"> -0.0412540489424  -0.0260749135374    0.998808391199   0.0603493575229</span><br><span class="line">                0                 0                 0                 1</span><br><span class="line">solve pnp by gauss newton cost time: 0.009116205 seconds.</span><br><span class="line">calling bundle adjustment by g2o</span><br><span class="line">iteration= 0     chi2= 410.547029        time= 0.00147405        cumTime= 0.00147405     edges= 75       schur= 0</span><br><span class="line">iteration= 1     chi2= 299.764681        time= 0.00139111        cumTime= 0.00286515     edges= 75       schur= 0</span><br><span class="line">iteration= 2     chi2= 299.763574        time= 0.00122962        cumTime= 0.00409478     edges= 75       schur= 0</span><br><span class="line">iteration= 3     chi2= 299.763574        time= 0.00106202        cumTime= 0.00515679     edges= 75       schur= 0</span><br><span class="line">iteration= 4     chi2= 299.763574        time= 0.00113331        cumTime= 0.00629011     edges= 75       schur= 0</span><br><span class="line">iteration= 5     chi2= 299.763574        time= 0.00103069        cumTime= 0.00732079     edges= 75       schur= 0</span><br><span class="line">iteration= 6     chi2= 299.763574        time= 0.00106611        cumTime= 0.0083869      edges= 75       schur= 0</span><br><span class="line">iteration= 7     chi2= 299.763574        time= 0.00100701        cumTime= 0.00939391     edges= 75       schur= 0</span><br><span class="line">iteration= 8     chi2= 299.763574        time= 0.001034  cumTime= 0.0104279      edges= 75       schur= 0</span><br><span class="line">iteration= 9     chi2= 299.763574        time= 0.00103463        cumTime= 0.0114625      edges= 75       schur= 0</span><br><span class="line">optimization costs time: 0.014154345 seconds.</span><br><span class="line">pose estimated by g2o =</span><br><span class="line">    0.99790590955  -0.0509194008911   0.0398874704367   -0.126782138956</span><br><span class="line">  0.0498186625425    0.998362315744   0.0281209417542 -0.00843949681823</span><br><span class="line"> -0.0412540488609  -0.0260749135293    0.998808391203   0.0603493574888</span><br><span class="line">                0                 0                 0                 1</span><br><span class="line">solve pnp by g2o cost time: 0.014431543 seconds.</span><br></pre></td></tr></table></figure>

<p>在前端，通常考虑局部相机位姿和特征点的小型BA问题，希望对它进行实时求解和优化。</p>
<hr>
<h2 id="3D-3D-ICP"><a href="#3D-3D-ICP" class="headerlink" title="3D-3D: ICP"></a>3D-3D: ICP</h2><p>假设有一组配好的3D点，现在，想要找一个欧式变换$R,t$​实现配准，这个问题可以使用迭代最近点(Iterative Closest Point,ICP)求解。ICP求解分为两种：利用线性代数求解(SVD)，以及利用非线性优化方式求解(类似BA)。</p>
<p>ICP 的工作流程通常分为四步，并不断迭代：</p>
<ol>
<li><strong>匹配 (Matching)</strong>：为源点云 P’ 中的每个点，在目标点云 P 中寻找一个最近的对应点。</li>
<li><strong>计算变换 (Compute Transformation)</strong>：假设上一步的匹配是完全正确的，计算出能让这些对应点之间误差最小的 R 和 t。<strong>这就是 SVD 和非线性优化方法发挥作用的地方</strong>。</li>
<li><strong>应用变换 (Apply Transformation)</strong>：将计算出的 R 和 t 应用于源点云 P’，得到一个新的点云。</li>
<li><strong>迭代 (Iterate)</strong>：重复以上步骤，直到满足某个停止条件（例如，R 和 t 的变化量足够小，或者误差不再下降）。</li>
</ol>
<h3 id="SVD方法"><a href="#SVD方法" class="headerlink" title="SVD方法"></a>SVD方法</h3><p>SVD方法旨在寻找一个解析解，也就是说通过一系列精确的数学公式，直接计算处最优解，不需要迭代猜测。</p>
<p><strong>核心思想</strong></p>
<p>将求解的$R,t$​的问题，转换为一个最小二乘问题，假设有n对匹配点，我们要最小化他们的欧氏距离平方和。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827205426113.png" alt="image-20250827205426113"></p>
<h3 id="非线性优化方法"><a href="#非线性优化方法" class="headerlink" title="非线性优化方法"></a>非线性优化方法</h3><p>该方法使用迭代的方式去寻找最优值，与之前描述的PnP十分相似，将位姿用李代数表述，然后定义一个误差函数，通过高斯牛顿法或者列文伯格-马夸尔特法迭代，寻找使得误差函数最小化的位姿增量。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250827205748538.png" alt="image-20250827205748538"></p>
<h2 id="实践：求解ICP"><a href="#实践：求解ICP" class="headerlink" title="实践：求解ICP"></a>实践：求解ICP</h2><h3 id="实践：SVD方法及非线性优化方法"><a href="#实践：SVD方法及非线性优化方法" class="headerlink" title="实践：SVD方法及非线性优化方法"></a>实践：SVD方法及非线性优化方法</h3><p>新建文件<code>slambook/ch7/pose_estimation_3d3d.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/calib3d/calib3d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/SVD&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_vertex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_unary_edge.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_gauss_newton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sophus/se3.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span> <span class="comment">// 【修改】为使用 std::make_unique 添加头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;DMatch&gt; &amp;matches)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 像素坐标转相机归一化坐标</span></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_3d3d</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bundleAdjustment</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// vertex and edges used in g2o ba</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VertexPose</span> : <span class="keyword">public</span> g2o::BaseVertex&lt;<span class="number">6</span>, Sophus::SE3d&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">setToOriginImpl</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    _estimate = Sophus::<span class="built_in">SE3d</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// left multiplication on SE3</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">oplusImpl</span><span class="params">(<span class="type">const</span> <span class="type">double</span> *update)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">6</span>, <span class="number">1</span>&gt; update_eigen;</span><br><span class="line">    update_eigen &lt;&lt; update[<span class="number">0</span>], update[<span class="number">1</span>], update[<span class="number">2</span>], update[<span class="number">3</span>], update[<span class="number">4</span>], update[<span class="number">5</span>];</span><br><span class="line">    _estimate = Sophus::SE3d::<span class="built_in">exp</span>(update_eigen) * _estimate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// g2o edge</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EdgeProjectXYZRGBDPoseOnly</span> : <span class="keyword">public</span> g2o::BaseUnaryEdge&lt;<span class="number">3</span>, Eigen::Vector3d, VertexPose&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">EdgeProjectXYZRGBDPoseOnly</span>(<span class="type">const</span> Eigen::Vector3d &amp;point) : _point(point) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">computeError</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> VertexPose *pose = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> VertexPose *&gt; ( _vertices[<span class="number">0</span>] );</span><br><span class="line">    _error = _measurement - pose-&gt;<span class="built_in">estimate</span>() * _point;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">linearizeOplus</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    VertexPose *pose = <span class="built_in">static_cast</span>&lt;VertexPose *&gt;(_vertices[<span class="number">0</span>]);</span><br><span class="line">    Sophus::SE3d T = pose-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">    Eigen::Vector3d xyz_trans = T * _point;</span><br><span class="line">    _jacobianOplusXi.<span class="built_in">block</span>&lt;<span class="number">3</span>, <span class="number">3</span>&gt;(<span class="number">0</span>, <span class="number">0</span>) = -Eigen::Matrix3d::<span class="built_in">Identity</span>();</span><br><span class="line">    _jacobianOplusXi.<span class="built_in">block</span>&lt;<span class="number">3</span>, <span class="number">3</span>&gt;(<span class="number">0</span>, <span class="number">3</span>) = Sophus::SO3d::<span class="built_in">hat</span>(xyz_trans);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  Eigen::Vector3d _point;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">5</span>) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;usage: pose_estimation_3d3d img1 img2 depth1 depth2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//-- 读取图像</span></span><br><span class="line">  <span class="comment">// 【修改】使用 OpenCV 4 的枚举类型</span></span><br><span class="line">  Mat img_1 = <span class="built_in">imread</span>(argv[<span class="number">1</span>], cv::IMREAD_COLOR);</span><br><span class="line">  Mat img_2 = <span class="built_in">imread</span>(argv[<span class="number">2</span>], cv::IMREAD_COLOR);</span><br><span class="line"></span><br><span class="line">  vector&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">  vector&lt;DMatch&gt; matches;</span><br><span class="line">  <span class="built_in">find_feature_matches</span>(img_1, img_2, keypoints_1, keypoints_2, matches);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;一共找到了&quot;</span> &lt;&lt; matches.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;组匹配点&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 建立3D点</span></span><br><span class="line">  Mat depth1 = <span class="built_in">imread</span>(argv[<span class="number">3</span>], cv::IMREAD_UNCHANGED);       <span class="comment">// 深度图为16位无符号数，单通道图像</span></span><br><span class="line">  Mat depth2 = <span class="built_in">imread</span>(argv[<span class="number">4</span>], cv::IMREAD_UNCHANGED);       <span class="comment">// 深度图为16位无符号数，单通道图像</span></span><br><span class="line">  Mat K = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">  vector&lt;Point3f&gt; pts1, pts2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (DMatch m:matches) &#123;</span><br><span class="line">    ushort d1 = depth<span class="number">1.</span><span class="built_in">ptr</span>&lt;<span class="type">unsigned</span> <span class="type">short</span>&gt;(<span class="built_in">int</span>(keypoints_1[m.queryIdx].pt.y))[<span class="built_in">int</span>(keypoints_1[m.queryIdx].pt.x)];</span><br><span class="line">    ushort d2 = depth<span class="number">2.</span><span class="built_in">ptr</span>&lt;<span class="type">unsigned</span> <span class="type">short</span>&gt;(<span class="built_in">int</span>(keypoints_2[m.trainIdx].pt.y))[<span class="built_in">int</span>(keypoints_2[m.trainIdx].pt.x)];</span><br><span class="line">    <span class="keyword">if</span> (d1 == <span class="number">0</span> || d2 == <span class="number">0</span>)   <span class="comment">// bad depth</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    Point2d p1 = <span class="built_in">pixel2cam</span>(keypoints_1[m.queryIdx].pt, K);</span><br><span class="line">    Point2d p2 = <span class="built_in">pixel2cam</span>(keypoints_2[m.trainIdx].pt, K);</span><br><span class="line">    <span class="type">float</span> dd1 = <span class="built_in">float</span>(d1) / <span class="number">5000.0</span>;</span><br><span class="line">    <span class="type">float</span> dd2 = <span class="built_in">float</span>(d2) / <span class="number">5000.0</span>;</span><br><span class="line">    pts<span class="number">1.</span><span class="built_in">push_back</span>(<span class="built_in">Point3f</span>(p<span class="number">1.</span>x * dd1, p<span class="number">1.</span>y * dd1, dd1));</span><br><span class="line">    pts<span class="number">2.</span><span class="built_in">push_back</span>(<span class="built_in">Point3f</span>(p<span class="number">2.</span>x * dd2, p<span class="number">2.</span>y * dd2, dd2));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;3d-3d pairs: &quot;</span> &lt;&lt; pts<span class="number">1.</span><span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">  Mat R, t;</span><br><span class="line">  <span class="built_in">pose_estimation_3d3d</span>(pts1, pts2, R, t);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;ICP via SVD results: &quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;R = &quot;</span> &lt;&lt; R &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t = &quot;</span> &lt;&lt; t &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;R_inv = &quot;</span> &lt;&lt; R.<span class="built_in">t</span>() &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;t_inv = &quot;</span> &lt;&lt; -R.<span class="built_in">t</span>() * t &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;calling bundle adjustment&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bundleAdjustment</span>(pts1, pts2, R, t);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// verify p1 = R * p2 + t</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 = &quot;</span> &lt;&lt; pts1[i] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 = &quot;</span> &lt;&lt; pts2[i] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;(R*p2+t) = &quot;</span> &lt;&lt;</span><br><span class="line">         R * (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; pts2[i].x, pts2[i].y, pts2[i].z) + t</span><br><span class="line">         &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find_feature_matches</span><span class="params">(<span class="type">const</span> Mat &amp;img_1, <span class="type">const</span> Mat &amp;img_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;KeyPoint&gt; &amp;keypoints_2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;DMatch&gt; &amp;matches)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//-- 初始化</span></span><br><span class="line">  Mat descriptors_1, descriptors_2;</span><br><span class="line">  <span class="comment">// 【修改】使用统一的 ORB 对象</span></span><br><span class="line">  Ptr&lt;ORB&gt; orb = ORB::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">1.2f</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, ORB::HARRIS_SCORE, <span class="number">31</span>, <span class="number">20</span>);</span><br><span class="line">  Ptr&lt;DescriptorMatcher&gt; matcher = DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//-- 检测和计算</span></span><br><span class="line">  orb-&gt;<span class="built_in">detectAndCompute</span>(img_1, <span class="built_in">Mat</span>(), keypoints_1, descriptors_1);</span><br><span class="line">  orb-&gt;<span class="built_in">detectAndCompute</span>(img_2, <span class="built_in">Mat</span>(), keypoints_2, descriptors_2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 匹配</span></span><br><span class="line">  vector&lt;DMatch&gt; match;</span><br><span class="line">  matcher-&gt;<span class="built_in">match</span>(descriptors_1, descriptors_2, match);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//-- 筛选</span></span><br><span class="line">  <span class="type">double</span> min_dist = <span class="number">10000</span>, max_dist = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="type">double</span> dist = match[i].distance;</span><br><span class="line">    <span class="keyword">if</span> (dist &lt; min_dist) min_dist = dist;</span><br><span class="line">    <span class="keyword">if</span> (dist &gt; max_dist) max_dist = dist;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Max dist : %f \n&quot;</span>, max_dist);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-- Min dist : %f \n&quot;</span>, min_dist);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; descriptors_<span class="number">1.</span>rows; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (match[i].distance &lt;= <span class="built_in">max</span>(<span class="number">2</span> * min_dist, <span class="number">30.0</span>)) &#123;</span><br><span class="line">      matches.<span class="built_in">push_back</span>(match[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span><span class="params">(<span class="type">const</span> Point2d &amp;p, <span class="type">const</span> Mat &amp;K)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Point2d</span>(</span><br><span class="line">    (p.x - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    (p.y - K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">2</span>)) / K.<span class="built_in">at</span>&lt;<span class="type">double</span>&gt;(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pose_estimation_3d3d</span><span class="params">(<span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Mat &amp;R, Mat &amp;t)</span> </span>&#123;</span><br><span class="line">  Point3f p1, p2;     <span class="comment">// center of mass</span></span><br><span class="line">  <span class="type">int</span> N = pts<span class="number">1.</span><span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    p1 += pts1[i];</span><br><span class="line">    p2 += pts2[i];</span><br><span class="line">  &#125;</span><br><span class="line">  p1 = <span class="built_in">Point3f</span>(<span class="built_in">Vec3f</span>(p1) / N);</span><br><span class="line">  p2 = <span class="built_in">Point3f</span>(<span class="built_in">Vec3f</span>(p2) / N);</span><br><span class="line">  <span class="function">vector&lt;Point3f&gt; <span class="title">q1</span><span class="params">(N)</span>, <span class="title">q2</span><span class="params">(N)</span></span>; <span class="comment">// remove the center</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    q1[i] = pts1[i] - p1;</span><br><span class="line">    q2[i] = pts2[i] - p2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compute q1*q2^T</span></span><br><span class="line">  Eigen::Matrix3d W = Eigen::Matrix3d::<span class="built_in">Zero</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    W += Eigen::<span class="built_in">Vector3d</span>(q1[i].x, q1[i].y, q1[i].z) * Eigen::<span class="built_in">Vector3d</span>(q2[i].x, q2[i].y, q2[i].z).<span class="built_in">transpose</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;W=&quot;</span> &lt;&lt; W &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SVD on W</span></span><br><span class="line">  <span class="function">Eigen::JacobiSVD&lt;Eigen::Matrix3d&gt; <span class="title">svd</span><span class="params">(W, Eigen::ComputeFullU | Eigen::ComputeFullV)</span></span>;</span><br><span class="line">  Eigen::Matrix3d U = svd.<span class="built_in">matrixU</span>();</span><br><span class="line">  Eigen::Matrix3d V = svd.<span class="built_in">matrixV</span>();</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;U=&quot;</span> &lt;&lt; U &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;V=&quot;</span> &lt;&lt; V &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  Eigen::Matrix3d R_ = U * (V.<span class="built_in">transpose</span>());</span><br><span class="line">  <span class="keyword">if</span> (R_.<span class="built_in">determinant</span>() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    R_ = -R_;</span><br><span class="line">  &#125;</span><br><span class="line">  Eigen::Vector3d t_ = Eigen::<span class="built_in">Vector3d</span>(p<span class="number">1.</span>x, p<span class="number">1.</span>y, p<span class="number">1.</span>z) - R_ * Eigen::<span class="built_in">Vector3d</span>(p<span class="number">2.</span>x, p<span class="number">2.</span>y, p<span class="number">2.</span>z);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// convert to cv::Mat</span></span><br><span class="line">  R = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt;</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    );</span><br><span class="line">  t = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; <span class="built_in">t_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bundleAdjustment</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts1,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> vector&lt;Point3f&gt; &amp;pts2,</span></span></span><br><span class="line"><span class="params"><span class="function">  Mat &amp;R, Mat &amp;t)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 构建图优化，先设定g2o</span></span><br><span class="line">  <span class="keyword">typedef</span> g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;<span class="number">6</span>,<span class="number">3</span>&gt;&gt; BlockSolverType;</span><br><span class="line">  <span class="keyword">typedef</span> g2o::LinearSolverDense&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType; <span class="comment">// 线性求解器类型</span></span><br><span class="line">  <span class="comment">// 梯度下降方法，可以从GN, LM, DogLeg 中选</span></span><br><span class="line">  <span class="comment">// 【修改】将 g2o::make_unique 改为 std::make_unique</span></span><br><span class="line">  <span class="keyword">auto</span> solver = <span class="keyword">new</span> g2o::<span class="built_in">OptimizationAlgorithmLevenberg</span>(</span><br><span class="line">    std::<span class="built_in">make_unique</span>&lt;BlockSolverType&gt;(std::<span class="built_in">make_unique</span>&lt;LinearSolverType&gt;()));</span><br><span class="line">  g2o::SparseOptimizer optimizer;     <span class="comment">// 图模型</span></span><br><span class="line">  optimizer.<span class="built_in">setAlgorithm</span>(solver);   <span class="comment">// 设置求解器</span></span><br><span class="line">  optimizer.<span class="built_in">setVerbose</span>(<span class="literal">true</span>);       <span class="comment">// 打开调试输出</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// vertex</span></span><br><span class="line">  VertexPose *pose = <span class="keyword">new</span> <span class="built_in">VertexPose</span>(); <span class="comment">// camera pose</span></span><br><span class="line">  pose-&gt;<span class="built_in">setId</span>(<span class="number">0</span>);</span><br><span class="line">  pose-&gt;<span class="built_in">setEstimate</span>(Sophus::<span class="built_in">SE3d</span>());</span><br><span class="line">  optimizer.<span class="built_in">addVertex</span>(pose);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// edges</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pts<span class="number">1.</span><span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    EdgeProjectXYZRGBDPoseOnly *edge = <span class="keyword">new</span> <span class="built_in">EdgeProjectXYZRGBDPoseOnly</span>(</span><br><span class="line">      Eigen::<span class="built_in">Vector3d</span>(pts2[i].x, pts2[i].y, pts2[i].z));</span><br><span class="line">    edge-&gt;<span class="built_in">setVertex</span>(<span class="number">0</span>, pose);</span><br><span class="line">    edge-&gt;<span class="built_in">setMeasurement</span>(Eigen::<span class="built_in">Vector3d</span>(</span><br><span class="line">      pts1[i].x, pts1[i].y, pts1[i].z));</span><br><span class="line">    edge-&gt;<span class="built_in">setInformation</span>(Eigen::Matrix3d::<span class="built_in">Identity</span>());</span><br><span class="line">    optimizer.<span class="built_in">addEdge</span>(edge);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  optimizer.<span class="built_in">initializeOptimization</span>();</span><br><span class="line">  optimizer.<span class="built_in">optimize</span>(<span class="number">10</span>);</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;optimization costs time: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;after optimization:&quot;</span> &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;T=\n&quot;</span> &lt;&lt; pose-&gt;<span class="built_in">estimate</span>().<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// convert to cv::Mat</span></span><br><span class="line">  Eigen::Matrix3d R_ = pose-&gt;<span class="built_in">estimate</span>().<span class="built_in">rotationMatrix</span>();</span><br><span class="line">  Eigen::Vector3d t_ = pose-&gt;<span class="built_in">estimate</span>().<span class="built_in">translation</span>();</span><br><span class="line">  R = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt;</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">1</span>), <span class="built_in">R_</span>(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    );</span><br><span class="line">  t = (<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">3</span>, <span class="number">1</span>) &lt;&lt; <span class="built_in">t_</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">t_</span>(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"># 设置最低 CMake 版本要求</span><br><span class="line">cmake_minimum_required(VERSION 3.12)</span><br><span class="line">project(vo1)</span><br><span class="line"></span><br><span class="line"># 设置 C++ 标准为 17</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># 添加自定义 Find 模块的路径</span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"># --- 查找依赖包 ---</span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(g2o REQUIRED) # 仍然保留以检查g2o是否存在</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- 定义所有可执行文件目标 ---</span><br><span class="line"></span><br><span class="line"># 目标 1: orb_cv</span><br><span class="line">add_executable(orb_cv orb_cv.cpp)</span><br><span class="line">target_link_libraries(orb_cv PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 2: orb_self</span><br><span class="line">add_executable(orb_self orb_self.cpp)</span><br><span class="line">target_link_libraries(orb_self PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line">target_compile_options(orb_self PRIVATE -msse4.2)</span><br><span class="line"></span><br><span class="line"># 目标 3: pose_estimation_2d2d</span><br><span class="line">add_executable(pose_estimation_2d2d pose_estimation_2d2d.cpp)</span><br><span class="line">target_link_libraries(pose_estimation_2d2d PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 4: triangulation</span><br><span class="line">add_executable(triangulation triangulation.cpp)</span><br><span class="line">target_link_libraries(triangulation PRIVATE $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line"># 目标 5: pose_estimation_3d2d</span><br><span class="line">add_executable(pose_estimation_3d2d pose_estimation_3d2d.cpp)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接为目标添加 g2o 和其他库的头文件目录</span><br><span class="line">target_include_directories(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;   # 尽管它可能是空的，但以防万一</span><br><span class="line">    /usr/local/include/g2o # 手动添加 g2o 的默认安装头文件路径</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 【手动修正】直接链接 g2o 的核心模块库</span><br><span class="line">target_link_libraries(pose_estimation_3d2d</span><br><span class="line">    PRIVATE</span><br><span class="line">    # 手动指定 g2o 的核心模块</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_stuff</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    # 链接其他库</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 目标 6 (已注释): pose_estimation_3d3d</span><br><span class="line">add_executable(pose_estimation_3d3d pose_estimation_3d3d.cpp)</span><br><span class="line">target_include_directories(pose_estimation_3d3d</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;g2o_INCLUDE_DIRS&#125;</span><br><span class="line">    /usr/local/include/g2o</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">)</span><br><span class="line">target_link_libraries(pose_estimation_3d3d</span><br><span class="line">    PRIVATE</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_stuff</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    # 链接其他库</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch7/build$ ./pose_estimation_3d3d ../1.png ../2.png ../1_depth.png ../2_depth.png </span><br><span class="line">-- Max dist : 94.000000 </span><br><span class="line">-- Min dist : 4.000000 </span><br><span class="line">一共找到了79组匹配点</span><br><span class="line">3d-3d pairs: 72</span><br><span class="line">W=  10.871 -1.01948  2.54771</span><br><span class="line">-2.16033  3.85307 -5.77742</span><br><span class="line"> 3.94738 -5.79979  9.62203</span><br><span class="line">U=  0.558087  -0.829399 -0.0252034</span><br><span class="line"> -0.428009  -0.313755   0.847565</span><br><span class="line">  0.710878   0.462228   0.530093</span><br><span class="line">V=  0.617887  -0.784771 -0.0484806</span><br><span class="line"> -0.399894  -0.366747   0.839989</span><br><span class="line">  0.676979   0.499631   0.540434</span><br><span class="line">ICP via SVD results: </span><br><span class="line">R = [0.9969452351705235, 0.0598334759429696, -0.05020112774999549;</span><br><span class="line"> -0.05932607556034211, 0.9981719680327525, 0.01153858709846634;</span><br><span class="line"> 0.05079975225724825, -0.008525103530306, 0.9986724727258676]</span><br><span class="line">t = [0.1441598281917405;</span><br><span class="line"> -0.06667849447794799;</span><br><span class="line"> -0.03009747343724256]</span><br><span class="line">R_inv = [0.9969452351705235, -0.05932607556034211, 0.05079975225724825;</span><br><span class="line"> 0.0598334759429696, 0.9981719680327525, -0.008525103530306;</span><br><span class="line"> -0.05020112774999549, 0.01153858709846634, 0.9986724727258676]</span><br><span class="line">t_inv = [-0.1461462830262246;</span><br><span class="line"> 0.0576744363694081;</span><br><span class="line"> 0.03806387978797152]</span><br><span class="line">calling bundle adjustment</span><br><span class="line">iteration= 0     chi2= 1.816112  <span class="keyword">time</span>= 0.00143625        cumTime= 0.00143625     edges= 72       schur= 0        lambda= 0.000758        levenbergIter= 1</span><br><span class="line">iteration= 1     chi2= 1.815514  <span class="keyword">time</span>= 0.00142032        cumTime= 0.00285657     edges= 72       schur= 0        lambda= 0.000505        levenbergIter= 1</span><br><span class="line">iteration= 2     chi2= 1.815514  <span class="keyword">time</span>= 0.00139409        cumTime= 0.00425066     edges= 72       schur= 0        lambda= 0.000337        levenbergIter= 1</span><br><span class="line">iteration= 3     chi2= 1.815514  <span class="keyword">time</span>= 0.00151481        cumTime= 0.00576547     edges= 72       schur= 0        lambda= 0.000225        levenbergIter= 1</span><br><span class="line">iteration= 4     chi2= 1.815514  <span class="keyword">time</span>= 0.001556  cumTime= 0.00732147     edges= 72       schur= 0        lambda= 0.000150        levenbergIter= 1</span><br><span class="line">iteration= 5     chi2= 1.815514  <span class="keyword">time</span>= 0.00141224        cumTime= 0.00873371     edges= 72       schur= 0        lambda= 0.000299        levenbergIter= 1</span><br><span class="line">optimization costs <span class="keyword">time</span>: 0.0101066 seconds.</span><br><span class="line"></span><br><span class="line">after optimization:</span><br><span class="line">T=</span><br><span class="line">  0.996945  0.0598335 -0.0502011    0.14416</span><br><span class="line">-0.0593261   0.998172  0.0115386 -0.0666785</span><br><span class="line"> 0.0507998 -0.0085251   0.998672 -0.0300979</span><br><span class="line">         0          0          0          1</span><br><span class="line">p1 = [-0.243698, -0.117719, 1.5848]</span><br><span class="line">p2 = [-0.297211, -0.0956614, 1.6558]</span><br><span class="line">(R*p2+t) = [-0.2409901495364605;</span><br><span class="line"> -0.1254270500587826;</span><br><span class="line"> 1.609221205029395]</span><br><span class="line"></span><br><span class="line">p1 = [0.402045, -0.341821, 2.2068]</span><br><span class="line">p2 = [0.378811, -0.262859, 2.2196]</span><br><span class="line">(R*p2+t) = [0.3946591022539743;</span><br><span class="line"> -0.3259188829495218;</span><br><span class="line"> 2.20803983035825]</span><br><span class="line"></span><br><span class="line">p1 = [-0.522843, -0.214436, 1.4956]</span><br><span class="line">p2 = [-0.58581, -0.208584, 1.6052]</span><br><span class="line">(R*p2+t) = [-0.532923946912698;</span><br><span class="line"> -0.2216052393093164;</span><br><span class="line"> 1.54499035805527]</span><br><span class="line"></span><br><span class="line">p1 = [-0.627753, 0.160186, 1.3396]</span><br><span class="line">p2 = [-0.709645, 0.159033, 1.4212]</span><br><span class="line">(R*p2+t) = [-0.6251478068660965;</span><br><span class="line"> 0.1505624195985039;</span><br><span class="line"> 1.351809862638435]</span><br><span class="line"></span><br><span class="line">p1 = [0.594266, -0.0256024, 1.5332]</span><br><span class="line">p2 = [0.514795, 0.0391393, 1.5332]</span><br><span class="line">(R*p2+t) = [0.582755696243957;</span><br><span class="line"> -0.04046060384335358;</span><br><span class="line"> 1.526884519595548]</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AB%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" class="post-title-link" itemprop="url">第八讲-视觉里程计2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:29:17" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第八讲）——视觉里程计2"><a href="#视觉SLAM十四讲（第八讲）——视觉里程计2" class="headerlink" title="视觉SLAM十四讲（第八讲）——视觉里程计2"></a>视觉SLAM十四讲（第八讲）——视觉里程计2</h1><h2 id="直接法的引出"><a href="#直接法的引出" class="headerlink" title="直接法的引出"></a>直接法的引出</h2><p>直接法只计算关键点，不计算描述子，会根据图像的像素灰度信息同时估计相机运动和点的投影，不要求提取到的点必须是角点。直接发根据像素的亮度信息估计相机的运动，可以完全不计算关键点和描述子，只要场景中存在明暗变化，直接法就能工作，根据使用像素的数量，直接法分为系数、稠密、半稠密三种。</p>
<blockquote>
<p>特殊点法和直接法的对比</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112719382.png" alt="image-20250828112719382"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828112739282.png" alt="image-20250828112739282"></p>
<hr>
<h2 id="2D光流"><a href="#2D光流" class="headerlink" title="2D光流"></a>2D光流</h2><p>直接法从光流演变而来，光流描述像素在图像中的运动，直接法附带着一个相机运动模型。二者都是基于一个假设：空间中同一个三维点，当它被相机从不同角度拍摄时，它在图像上的像素亮度（灰度）是基本不变的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828150507385.png" alt="image-20250828150507385"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-bf1f8c83d411a81b327d1f518d2deda4_r.jpg" alt="重读《视觉SLAM十四讲》ch8 视觉里程计2 - 知乎"></p>
<p>光流是一种描述像素随时间在图像之间运动的方法，计算部分像素运动称为稀疏光流，计算全部像素称为稠密光流。光流的目标是计算图像中每个像素点在连续两帧之间的<strong>二维运动向量</strong>，这会产出一个<strong>二维向量场</strong>描述纯粹的图像平面上的运动。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828151228168.png" alt="image-20250828151228168"></p>
<p>在SLAM中，LK光流常被用来跟踪角点的运动。</p>
<h2 id="实践：-LK光流"><a href="#实践：-LK光流" class="headerlink" title="实践： LK光流"></a>实践： LK光流</h2><h3 id="使用LK光流"><a href="#使用LK光流" class="headerlink" title="使用LK光流"></a>使用LK光流</h3><p>我们使用两张来自Euroc数据集中的图像，在第一章图像中提取角点，然后利用光流追踪它们在第二张图像中的位置。</p>
<p>把源代码中的图片复制到新建文件夹:<code>slambook/ch8/</code></p>
<p>新建文件:<code>slambook/ch8/optical_flow.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span> <span class="comment">// 【修改】为使用 lambda 包含头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 光流追踪器类定义 (保持不变)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpticalFlowTracker</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">OpticalFlowTracker</span>(</span><br><span class="line">        <span class="type">const</span> Mat &amp;img1_,</span><br><span class="line">        <span class="type">const</span> Mat &amp;img2_,</span><br><span class="line">        <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1_,</span><br><span class="line">        vector&lt;KeyPoint&gt; &amp;kp2_,</span><br><span class="line">        vector&lt;<span class="type">bool</span>&gt; &amp;success_,</span><br><span class="line">        <span class="type">bool</span> inverse_ = <span class="literal">true</span>, <span class="type">bool</span> has_initial_ = <span class="literal">false</span>) :</span><br><span class="line">        <span class="built_in">img1</span>(img1_), <span class="built_in">img2</span>(img2_), <span class="built_in">kp1</span>(kp1_), <span class="built_in">kp2</span>(kp2_), <span class="built_in">success</span>(success_), <span class="built_in">inverse</span>(inverse_),</span><br><span class="line">        <span class="built_in">has_initial</span>(has_initial_) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">calculateOpticalFlow</span><span class="params">(<span class="type">const</span> Range &amp;range)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> Mat &amp;img1;</span><br><span class="line">    <span class="type">const</span> Mat &amp;img2;</span><br><span class="line">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1;</span><br><span class="line">    vector&lt;KeyPoint&gt; &amp;kp2;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; &amp;success;</span><br><span class="line">    <span class="type">bool</span> inverse = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">bool</span> has_initial = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明 (保持不变)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowSingleLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> has_initial_guess = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowMultiLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【修改】稍微清理了边界检查逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">float</span> <span class="title">GetPixelValue</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, <span class="type">float</span> x, <span class="type">float</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 边界检查</span></span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>) x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>) y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= img.cols - <span class="number">1</span>) x = img.cols - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= img.rows - <span class="number">1</span>) y = img.rows - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> xx = x - <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">float</span> yy = y - <span class="built_in">floor</span>(y);</span><br><span class="line">    <span class="type">int</span> x_int = <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">int</span> y_int = <span class="built_in">floor</span>(y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> - xx) * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int)</span><br><span class="line">           + xx * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int + <span class="number">1</span>)</span><br><span class="line">           + (<span class="number">1</span> - xx) * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int)</span><br><span class="line">           + xx * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 【修改】将全局变量移入 main 作为常量</span></span><br><span class="line">    <span class="type">const</span> string file_1 = <span class="string">&quot;../LK1.png&quot;</span>;  <span class="comment">// first image</span></span><br><span class="line">    <span class="type">const</span> string file_2 = <span class="string">&quot;../LK2.png&quot;</span>;  <span class="comment">// second image</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 【修改】使用 cv::IMREAD_GRAYSCALE 替换旧的宏 `0`</span></span><br><span class="line">    Mat img1 = <span class="built_in">imread</span>(file_1, cv::IMREAD_GRAYSCALE);</span><br><span class="line">    Mat img2 = <span class="built_in">imread</span>(file_2, cv::IMREAD_GRAYSCALE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (img<span class="number">1.</span><span class="built_in">empty</span>() || img<span class="number">2.</span><span class="built_in">empty</span>()) &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Could not open or find the images!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 GFTT 检测特征点</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp1;</span><br><span class="line">    Ptr&lt;GFTTDetector&gt; detector = GFTTDetector::<span class="built_in">create</span>(<span class="number">500</span>, <span class="number">0.01</span>, <span class="number">20</span>);</span><br><span class="line">    detector-&gt;<span class="built_in">detect</span>(img1, kp1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单层光流</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp2_single;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; success_single;</span><br><span class="line">    <span class="built_in">OpticalFlowSingleLevel</span>(img1, img2, kp1, kp2_single, success_single);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多层光流</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp2_multi;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; success_multi;</span><br><span class="line">    chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">OpticalFlowMultiLevel</span>(img1, img2, kp1, kp2_multi, success_multi, <span class="literal">true</span>);</span><br><span class="line">    chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;optical flow by gauss-newton: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// OpenCV 的光流函数作为对比</span></span><br><span class="line">    vector&lt;Point2f&gt; pt1, pt2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: kp1) pt<span class="number">1.</span><span class="built_in">push_back</span>(kp.pt);</span><br><span class="line">    vector&lt;uchar&gt; status;</span><br><span class="line">    vector&lt;<span class="type">float</span>&gt; error;</span><br><span class="line">    t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    cv::<span class="built_in">calcOpticalFlowPyrLK</span>(img1, img2, pt1, pt2, status, error);</span><br><span class="line">    t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;optical flow by opencv: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制结果</span></span><br><span class="line">    Mat img2_single, img2_multi, img2_CV;</span><br><span class="line">    <span class="comment">// 【修改】使用 cv::COLOR_GRAY2BGR 替换旧的宏</span></span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_single, cv::COLOR_GRAY2BGR);</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_multi, cv::COLOR_GRAY2BGR);</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_CV, cv::COLOR_GRAY2BGR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; kp2_single.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (success_single[i]) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_single, kp2_single[i].pt, <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_single, kp1[i].pt, kp2_single[i].pt, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; kp2_multi.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (success_multi[i]) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_multi, kp2_multi[i].pt, <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_multi, kp1[i].pt, kp2_multi[i].pt, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pt<span class="number">2.</span><span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status[i]) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_CV, pt2[i], <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_CV, pt1[i], pt2[i], cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;tracked single level&quot;</span>, img2_single);</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;tracked multi level&quot;</span>, img2_multi);</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;tracked by opencv&quot;</span>, img2_CV);</span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowSingleLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse, <span class="type">bool</span> has_initial)</span> </span>&#123;</span><br><span class="line">    kp<span class="number">2.</span><span class="built_in">resize</span>(kp<span class="number">1.</span><span class="built_in">size</span>());</span><br><span class="line">    success.<span class="built_in">resize</span>(kp<span class="number">1.</span><span class="built_in">size</span>());</span><br><span class="line">    <span class="function">OpticalFlowTracker <span class="title">tracker</span><span class="params">(img1, img2, kp1, kp2, success, inverse, has_initial)</span></span>;</span><br><span class="line">    <span class="comment">// 【修改】使用 Lambda 表达式替代 std::bind，更简洁</span></span><br><span class="line">    <span class="built_in">parallel_for_</span>(<span class="built_in">Range</span>(<span class="number">0</span>, kp<span class="number">1.</span><span class="built_in">size</span>()),</span><br><span class="line">                  [&amp;](<span class="type">const</span> Range &amp;range) &#123;</span><br><span class="line">                      tracker.<span class="built_in">calculateOpticalFlow</span>(range);</span><br><span class="line">                  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowTracker::calculateOpticalFlow</span><span class="params">(<span class="type">const</span> Range &amp;range)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// parameters</span></span><br><span class="line">    <span class="type">int</span> half_patch_size = <span class="number">4</span>;</span><br><span class="line">    <span class="type">int</span> iterations = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = range.start; i &lt; range.end; i++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> kp = kp1[i];</span><br><span class="line">        <span class="type">double</span> dx = <span class="number">0</span>, dy = <span class="number">0</span>; <span class="comment">// dx,dy need to be estimated</span></span><br><span class="line">        <span class="keyword">if</span> (has_initial) &#123;</span><br><span class="line">            dx = kp2[i].pt.x - kp.pt.x;</span><br><span class="line">            dy = kp2[i].pt.y - kp.pt.y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> cost = <span class="number">0</span>, lastCost = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> succ = <span class="literal">true</span>; <span class="comment">// indicate if this point succeeded</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gauss-Newton iterations</span></span><br><span class="line">        Eigen::Matrix2d H = Eigen::Matrix2d::<span class="built_in">Zero</span>();    <span class="comment">// hessian</span></span><br><span class="line">        Eigen::Vector2d b = Eigen::Vector2d::<span class="built_in">Zero</span>();    <span class="comment">// bias</span></span><br><span class="line">        Eigen::Vector2d J;  <span class="comment">// jacobian</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; iterations; iter++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!inverse) &#123;</span><br><span class="line">                H = Eigen::Matrix2d::<span class="built_in">Zero</span>();</span><br><span class="line">                b = Eigen::Vector2d::<span class="built_in">Zero</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                b = Eigen::Vector2d::<span class="built_in">Zero</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cost = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// compute cost and jacobian</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> x = -half_patch_size; x &lt; half_patch_size; x++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> y = -half_patch_size; y &lt; half_patch_size; y++) &#123;</span><br><span class="line">                    <span class="type">double</span> error = <span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x, kp.pt.y + y) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img2, kp.pt.x + x + dx, kp.pt.y + y + dy);</span><br><span class="line">                    <span class="keyword">if</span> (!inverse) &#123;</span><br><span class="line">                        J = <span class="number">-1.0</span> * Eigen::<span class="built_in">Vector2d</span>(</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x + <span class="number">1</span>, kp.pt.y + dy + y) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x - <span class="number">1</span>, kp.pt.y + dy + y)),</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x, kp.pt.y + dy + y + <span class="number">1</span>) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img2, kp.pt.x + dx + x, kp.pt.y + dy + y - <span class="number">1</span>))</span><br><span class="line">                        );</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iter == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// in inverse mode, J keeps same for all iterations</span></span><br><span class="line">                        J = <span class="number">-1.0</span> * Eigen::<span class="built_in">Vector2d</span>(</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x + <span class="number">1</span>, kp.pt.y + y) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x - <span class="number">1</span>, kp.pt.y + y)),</span><br><span class="line">                            <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x, kp.pt.y + y + <span class="number">1</span>) -</span><br><span class="line">                                   <span class="built_in">GetPixelValue</span>(img1, kp.pt.x + x, kp.pt.y + y - <span class="number">1</span>))</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                    b += -error * J;</span><br><span class="line">                    cost += error * error;</span><br><span class="line">                    <span class="keyword">if</span> (!inverse || iter == <span class="number">0</span>) &#123;</span><br><span class="line">                        H += J * J.<span class="built_in">transpose</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// compute update</span></span><br><span class="line">            Eigen::Vector2d update = H.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(b);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (std::<span class="built_in">isnan</span>(update[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="comment">// sometimes occurred when we have a black or white patch and H is irreversible</span></span><br><span class="line">                <span class="comment">// cout &lt;&lt; &quot;update is nan&quot; &lt;&lt; endl;</span></span><br><span class="line">                succ = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (iter &gt; <span class="number">0</span> &amp;&amp; cost &gt; lastCost) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// update dx, dy</span></span><br><span class="line">            dx += update[<span class="number">0</span>];</span><br><span class="line">            dy += update[<span class="number">1</span>];</span><br><span class="line">            lastCost = cost;</span><br><span class="line">            succ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (update.<span class="built_in">norm</span>() &lt; <span class="number">1e-2</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        success[i] = succ;</span><br><span class="line">        kp2[i].pt = kp.pt + <span class="built_in">Point2f</span>(dx, dy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpticalFlowMultiLevel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;KeyPoint&gt; &amp;kp1,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;KeyPoint&gt; &amp;kp2,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;<span class="type">bool</span>&gt; &amp;success,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> inverse)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parameters</span></span><br><span class="line">    <span class="type">int</span> pyramids = <span class="number">4</span>;</span><br><span class="line">    <span class="type">double</span> pyramid_scale = <span class="number">0.5</span>;</span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; scales = &#123;<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.25</span>, <span class="number">0.125</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create pyramids</span></span><br><span class="line">    vector&lt;Mat&gt; pyr1, pyr2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pyramids; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Mat img1_pyr, img2_pyr;</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr1[i - <span class="number">1</span>], img1_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr1[i - <span class="number">1</span>].cols * pyramid_scale, pyr1[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr2[i - <span class="number">1</span>], img2_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr2[i - <span class="number">1</span>].cols * pyramid_scale, pyr2[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1_pyr);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2_pyr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// coarse-to-fine LK tracking in pyramids</span></span><br><span class="line">    vector&lt;KeyPoint&gt; kp1_pyr = kp1;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp : kp1_pyr) &#123;</span><br><span class="line">        kp.pt *= scales[pyramids - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vector&lt;KeyPoint&gt; kp2_pyr = kp1_pyr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> level = pyramids - <span class="number">1</span>; level &gt;= <span class="number">0</span>; level--) &#123;</span><br><span class="line">        <span class="comment">// from coarse to fine</span></span><br><span class="line">        success.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">OpticalFlowSingleLevel</span>(pyr1[level], pyr2[level], kp1_pyr, kp2_pyr, success, inverse, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (level &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: kp1_pyr)</span><br><span class="line">                kp.pt /= pyramid_scale;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;kp: kp2_pyr)</span><br><span class="line">                kp.pt /= pyramid_scale;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kp2 = kp2_pyr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置最低 CMake 版本要求，以支持现代 CMake 命令</span></span><br><span class="line">cmake_minimum_required(VERSION 3.12)</span><br><span class="line">project(ch8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 C++ 标准为 17</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建议在命令行中设置编译类型, e.g., cmake -DCMAKE_BUILD_TYPE=Release ..</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 查找依赖包 ---</span></span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line">find_package(Pangolin REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义可执行文件目标 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标 1: optical_flow</span></span><br><span class="line">add_executable(optical_flow optical_flow.cpp)</span><br><span class="line"><span class="comment"># 优化：开启原生指令集优化，提高运行速度</span></span><br><span class="line">target_compile_options(optical_flow PRIVATE -march=native)</span><br><span class="line"><span class="comment"># 链接库</span></span><br><span class="line">target_link_libraries(optical_flow</span><br><span class="line">    PRIVATE</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">    Eigen3::Eigen</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标 2: direct_method</span></span><br><span class="line"><span class="comment"># add_executable(direct_method direct_method.cpp)</span></span><br><span class="line"><span class="comment"># # 为该目标添加头文件目录</span></span><br><span class="line"><span class="comment"># target_include_directories(direct_method</span></span><br><span class="line"><span class="comment">#     PRIVATE</span></span><br><span class="line"><span class="comment">#     $&#123;Sophus_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment">#     $&#123;Pangolin_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment">#     $&#123;EIGEN3_INCLUDE_DIR&#125;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"><span class="comment"># # 优化：开启原生指令集优化</span></span><br><span class="line"><span class="comment"># target_compile_options(direct_method PRIVATE -march=native)</span></span><br><span class="line"><span class="comment"># # 链接库</span></span><br><span class="line"><span class="comment"># target_link_libraries(direct_method</span></span><br><span class="line"><span class="comment">#     PRIVATE</span></span><br><span class="line"><span class="comment">#     $&#123;OpenCV_LIBS&#125;</span></span><br><span class="line"><span class="comment">#     Sophus::Sophus</span></span><br><span class="line"><span class="comment">#     $&#123;Pangolin_LIBRARIES&#125;</span></span><br><span class="line"><span class="comment">#     Eigen3::Eigen</span></span><br><span class="line"><span class="comment"># )</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828153002903.png" alt="image-20250828153002903"></p>
<p>所有的窗口的背景都是第二张图片，绿色的线代表一个特征点的运动轨迹，线的起点是一个特征点在第一张图片中的位置，线的终点时算法追踪到的、在第二张图片中的新位置。绿色的圈表示特征点在第二章图片的最终位置。</p>
<p>三个图片分别展示了单程光流、多层光流、OpenCV光流追踪的结果。</p>
<h3 id="用高斯牛顿法实现光流"><a href="#用高斯牛顿法实现光流" class="headerlink" title="用高斯牛顿法实现光流"></a>用高斯牛顿法实现光流</h3><h4 id="单层光流"><a href="#单层光流" class="headerlink" title="单层光流"></a>单层光流</h4><p>光流可以看成一个优化问题，通过最小化灰度误差估计最优的像素偏移，所以可以实现一个基于高斯牛顿法的光流。</p>
<h4 id="多层光流"><a href="#多层光流" class="headerlink" title="多层光流"></a>多层光流</h4><p>如果相机运动较快，两张图像差异明显，那么单层图像光流容易达到一个局部极小值，可以引入图像金字塔来改善。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20200415221947629.jpg" alt="图像处理作业4——图像金字塔多尺度特征提取（改进版）_金字塔特征提取-CSDN博客"></p>
<p>图像金字塔是指对同一个图像进行缩放，得到不同分辨率下的图像。金字塔的底部是高分辨率图像，顶部是低分辨率图像。在计算光流时，先从顶层图像开始计算，然后把上一层追踪结果，作为下一层光流的初始值，这是一个由粗至精的光流，也是实际光流法通常的流程。这个好处在于，当原始图像的像素运动较大时，在金字塔顶层图像看来，运动仍然在一个很小的范围内。</p>
<h3 id="光流实践小结"><a href="#光流实践小结" class="headerlink" title="光流实践小结"></a>光流实践小结</h3><p>LK光流跟踪能够直接得到特征点的对应关系，就像是描述子的匹配，只是光流对图像的连续性和光照稳定性要求较高。光流法可以加速基于特征点的视觉里程计算法，避免计算和匹配描述子的过程，但要求相机运动较为平滑。</p>
<h2 id="直接法"><a href="#直接法" class="headerlink" title="直接法"></a>直接法</h2><p>直接法的的目标是估计相机本身的三维空间运动，会产出一个六自由度的三维变换，描述相机从第一个位置移动到第二个位置的完整过程。</p>
<h3 id="直接法的推导"><a href="#直接法的推导" class="headerlink" title="直接法的推导"></a>直接法的推导</h3><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828161114606.png" alt="image-20250828161114606"></p>
<h3 id="直接法的讨论"><a href="#直接法的讨论" class="headerlink" title="直接法的讨论"></a>直接法的讨论</h3><p>假设$P$是一个已知位置的空间点，并且深度也是已知的，根据$P$的来源，可以把直接法分类</p>
<h4 id="稀疏直接法"><a href="#稀疏直接法" class="headerlink" title="稀疏直接法"></a>稀疏直接法</h4><p>这个方法最接近特征点法，这并不使用图像中所有的像素点，只是选择一组稀疏的、具有代表性的像素点。这些点通常时角点或者梯度非常明显的点。虽然要选择角点，但是与特征点法不同的是：<strong>它不计算描述子</strong>，而是直接使用角点周围的一小块图像(patch)的像素亮度信息进行追踪和位姿优化。速度虽然很快，但是信息丢失严重。</p>
<h4 id="稠密直接法"><a href="#稠密直接法" class="headerlink" title="稠密直接法"></a>稠密直接法</h4><p>这种方法最为极端，同时也是理论上利用信息最充分的方法</p>
<p>它会尝试使用图像帧中所有拥有有效深度值的像素来构建广度误差模型，进行位姿优化。信息最为完整，但是需要巨大的计算量</p>
<h4 id="半稠密直接法"><a href="#半稠密直接法" class="headerlink" title="半稠密直接法"></a>半稠密直接法</h4><p>这是介于稀疏和稠密之间的一种非常使用和流行的折中方案</p>
<p>它的策略是：<strong>选择图像中梯度（亮度变化）比较明显的像素点</strong>，这意味着会忽略大部分没有纹理的区域，但是会保留物体的边缘等所有能够提供优化信息的地方。</p>
<hr>
<h2 id="实践：直接法"><a href="#实践：直接法" class="headerlink" title="实践：直接法"></a>实践：直接法</h2><p>求解直接法最后等价于求解一个优化问题，因此可以使用g2o或者Ceres这些优化库来求解，同样也可以使用金字塔式的多层直接法。</p>
<p>将原始图片lift.png，五张不同位置图片000001-000005.png,一张深度图disparity.png放入文件夹<code>slambook/ch8/</code>下，新建文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sophus/se3.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pangolin/pangolin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Sophus;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useful typedefs</span></span><br><span class="line"><span class="keyword">typedef</span> Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">6</span>, <span class="number">6</span>&gt; Matrix6d;</span><br><span class="line"><span class="keyword">typedef</span> Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">2</span>, <span class="number">6</span>&gt; Matrix26d;</span><br><span class="line"><span class="keyword">typedef</span> Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">6</span>, <span class="number">1</span>&gt; Vector6d;</span><br><span class="line"><span class="keyword">typedef</span> vector&lt;Eigen::Vector2d, Eigen::aligned_allocator&lt;Eigen::Vector2d&gt;&gt; VecVector2d;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将相机内参封装到结构体中</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CameraIntrinsics</span> &#123;</span><br><span class="line">    <span class="type">double</span> fx, fy, cx, cy, baseline;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bilinear interpolation</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">float</span> <span class="title">GetPixelValue</span><span class="params">(<span class="type">const</span> cv::Mat &amp;img, <span class="type">float</span> x, <span class="type">float</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 边界检查</span></span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>) x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>) y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= img.cols - <span class="number">1</span>) x = img.cols - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= img.rows - <span class="number">1</span>) y = img.rows - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> xx = x - <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">float</span> yy = y - <span class="built_in">floor</span>(y);</span><br><span class="line">    <span class="type">int</span> x_int = <span class="built_in">floor</span>(x);</span><br><span class="line">    <span class="type">int</span> y_int = <span class="built_in">floor</span>(y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> - xx) * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int)</span><br><span class="line">           + xx * (<span class="number">1</span> - yy) * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int, x_int + <span class="number">1</span>)</span><br><span class="line">           + (<span class="number">1</span> - xx) * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int)</span><br><span class="line">           + xx * yy * img.<span class="built_in">at</span>&lt;uchar&gt;(y_int + <span class="number">1</span>, x_int + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// class for accumulator jacobians in parallel</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JacobianAccumulator</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">JacobianAccumulator</span>(</span><br><span class="line">        <span class="type">const</span> cv::Mat &amp;img1_,</span><br><span class="line">        <span class="type">const</span> cv::Mat &amp;img2_,</span><br><span class="line">        <span class="type">const</span> VecVector2d &amp;px_ref_,</span><br><span class="line">        <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref_,</span><br><span class="line">        <span class="type">const</span> CameraIntrinsics&amp; camera_,</span><br><span class="line">        SE3d &amp;T21_) :</span><br><span class="line">        <span class="built_in">img1</span>(img1_), <span class="built_in">img2</span>(img2_), <span class="built_in">px_ref</span>(px_ref_), <span class="built_in">depth_ref</span>(depth_ref_), <span class="built_in">camera</span>(camera_), <span class="built_in">T21</span>(T21_) &#123;</span><br><span class="line">        projection.<span class="built_in">resize</span>(px_ref.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">accumulate_jacobian</span><span class="params">(<span class="type">const</span> cv::Range &amp;range)</span></span>;</span><br><span class="line">    <span class="function">Matrix6d <span class="title">hessian</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> H; &#125;</span><br><span class="line">    <span class="function">Vector6d <span class="title">bias</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> b; &#125;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">cost_func</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> cost; &#125;</span><br><span class="line">    <span class="function">VecVector2d <span class="title">projected_points</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> projection; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        H = Matrix6d::<span class="built_in">Zero</span>();</span><br><span class="line">        b = Vector6d::<span class="built_in">Zero</span>();</span><br><span class="line">        cost = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> cv::Mat &amp;img1;</span><br><span class="line">    <span class="type">const</span> cv::Mat &amp;img2;</span><br><span class="line">    <span class="type">const</span> VecVector2d &amp;px_ref;</span><br><span class="line">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref;</span><br><span class="line">    <span class="type">const</span> CameraIntrinsics&amp; camera;</span><br><span class="line">    SE3d &amp;T21;</span><br><span class="line">    VecVector2d projection;</span><br><span class="line"></span><br><span class="line">    std::mutex hessian_mutex;</span><br><span class="line">    Matrix6d H = Matrix6d::<span class="built_in">Zero</span>();</span><br><span class="line">    Vector6d b = Vector6d::<span class="built_in">Zero</span>();</span><br><span class="line">    <span class="type">double</span> cost = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationSingleLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationMultiLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> string left_file = <span class="string">&quot;../left.png&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string disparity_file = <span class="string">&quot;../disparity.png&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string other_files_fmt = <span class="string">&quot;../%06d.png&quot;</span>;</span><br><span class="line"></span><br><span class="line">    CameraIntrinsics camera = &#123;<span class="number">718.856</span>, <span class="number">718.856</span>, <span class="number">607.1928</span>, <span class="number">185.2157</span>, <span class="number">0.573</span>&#125;;</span><br><span class="line"></span><br><span class="line">    cv::Mat left_img = cv::<span class="built_in">imread</span>(left_file, cv::IMREAD_GRAYSCALE);</span><br><span class="line">    cv::Mat disparity_img = cv::<span class="built_in">imread</span>(disparity_file, cv::IMREAD_GRAYSCALE);</span><br><span class="line"></span><br><span class="line">    cv::RNG rng;</span><br><span class="line">    <span class="type">int</span> nPoints = <span class="number">2000</span>;</span><br><span class="line">    <span class="type">int</span> boarder = <span class="number">20</span>;</span><br><span class="line">    VecVector2d pixels_ref;</span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; depth_ref;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nPoints; i++) &#123;</span><br><span class="line">        <span class="type">int</span> x = rng.<span class="built_in">uniform</span>(boarder, left_img.cols - boarder);</span><br><span class="line">        <span class="type">int</span> y = rng.<span class="built_in">uniform</span>(boarder, left_img.rows - boarder);</span><br><span class="line">        <span class="type">int</span> disparity = disparity_img.<span class="built_in">at</span>&lt;uchar&gt;(y, x);</span><br><span class="line">        <span class="keyword">if</span> (disparity == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">double</span> depth = camera.fx * camera.baseline / disparity;</span><br><span class="line">        depth_ref.<span class="built_in">push_back</span>(depth);</span><br><span class="line">        pixels_ref.<span class="built_in">push_back</span>(Eigen::<span class="built_in">Vector2d</span>(x, y));</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Generated &quot;</span> &lt;&lt; pixels_ref.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; reference points.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    SE3d T_cur_ref;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        <span class="type">char</span> filename[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(filename, <span class="built_in">sizeof</span>(filename), other_files_fmt.<span class="built_in">c_str</span>(), i);</span><br><span class="line">        cv::Mat img = cv::<span class="built_in">imread</span>(filename, cv::IMREAD_GRAYSCALE);</span><br><span class="line">        <span class="keyword">if</span> (img.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Could not load image &quot;</span> &lt;&lt; filename &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;\n--- Tracking frame &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; ---&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">DirectPoseEstimationMultiLayer</span>(left_img, img, pixels_ref, depth_ref, camera, T_cur_ref);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationSingleLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> iterations = <span class="number">10</span>;</span><br><span class="line">    <span class="type">double</span> cost = <span class="number">0</span>, lastCost = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="function">JacobianAccumulator <span class="title">jaco_accu</span><span class="params">(img1, img2, px_ref, depth_ref, camera, T21)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; iterations; iter++) &#123;</span><br><span class="line">        jaco_accu.<span class="built_in">reset</span>();</span><br><span class="line">        cv::<span class="built_in">parallel_for_</span>(cv::<span class="built_in">Range</span>(<span class="number">0</span>, px_ref.<span class="built_in">size</span>()),</span><br><span class="line">                          [&amp;](<span class="type">const</span> cv::Range&amp; range)&#123;</span><br><span class="line">                              jaco_accu.<span class="built_in">accumulate_jacobian</span>(range);</span><br><span class="line">                          &#125;);</span><br><span class="line">        Matrix6d H = jaco_accu.<span class="built_in">hessian</span>();</span><br><span class="line">        Vector6d b = jaco_accu.<span class="built_in">bias</span>();</span><br><span class="line"></span><br><span class="line">        Vector6d update = H.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(b);</span><br><span class="line">        T21 = SE3d::<span class="built_in">exp</span>(update) * T21;</span><br><span class="line">        cost = jaco_accu.<span class="built_in">cost_func</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (std::<span class="built_in">isnan</span>(update[<span class="number">0</span>])) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;update is nan&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (iter &gt; <span class="number">0</span> &amp;&amp; cost &gt; lastCost) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;cost increased: &quot;</span> &lt;&lt; cost &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; lastCost &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (update.<span class="built_in">norm</span>() &lt; <span class="number">1e-3</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastCost = cost;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;iteration: &quot;</span> &lt;&lt; iter &lt;&lt; <span class="string">&quot;, cost: &quot;</span> &lt;&lt; cost &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;T21 = \n&quot;</span> &lt;&lt; T<span class="number">21.</span><span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">auto</span> t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;direct method for single layer time: &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// plot the projected pixels</span></span><br><span class="line">    cv::Mat img2_show;</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img2, img2_show, cv::COLOR_GRAY2BGR);</span><br><span class="line">    VecVector2d projection = jaco_accu.<span class="built_in">projected_points</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; px_ref.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        <span class="keyword">auto</span> p_ref = px_ref[i];</span><br><span class="line">        <span class="keyword">auto</span> p_cur = projection[i];</span><br><span class="line">        <span class="keyword">if</span> (p_cur[<span class="number">0</span>] &gt; <span class="number">0</span> &amp;&amp; p_cur[<span class="number">1</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            cv::<span class="built_in">circle</span>(img2_show, cv::<span class="built_in">Point2f</span>(p_cur[<span class="number">0</span>], p_cur[<span class="number">1</span>]), <span class="number">2</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>), <span class="number">2</span>);</span><br><span class="line">            cv::<span class="built_in">line</span>(img2_show, cv::<span class="built_in">Point2f</span>(p_ref[<span class="number">0</span>], p_ref[<span class="number">1</span>]), cv::<span class="built_in">Point2f</span>(p_cur[<span class="number">0</span>], p_cur[<span class="number">1</span>]),</span><br><span class="line">                     cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">250</span>, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;current&quot;</span>, img2_show);</span><br><span class="line">    <span class="comment">// 【修改】将 waitKey(1) 改为 waitKey(0)，程序会在此暂停等待用户按键</span></span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">JacobianAccumulator::accumulate_jacobian</span><span class="params">(<span class="type">const</span> cv::Range &amp;range)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> half_patch_size = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> cnt_good = <span class="number">0</span>;</span><br><span class="line">    Matrix6d hessian_local = Matrix6d::<span class="built_in">Zero</span>();</span><br><span class="line">    Vector6d bias_local = Vector6d::<span class="built_in">Zero</span>();</span><br><span class="line">    <span class="type">double</span> cost_tmp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = range.start; i &lt; range.end; i++) &#123;</span><br><span class="line">        Eigen::Vector3d point_ref =</span><br><span class="line">            depth_ref[i] * Eigen::<span class="built_in">Vector3d</span>((px_ref[i][<span class="number">0</span>] - camera.cx) / camera.fx,</span><br><span class="line">                                           (px_ref[i][<span class="number">1</span>] - camera.cy) / camera.fy, <span class="number">1</span>);</span><br><span class="line">        Eigen::Vector3d point_cur = T21 * point_ref;</span><br><span class="line">        <span class="keyword">if</span> (point_cur[<span class="number">2</span>] &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> u = camera.fx * point_cur[<span class="number">0</span>] / point_cur[<span class="number">2</span>] + camera.cx;</span><br><span class="line">        <span class="type">float</span> v = camera.fy * point_cur[<span class="number">1</span>] / point_cur[<span class="number">2</span>] + camera.cy;</span><br><span class="line">        <span class="keyword">if</span> (u &lt; half_patch_size || u &gt; img<span class="number">2.</span>cols - half_patch_size ||</span><br><span class="line">            v &lt; half_patch_size || v &gt; img<span class="number">2.</span>rows - half_patch_size) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        projection[i] = Eigen::<span class="built_in">Vector2d</span>(u, v);</span><br><span class="line">        <span class="type">double</span> X = point_cur[<span class="number">0</span>], Y = point_cur[<span class="number">1</span>], Z = point_cur[<span class="number">2</span>];</span><br><span class="line">        <span class="type">double</span> Z_inv = <span class="number">1.0</span> / Z, Z2_inv = Z_inv * Z_inv;</span><br><span class="line">        cnt_good++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = -half_patch_size; x &lt;= half_patch_size; x++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> y = -half_patch_size; y &lt;= half_patch_size; y++) &#123;</span><br><span class="line">                <span class="type">double</span> error = <span class="built_in">GetPixelValue</span>(img1, px_ref[i][<span class="number">0</span>] + x, px_ref[i][<span class="number">1</span>] + y) -</span><br><span class="line">                               <span class="built_in">GetPixelValue</span>(img2, u + x, v + y);</span><br><span class="line">                Matrix26d J_pixel_xi;</span><br><span class="line">                Eigen::Vector2d J_img_pixel;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">0</span>) = camera.fx * Z_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">2</span>) = -camera.fx * X * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">3</span>) = -camera.fx * X * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">4</span>) = camera.fx + camera.fx * X * X * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">0</span>, <span class="number">5</span>) = -camera.fx * Y * Z_inv;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">0</span>) = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">1</span>) = camera.fy * Z_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">2</span>) = -camera.fy * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">3</span>) = -camera.fy - camera.fy * Y * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">4</span>) = camera.fy * X * Y * Z2_inv;</span><br><span class="line">                <span class="built_in">J_pixel_xi</span>(<span class="number">1</span>, <span class="number">5</span>) = camera.fy * X * Z_inv;</span><br><span class="line"></span><br><span class="line">                J_img_pixel = Eigen::<span class="built_in">Vector2d</span>(</span><br><span class="line">                    <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, u + <span class="number">1</span> + x, v + y) - <span class="built_in">GetPixelValue</span>(img2, u - <span class="number">1</span> + x, v + y)),</span><br><span class="line">                    <span class="number">0.5</span> * (<span class="built_in">GetPixelValue</span>(img2, u + x, v + <span class="number">1</span> + y) - <span class="built_in">GetPixelValue</span>(img2, u + x, v - <span class="number">1</span> + y))</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                Vector6d J = <span class="number">-1.0</span> * (J_img_pixel.<span class="built_in">transpose</span>() * J_pixel_xi).<span class="built_in">transpose</span>();</span><br><span class="line">                hessian_local += J * J.<span class="built_in">transpose</span>();</span><br><span class="line">                bias_local += -error * J;</span><br><span class="line">                cost_tmp += error * error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cnt_good) &#123;</span><br><span class="line">        <span class="function">unique_lock&lt;mutex&gt; <span class="title">lck</span><span class="params">(hessian_mutex)</span></span>;</span><br><span class="line">        H += hessian_local;</span><br><span class="line">        b += bias_local;</span><br><span class="line">        cost += cost_tmp / cnt_good;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DirectPoseEstimationMultiLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> cv::Mat &amp;img2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VecVector2d &amp;px_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;<span class="type">double</span>&gt; &amp;depth_ref,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CameraIntrinsics&amp; camera_master,</span></span></span><br><span class="line"><span class="params"><span class="function">    SE3d &amp;T21)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pyramids = <span class="number">4</span>;</span><br><span class="line">    <span class="type">double</span> pyramid_scale = <span class="number">0.5</span>;</span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; scales = &#123;<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.25</span>, <span class="number">0.125</span>&#125;;</span><br><span class="line"></span><br><span class="line">    vector&lt;cv::Mat&gt; pyr1, pyr2;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pyramids; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cv::Mat img1_pyr, img2_pyr;</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr1[i - <span class="number">1</span>], img1_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr1[i - <span class="number">1</span>].cols * pyramid_scale, pyr1[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            cv::<span class="built_in">resize</span>(pyr2[i - <span class="number">1</span>], img2_pyr,</span><br><span class="line">                       cv::<span class="built_in">Size</span>(pyr2[i - <span class="number">1</span>].cols * pyramid_scale, pyr2[i - <span class="number">1</span>].rows * pyramid_scale));</span><br><span class="line">            pyr<span class="number">1.</span><span class="built_in">push_back</span>(img1_pyr);</span><br><span class="line">            pyr<span class="number">2.</span><span class="built_in">push_back</span>(img2_pyr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CameraIntrinsics camera_pyr = camera_master;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> level = pyramids - <span class="number">1</span>; level &gt;= <span class="number">0</span>; level--) &#123;</span><br><span class="line">        VecVector2d px_ref_pyr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;px: px_ref) &#123;</span><br><span class="line">            px_ref_pyr.<span class="built_in">push_back</span>(scales[level] * px);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        camera_pyr.fx = camera_master.fx * scales[level];</span><br><span class="line">        camera_pyr.fy = camera_master.fy * scales[level];</span><br><span class="line">        camera_pyr.cx = camera_master.cx * scales[level];</span><br><span class="line">        camera_pyr.cy = camera_master.cy * scales[level];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">DirectPoseEstimationSingleLayer</span>(pyr1[level], pyr2[level], px_ref_pyr, depth_ref, camera_pyr, T21);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch8/build$ ./direct_method </span><br><span class="line">Generated 2000 reference points.</span><br><span class="line"></span><br><span class="line">--- Tracking frame 1 ---</span><br><span class="line">iteration: 0, cost: 1.3471e+07</span><br><span class="line">iteration: 1, cost: 5.51357e+06</span><br><span class="line">iteration: 2, cost: 2.05839e+06</span><br><span class="line">iteration: 3, cost: 1.4464e+06</span><br><span class="line">cost increased: 1.44682e+06, 1.4464e+06</span><br><span class="line">T21 = </span><br><span class="line">   0.999991  0.00227962  0.00349265 -0.00108759</span><br><span class="line">-0.00228906    0.999994  0.00270175 0.000362411</span><br><span class="line">-0.00348647 -0.00270972     0.99999     -0.7297</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.0482883s</span><br><span class="line">iteration: 0, cost: 1.87757e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999989   0.00302426   0.00350356 -8.65681e-05</span><br><span class="line"> -0.00303232     0.999993   0.00229621    0.0054432</span><br><span class="line"> -0.00349659   -0.0023068     0.999991    -0.728436</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.0139432s</span><br><span class="line">iteration: 0, cost: 2.60309e+06</span><br><span class="line">iteration: 1, cost: 2.17855e+06</span><br><span class="line">cost increased: 2.38003e+06, 2.17855e+06</span><br><span class="line">T21 = </span><br><span class="line">   0.999991   0.0025115  0.00346968 -0.00289651</span><br><span class="line">-0.00251964    0.999994  0.00234158  0.00227251</span><br><span class="line">-0.00346378  -0.0023503    0.999991   -0.734471</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.0226829s</span><br><span class="line">iteration: 0, cost: 3.28428e+06</span><br><span class="line">cost increased: 3.50009e+06, 3.28428e+06</span><br><span class="line">T21 = </span><br><span class="line">   0.999991  0.00247928  0.00343485 -0.00376434</span><br><span class="line">-0.00248683    0.999994  0.00219501  0.00304134</span><br><span class="line">-0.00342939 -0.00220353    0.999992   -0.732337</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.0151728s</span><br><span class="line"></span><br><span class="line">--- Tracking frame 2 ---</span><br><span class="line">iteration: 0, cost: 1.16978e+07</span><br><span class="line">iteration: 1, cost: 7.92955e+06</span><br><span class="line">iteration: 2, cost: 3.99292e+06</span><br><span class="line">iteration: 3, cost: 2.62454e+06</span><br><span class="line">iteration: 4, cost: 2.38463e+06</span><br><span class="line">iteration: 5, cost: 2.27323e+06</span><br><span class="line">iteration: 6, cost: 2.16749e+06</span><br><span class="line">......</span><br><span class="line">--- Tracking frame 5 ---</span><br><span class="line">iteration: 0, cost: 1.21048e+07</span><br><span class="line">iteration: 1, cost: 1.04308e+07</span><br><span class="line">iteration: 2, cost: 7.52323e+06</span><br><span class="line">iteration: 3, cost: 6.06915e+06</span><br><span class="line">iteration: 4, cost: 5.22205e+06</span><br><span class="line">iteration: 5, cost: 5.10158e+06</span><br><span class="line">iteration: 6, cost: 4.88033e+06</span><br><span class="line">iteration: 7, cost: 4.63755e+06</span><br><span class="line">cost increased: 4.69869e+06, 4.63755e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999803  0.000619207    0.0198397    0.0421073</span><br><span class="line">-0.000761828     0.999974   0.00718192    0.0117245</span><br><span class="line">  -0.0198347  -0.00719562     0.999777      -3.7619</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.0497371s</span><br><span class="line">iteration: 0, cost: 7.16515e+06</span><br><span class="line">iteration: 1, cost: 6.18497e+06</span><br><span class="line">cost increased: 6.3539e+06, 6.18497e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999784  0.000773241    0.0207706   0.00636215</span><br><span class="line">-0.000915734     0.999976   0.00685172   0.00514185</span><br><span class="line">  -0.0207648  -0.00686926     0.999761      -3.8278</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.0140251s</span><br><span class="line">iteration: 0, cost: 8.39277e+06</span><br><span class="line">cost increased: 8.62659e+06, 8.39277e+06</span><br><span class="line">T21 = </span><br><span class="line">    0.999781  0.000735254    0.0209358  -0.00402205</span><br><span class="line">-0.000868872     0.999979   0.00637387    0.0088492</span><br><span class="line">  -0.0209307  -0.00639066     0.999761     -3.84657</span><br><span class="line">           0            0            0            1</span><br><span class="line">direct method for single layer time: 0.00886143s</span><br><span class="line">iteration: 0, cost: 1.06391e+07</span><br><span class="line">cost increased: 1.07386e+07, 1.06391e+07</span><br><span class="line">T21 = </span><br><span class="line">   0.999787 0.000976808   0.0205927 -0.00158126</span><br><span class="line">-0.00110271    0.999981  0.00610343   0.0103151</span><br><span class="line"> -0.0205864 -0.00612484    0.999769    -3.85441</span><br><span class="line">          0           0           0           1</span><br><span class="line">direct method for single layer time: 0.00941341s</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828165648850.png" alt="image-20250828165648850"></p>
<p>会依次输出金字塔0-3的直接法所展示的像素运动图片。并且依次在终端输出四层金字塔的其次变换矩阵，会变得更加精准。会输出5个循环。</p>
<p>最终第五张图片显示大约是相机向前运动了3.8米。</p>
<hr>
<blockquote>
<p>直接法迭代过程</p>
</blockquote>
<p>直接法完全依靠优化来求解相机位姿，像素梯度引导着优化的方向，，所以必须保证大部分像素梯度能够把优化引导到正确的地方。假设对于参考图像，我们测量到了一个灰度值是229的像素，并且知道深度，就可以图短处空间点p的位置，此时我们又得到了一幅新的图像，需要估计它的相机位姿，需要不断迭代。假设初始值比较大，空间点p投影后像素灰度值是126。于是此像素的误差值是103，为了减少误差，希望调整相机的位姿，使得像素更亮一些。</p>
<p>那么怎么知道往哪里微调像素会更亮？所以就需要局部像素梯度，在一个局部区域，我们可以得到一个梯度$[-3,-18]$，所以为了提高亮度，我们会建议优化算法微调相机，是P的像素往左上方移动，这个迭代过程中，我们用像素的局部梯度近似它附近的灰度分布。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-6850c4e4acb75faa5e52010975d41686_r.jpg" alt="【读书笔记-视觉SLAM十四讲-第8讲】视觉里程计 2：直接法 - 知乎"></p>
<p>综合了其他像素的意见之后，优化算法会选择一个和我们建议的方向偏移不远的地方，计算出一个更新量$exp(ξ∧)$,加上更新量之后，图像发生对应移动，像素投影位置会变到一个更亮的地方。在理想情况下，误差会逐渐变小，直至收敛。</p>
<p>总的来说，一次迭代有如下步骤：</p>
<p>首先假设</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250828173323922.png" alt="image-20250828173323922"></p>
<ol>
<li>计算当前位姿下的投影和误差</li>
<li>线性化——求误差如何随位姿变化</li>
<li>通过高斯牛顿法来求解得到迭代的最优位姿增量$δξ$</li>
<li>更新位姿</li>
</ol>
<hr>
<p>但是直接法的梯度是由图像梯度确定的，<strong>必须保证沿着图像梯度走时，灰度误差会不断下降</strong>，但是沿着图像梯度走时，很容易落入一个局部极小值之中，无法继续优化，所以只有当相机运动很小的时候，图像中的梯度不会有很强的非凸性，直接法才能成立。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/v2-22736e7053e97845983719468bb27613_r.jpg" alt="【读书笔记-视觉SLAM十四讲-第8讲】视觉里程计 2：直接法 - 知乎"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E4%BA%8C%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%BB%BA%E5%9B%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E4%BA%8C%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%BB%BA%E5%9B%BE/" class="post-title-link" itemprop="url">第十二讲-建图</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:30:57" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第十二讲）——建图"><a href="#视觉SLAM十四讲（第十二讲）——建图" class="headerlink" title="视觉SLAM十四讲（第十二讲）——建图"></a>视觉SLAM十四讲（第十二讲）——建图</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在经典SLAM模型中，所谓的地图，就是所有路标点的集合。一旦确定路标点的位置，就可以说我们完成了建图。关于地图的用处，大致分为以下几类：</p>
<ol>
<li><p>定位</p>
<p>定位是地图的一项基本功能。视觉里程计部分，可以通过局部地图实现定位。回环检测部分，只要有全局描述子信息，也可以通过回环检测确定机器人位置。</p>
</li>
<li><p>导航</p>
<p>导航是指机器人能够在地图中进行路径规划，在任意两个地图点之间寻找路径，然后控制自己运动到目标点的过程。在该过程中至少需要知道地图中<strong>哪些地方不可通过</strong>，这超出了稀疏特征点地图的能力范围，需要另外的地图形式，至少是一种<strong>稠密</strong>的地图。</p>
</li>
<li><p>避障</p>
<p>避障与导航类似，但更注重局部、动态的障碍物处理。同样，仅有特征点无法判断某个特征点是否是障碍物，需要稠密地图。</p>
</li>
<li><p>重建</p>
<p>有时希望利用SLAM获得周围环境的重建效果，这种地图主要用于向人展示，我们也可以将该地图用于通信，使其他人能够远程观看重建得到的三维物体或者场景，这种地图也是稠密的。</p>
</li>
<li><p>交互</p>
<p>主要指人与地图之间有一些互动，需要更高层面的认知——语义地图。</p>
</li>
</ol>
<p>所谓稠密地图是相对于稀疏地图而言，稀疏地图是建模感兴趣的部分，即特征点。稠密地图是指建模所有看到过的部分。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/be392d965ec7efb142f30f90aa45ad77.png" alt="在这里插入图片描述"></p>
<h2 id="单目稠密重建"><a href="#单目稠密重建" class="headerlink" title="单目稠密重建"></a>单目稠密重建</h2><h3 id="立体视觉"><a href="#立体视觉" class="headerlink" title="立体视觉"></a>立体视觉</h3><p>单幅图像中的像素，只能提供物体与相机成像平面的角度以及物体采集到的亮度，无法提供物体的距离，所以想要知道每一个像素点的距离，可以：</p>
<ol>
<li>使用单目相机，估计相机运动，三角化计算像素距离</li>
<li>使用双目相机，利用左右目视差计算像素距离</li>
<li>使用RGB-D相机直接获得像素距离</li>
</ol>
<p>前两种称为立体视觉（SV，Stereo Vision）.其中移动单目相机又称为移动视角的立体视觉（MSV, Moving View Stereo）</p>
<p>下面实现单目的稠密估计。</p>
<h3 id="极线搜索与块匹配"><a href="#极线搜索与块匹配" class="headerlink" title="极线搜索与块匹配"></a>极线搜索与块匹配</h3><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/e456f9b908ac741c2bc595033c34c399.png" alt="在这里插入图片描述"></p>
<p>现在介绍的是基于多视图集合（MSV）</p>
<p><strong>第一步：获得精确的相机位姿</strong></p>
<p>这是进行稠密估计的绝对前提，我们需要一个已经运行良好的SLAM系统的后端，来提供一系列关键帧，以及它们之间被精确优化过的相对位姿。</p>
<p><strong>第二步：选择参考帧和匹配帧</strong></p>
<p>需要选择一个参考帧，然后从邻近关键帧中，选择几个视角和它有一定差异但是有足够重叠区域的匹配帧。</p>
<p><strong>第三步：极限搜索与立体匹配</strong></p>
<p>对于参考帧的每一个像素，都需要知道它的深度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250903111631612.png" alt="image-20250903111631612"></p>
<p>但是如果极线上有很多和p1相似的点，可以在p1周围取一个小块，在极线上也取同样大小的小块进行比较，这既是所谓的<strong>块匹配</strong>。对参考帧的某个像素，在匹配的极线上计算相似度，我们得到的不是一个完美的、唯一的匹配点，是一个相似度分布。这个分布可能是一个明显的、尖锐的峰值。如果每次都简单地选择相似度最高的那个点，结果会非常不稳定。所以<strong>深度滤波器</strong>就登场了。这是一种概率方法，用来优雅处理不确定性，并且将来自多个视图的信息融合起来，最终得到一个稳定并且准确的深度估计。</p>
<h3 id="高斯分布的深度滤波器"><a href="#高斯分布的深度滤波器" class="headerlink" title="高斯分布的深度滤波器"></a>高斯分布的深度滤波器</h3><p><strong>核心定义</strong>：深度滤波器是一种<strong>时域</strong>上的滤波器，它不依赖于单次测量，而是将一个像素的深度值建模为一个<strong>概率分布</strong>，并通过连续的、来自新视角的观测来<strong>不断更新和收敛</strong>这个分布，最终得到一个高置信度的深度估计。</p>
<p>最常见的深度滤波器实现，是假设每个像素的逆深度服从高斯分布。其中：</p>
<ul>
<li><strong>均值 μ</strong>：代表当前对逆深度的<strong>最佳估计值</strong>。</li>
<li><strong>方差 σ²</strong>：代表这个估计值的<strong>不确定性</strong>。方差越大，不确定性越高，我们对这个估计值越没信心</li>
</ul>
<p>步骤如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250903162711493.png" alt="image-20250903162711493"></p>
<p><strong>第三步</strong>：收敛与输出</p>
<p>不断重复第二步更新过程，方差会不断减小，当方差小于一个预设的阈值，就认为这个点的深度已经收敛，均值就是一个稳定、可靠的深度估计，这个点就可以被输出，用于构建稠密地图。同时滤波器还会进行内点外点判断，来增加算法鲁棒性。</p>
<hr>
<h2 id="实践：单目稠密重建"><a href="#实践：单目稠密重建" class="headerlink" title="实践：单目稠密重建"></a>实践：单目稠密重建</h2><p>下载数据集：<a target="_blank" rel="noopener" href="http://rpg.ifi.uzh.ch/datasets/remode_test_data.zip">http://rpg.ifi.uzh.ch/datasets/remode_test_data.zip</a></p>
<p>新建文件夹：<code>slambook/ch12/dataset/</code>c存放数据集：test_data</p>
<p>新建文件夹及文件：<code>slambook/dense_mono/dense/mapping.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;fstream&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">// #include &lt;boost/timer.hpp&gt; // 如果需要计时，可以取消此行注释</span><br><span class="line"></span><br><span class="line">// for sophus</span><br><span class="line">#include &lt;sophus/se3.hpp&gt;</span><br><span class="line"></span><br><span class="line">using Sophus::SE3d;</span><br><span class="line"></span><br><span class="line">// for eigen</span><br><span class="line">#include &lt;Eigen/Core&gt;</span><br><span class="line">#include &lt;Eigen/Geometry&gt;</span><br><span class="line"></span><br><span class="line">using namespace Eigen;</span><br><span class="line"></span><br><span class="line">#include &lt;opencv2/core/core.hpp&gt;</span><br><span class="line">#include &lt;opencv2/highgui/highgui.hpp&gt;</span><br><span class="line">#include &lt;opencv2/imgproc/imgproc.hpp&gt;</span><br><span class="line"></span><br><span class="line">using namespace cv;</span><br><span class="line"></span><br><span class="line">// ... (函数声明和参数定义与您提供的版本相同，为简洁省略)</span><br><span class="line">// ... 您原来的所有函数声明和参数定义都保留在这里 ...</span><br><span class="line"></span><br><span class="line">// ------------------------------------------------------------------</span><br><span class="line">// parameters</span><br><span class="line">const int boarder = 20;      // 边缘宽度</span><br><span class="line">const int width = 640;       // 图像宽度</span><br><span class="line">const int height = 480;      // 图像高度</span><br><span class="line">const double fx = 481.2f;    // 相机内参</span><br><span class="line">const double fy = -480.0f;   // 注意这个负号，是REMODE数据集的特殊相机模型</span><br><span class="line">const double cx = 319.5f;</span><br><span class="line">const double cy = 239.5f;</span><br><span class="line">const int ncc_window_size = 3;    // NCC 取的窗口半宽度</span><br><span class="line">const int ncc_area = (2 * ncc_window_size + 1) * (2 * ncc_window_size + 1); // NCC窗口面积</span><br><span class="line">const double min_cov = 0.1;       // 收敛判定：最小方差</span><br><span class="line">const double max_cov = 10;        // 发散判定：最大方差</span><br><span class="line"></span><br><span class="line">// 函数声明</span><br><span class="line">bool readDatasetFiles(</span><br><span class="line">    const string &amp;path,</span><br><span class="line">    vector&lt;string&gt; &amp;color_image_files,</span><br><span class="line">    vector&lt;SE3d&gt; &amp;poses,</span><br><span class="line">    cv::Mat &amp;ref_depth</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">bool update(</span><br><span class="line">    const Mat &amp;ref,</span><br><span class="line">    const Mat &amp;curr,</span><br><span class="line">    const SE3d &amp;T_C_R,</span><br><span class="line">    Mat &amp;depth,</span><br><span class="line">    Mat &amp;depth_cov2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">bool epipolarSearch(</span><br><span class="line">    const Mat &amp;ref,</span><br><span class="line">    const Mat &amp;curr,</span><br><span class="line">    const SE3d &amp;T_C_R,</span><br><span class="line">    const Vector2d &amp;pt_ref,</span><br><span class="line">    const double &amp;depth_mu,</span><br><span class="line">    const double &amp;depth_cov,</span><br><span class="line">    Vector2d &amp;pt_curr,</span><br><span class="line">    Vector2d &amp;epipolar_direction</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">bool updateDepthFilter(</span><br><span class="line">    const Vector2d &amp;pt_ref,</span><br><span class="line">    const Vector2d &amp;pt_curr,</span><br><span class="line">    const SE3d &amp;T_C_R,</span><br><span class="line">    const Vector2d &amp;epipolar_direction,</span><br><span class="line">    Mat &amp;depth,</span><br><span class="line">    Mat &amp;depth_cov2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">double NCC(const Mat &amp;ref, const Mat &amp;curr, const Vector2d &amp;pt_ref, const Vector2d &amp;pt_curr);</span><br><span class="line">inline double getBilinearInterpolatedValue(const Mat &amp;img, const Vector2d &amp;pt);</span><br><span class="line">void plotDepth(const Mat &amp;depth_truth, const Mat &amp;depth_estimate);</span><br><span class="line">inline Vector3d px2cam(const Vector2d px);</span><br><span class="line">inline Vector2d cam2px(const Vector3d p_cam);</span><br><span class="line">inline bool inside(const Vector2d &amp;pt);</span><br><span class="line">void showEpipolarMatch(const Mat &amp;ref, const Mat &amp;curr, const Vector2d &amp;px_ref, const Vector2d &amp;px_curr);</span><br><span class="line">void showEpipolarLine(const Mat &amp;ref, const Mat &amp;curr, const Vector2d &amp;px_ref, const Vector2d &amp;px_min_curr,</span><br><span class="line">                      const Vector2d &amp;px_max_curr);</span><br><span class="line">void evaludateDepth(const Mat &amp;depth_truth, const Mat &amp;depth_estimate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">    if (argc != 2) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;Usage: dense_mapping path_to_test_dataset&quot; &lt;&lt; endl;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vector&lt;string&gt; color_image_files;</span><br><span class="line">    vector&lt;SE3d&gt; poses_TWC;</span><br><span class="line">    Mat ref_depth;</span><br><span class="line">    bool ret = readDatasetFiles(argv[1], color_image_files, poses_TWC, ref_depth);</span><br><span class="line">    if (!ret) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;Reading image files failed!&quot; &lt;&lt; endl;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; &quot;read total &quot; &lt;&lt; color_image_files.size() &lt;&lt; &quot; files.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    Mat ref = imread(color_image_files[0], 0);</span><br><span class="line">    SE3d pose_ref_TWC = poses_TWC[0];</span><br><span class="line">    double init_depth = 3.0;</span><br><span class="line">    double init_cov2 = 3.0;</span><br><span class="line">    Mat depth(height, width, CV_64F, init_depth);</span><br><span class="line">    Mat depth_cov2(height, width, CV_64F, init_cov2);</span><br><span class="line"></span><br><span class="line">    for (int index = 1; index &lt; color_image_files.size(); index++) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;*** loop &quot; &lt;&lt; index &lt;&lt; &quot; ***&quot; &lt;&lt; endl;</span><br><span class="line">        Mat curr = imread(color_image_files[index], 0);</span><br><span class="line">        if (curr.empty()) continue;</span><br><span class="line">        SE3d pose_curr_TWC = poses_TWC[index];</span><br><span class="line">        SE3d pose_T_C_R = pose_curr_TWC.inverse() * pose_ref_TWC;</span><br><span class="line">        update(ref, curr, pose_T_C_R, depth, depth_cov2);</span><br><span class="line">        evaludateDepth(ref_depth, depth);</span><br><span class="line">        plotDepth(ref_depth, depth);</span><br><span class="line">        imshow(&quot;image&quot;, curr);</span><br><span class="line">        waitKey(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;estimation returns, saving depth map ...&quot; &lt;&lt; endl;</span><br><span class="line">    imwrite(&quot;depth.png&quot;, depth);</span><br><span class="line">    cout &lt;&lt; &quot;done.&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool readDatasetFiles(</span><br><span class="line">    const string &amp;path,</span><br><span class="line">    vector&lt;string&gt; &amp;color_image_files,</span><br><span class="line">    std::vector&lt;SE3d&gt; &amp;poses,</span><br><span class="line">    cv::Mat &amp;ref_depth) &#123;</span><br><span class="line">    ifstream fin(path + &quot;/first_200_frames_traj_over_table_input_sequence.txt&quot;);</span><br><span class="line">    if (!fin) return false;</span><br><span class="line"></span><br><span class="line">    // 【修正】: 使用更健壮的文件读取循环</span><br><span class="line">    string image;</span><br><span class="line">    double data[7];</span><br><span class="line">    while (fin &gt;&gt; image &gt;&gt; data[0] &gt;&gt; data[1] &gt;&gt; data[2] &gt;&gt; data[3] &gt;&gt; data[4] &gt;&gt; data[5] &gt;&gt; data[6]) &#123;</span><br><span class="line">        color_image_files.push_back(path + string(&quot;/images/&quot;) + image);</span><br><span class="line">        poses.push_back(</span><br><span class="line">            SE3d(Quaterniond(data[6], data[3], data[4], data[5]),</span><br><span class="line">                 Vector3d(data[0], data[1], data[2]))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    fin.close();</span><br><span class="line"></span><br><span class="line">    fin.open(path + &quot;/depthmaps/scene_000.depth&quot;);</span><br><span class="line">    ref_depth = cv::Mat(height, width, CV_64F);</span><br><span class="line">    if (!fin) return false;</span><br><span class="line">    for (int y = 0; y &lt; height; y++)</span><br><span class="line">        for (int x = 0; x &lt; width; x++) &#123;</span><br><span class="line">            double depth = 0;</span><br><span class="line">            fin &gt;&gt; depth;</span><br><span class="line">            ref_depth.ptr&lt;double&gt;(y)[x] = depth / 100.0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ... 您原来的其他函数实现保持不变 ...</span><br><span class="line"></span><br><span class="line">// 这里只展示需要修改的函数</span><br><span class="line">void showEpipolarMatch(const Mat &amp;ref, const Mat &amp;curr, const Vector2d &amp;px_ref, const Vector2d &amp;px_curr) &#123;</span><br><span class="line">    Mat ref_show, curr_show;</span><br><span class="line">    // 【修正】: 使用 OpenCV 4+ 的正确颜色转换标志</span><br><span class="line">    cv::cvtColor(ref, ref_show, cv::COLOR_GRAY2BGR);</span><br><span class="line">    cv::cvtColor(curr, curr_show, cv::COLOR_GRAY2BGR);</span><br><span class="line"></span><br><span class="line">    cv::circle(ref_show, cv::Point2f(px_ref(0, 0), px_ref(1, 0)), 5, cv::Scalar(0, 0, 250), 2);</span><br><span class="line">    cv::circle(curr_show, cv::Point2f(px_curr(0, 0), px_curr(1, 0)), 5, cv::Scalar(0, 0, 250), 2);</span><br><span class="line"></span><br><span class="line">    imshow(&quot;ref&quot;, ref_show);</span><br><span class="line">    imshow(&quot;curr&quot;, curr_show);</span><br><span class="line">    waitKey(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void showEpipolarLine(const Mat &amp;ref, const Mat &amp;curr, const Vector2d &amp;px_ref, const Vector2d &amp;px_min_curr,</span><br><span class="line">                      const Vector2d &amp;px_max_curr) &#123;</span><br><span class="line">    Mat ref_show, curr_show;</span><br><span class="line">    // 【修正】: 使用 OpenCV 4+ 的正确颜色转换标志</span><br><span class="line">    cv::cvtColor(ref, ref_show, cv::COLOR_GRAY2BGR);</span><br><span class="line">    cv::cvtColor(curr, curr_show, cv::COLOR_GRAY2BGR);</span><br><span class="line"></span><br><span class="line">    cv::circle(ref_show, cv::Point2f(px_ref(0, 0), px_ref(1, 0)), 5, cv::Scalar(0, 255, 0), 2);</span><br><span class="line">    cv::circle(curr_show, cv::Point2f(px_min_curr(0, 0), px_min_curr(1, 0)), 5, cv::Scalar(0, 255, 0), 2);</span><br><span class="line">    cv::circle(curr_show, cv::Point2f(px_max_curr(0, 0), px_max_curr(1, 0)), 5, cv::Scalar(0, 255, 0), 2);</span><br><span class="line">    cv::line(curr_show, Point2f(px_min_curr(0, 0), px_min_curr(1, 0)), Point2f(px_max_curr(0, 0), px_max_curr(1, 0)),</span><br><span class="line">             Scalar(0, 255, 0), 1);</span><br><span class="line"></span><br><span class="line">    imshow(&quot;ref&quot;, ref_show);</span><br><span class="line">    imshow(&quot;curr&quot;, curr_show);</span><br><span class="line">    waitKey(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ... 您的其他所有函数实现都保持原样，这里不再重复列出 ...</span><br><span class="line">// （getBilinearInterpolatedValue, NCC, updateDepthFilter, 等函数都不需要修改）</span><br><span class="line">// --- 复制您源文件中未在这里列出的所有函数到这里 ---</span><br><span class="line">inline double getBilinearInterpolatedValue(const Mat &amp;img, const Vector2d &amp;pt) &#123;</span><br><span class="line">    // 确保访问在图像范围内</span><br><span class="line">    int x = static_cast&lt;int&gt;(pt(0, 0));</span><br><span class="line">    int y = static_cast&lt;int&gt;(pt(1, 0));</span><br><span class="line">    if (x &lt; 0 || x &gt;= img.cols - 1 || y &lt; 0 || y &gt;= img.rows - 1)</span><br><span class="line">        return 0.0;</span><br><span class="line">    uchar *d = &amp;img.data[y * img.step + x];</span><br><span class="line">    double xx = pt(0, 0) - floor(pt(0, 0));</span><br><span class="line">    double yy = pt(1, 0) - floor(pt(1, 0));</span><br><span class="line">    return ((1 - xx) * (1 - yy) * double(d[0]) +</span><br><span class="line">            xx * (1 - yy) * double(d[1]) +</span><br><span class="line">            (1 - xx) * yy * double(d[img.step]) +</span><br><span class="line">            xx * yy * double(d[img.step + 1])) / 255.0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool update(const Mat &amp;ref, const Mat &amp;curr, const SE3d &amp;T_C_R, Mat &amp;depth, Mat &amp;depth_cov2) &#123;</span><br><span class="line">    for (int x = boarder; x &lt; width - boarder; x++)</span><br><span class="line">        for (int y = boarder; y &lt; height - boarder; y++) &#123;</span><br><span class="line">            if (depth_cov2.ptr&lt;double&gt;(y)[x] &lt; min_cov || depth_cov2.ptr&lt;double&gt;(y)[x] &gt; max_cov)</span><br><span class="line">                continue;</span><br><span class="line">            Vector2d pt_curr;</span><br><span class="line">            Vector2d epipolar_direction;</span><br><span class="line">            bool ret = epipolarSearch(</span><br><span class="line">                ref,</span><br><span class="line">                curr,</span><br><span class="line">                T_C_R,</span><br><span class="line">                Vector2d(x, y),</span><br><span class="line">                depth.ptr&lt;double&gt;(y)[x],</span><br><span class="line">                sqrt(depth_cov2.ptr&lt;double&gt;(y)[x]),</span><br><span class="line">                pt_curr,</span><br><span class="line">                epipolar_direction</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            if (!ret)</span><br><span class="line">                continue;</span><br><span class="line"></span><br><span class="line">            updateDepthFilter(Vector2d(x, y), pt_curr, T_C_R, epipolar_direction, depth, depth_cov2);</span><br><span class="line">        &#125;</span><br><span class="line">    return true; // 添加返回值</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bool epipolarSearch(</span><br><span class="line">    const Mat &amp;ref, const Mat &amp;curr,</span><br><span class="line">    const SE3d &amp;T_C_R, const Vector2d &amp;pt_ref,</span><br><span class="line">    const double &amp;depth_mu, const double &amp;depth_cov,</span><br><span class="line">    Vector2d &amp;pt_curr, Vector2d &amp;epipolar_direction) &#123;</span><br><span class="line">    Vector3d f_ref = px2cam(pt_ref);</span><br><span class="line">    f_ref.normalize();</span><br><span class="line">    Vector3d P_ref = f_ref * depth_mu;</span><br><span class="line"></span><br><span class="line">    Vector2d px_mean_curr = cam2px(T_C_R * P_ref);</span><br><span class="line">    double d_min = depth_mu - 3 * depth_cov, d_max = depth_mu + 3 * depth_cov;</span><br><span class="line">    if (d_min &lt; 0.1) d_min = 0.1;</span><br><span class="line">    Vector2d px_min_curr = cam2px(T_C_R * (f_ref * d_min));</span><br><span class="line">    Vector2d px_max_curr = cam2px(T_C_R * (f_ref * d_max));</span><br><span class="line"></span><br><span class="line">    Vector2d epipolar_line = px_max_curr - px_min_curr;</span><br><span class="line">    epipolar_direction = epipolar_line;</span><br><span class="line">    epipolar_direction.normalize();</span><br><span class="line">    double half_length = 0.5 * epipolar_line.norm();</span><br><span class="line">    if (half_length &gt; 100) half_length = 100;</span><br><span class="line"></span><br><span class="line">    double best_ncc = -1.0;</span><br><span class="line">    Vector2d best_px_curr;</span><br><span class="line">    for (double l = -half_length; l &lt;= half_length; l += 0.7) &#123;</span><br><span class="line">        Vector2d px_curr = px_mean_curr + l * epipolar_direction;</span><br><span class="line">        if (!inside(px_curr))</span><br><span class="line">            continue;</span><br><span class="line">        double ncc = NCC(ref, curr, pt_ref, px_curr);</span><br><span class="line">        if (ncc &gt; best_ncc) &#123;</span><br><span class="line">            best_ncc = ncc;</span><br><span class="line">            best_px_curr = px_curr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (best_ncc &lt; 0.85f)</span><br><span class="line">        return false;</span><br><span class="line">    pt_curr = best_px_curr;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double NCC(</span><br><span class="line">    const Mat &amp;ref, const Mat &amp;curr,</span><br><span class="line">    const Vector2d &amp;pt_ref, const Vector2d &amp;pt_curr) &#123;</span><br><span class="line">    double mean_ref = 0, mean_curr = 0;</span><br><span class="line">    vector&lt;double&gt; values_ref, values_curr;</span><br><span class="line">    for (int x = -ncc_window_size; x &lt;= ncc_window_size; x++)</span><br><span class="line">        for (int y = -ncc_window_size; y &lt;= ncc_window_size; y++) &#123;</span><br><span class="line">            double value_ref = double(ref.ptr&lt;uchar&gt;(int(y + pt_ref(1, 0)))[int(x + pt_ref(0, 0))]) / 255.0;</span><br><span class="line">            mean_ref += value_ref;</span><br><span class="line"></span><br><span class="line">            double value_curr = getBilinearInterpolatedValue(curr, pt_curr + Vector2d(x, y));</span><br><span class="line">            mean_curr += value_curr;</span><br><span class="line"></span><br><span class="line">            values_ref.push_back(value_ref);</span><br><span class="line">            values_curr.push_back(value_curr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    mean_ref /= ncc_area;</span><br><span class="line">    mean_curr /= ncc_area;</span><br><span class="line"></span><br><span class="line">    double numerator = 0, demoniator1 = 0, demoniator2 = 0;</span><br><span class="line">    for (int i = 0; i &lt; values_ref.size(); i++) &#123;</span><br><span class="line">        double n = (values_ref[i] - mean_ref) * (values_curr[i] - mean_curr);</span><br><span class="line">        numerator += n;</span><br><span class="line">        demoniator1 += (values_ref[i] - mean_ref) * (values_ref[i] - mean_ref);</span><br><span class="line">        demoniator2 += (values_curr[i] - mean_curr) * (values_curr[i] - mean_curr);</span><br><span class="line">    &#125;</span><br><span class="line">    return numerator / sqrt(demoniator1 * demoniator2 + 1e-10);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool updateDepthFilter(</span><br><span class="line">    const Vector2d &amp;pt_ref,</span><br><span class="line">    const Vector2d &amp;pt_curr,</span><br><span class="line">    const SE3d &amp;T_C_R,</span><br><span class="line">    const Vector2d &amp;epipolar_direction,</span><br><span class="line">    Mat &amp;depth,</span><br><span class="line">    Mat &amp;depth_cov2) &#123;</span><br><span class="line">    SE3d T_R_C = T_C_R.inverse();</span><br><span class="line">    Vector3d f_ref = px2cam(pt_ref);</span><br><span class="line">    f_ref.normalize();</span><br><span class="line">    Vector3d f_curr = px2cam(pt_curr);</span><br><span class="line">    f_curr.normalize();</span><br><span class="line"></span><br><span class="line">    Vector3d t = T_R_C.translation();</span><br><span class="line">    Vector3d f2 = T_R_C.so3() * f_curr;</span><br><span class="line">    Vector2d b = Vector2d(t.dot(f_ref), t.dot(f2));</span><br><span class="line">    Matrix2d A;</span><br><span class="line">    A(0, 0) = f_ref.dot(f_ref);</span><br><span class="line">    A(0, 1) = -f_ref.dot(f2);</span><br><span class="line">    A(1, 0) = -A(0, 1);</span><br><span class="line">    A(1, 1) = -f2.dot(f2);</span><br><span class="line">    Vector2d ans = A.inverse() * b;</span><br><span class="line">    Vector3d xm = ans[0] * f_ref;</span><br><span class="line">    Vector3d xn = t + ans[1] * f2;</span><br><span class="line">    Vector3d p_esti = (xm + xn) / 2.0;</span><br><span class="line">    double depth_estimation = p_esti.norm();</span><br><span class="line"></span><br><span class="line">    Vector3d p = f_ref * depth_estimation;</span><br><span class="line">    Vector3d a = p - t;</span><br><span class="line">    double t_norm = t.norm();</span><br><span class="line">    double a_norm = a.norm();</span><br><span class="line">    double alpha = acos(f_ref.dot(t) / t_norm);</span><br><span class="line">    double beta = acos(-a.dot(t) / (a_norm * t_norm));</span><br><span class="line">    Vector3d f_curr_prime = px2cam(pt_curr + epipolar_direction);</span><br><span class="line">    f_curr_prime.normalize();</span><br><span class="line">    double beta_prime = acos(f_curr_prime.dot(-t) / t_norm);</span><br><span class="line">    double gamma = M_PI - alpha - beta_prime;</span><br><span class="line">    double p_prime = t_norm * sin(beta_prime) / sin(gamma);</span><br><span class="line">    double d_cov = p_prime - depth_estimation;</span><br><span class="line">    double d_cov2 = d_cov * d_cov;</span><br><span class="line"></span><br><span class="line">    double mu = depth.ptr&lt;double&gt;(int(pt_ref(1, 0)))[int(pt_ref(0, 0))];</span><br><span class="line">    double sigma2 = depth_cov2.ptr&lt;double&gt;(int(pt_ref(1, 0)))[int(pt_ref(0, 0))];</span><br><span class="line"></span><br><span class="line">    double mu_fuse = (d_cov2 * mu + sigma2 * depth_estimation) / (sigma2 + d_cov2);</span><br><span class="line">    double sigma_fuse2 = (sigma2 * d_cov2) / (sigma2 + d_cov2);</span><br><span class="line"></span><br><span class="line">    depth.ptr&lt;double&gt;(int(pt_ref(1, 0)))[int(pt_ref(0, 0))] = mu_fuse;</span><br><span class="line">    depth_cov2.ptr&lt;double&gt;(int(pt_ref(1, 0)))[int(pt_ref(0, 0))] = sigma_fuse2;</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void plotDepth(const Mat &amp;depth_truth, const Mat &amp;depth_estimate) &#123;</span><br><span class="line">    imshow(&quot;depth_truth&quot;, depth_truth * 0.4);</span><br><span class="line">    imshow(&quot;depth_estimate&quot;, depth_estimate * 0.4);</span><br><span class="line">    imshow(&quot;depth_error&quot;, depth_truth - depth_estimate);</span><br><span class="line">    waitKey(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void evaludateDepth(const Mat &amp;depth_truth, const Mat &amp;depth_estimate) &#123;</span><br><span class="line">    double ave_depth_error = 0;</span><br><span class="line">    double ave_depth_error_sq = 0;</span><br><span class="line">    int cnt_depth_data = 0;</span><br><span class="line">    for (int y = boarder; y &lt; depth_truth.rows - boarder; y++)</span><br><span class="line">        for (int x = boarder; x &lt; depth_truth.cols - boarder; x++) &#123;</span><br><span class="line">            double error = depth_truth.ptr&lt;double&gt;(y)[x] - depth_estimate.ptr&lt;double&gt;(y)[x];</span><br><span class="line">            ave_depth_error += error;</span><br><span class="line">            ave_depth_error_sq += error * error;</span><br><span class="line">            cnt_depth_data++;</span><br><span class="line">        &#125;</span><br><span class="line">    ave_depth_error /= cnt_depth_data;</span><br><span class="line">    ave_depth_error_sq /= cnt_depth_data;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;Average squared error = &quot; &lt;&lt; ave_depth_error_sq &lt;&lt; &quot;, average error: &quot; &lt;&lt; ave_depth_error &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector3d px2cam(const Vector2d px) &#123;</span><br><span class="line">    return Vector3d(</span><br><span class="line">        (px(0, 0) - cx) / fx,</span><br><span class="line">        (px(1, 0) - cy) / fy,</span><br><span class="line">        1</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector2d cam2px(const Vector3d p_cam) &#123;</span><br><span class="line">    return Vector2d(</span><br><span class="line">        p_cam(0, 0) * fx / p_cam(2, 0) + cx,</span><br><span class="line">        p_cam(1, 0) * fy / p_cam(2, 0) + cy</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool inside(const Vector2d &amp;pt) &#123;</span><br><span class="line">    return pt(0, 0) &gt;= boarder &amp;&amp; pt(1, 0) &gt;= boarder</span><br><span class="line">           &amp;&amp; pt(0, 0) + boarder &lt; width &amp;&amp; pt(1, 0) + boarder &lt;= height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(dense_monocular_project)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_STANDARD 11)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># --- 寻找依赖 ---</span><br><span class="line"># 明确要求版本4以上的OpenCV</span><br><span class="line">find_package(OpenCV 4 REQUIRED COMPONENTS core highgui imgproc)</span><br><span class="line">find_package(Eigen3 3.3 REQUIRED NO_MODULE)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- 构建可执行文件 ---</span><br><span class="line">add_executable(dense_mono_mapping dense_mapping.cpp)</span><br><span class="line"></span><br><span class="line"># --- 链接库 ---</span><br><span class="line">target_include_directories(dense_mono_mapping PRIVATE</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 使用旧模式的变量进行链接，以兼容您系统的OpenCV配置</span><br><span class="line">target_link_libraries(dense_mono_mapping PRIVATE</span><br><span class="line">    Sophus::Sophus</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch12/dense_mono/build$ ./dense_mono_mapping ../../dataset/test_data/</span><br><span class="line">read total 201 files.</span><br><span class="line">*** loop 1 ***</span><br><span class="line">Average squared error = 1.84285, average error: -1.12517</span><br><span class="line">*** loop 2 ***</span><br><span class="line">Average squared error = 1.42146, average error: -0.865388</span><br><span class="line">*** loop 3 ***</span><br><span class="line">Average squared error = 1.05544, average error: -0.62268</span><br></pre></td></tr></table></figure>

<p>程序每一次循环都会将当前估计出的深度图与真实的深度图进行比较，计算两者之间的误差。同时会输出四个窗口的图像，分别代表当前输入窗口，深度真值图，深度估计图以及深度误差图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250903204137794.png" alt="image-20250903204137794"></p>
<p>随着不断地迭代，估计图将更加接近真实图。</p>
<hr>
<h3 id="像素梯度问题"><a href="#像素梯度问题" class="headerlink" title="像素梯度问题"></a>像素梯度问题</h3><p>块匹配的正确与否依赖于图像块是否具有区分度。当像素梯度与极线夹角较大时，极线匹配的不确定性大，夹角小时，匹配的不确定性小。</p>
<h3 id="逆深度"><a href="#逆深度" class="headerlink" title="逆深度"></a>逆深度</h3><hr>
<h2 id="RGB-D稠密建图"><a href="#RGB-D稠密建图" class="headerlink" title="RGB-D稠密建图"></a>RGB-D稠密建图</h2><p>RGB-D的结构光或飞行时间原理，保证了深度数据对于纹理的无关性，即使面对纯色的物体，只要能够反射光，就能够测量深度。</p>
<p>利用RGB-D进行稠密建图是相对容易的，存在好几种方式。可以根据估算的相机位姿，将RGB-D数据转化为点云，进行拼接，得到一个由离散点组成的点云地图。如果希望对物体的表面进行估计，可以在此基础上使用三角网格、面片进行建图。如果希望知道地图的障碍物信息并在地图上导航，也可以通过体素建立建立占据网格地图。</p>
<h3 id="实践：点云地图"><a href="#实践：点云地图" class="headerlink" title="实践：点云地图"></a>实践：点云地图</h3><p>新建文件夹及文件<code>slambook/ch12/dense_RGBD/pointcloud_mapping.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 using namespace std;</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/format.hpp&gt;</span>  <span class="comment">// for formating strings</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcl/point_types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcl/io/pcd_io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcl/filters/voxel_grid.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcl/visualization/pcl_visualizer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcl/filters/statistical_outlier_removal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    vector&lt;cv::Mat&gt; colorImgs, depthImgs;    <span class="comment">// 彩色图和深度图</span></span><br><span class="line">    vector&lt;Eigen::Isometry3d&gt; poses;        <span class="comment">// 相机位姿</span></span><br><span class="line"></span><br><span class="line">    <span class="function">ifstream <span class="title">fin</span><span class="params">(<span class="string">&quot;../data/pose.txt&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!fin) &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;cannot find pose file at ./data/pose.txt&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="function">boost::format <span class="title">fmt</span><span class="params">(<span class="string">&quot;../data/%s/%d.%s&quot;</span>)</span></span>; <span class="comment">//图像文件格式</span></span><br><span class="line">        string color_path = (fmt % <span class="string">&quot;color&quot;</span> % (i + <span class="number">1</span>) % <span class="string">&quot;png&quot;</span>).<span class="built_in">str</span>();</span><br><span class="line">        string depth_path = (fmt % <span class="string">&quot;depth&quot;</span> % (i + <span class="number">1</span>) % <span class="string">&quot;png&quot;</span>).<span class="built_in">str</span>();</span><br><span class="line">        </span><br><span class="line">        cv::Mat color_img = cv::<span class="built_in">imread</span>(color_path);</span><br><span class="line">        <span class="comment">// 使用-1读取原始图像，包含深度数据</span></span><br><span class="line">        cv::Mat depth_img = cv::<span class="built_in">imread</span>(depth_path, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 【健壮性修正】: 检查图像是否成功读取</span></span><br><span class="line">        <span class="keyword">if</span> (color_img.<span class="built_in">empty</span>() || depth_img.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;Could not read image: &quot;</span> &lt;&lt; color_path &lt;&lt; <span class="string">&quot; or &quot;</span> &lt;&lt; depth_path &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        colorImgs.<span class="built_in">push_back</span>(color_img);</span><br><span class="line">        depthImgs.<span class="built_in">push_back</span>(depth_img);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 【关键Bug修正】: 每次循环只读取一行（7个double）位姿数据</span></span><br><span class="line">        <span class="type">double</span> data[<span class="number">7</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">7</span>; k++) &#123;</span><br><span class="line">            fin &gt;&gt; data[k];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Eigen::Quaterniond <span class="title">q</span><span class="params">(data[<span class="number">6</span>], data[<span class="number">3</span>], data[<span class="number">4</span>], data[<span class="number">5</span>])</span></span>;</span><br><span class="line">        <span class="function">Eigen::Isometry3d <span class="title">T</span><span class="params">(q)</span></span>;</span><br><span class="line">        T.<span class="built_in">pretranslate</span>(Eigen::<span class="built_in">Vector3d</span>(data[<span class="number">0</span>], data[<span class="number">1</span>], data[<span class="number">2</span>]));</span><br><span class="line">        poses.<span class="built_in">push_back</span>(T);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机内参 </span></span><br><span class="line">    <span class="type">double</span> cx = <span class="number">319.5</span>;</span><br><span class="line">    <span class="type">double</span> cy = <span class="number">239.5</span>;</span><br><span class="line">    <span class="type">double</span> fx = <span class="number">481.2</span>;</span><br><span class="line">    <span class="type">double</span> fy = <span class="number">-480.0</span>;</span><br><span class="line">    <span class="type">double</span> depthScale = <span class="number">5000.0</span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;正在将图像转换为点云...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义点云使用的格式：这里用的是XYZRGB</span></span><br><span class="line">    <span class="keyword">typedef</span> pcl::PointXYZRGB PointT;</span><br><span class="line">    <span class="keyword">typedef</span> pcl::PointCloud&lt;PointT&gt; PointCloud;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建一个点云，用于存储所有拼接后的点</span></span><br><span class="line">    <span class="function">PointCloud::Ptr <span class="title">pointCloud</span><span class="params">(<span class="keyword">new</span> PointCloud)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;转换图像中: &quot;</span> &lt;&lt; i + <span class="number">1</span> &lt;&lt; endl;</span><br><span class="line">        cv::Mat color = colorImgs[i];</span><br><span class="line">        cv::Mat depth = depthImgs[i];</span><br><span class="line">        Eigen::Isometry3d T = poses[i];</span><br><span class="line">        </span><br><span class="line">        <span class="function">PointCloud::Ptr <span class="title">current</span><span class="params">(<span class="keyword">new</span> PointCloud)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">0</span>; v &lt; color.rows; v++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> u = <span class="number">0</span>; u &lt; color.cols; u++) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">int</span> d = depth.<span class="built_in">ptr</span>&lt;<span class="type">unsigned</span> <span class="type">short</span>&gt;(v)[u]; <span class="comment">// 深度值</span></span><br><span class="line">                <span class="keyword">if</span> (d == <span class="number">0</span>) <span class="keyword">continue</span>; <span class="comment">// 为0表示没有测量到</span></span><br><span class="line">                </span><br><span class="line">                Eigen::Vector3d point;</span><br><span class="line">                point[<span class="number">2</span>] = <span class="built_in">double</span>(d) / depthScale;</span><br><span class="line">                point[<span class="number">0</span>] = (u - cx) * point[<span class="number">2</span>] / fx;</span><br><span class="line">                point[<span class="number">1</span>] = (v - cy) * point[<span class="number">2</span>] / fy;</span><br><span class="line">                Eigen::Vector3d pointWorld = T * point;</span><br><span class="line"></span><br><span class="line">                PointT p;</span><br><span class="line">                p.x = pointWorld[<span class="number">0</span>];</span><br><span class="line">                p.y = pointWorld[<span class="number">1</span>];</span><br><span class="line">                p.z = pointWorld[<span class="number">2</span>];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 【可读性优化】: 使用 .at&lt;cv::Vec3b&gt; 访问颜色</span></span><br><span class="line">                cv::Vec3b bgr = color.<span class="built_in">at</span>&lt;cv::Vec3b&gt;(v, u);</span><br><span class="line">                p.b = bgr[<span class="number">0</span>];</span><br><span class="line">                p.g = bgr[<span class="number">1</span>];</span><br><span class="line">                p.r = bgr[<span class="number">2</span>];</span><br><span class="line">                current-&gt;points.<span class="built_in">push_back</span>(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对当前帧进行统计滤波，去除离群点</span></span><br><span class="line">        <span class="function">PointCloud::Ptr <span class="title">tmp</span><span class="params">(<span class="keyword">new</span> PointCloud)</span></span>;</span><br><span class="line">        pcl::StatisticalOutlierRemoval&lt;PointT&gt; statistical_filter;</span><br><span class="line">        statistical_filter.<span class="built_in">setMeanK</span>(<span class="number">50</span>);</span><br><span class="line">        statistical_filter.<span class="built_in">setStddevMulThresh</span>(<span class="number">1.0</span>);</span><br><span class="line">        statistical_filter.<span class="built_in">setInputCloud</span>(current);</span><br><span class="line">        statistical_filter.<span class="built_in">filter</span>(*tmp);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将滤波后的当前帧点云，拼接到全局点云中</span></span><br><span class="line">        (*pointCloud) += *tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后的点云可能包含无效点，设置为false</span></span><br><span class="line">    pointCloud-&gt;is_dense = <span class="literal">false</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;拼接后点云共有&quot;</span> &lt;&lt; pointCloud-&gt;<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;个点.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用体素滤波（VoxelGrid）对整个点云进行降采样</span></span><br><span class="line">    pcl::VoxelGrid&lt;PointT&gt; voxel_filter;</span><br><span class="line">    <span class="type">double</span> resolution = <span class="number">0.03</span>;</span><br><span class="line">    voxel_filter.<span class="built_in">setLeafSize</span>(resolution, resolution, resolution);</span><br><span class="line">    <span class="function">PointCloud::Ptr <span class="title">tmp</span><span class="params">(<span class="keyword">new</span> PointCloud)</span></span>;</span><br><span class="line">    voxel_filter.<span class="built_in">setInputCloud</span>(pointCloud);</span><br><span class="line">    voxel_filter.<span class="built_in">filter</span>(*tmp);</span><br><span class="line">    tmp-&gt;<span class="built_in">swap</span>(*pointCloud);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;滤波之后，点云共有&quot;</span> &lt;&lt; pointCloud-&gt;<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;个点.&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    pcl::io::<span class="built_in">savePCDFileBinary</span>(<span class="string">&quot;map.pcd&quot;</span>, *pointCloud);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;点云已保存到 map.pcd&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(pointcloud_mapping_project)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用标准方式设置C++11</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 11)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 寻找依赖 ---</span></span><br><span class="line"><span class="comment"># 使用find_package自动寻找所有依赖</span></span><br><span class="line">find_package(Eigen3 3.3 REQUIRED NO_MODULE)</span><br><span class="line">find_package(OpenCV 4 REQUIRED)</span><br><span class="line">find_package(PCL 1.8 REQUIRED)</span><br><span class="line">find_package(Boost REQUIRED COMPONENTS system) <span class="comment"># boost::format 需要 system</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 构建可执行文件 ---</span></span><br><span class="line">add_executable(pointcloud_mapping pointcloud_mapping.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 链接库 ---</span></span><br><span class="line"><span class="comment"># 使用 target_* 命令，链接到由find_package导入的目标</span></span><br><span class="line">target_include_directories(pointcloud_mapping PRIVATE</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;PCL_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;Boost_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_link_libraries(pointcloud_mapping PRIVATE</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">    $&#123;PCL_LIBRARIES&#125;</span><br><span class="line">    $&#123;Boost_LIBRARIES&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 【可选，如果PCL编译报错】: 为PCL版本兼容性添加此行</span></span><br><span class="line">set_target_properties(pointcloud_mapping PROPERTIES</span><br><span class="line">    COMPILE_FLAGS <span class="string">&quot;-fpermissive&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 为本书中的其他目标预留（您可以取消注释来编译它们） ---</span></span><br><span class="line"><span class="comment"># add_executable(octomap_mapping octomap_mapping.cpp)</span></span><br><span class="line"><span class="comment"># find_package(octomap REQUIRED)</span></span><br><span class="line"><span class="comment"># target_link_libraries(octomap_mapping PRIVATE </span></span><br><span class="line"><span class="comment">#     $&#123;OpenCV_LIBS&#125; </span></span><br><span class="line"><span class="comment">#     $&#123;PCL_LIBRARIES&#125; </span></span><br><span class="line"><span class="comment">#     $&#123;OCTOMAP_LIBRARIES&#125;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add_executable(surfel_mapping surfel_mapping.cpp)</span></span><br><span class="line"><span class="comment"># target_link_libraries(surfel_mapping PRIVATE </span></span><br><span class="line"><span class="comment">#     $&#123;OpenCV_LIBS&#125; </span></span><br><span class="line"><span class="comment">#     $&#123;PCL_LIBRARIES&#125;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch12/dense_RGBD/build$ ./pointcloud_mapping </span><br><span class="line">正在将图像转换为点云...</span><br><span class="line">转换图像中: 1</span><br><span class="line">转换图像中: 2</span><br><span class="line">转换图像中: 3</span><br><span class="line">转换图像中: 4</span><br><span class="line">转换图像中: 5</span><br><span class="line">拼接后点云共有1309800个点.</span><br><span class="line">滤波之后，点云共有31876个点.</span><br><span class="line">点云已保存到 map.pcd</span><br><span class="line">hita@hita-vm:~/slambook/ch12/dense_RGBD/build$ pcl_viewer map.pcd </span><br><span class="line">CMakeCache.txt       CMakeFiles/          cmake_install.cmake  Makefile             map.pcd              pointcloud_mapping   </span><br><span class="line">hita@hita-vm:~/slambook/ch12/dense_RGBD/build$ pcl_viewer map.pcd </span><br><span class="line">The viewer window provides interactive commands; for help, press &#x27;h&#x27; or &#x27;H&#x27; from within the window.</span><br><span class="line">&gt; Loading map.pcd [PCLVisualizer::setUseVbos] Has no effect when OpenGL version is ≥ 2</span><br><span class="line">[done, 398.158 ms : 31876 points]</span><br><span class="line">Available dimensions: x y z rgb</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250904102722910.png" alt="image-20250904102722910"></p>
<h3 id="从点云重建网格"><a href="#从点云重建网格" class="headerlink" title="从点云重建网格"></a>从点云重建网格</h3><p>新建文件：<code>slambook/ch12/dense_RGBD/pointcloud_mapping.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Created by gaoxiang on 19-4-25.</span><br><span class="line">// Modified for robustness and clarity.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">#include &lt;iostream&gt; // 用于 cout</span><br><span class="line">#include &lt;pcl/point_cloud.h&gt;</span><br><span class="line">#include &lt;pcl/point_types.h&gt;</span><br><span class="line">#include &lt;pcl/io/pcd_io.h&gt;</span><br><span class="line">#include &lt;pcl/visualization/pcl_visualizer.h&gt;</span><br><span class="line">#include &lt;pcl/kdtree/kdtree_flann.h&gt;</span><br><span class="line">#include &lt;pcl/surface/mls.h&gt; // 【修正】: 使用标准的MLS头文件</span><br><span class="line">#include &lt;pcl/surface/gp3.h&gt;</span><br><span class="line"></span><br><span class="line">// using namespace std; // 在.cpp文件中使用是安全的</span><br><span class="line"></span><br><span class="line">// typedefs for convenience</span><br><span class="line">typedef pcl::PointXYZRGB PointT;</span><br><span class="line">typedef pcl::PointCloud&lt;PointT&gt; PointCloud;</span><br><span class="line">typedef pcl::PointCloud&lt;PointT&gt;::Ptr PointCloudPtr;</span><br><span class="line">typedef pcl::PointXYZRGBNormal SurfelT;</span><br><span class="line">typedef pcl::PointCloud&lt;SurfelT&gt; SurfelCloud;</span><br><span class="line">typedef pcl::PointCloud&lt;SurfelT&gt;::Ptr SurfelCloudPtr;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @brief 使用移动最小二乘法（MLS）平滑点云并计算法向量</span><br><span class="line"> * @param input 输入的原始点云</span><br><span class="line"> * @param radius MLS算法的搜索半径</span><br><span class="line"> * @param polynomial_order 多项式拟合的阶数</span><br><span class="line"> * @return 带有法向量的平滑点云 (surfels)</span><br><span class="line"> */</span><br><span class="line">SurfelCloudPtr reconstructSurface(</span><br><span class="line">    const PointCloudPtr &amp;input, float radius, int polynomial_order) &#123;</span><br><span class="line">    </span><br><span class="line">    // 创建一个KdTree用于邻域搜索</span><br><span class="line">    pcl::search::KdTree&lt;PointT&gt;::Ptr tree(new pcl::search::KdTree&lt;PointT&gt;);</span><br><span class="line"></span><br><span class="line">    // 初始化移动最小二乘法（MLS）对象</span><br><span class="line">    pcl::MovingLeastSquares&lt;PointT, SurfelT&gt; mls;</span><br><span class="line">    </span><br><span class="line">    mls.setSearchMethod(tree);</span><br><span class="line">    mls.setSearchRadius(radius);</span><br><span class="line">    mls.setComputeNormals(true);</span><br><span class="line">    mls.setSqrGaussParam(radius * radius);</span><br><span class="line">    mls.setPolynomialFit(polynomial_order &gt; 1);</span><br><span class="line">    mls.setPolynomialOrder(polynomial_order);</span><br><span class="line">    mls.setInputCloud(input);</span><br><span class="line"></span><br><span class="line">    SurfelCloudPtr output(new SurfelCloud);</span><br><span class="line">    mls.process(*output);</span><br><span class="line">    return (output);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @brief 使用贪心投影三角化算法从带有法向量的点云创建网格</span><br><span class="line"> * @param surfels 输入的带有法向量的点云</span><br><span class="line"> * @return 生成的三维网格模型</span><br><span class="line"> */</span><br><span class="line">pcl::PolygonMeshPtr triangulateMesh(const SurfelCloudPtr &amp;surfels) &#123;</span><br><span class="line">    // 创建一个KdTree用于邻域搜索</span><br><span class="line">    pcl::search::KdTree&lt;SurfelT&gt;::Ptr tree(new pcl::search::KdTree&lt;SurfelT&gt;);</span><br><span class="line">    tree-&gt;setInputCloud(surfels);</span><br><span class="line"></span><br><span class="line">    // 初始化贪心投影三角化算法（Greedy Projection Triangulation）对象</span><br><span class="line">    pcl::GreedyProjectionTriangulation&lt;SurfelT&gt; gp3;</span><br><span class="line">    pcl::PolygonMeshPtr triangles(new pcl::PolygonMesh);</span><br><span class="line"></span><br><span class="line">    // 设置算法参数</span><br><span class="line">    gp3.setSearchRadius(0.05); // 设置连接点之间的最大距离（即最大边长）</span><br><span class="line">    gp3.setMu(2.5); // 设置被样本点距离查询点最近邻点的距离，以限制搜索范围</span><br><span class="line">    gp3.setMaximumNearestNeighbors(100); // 设置搜索的最近邻点数目</span><br><span class="line">    gp3.setMaximumSurfaceAngle(M_PI / 4); // 45 degrees, 设置某点法线方向偏离样本点法线的最大角度</span><br><span class="line">    gp3.setMinimumAngle(M_PI / 18); // 10 degrees, 设置三角化后三角形的最小角</span><br><span class="line">    gp3.setMaximumAngle(2 * M_PI / 3); // 120 degrees, 设置三角化后三角形的最大角</span><br><span class="line">    gp3.setNormalConsistency(false); // 设置是否保证法线朝向一致</span><br><span class="line"></span><br><span class="line">    // 执行重建</span><br><span class="line">    gp3.setInputCloud(surfels);</span><br><span class="line">    gp3.setSearchMethod(tree);</span><br><span class="line">    gp3.reconstruct(*triangles);</span><br><span class="line"></span><br><span class="line">    return triangles;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line"></span><br><span class="line">    // 【关键Bug修正】: 检查命令行参数数量是否正确</span><br><span class="line">    if (argc != 2) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;Usage: surfel_mapping &lt;path_to_pcd_file&gt;&quot; &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; &quot;Example: ./surfel_mapping ../dense_RGBD/build/map.pcd&quot; &lt;&lt; endl;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 加载点云文件</span><br><span class="line">    PointCloudPtr cloud(new PointCloud);</span><br><span class="line">    if (pcl::io::loadPCDFile(argv[1], *cloud) == -1) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;Failed to load point cloud from: &quot; &lt;&lt; argv[1] &lt;&lt; endl;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 【健壮性优化】: 检查加载的点云是否为空</span><br><span class="line">    if (cloud-&gt;points.empty())&#123;</span><br><span class="line">        cout &lt;&lt; &quot;Loaded point cloud is empty!&quot; &lt;&lt; endl;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;Point cloud loaded, points: &quot; &lt;&lt; cloud-&gt;points.size() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    // 步骤1: 计算表面元素 (平滑并计算法向量)</span><br><span class="line">    cout &lt;&lt; &quot;Computing normals and smoothing with MLS...&quot; &lt;&lt; endl;</span><br><span class="line">    double mls_radius = 0.03;</span><br><span class="line">    int polynomial_order = 2; // 使用2阶多项式拟合</span><br><span class="line">    SurfelCloudPtr surfels = reconstructSurface(cloud, mls_radius, polynomial_order);</span><br><span class="line">    </span><br><span class="line">    // 步骤2: 从表面元素计算贪心三角化网格</span><br><span class="line">    cout &lt;&lt; &quot;Computing mesh with Greedy Projection Triangulation...&quot; &lt;&lt; endl;</span><br><span class="line">    pcl::PolygonMeshPtr mesh = triangulateMesh(surfels);</span><br><span class="line"></span><br><span class="line">    // 步骤3: 可视化结果</span><br><span class="line">    cout &lt;&lt; &quot;Displaying mesh...&quot; &lt;&lt; endl;</span><br><span class="line">    pcl::visualization::PCLVisualizer vis(&quot;3D Mesh Viewer&quot;);</span><br><span class="line">    vis.setBackgroundColor(0.1, 0.1, 0.1); // 设置背景为深灰色</span><br><span class="line"></span><br><span class="line">    // 添加网格模型，并给它一个ID &quot;mesh&quot;</span><br><span class="line">    vis.addPolygonMesh(*mesh, &quot;mesh&quot;);</span><br><span class="line"></span><br><span class="line">    // 添加一个坐标系作为参考</span><br><span class="line">    vis.addCoordinateSystem(0.1);</span><br><span class="line">    </span><br><span class="line">    vis.resetCamera(); // 自动调整视角</span><br><span class="line">    vis.spin(); // 保持窗口打开，直到用户关闭</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<p>输出结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250904105924662.png" alt="image-20250904105924662"></p>
<h3 id="八叉树地图"><a href="#八叉树地图" class="headerlink" title="八叉树地图"></a>八叉树地图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;fstream&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">// 【代码风格】: 添加 using namespace std;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">#include &lt;opencv2/core/core.hpp&gt;</span><br><span class="line">#include &lt;opencv2/highgui/highgui.hpp&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;octomap/octomap.h&gt;   // for octomap </span><br><span class="line"></span><br><span class="line">#include &lt;Eigen/Geometry&gt;</span><br><span class="line">#include &lt;boost/format.hpp&gt;  // for formating strings</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">    vector&lt;cv::Mat&gt; colorImgs, depthImgs;    // 彩色图和深度图</span><br><span class="line">    vector&lt;Eigen::Isometry3d&gt; poses;        // 相机位姿</span><br><span class="line"></span><br><span class="line">    ifstream fin(&quot;../data/pose.txt&quot;);</span><br><span class="line">    if (!fin) &#123;</span><br><span class="line">        cerr &lt;&lt; &quot;cannot find pose file at ./data/pose.txt&quot; &lt;&lt; endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">        boost::format fmt(&quot;../data/%s/%d.%s&quot;); //图像文件格式</span><br><span class="line">        string color_path = (fmt % &quot;color&quot; % (i + 1) % &quot;png&quot;).str();</span><br><span class="line">        string depth_path = (fmt % &quot;depth&quot; % (i + 1) % &quot;png&quot;).str();</span><br><span class="line">        </span><br><span class="line">        cv::Mat color_img = cv::imread(color_path);</span><br><span class="line">        // 使用-1读取原始图像，包含16位无符号深度数据</span><br><span class="line">        cv::Mat depth_img = cv::imread(depth_path, -1);</span><br><span class="line"></span><br><span class="line">        // 【健壮性修正】: 检查图像是否成功读取</span><br><span class="line">        if (color_img.empty() || depth_img.empty()) &#123;</span><br><span class="line">            cerr &lt;&lt; &quot;Could not read image: &quot; &lt;&lt; color_path &lt;&lt; &quot; or &quot; &lt;&lt; depth_path &lt;&lt; endl;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        colorImgs.push_back(color_img);</span><br><span class="line">        depthImgs.push_back(depth_img);</span><br><span class="line"></span><br><span class="line">        // 【关键Bug修正】: 每次循环只读取一行（7个double）位姿数据</span><br><span class="line">        double data[7] = &#123;0&#125;;</span><br><span class="line">        for (int k = 0; k &lt; 7; k++) &#123;</span><br><span class="line">            fin &gt;&gt; data[k];</span><br><span class="line">        &#125;</span><br><span class="line">        Eigen::Quaterniond q(data[6], data[3], data[4], data[5]);</span><br><span class="line">        Eigen::Isometry3d T(q);</span><br><span class="line">        T.pretranslate(Eigen::Vector3d(data[0], data[1], data[2]));</span><br><span class="line">        poses.push_back(T);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 相机内参 </span><br><span class="line">    double cx = 319.5;</span><br><span class="line">    double cy = 239.5;</span><br><span class="line">    double fx = 481.2;</span><br><span class="line">    double fy = -480.0;</span><br><span class="line">    double depthScale = 5000.0;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;正在将图像转换为 Octomap ...&quot; &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    // octomap tree </span><br><span class="line">    // 参数为分辨率，这里设置为0.01米</span><br><span class="line">    octomap::OcTree tree(0.01); </span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;转换图像中: &quot; &lt;&lt; i + 1 &lt;&lt; endl;</span><br><span class="line">        cv::Mat color = colorImgs[i];</span><br><span class="line">        cv::Mat depth = depthImgs[i];</span><br><span class="line">        Eigen::Isometry3d T = poses[i];</span><br><span class="line"></span><br><span class="line">        // octomap专用的点云容器</span><br><span class="line">        octomap::Pointcloud cloud;  </span><br><span class="line"></span><br><span class="line">        for (int v = 0; v &lt; color.rows; v++)</span><br><span class="line">            for (int u = 0; u &lt; color.cols; u++) &#123;</span><br><span class="line">                unsigned int d = depth.ptr&lt;unsigned short&gt;(v)[u]; // 深度值</span><br><span class="line">                if (d == 0) continue; // 为0表示没有测量到</span><br><span class="line"></span><br><span class="line">                Eigen::Vector3d point;</span><br><span class="line">                point[2] = double(d) / depthScale;</span><br><span class="line">                point[0] = (u - cx) * point[2] / fx;</span><br><span class="line">                point[1] = (v - cy) * point[2] / fy;</span><br><span class="line">                Eigen::Vector3d pointWorld = T * point;</span><br><span class="line">                </span><br><span class="line">                // 将世界坐标系的点放入点云</span><br><span class="line">                cloud.push_back(pointWorld[0], pointWorld[1], pointWorld[2]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        // 将点云存入八叉树地图，并给出相机原点，这样可以计算投射线，更新空闲区域</span><br><span class="line">        octomap::point3d sensor_origin(T(0, 3), T(1, 3), T(2, 3));</span><br><span class="line">        tree.insertPointCloud(cloud, sensor_origin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 更新中间节点的占据信息并写入磁盘</span><br><span class="line">    tree.updateInnerOccupancy();</span><br><span class="line">    cout &lt;&lt; &quot;saving octomap... &quot; &lt;&lt; endl;</span><br><span class="line">    // 将地图保存为二进制文件 .bt</span><br><span class="line">    tree.writeBinary(&quot;octomap.bt&quot;);</span><br><span class="line">    cout &lt;&lt; &quot;OctoMap 已保存到 octomap.bt&quot; &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch12/dense_RGBD/build$ octovis octomap.bt</span><br><span class="line">Reading binary octree type OcTree</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250904111515019.png" alt="image-20250904111515019"></p>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E4%B8%80%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%9B%9E%E7%8E%AF%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%8D%81%E4%B8%80%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E5%9B%9E%E7%8E%AF%E6%A3%80%E6%B5%8B/" class="post-title-link" itemprop="url">第十一讲-回环检测</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:30:37" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第十一讲）——回环检测"><a href="#视觉SLAM十四讲（第十一讲）——回环检测" class="headerlink" title="视觉SLAM十四讲（第十一讲）——回环检测"></a>视觉SLAM十四讲（第十一讲）——回环检测</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="回环检测的意义"><a href="#回环检测的意义" class="headerlink" title="回环检测的意义"></a>回环检测的意义</h3><p>前端提供特征点的提取和轨迹、地图的初值，后端负责对所有这些数据进行优化。但是会存在累计误差，长期估计的结果会变得不可靠，导致无法构建一个全局一致的轨迹和地图。回环检测能够给出相邻帧的一些时隔更加久远的约束，这是因为我们察觉到相机经过同一个地方，采集到相似的数据，回环检测的关键就是检测出<strong>相机经过同一个地方这件事</strong>。</p>
<p>当系统成功检测到一个回环时，就会获得一个全局的、跨越长时间的约束信息，可以校正回环内累积的所有漂移，将整个地图和轨迹拉回正轨。</p>
<h3 id="回环检测的方法"><a href="#回环检测的方法" class="headerlink" title="回环检测的方法"></a>回环检测的方法</h3><p>至于回环如何实现的问题，可以做一个 <strong>哪里可能出现回环</strong>的预计，大致有两种思路：</p>
<ol>
<li>基于里程计的几何关系</li>
<li>基于外观的几何关系</li>
</ol>
<p>第一种无法在累积误差较大的时候工作，对于第二种，仅仅根据两幅图像的相似性确定回环检测关系，这种做法脱离累积误差，使得回环检测模块成为一个相对独立的模块。是视觉SLAM中主流的做法。除此之外，室外的无人车通常会配备GPS，提供全局的位置信息，可以利用GPS信息判断汽车是否回到某个经过的点，在室内就行不通了。</p>
<p>基于外观的回环检测算法中，核心问题就是<strong>如何计算图像间的相似性</strong>。</p>
<h3 id="准确率和召回率"><a href="#准确率和召回率" class="headerlink" title="准确率和召回率"></a>准确率和召回率</h3><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902095519640.png" alt="image-20250902095519640" style="zoom:50%;" />

<p>根据表格中的四种情况，<strong>假阳性(FP False Positive)又被称为感知偏差</strong>，<strong>假阴性(FN False Negative)称为感知变异</strong>。使用TP(True Positive)和TN(True Negative)分别表示真阳性和真阴性。对于特定算法，需要计算两个统计量：<strong>准确率和召回率</strong><br>$$<br>\text{Precision} &#x3D; \mathrm{TP} &#x2F; (\mathrm{TP} + \mathrm{FP}), \quad \text{Recall} &#x3D; \mathrm{TP} &#x2F; (\mathrm{TP} + \mathrm{FN})<br>$$<br>准确率描述的是所预测的回环中是真的回环的概率，召回率即在所有实际上是回环的事实上，被正确检测出来的概率。这两个指标通常是矛盾的，提高准确率，会降低召回率，反之亦然。为了评价算法的好坏，通常会测试在各种配置下的P和R值，做$P-R$曲线，在SLAM中，对于准确率要求更高，对于召回率则相对宽容。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902101337010.png" alt="image-20250902101337010"></p>
<hr>
<h2 id="词袋模型"><a href="#词袋模型" class="headerlink" title="词袋模型"></a>词袋模型</h2><p>词袋模型（Bag-of-Words Model, BoW），目的是用“图像上有哪几种特征”来描述一幅图像。核心思想就是将一个复杂的图像简化为一个不考虑顺序的、由词语频率构成的向量。视觉词袋模型分为两个阶段：离线构建词典、在线图像表示。</p>
<h3 id="字典的结构"><a href="#字典的结构" class="headerlink" title="字典的结构"></a>字典的结构</h3><p>字典由很多单词组成，一个单词与一个单独的特征点不同，不是从单幅图像上提取出来的，而是某一类特征的组合，所以是一个<strong>特征聚类</strong>问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902102410657.png" alt="image-20250902102410657"></p>
<img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/c26d7e08790cefa6ca49658fa6aa60aa.png" alt="img" style="zoom:67%;" />

<p>至于K-means聚类实际很简单，下面是一个直观的例子</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902102935196.png" alt="image-20250902102935196"></p>
<p>但是即使构建好了字典，如果单词数量很少一一对比还是简单的，一旦单词多起来，再一一对比效率就会低得多，所以需要使用一种K叉树来表达字典。类似于层次聚类</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902104140501.png" alt="image-20250902104140501"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902104234298.png" alt="image-20250902104234298"></p>
<p>树结构中的中间节点仅在快速查找的时候使用，可以保证查找效率。</p>
<h3 id="实践：创建字典"><a href="#实践：创建字典" class="headerlink" title="实践：创建字典"></a>实践：创建字典</h3><p>选用TUM数据集中的10幅图像，在源代码中的<code>ch11/data</code>，来自于一组实际的相机运动轨迹，实际的字典往往需要更大的数据集上训练，并且数据应该来自与目标环境类似的地方，下面开始训练字典。首先安装<strong>BoW库</strong></p>
<blockquote>
<p>安装BoW</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 在3rdparty文件夹下打开终端</span><br><span class="line">git clone https://github.com/rmsalinas/DBow3.git</span><br><span class="line">mkdir build </span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make </span><br><span class="line">sudo make install</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>

<p>安装完成之后，新建文件夹及文件<code>slambook/ch11/feature_training.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DBoW3/DBoW3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************</span></span><br><span class="line"><span class="comment"> * 本节演示了如何根据data/目录下的十张图训练字典</span></span><br><span class="line"><span class="comment"> * ************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">( <span class="type">int</span> argc, <span class="type">char</span>** argv )</span> </span>&#123;</span><br><span class="line">    <span class="comment">// read the image </span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;reading images... &quot;</span>&lt;&lt;endl;</span><br><span class="line">    vector&lt;Mat&gt; images; </span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        string path = <span class="string">&quot;../data/&quot;</span>+<span class="built_in">to_string</span>(i<span class="number">+1</span>)+<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">        images.<span class="built_in">push_back</span>( <span class="built_in">imread</span>(path) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// detect ORB features</span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;detecting ORB features ... &quot;</span>&lt;&lt;endl;</span><br><span class="line">    Ptr&lt; Feature2D &gt; detector = ORB::<span class="built_in">create</span>();</span><br><span class="line">    vector&lt;Mat&gt; descriptors;</span><br><span class="line">    <span class="keyword">for</span> ( Mat&amp; image:images )</span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;KeyPoint&gt; keypoints; </span><br><span class="line">        Mat descriptor;</span><br><span class="line">        detector-&gt;<span class="built_in">detectAndCompute</span>( image, <span class="built_in">Mat</span>(), keypoints, descriptor );</span><br><span class="line">        descriptors.<span class="built_in">push_back</span>( descriptor );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create vocabulary </span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;creating vocabulary ... &quot;</span>&lt;&lt;endl;</span><br><span class="line">    DBoW3::Vocabulary vocab;</span><br><span class="line">    vocab.<span class="built_in">create</span>( descriptors );</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;vocabulary info: &quot;</span>&lt;&lt;vocab&lt;&lt;endl;</span><br><span class="line">    vocab.<span class="built_in">save</span>( <span class="string">&quot;vocabulary.yml.gz&quot;</span> );</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;done&quot;</span>&lt;&lt;endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># 设置一个现代的CMake最低版本，并启用新特性</span><br><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(loop_closure)</span><br><span class="line"></span><br><span class="line"># 设置C++标准，而不是直接修改 CMAKE_CXX_FLAGS</span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"># 设置编译类型，Release模式会自动启用-O3优化</span><br><span class="line">set(CMAKE_BUILD_TYPE &quot;Release&quot;)</span><br><span class="line"></span><br><span class="line"># --- 查找依赖包 ---</span><br><span class="line"># 1. 查找OpenCV</span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line"></span><br><span class="line"># 2. 查找DBoW3</span><br><span class="line">find_package(DBoW3 REQUIRED)</span><br><span class="line"></span><br><span class="line"># --- 定义可执行文件目标 ---</span><br><span class="line"></span><br><span class="line"># 目标1: feature_training</span><br><span class="line">add_executable(feature_training feature_training.cpp)</span><br><span class="line"># 【修改点】: 添加 target_include_directories 以手动包含头文件</span><br><span class="line">target_include_directories(feature_training PRIVATE $&#123;DBoW3_INCLUDE_DIRS&#125;)</span><br><span class="line"># 【修改点】: 链接旧模式提供的库变量 $&#123;DBoW3_LIBRARIES&#125;</span><br><span class="line">target_link_libraries(feature_training PRIVATE</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">    $&#123;DBoW3_LIBRARIES&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># # 目标2: loop_closure</span><br><span class="line"># add_executable(loop_closure loop_closure.cpp)</span><br><span class="line"># target_include_directories(loop_closure PRIVATE $&#123;DBoW3_INCLUDE_DIRS&#125;)</span><br><span class="line"># target_link_libraries(loop_closure PRIVATE</span><br><span class="line">#     $&#123;OpenCV_LIBS&#125;</span><br><span class="line">#     $&#123;DBoW3_LIBRARIES&#125;</span><br><span class="line"># )</span><br><span class="line"></span><br><span class="line"># # 目标3: gen_vocab</span><br><span class="line"># add_executable(gen_vocab gen_vocab_large.cpp)</span><br><span class="line"># target_include_directories(gen_vocab PRIVATE $&#123;DBoW3_INCLUDE_DIRS&#125;)</span><br><span class="line"># target_link_libraries(gen_vocab PRIVATE</span><br><span class="line">#     $&#123;OpenCV_LIBS&#125;</span><br><span class="line">#     $&#123;DBoW3_LIBRARIES&#125;</span><br><span class="line"># )</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样就会生成一个字典压缩文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902112507945.png" alt="image-20250902112507945"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch11/build$ ./feature_training </span><br><span class="line">reading images... </span><br><span class="line">detecting ORB features ... </span><br><span class="line">creating vocabulary ... </span><br><span class="line">vocabulary info: Vocabulary: k = 10, L = 5, Weighting = tf-idf, Scoring = L1-norm, Number of words = 4972</span><br></pre></td></tr></table></figure>

<p>分支数量为10，深度为5，单词数量是4972，还有权重和评分。</p>
<hr>
<h2 id="相似度计算"><a href="#相似度计算" class="headerlink" title="相似度计算"></a>相似度计算</h2><h3 id="理论部分"><a href="#理论部分" class="headerlink" title="理论部分"></a>理论部分</h3><p>我们希望对单词的区分性或重要性加以评估，给它们不同的权值以起到更好的效果。<strong>TF-IDF</strong>，是文本检索的一种加权方式，TF部分的思想是，某单词在一幅图像经常出现，它的评分就高。另外，IDF的思想是：某单词在字典中出现的频率低，分类图像时区分度就高。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902145045033.png" alt="image-20250902145045033"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250902145102666.png" alt="image-20250902145102666"></p>
<h3 id="实践：相似度计算"><a href="#实践：相似度计算" class="headerlink" title="实践：相似度计算"></a>实践：相似度计算</h3><p>上一节已经通过10幅图像生成了字典，下面使用字典来生成词袋比较差异。</p>
<p>新建文件<code>slambook/ch11/loop_closure.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DBoW3/DBoW3.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************</span></span><br><span class="line"><span class="comment"> * 本节演示了如何根据data/目录下的十张图训练字典</span></span><br><span class="line"><span class="comment"> * ************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">( <span class="type">int</span> argc, <span class="type">char</span>** argv )</span> </span>&#123;</span><br><span class="line">    <span class="comment">// read the image </span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;reading images... &quot;</span>&lt;&lt;endl;</span><br><span class="line">    vector&lt;Mat&gt; images; </span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        string path = <span class="string">&quot;../data/&quot;</span>+<span class="built_in">to_string</span>(i<span class="number">+1</span>)+<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">        images.<span class="built_in">push_back</span>( <span class="built_in">imread</span>(path) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// detect ORB features</span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;detecting ORB features ... &quot;</span>&lt;&lt;endl;</span><br><span class="line">    Ptr&lt; Feature2D &gt; detector = ORB::<span class="built_in">create</span>();</span><br><span class="line">    vector&lt;Mat&gt; descriptors;</span><br><span class="line">    <span class="keyword">for</span> ( Mat&amp; image:images )</span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;KeyPoint&gt; keypoints; </span><br><span class="line">        Mat descriptor;</span><br><span class="line">        detector-&gt;<span class="built_in">detectAndCompute</span>( image, <span class="built_in">Mat</span>(), keypoints, descriptor );</span><br><span class="line">        descriptors.<span class="built_in">push_back</span>( descriptor );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create vocabulary </span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;creating vocabulary ... &quot;</span>&lt;&lt;endl;</span><br><span class="line">    DBoW3::Vocabulary vocab;</span><br><span class="line">    vocab.<span class="built_in">create</span>( descriptors );</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;vocabulary info: &quot;</span>&lt;&lt;vocab&lt;&lt;endl;</span><br><span class="line">    vocab.<span class="built_in">save</span>( <span class="string">&quot;vocabulary.yml.gz&quot;</span> );</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;done&quot;</span>&lt;&lt;endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch11/build$ ./loop_closure </span><br><span class="line">reading database</span><br><span class="line">reading images... </span><br><span class="line">detecting ORB features ... </span><br><span class="line">comparing images with images </span><br><span class="line">image 0 vs image 0 : 1</span><br><span class="line">image 0 vs image 1 : 0.0305829</span><br><span class="line">image 0 vs image 2 : 0.0221928</span><br><span class="line">image 0 vs image 3 : 0.0308756</span><br><span class="line">image 0 vs image 4 : 0.0231492</span><br><span class="line">image 0 vs image 5 : 0.0240249</span><br><span class="line">image 0 vs image 6 : 0.0240589</span><br><span class="line">image 0 vs image 7 : 0.0246117</span><br><span class="line">image 0 vs image 8 : 0.0287788</span><br><span class="line">image 0 vs image 9 : 0.0542239</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">image 9 vs image 9 : 1</span><br><span class="line"></span><br><span class="line">comparing images with database </span><br><span class="line">database info: Database: Entries = 10, Using direct index = no. Vocabulary: k = 10, L = 5, Weighting = tf-idf, Scoring = L1-norm, Number of words = 4972</span><br><span class="line">searching for image 0 returns 4 results:</span><br><span class="line">&lt;EntryId: 0, Score: 1&gt;</span><br><span class="line">&lt;EntryId: 9, Score: 0.0542239&gt;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">searching for image 4 returns 4 results:</span><br><span class="line">&lt;EntryId: 4, Score: 1&gt;</span><br><span class="line">&lt;EntryId: 5, Score: 0.0388892&gt;</span><br><span class="line">&lt;EntryId: 3, Score: 0.0379569&gt;</span><br></pre></td></tr></table></figure>

<p>首先可以看到不同图像与相似图像的评分，明显相似的是0与9（第一张与第十张）相似度约为0.0525；其他的约为0.02。似然相似图像的评分明显高于其他图像，但是从数值上来看，并没有特别明显，其实无关的图像相似度为2%，相似图像的相似度约为5%。没有想象的那么明显。</p>
<hr>
<h2 id="实验分析与评述"><a href="#实验分析与评述" class="headerlink" title="实验分析与评述"></a>实验分析与评述</h2><h3 id="增加字典规模"><a href="#增加字典规模" class="headerlink" title="增加字典规模"></a>增加字典规模</h3><p>当增加字典规模时，无关图像的相似性明显会减少，相似的图像相对于其他图像变得更为显著，这说明增加字典训练样本是有益的。</p>
<h3 id="相似性评分的处理"><a href="#相似性评分的处理" class="headerlink" title="相似性评分的处理"></a>相似性评分的处理</h3><p>对任意两幅图像，都可以给出一个相似性评分，但是不能只利用绝对大小，所以可以考虑先取一个先验相似度，表示某时刻关键帧图像与上一时刻的关键帧的相似性，然后其他的分值都参照这个值进行归一化处理。如果说：当前帧与之前某关键帧的相似度超过当前帧与上一关键帧相似度的3倍，就认为可能存在回环。这个步骤避免了引入绝对的相似性阈值，使得算法可以适应更多环境。</p>
<h3 id="关键帧的处理"><a href="#关键帧的处理" class="headerlink" title="关键帧的处理"></a>关键帧的处理</h3><p>用于回环检测的关键帧最好稀疏一点，另外如果确认第一帧与第n帧之间存在回环对轨迹优化是有帮助的，接下来的几帧帮助就没有那么大了，所以我们会把相近的回环聚成一类，使得算法不要反复检测同一类回环。</p>
<h3 id="检测之后的验证"><a href="#检测之后的验证" class="headerlink" title="检测之后的验证"></a>检测之后的验证</h3><p>词袋的回环检测算法完全依赖外观不利用任何几何信息，所以会导致外观相似的图像容易被当成回环。所以在回环检测之后，通常还会有一个验证步骤，一个方法是设立回环的缓存机制，另一个方法是空间上的一致性检测，对回环检测的两帧进行特征匹配，估计相机运动。</p>
<h3 id="与机器学习的关系"><a href="#与机器学习的关系" class="headerlink" title="与机器学习的关系"></a>与机器学习的关系</h3><p>……</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89--%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E5%85%AD%E8%AE%B2%EF%BC%89--%E9%9D%9E%E7%BA%BF%E6%80%A7%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">第六讲-非线性优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-06 00:00:00 / 修改时间：11:28:15" itemprop="dateCreated datePublished" datetime="2025-09-06T00:00:00+08:00">2025-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第六讲）–非线性优化"><a href="#视觉SLAM十四讲（第六讲）–非线性优化" class="headerlink" title="视觉SLAM十四讲（第六讲）–非线性优化"></a>视觉SLAM十四讲（第六讲）–非线性优化</h1><p>由于噪声存在，运动方程和观测方程的等式必定不是精确成立的，所以与其假设数据必须符合方程，不如讨论如何在有噪声的数据中进行准确的状态估计。非线性优化的核心就是构建一个总误差（代价函数），然后寻找一组状态变量（相机的位姿和路标点坐标），使得总误差最小。本节介绍基本的无约束非线性优化方法，同时介绍优化库<code>g2o Ceres</code>的使用。</p>
<h2 id="状态估计问题"><a href="#状态估计问题" class="headerlink" title="状态估计问题"></a>状态估计问题</h2><h3 id="批量状态估计与最大后验估计"><a href="#批量状态估计与最大后验估计" class="headerlink" title="批量状态估计与最大后验估计"></a>批量状态估计与最大后验估计</h3><p>回顾经典的SLAM模型，是由一个运动方程和一个观测方程构成，如下图所示<br>$$<br>\begin{cases} \mathbf{x}<em>{k} &#x3D; f(\mathbf{x}</em>{k-1}, \mathbf{u}<em>{k}) + \mathbf{w}</em>{k} \ \mathbf{z}<em>{k,j} &#x3D; h(\mathbf{y}</em>{j}, \mathbf{x}<em>{k}) + \mathbf{v}</em>{k,j} \end{cases}<br>$$</p>
<blockquote>
<p>运动方程和观测方程和状态方程</p>
</blockquote>
<ol>
<li><p>状态方程</p>
<p>状态方程描述了系统在内部状态上的宴会规律，是一个数学表达式，通常以微分方程、差分方程的形式，说明系统当前状态如何决定下一时刻的状态。是系统动态特性的数学模型，反映了系统如何相应输入，以及其自身的内在变化。</p>
</li>
<li><p>运动方程</p>
<p>运动方程是物理学中用来描述物体或系统运动状态变化的方程，通常是状态方程的一种特殊形式，其状态变量是与位置和速度相关的物理量，它的作用是讲作用在系统上的力、力矩等外部因素与系统的加速度等运动状态的变化联系起来。</p>
</li>
<li><p>观测方程</p>
<p>观测方程描述了系统内部状态与我们能够进行外部测量之间的关系，它将不可直接访问或者难以直接测量的状态变量，与可以从传感器等设备获得的测量数据联系起来，是连接模型内部与现实世界数据的桥梁，在状态估计（如卡尔曼滤波）中，可以利用观测方程来修正对系统状态的估计。</p>
</li>
</ol>
<hr>
<p>其中这里$x_k$是相机的位姿，可以由$T_k \in SE(3)$描述，假设在$x_k$处对路标$y_i$进行一次观测，对应到图像上的像素位置$z_{k,j}$，那么观测方程可以表示为：<br>$$<br>s\mathbf{z}<em>{k,j} &#x3D; \mathbf{K}(\mathbf{R}</em>{k}\mathbf{y}<em>{j} + \mathbf{t}</em>{k})<br>$$<br>其中$K$是相机内参，$s$是像素点的距离，也是$(\mathbf{R}<em>{k}\mathbf{y}</em>{j} + \mathbf{t}_{k})$的第三个分量。使用变换矩阵$T_k$描述位姿，那么路标点$y_i$必须以齐次坐标来描述，计算完成后要转换为非齐次坐标。等式左边表示带有深度信息的像素坐标，而右边代表了从三维转换而来的二维坐标的相机成像原理。理论上应该严格满足等式，左边是图像像素位置，右边是根据三维坐标推算出的像素位置。</p>
<p>现在，假设两个噪声项$w_k,v_{k,j}$满足零均值的高斯分布，像这样：<br>$$<br>\mathbf{w}<em>{k} \sim N(\mathbf{0}, \mathbf{R}</em>{k}), \quad \mathbf{v}<em>{k} \sim N(\mathbf{0}, \mathbf{Q}</em>{k,j})<br>$$<br>其中$N$表示高斯分布，$0$表示零均值，$R_k,Q_{k,j}$是协方差矩阵。希望通过带噪声的数据$z$和$u$推断位姿$x$和地图$y$，构成一个状态估计问题。</p>
<p>处理状态估计问题的方法有两种，由于数据是随时间逐渐到来的，所以应该持有一个当前的估计状态，使用新的数据来更新，这个方式称为<strong>增量&#x2F;渐进</strong>，或者是<strong>滤波器</strong>。另一种方式，则是把数据攒起来，称为<strong>批量</strong>。</p>
<p>其实批量和增量都是为了解决同一个问题：如何利用一系列带有噪声的观测数据，来最优地估计一个系统随时间变化的状态。它们的主要区别在于如何处理和利用这些数据。</p>
<hr>
<p>先介绍<strong>批量方法</strong>：</p>
<p>考虑从1到N的所有时刻，假设有M个路标点。定义所有时刻的机器人位姿和路标点的坐标为：<br>$$<br>\mathbf{x} &#x3D; {\mathbf{x}<em>{1}, \dots, \mathbf{x}</em>{N}}, \quad \mathbf{y} &#x3D; {\mathbf{y}<em>{1}, \dots, \mathbf{y}</em>{M}}<br>$$<br>用不带下标的u表示所有时刻的输入，z表示所有时刻的观测数据。已知了输入数据u和观测数据z的条件下，求x,y的条件概率分布：<br>$$<br>P(x, y | z, u)<br>$$<br><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829103331874.png" alt="image-20250829103331874"></p>
<hr>
<h3 id="最小二乘的引出"><a href="#最小二乘的引出" class="headerlink" title="最小二乘的引出"></a>最小二乘的引出</h3><p>由于真实的观测值与模型的预测值之间存在误差（<strong>重投影误差</strong>），所以就可以讲观测的误差的平方加起来，形成总的代价函数，来寻找一组最优的$T,P$​使得代价最小。这样就构成了一个最小二乘问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829104447523.png" alt="image-20250829104447523"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829104505181.png" alt="image-20250829104505181"></p>
<p>由于该式等价于最小化噪声项（误差）的一个二次型。这个二次型称为马哈拉诺比斯距离，称为<strong>马氏距离</strong>。最后，最小化所有时刻估计值与真实度数的马氏距离，等价于求最大似然估计。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250829105859126.png" alt="image-20250829105859126"></p>
<hr>
<h2 id="非线性最小二乘"><a href="#非线性最小二乘" class="headerlink" title="非线性最小二乘"></a>非线性最小二乘</h2><p>其实是为了算极值，优化联合优化函数，计算最小值，就可以求出想要的位姿了。一般有两种思路，一种是固定搜索方向，沿着方向寻找步长，称为<strong>line search</strong>,另一种是固定搜索区域，从区域中找最优点，称为<strong>Trust Reigion</strong>.</p>
<p>如何求解$x$的最优值呢，如果方程较为简单，很容易想到可以对方程进行求导，就可以求出极值，比较极值即可求出最优值。但是方程比较复杂，求导不方便，或者求导结果不容易求得的情况下，就需要采用另外一种方式——<strong>迭代</strong>，从一个初始值开始，不断更新当前的优化变量，使得目标函数下降，这样的话，就把求解导函数为0的问题，转换为了求下降增量$\Delta x_k$的问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826203637438.png" alt="image-20250826203637438"></p>
<p>同时可以对$f$进行线性化，可以更方便求解增量，当函数下降知道增量很小的时候，就认为算法收敛，目标函数达到了一个极小值。接下来只要考虑如何去寻找这个增量。常见的有几种方法</p>
<h3 id="一阶和二阶梯度法"><a href="#一阶和二阶梯度法" class="headerlink" title="一阶和二阶梯度法"></a>一阶和二阶梯度法</h3><p>最速下降法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826204413348.png" alt="image-20250826204413348"></p>
<p>将目标函数进行泰勒展开，保留一阶和二阶项，只要沿着反向梯度前进，目标函数一定会下降，但是最速下降法过于贪心，会走出锯齿路线，增加迭代次数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826204434100.png" alt="image-20250826204434100"></p>
<p>牛顿法需要计算目标函数的$H$矩阵（二阶导数，海塞矩阵），计算比较困难。</p>
<h3 id="高斯牛顿法"><a href="#高斯牛顿法" class="headerlink" title="高斯牛顿法"></a>高斯牛顿法</h3><p>由于$H$矩阵很难求解，所以就出现了高斯牛顿法，本质就是利用$JJ^T$作为牛顿法中二阶$H$矩阵的近似，从而求解增量。</p>
<h3 id="列文伯格-马夸尔特方法"><a href="#列文伯格-马夸尔特方法" class="headerlink" title="列文伯格-马夸尔特方法"></a>列文伯格-马夸尔特方法</h3><p>如果$J J^T$ 是非奇异矩阵或者病态的，稳定性就较差，可能需要考虑给$\Delta x$增加一个范围，称为信赖区域，这个范围定义了在什么情况下二阶近似是有效的。这样就渐渐引出了该方法，列文伯格-马夸尔特方法，可以在一定程度上避免方程组的系数矩阵的非奇异和病态问题。具体怎么求解可以查看教材，这里还没有研究明白。</p>
<hr>
<p><strong>总结</strong></p>
<p>通过最大似然估计计算位姿，分别由两大方法，line search 和 trust region 。</p>
<h2 id="实践：曲线拟合问题"><a href="#实践：曲线拟合问题" class="headerlink" title="实践：曲线拟合问题"></a>实践：曲线拟合问题</h2><h3 id="手写高斯牛顿法"><a href="#手写高斯牛顿法" class="headerlink" title="手写高斯牛顿法"></a>手写高斯牛顿法</h3><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250826095039537.png" alt="image-20250826095039537"></p>
<p>新建文件夹及文件<code>slambook/ch6/gaussNewton.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="type">double</span> ar = <span class="number">1.0</span>, br = <span class="number">2.0</span>, cr = <span class="number">1.0</span>;         <span class="comment">// 真实参数值</span></span><br><span class="line">  <span class="type">double</span> ae = <span class="number">2.0</span>, be = <span class="number">-1.0</span>, ce = <span class="number">5.0</span>;        <span class="comment">// 估计参数值</span></span><br><span class="line">  <span class="type">int</span> N = <span class="number">100</span>;                                 <span class="comment">// 数据点</span></span><br><span class="line">  <span class="type">double</span> w_sigma = <span class="number">1.0</span>;                        <span class="comment">// 噪声Sigma值</span></span><br><span class="line">  <span class="type">double</span> inv_sigma = <span class="number">1.0</span> / w_sigma;</span><br><span class="line">  cv::RNG rng;                                 <span class="comment">// OpenCV随机数产生器</span></span><br><span class="line"></span><br><span class="line">  vector&lt;<span class="type">double</span>&gt; x_data, y_data;      <span class="comment">// 数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="type">double</span> x = i / <span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(ar * x * x + br * x + cr) + rng.<span class="built_in">gaussian</span>(w_sigma * w_sigma));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始Gauss-Newton迭代</span></span><br><span class="line">  <span class="type">int</span> iterations = <span class="number">100</span>;    <span class="comment">// 迭代次数</span></span><br><span class="line">  <span class="type">double</span> cost = <span class="number">0</span>, lastCost = <span class="number">0</span>;  <span class="comment">// 本次迭代的cost和上一次迭代的cost</span></span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; iterations; iter++) &#123;</span><br><span class="line"></span><br><span class="line">    Matrix3d H = Matrix3d::<span class="built_in">Zero</span>();             <span class="comment">// Hessian = J^T W^&#123;-1&#125; J in Gauss-Newton</span></span><br><span class="line">    Vector3d b = Vector3d::<span class="built_in">Zero</span>();             <span class="comment">// bias</span></span><br><span class="line">    cost = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">      <span class="type">double</span> xi = x_data[i], yi = y_data[i];  <span class="comment">// 第i个数据点</span></span><br><span class="line">      <span class="type">double</span> error = yi - <span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);</span><br><span class="line">      Vector3d J; <span class="comment">// 雅可比矩阵</span></span><br><span class="line">      J[<span class="number">0</span>] = -xi * xi * <span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);  <span class="comment">// de/da</span></span><br><span class="line">      J[<span class="number">1</span>] = -xi * <span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);  <span class="comment">// de/db</span></span><br><span class="line">      J[<span class="number">2</span>] = -<span class="built_in">exp</span>(ae * xi * xi + be * xi + ce);  <span class="comment">// de/dc</span></span><br><span class="line"></span><br><span class="line">      H += inv_sigma * inv_sigma * J * J.<span class="built_in">transpose</span>();</span><br><span class="line">      b += -inv_sigma * inv_sigma * error * J;</span><br><span class="line"></span><br><span class="line">      cost += error * error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 求解线性方程 Hx=b</span></span><br><span class="line">    Vector3d dx = H.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(b);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isnan</span>(dx[<span class="number">0</span>])) &#123;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;result is nan!&quot;</span> &lt;&lt; endl;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iter &gt; <span class="number">0</span> &amp;&amp; cost &gt;= lastCost) &#123;</span><br><span class="line">      cout &lt;&lt; <span class="string">&quot;cost: &quot;</span> &lt;&lt; cost &lt;&lt; <span class="string">&quot;&gt;= last cost: &quot;</span> &lt;&lt; lastCost &lt;&lt; <span class="string">&quot;, break.&quot;</span> &lt;&lt; endl;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ae += dx[<span class="number">0</span>];</span><br><span class="line">    be += dx[<span class="number">1</span>];</span><br><span class="line">    ce += dx[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    lastCost = cost;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;total cost: &quot;</span> &lt;&lt; cost &lt;&lt; <span class="string">&quot;, \t\tupdate: &quot;</span> &lt;&lt; dx.<span class="built_in">transpose</span>() &lt;&lt;</span><br><span class="line">         <span class="string">&quot;\t\testimated params: &quot;</span> &lt;&lt; ae &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; be &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; ce &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;solve time cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;estimated abc = &quot;</span> &lt;&lt; ae &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; be &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; ce &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建cmakelists.txt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cmake<span class="emphasis">_minimum_</span>required(VERSION 2.8)</span><br><span class="line">project(ch6)</span><br><span class="line"></span><br><span class="line">set(CMAKE<span class="emphasis">_BUILD_</span>TYPE Release)</span><br><span class="line">set(CMAKE<span class="emphasis">_CXX_</span>FLAGS &quot;-std=c++14 -O3&quot;)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE<span class="emphasis">_MODULE_</span>PATH $&#123;PROJECT<span class="emphasis">_SOURCE_</span>DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="section"># OpenCV</span></span><br><span class="line">find<span class="emphasis">_package(OpenCV REQUIRED)</span></span><br><span class="line"><span class="emphasis">include_</span>directories($&#123;OpenCV<span class="emphasis">_INCLUDE_</span>DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="section"># Eigen</span></span><br><span class="line">include<span class="emphasis">_directories(&quot;/usr/include/eigen3&quot;)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">add_</span>executable(gaussNewton gaussNewton.cpp)</span><br><span class="line">target<span class="emphasis">_link_</span>libraries(gaussNewton $&#123;OpenCV<span class="emphasis">_LIBS&#125;)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span></span><br></pre></td></tr></table></figure>

<p>终端输入输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ cmake ..</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch6/build</span><br><span class="line">hita@hita-vm:~/slambook/ch6/build$ make</span><br><span class="line">[100%] Built target gaussNewton</span><br><span class="line">hita@hita-vm:~/slambook/ch6/build$ ./gaussNewton </span><br><span class="line">total cost: 3.19575e+06,                update: 0.0455771  0.078164 -0.985329           estimated params: 2.04558,-0.921836,4.01467</span><br><span class="line">total cost: 376785,             update:  0.065762  0.224972 -0.962521           estimated params: 2.11134,-0.696864,3.05215</span><br><span class="line">total cost: 35673.6,            update: -0.0670241   0.617616  -0.907497                estimated params: 2.04432,-0.0792484,2.14465</span><br><span class="line">total cost: 2195.01,            update: -0.522767   1.19192 -0.756452           estimated params: 1.52155,1.11267,1.3882</span><br><span class="line">total cost: 174.853,            update: -0.537502  0.909933 -0.386395           estimated params: 0.984045,2.0226,1.00181</span><br><span class="line">total cost: 102.78,             update: -0.0919666   0.147331 -0.0573675                estimated params: 0.892079,2.16994,0.944438</span><br><span class="line">total cost: 101.937,            update: -0.00117081  0.00196749 -0.00081055             estimated params: 0.890908,2.1719,0.943628</span><br><span class="line">total cost: 101.937,            update:   3.4312e-06 -4.28555e-06  1.08348e-06          estimated params: 0.890912,2.1719,0.943629</span><br><span class="line">total cost: 101.937,            update: -2.01204e-08  2.68928e-08 -7.86602e-09          estimated params: 0.890912,2.1719,0.943629</span><br><span class="line">cost: 101.937&gt;= last cost: 101.937, <span class="built_in">break</span>.</span><br><span class="line">solve <span class="keyword">time</span> cost = 0.000200972 seconds. </span><br><span class="line">estimated abc = 0.890912, 2.1719, 0.943629</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="使用Ceres进行曲线拟合"><a href="#使用Ceres进行曲线拟合" class="headerlink" title="使用Ceres进行曲线拟合"></a>使用Ceres进行曲线拟合</h3><p>Ceres是一个最小二乘问题求解库</p>
<blockquote>
<p>安装Ceres</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://ceres-solver.googlesource.com/ceres-solver</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install libgogle-glog-dev libgflags-dev libatlas-base-dev libsuitespares-dev</span><br><span class="line"><span class="built_in">cd</span> ceres-solver</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make </span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>这样通过测试之后就安装成功了</p>
<p>新建文件<code>slambook/ch/ceresCurveFitting.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xiang on 18-11-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ceres/ceres.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代价函数的计算模型</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CURVE_FITTING_COST</span> &#123;</span><br><span class="line">  <span class="built_in">CURVE_FITTING_COST</span>(<span class="type">double</span> x, <span class="type">double</span> y) : _x(x), _y(y) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 残差的计算</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">  <span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> T *<span class="type">const</span> abc, <span class="comment">// 模型参数，有3维</span></span></span></span><br><span class="line"><span class="params"><span class="function">    T *residual)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    residual[<span class="number">0</span>] = <span class="built_in">T</span>(_y) - ceres::<span class="built_in">exp</span>(abc[<span class="number">0</span>] * <span class="built_in">T</span>(_x) * <span class="built_in">T</span>(_x) + abc[<span class="number">1</span>] * <span class="built_in">T</span>(_x) + abc[<span class="number">2</span>]); <span class="comment">// y-exp(ax^2+bx+c)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> _x, _y;    <span class="comment">// x,y数据</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="type">double</span> ar = <span class="number">1.0</span>, br = <span class="number">2.0</span>, cr = <span class="number">1.0</span>;         <span class="comment">// 真实参数值</span></span><br><span class="line">  <span class="type">double</span> ae = <span class="number">2.0</span>, be = <span class="number">-1.0</span>, ce = <span class="number">5.0</span>;        <span class="comment">// 估计参数值</span></span><br><span class="line">  <span class="type">int</span> N = <span class="number">100</span>;                                 <span class="comment">// 数据点</span></span><br><span class="line">  <span class="type">double</span> w_sigma = <span class="number">1.0</span>;                        <span class="comment">// 噪声Sigma值</span></span><br><span class="line">  <span class="type">double</span> inv_sigma = <span class="number">1.0</span> / w_sigma;</span><br><span class="line">  cv::RNG rng;                                 <span class="comment">// OpenCV随机数产生器</span></span><br><span class="line"></span><br><span class="line">  vector&lt;<span class="type">double</span>&gt; x_data, y_data;      <span class="comment">// 数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="type">double</span> x = i / <span class="number">100.0</span>;</span><br><span class="line">    x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">    y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(ar * x * x + br * x + cr) + rng.<span class="built_in">gaussian</span>(w_sigma * w_sigma));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> abc[<span class="number">3</span>] = &#123;ae, be, ce&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建最小二乘问题</span></span><br><span class="line">  ceres::Problem problem;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    problem.<span class="built_in">AddResidualBlock</span>(     <span class="comment">// 向问题中添加误差项</span></span><br><span class="line">      <span class="comment">// 使用自动求导，模板参数：误差类型，输出维度，输入维度，维数要与前面struct中一致</span></span><br><span class="line">      <span class="keyword">new</span> ceres::<span class="built_in">AutoDiffCostFunction</span>&lt;CURVE_FITTING_COST, <span class="number">1</span>, <span class="number">3</span>&gt;(</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">CURVE_FITTING_COST</span>(x_data[i], y_data[i])</span><br><span class="line">      ),</span><br><span class="line">      <span class="literal">nullptr</span>,            <span class="comment">// 核函数，这里不使用，为空</span></span><br><span class="line">      abc                 <span class="comment">// 待估计参数</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置求解器</span></span><br><span class="line">  ceres::Solver::Options options;     <span class="comment">// 这里有很多配置项可以填</span></span><br><span class="line">  options.linear_solver_type = ceres::DENSE_NORMAL_CHOLESKY;  <span class="comment">// 增量方程如何求解</span></span><br><span class="line">  options.minimizer_progress_to_stdout = <span class="literal">true</span>;   <span class="comment">// 输出到cout</span></span><br><span class="line"></span><br><span class="line">  ceres::Solver::Summary summary;                <span class="comment">// 优化信息</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  ceres::<span class="built_in">Solve</span>(options, &amp;problem, &amp;summary);  <span class="comment">// 开始优化</span></span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;solve time cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出结果</span></span><br><span class="line">  cout &lt;&lt; summary.<span class="built_in">BriefReport</span>() &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;estimated a,b,c = &quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> a:abc) cout &lt;&lt; a &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">  cout &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(ch6)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE Release)</span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++14 -O3&quot;</span>)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenCV</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ceres</span></span><br><span class="line">find_package(Ceres REQUIRED)</span><br><span class="line">include_directories($&#123;CERES_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # g2o</span></span><br><span class="line"><span class="comment"># find_package(G2O REQUIRED)</span></span><br><span class="line"><span class="comment"># include_directories($&#123;G2O_INCLUDE_DIRS&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eigen</span></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line"></span><br><span class="line">add_executable(gaussNewton gaussNewton.cpp)</span><br><span class="line">target_link_libraries(gaussNewton $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(ceresCurveFitting ceresCurveFitting.cpp)</span><br><span class="line">target_link_libraries(ceresCurveFitting $&#123;OpenCV_LIBS&#125; $&#123;CERES_LIBRARIES&#125;)</span><br></pre></td></tr></table></figure>

<p>终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch6/build</span><br><span class="line">hita@hita-vm:~/slambook/ch6/build$ make -j8</span><br><span class="line">[ 50%] Built target ceresCurveFitting</span><br><span class="line">[100%] Built target gaussNewton</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ ./ceresCurveFitting </span><br><span class="line">iter      cost      cost_change  |gradient|   |step|    tr_ratio  tr_radius  ls_iter  iter_time  total_time</span><br><span class="line">   0  1.597873e+06    0.00e+00    3.52e+06   0.00e+00   0.00e+00  1.00e+04        0    1.05e-05    4.74e-05</span><br><span class="line">   1  1.884440e+05    1.41e+06    4.86e+05   0.00e+00   8.82e-01  1.81e+04        1    7.48e-05    1.66e-04</span><br><span class="line">   2  1.784821e+04    1.71e+05    6.78e+04   9.89e-01   9.06e-01  3.87e+04        1    1.10e-05    1.92e-04</span><br><span class="line">   3  1.099631e+03    1.67e+04    8.58e+03   1.10e+00   9.41e-01  1.16e+05        1    1.04e-05    2.14e-04</span><br><span class="line">   4  8.784938e+01    1.01e+03    6.53e+02   1.51e+00   9.67e-01  3.48e+05        1    1.03e-05    2.37e-04</span><br><span class="line">   5  5.141230e+01    3.64e+01    2.72e+01   1.13e+00   9.90e-01  1.05e+06        1    1.03e-05    2.59e-04</span><br><span class="line">   6  5.096862e+01    4.44e-01    4.27e-01   1.89e-01   9.98e-01  3.14e+06        1    1.02e-05    2.81e-04</span><br><span class="line">   7  5.096851e+01    1.10e-04    9.53e-04   2.84e-03   9.99e-01  9.41e+06        1    1.01e-05    3.03e-04</span><br><span class="line">solve time cost = 0.000338185 seconds. </span><br><span class="line">Ceres Solver Report: Iterations: 8, Initial cost: 1.597873e+06, Final cost: 5.096851e+01, Termination: CONVERGENCE</span><br><span class="line">estimated a,b,c = 0.890908 2.1719 0.943628 </span><br></pre></td></tr></table></figure>

<hr>
<h3 id="使用g2o进行曲线拟合"><a href="#使用g2o进行曲线拟合" class="headerlink" title="使用g2o进行曲线拟合"></a>使用g2o进行曲线拟合</h3><p>g2o(General Graphic Optimization,$G^2O$)这是一个基于图优化的库，这是一种将非线性优化与图论结合起来的理论。</p>
<blockquote>
<p>图优化理论简介</p>
</blockquote>
<p><strong>组成</strong></p>
<ul>
<li><p>节点</p>
<p>表示需要估计的未知变量，通常是机器人的位姿</p>
</li>
<li><p>边</p>
<p>边代表节点之间的关系，也就是获得的观测数据或约束</p>
</li>
</ul>
<hr>
<p><strong>原理</strong></p>
<p>图优化的目标就是找到一组位姿的估计值，使得所有边的误差和最小。</p>
<ol>
<li>定义误差函数</li>
<li>构建总代价函数</li>
<li>求解：高斯牛顿、列文伯格法。</li>
</ol>
<blockquote>
<p>g2o的编译安装</p>
</blockquote>
<p>根据：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RainerKuemmerle/g2o">RainerKuemmerle&#x2F;g2o: g2o: A General Framework for Graph Optimization</a></p>
<p>安装即可。</p>
<p>新建文件<code>slambook/ch6/g2oCurveFitting.cpp</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/g2o_core_api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_vertex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/base_unary_edge.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_gauss_newton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/core/optimization_algorithm_dogleg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 曲线模型的顶点，模板参数：优化变量维度和数据类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CurveFittingVertex</span> : <span class="keyword">public</span> g2o::BaseVertex&lt;<span class="number">3</span>, Eigen::Vector3d&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">setToOriginImpl</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        _estimate &lt;&lt; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">oplusImpl</span><span class="params">(<span class="type">const</span> <span class="type">double</span> *update)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        _estimate += Eigen::<span class="built_in">Vector3d</span>(update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存盘和读盘：留空，但需要返回值</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 误差模型 模板参数：观测值维度，类型，连接顶点类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CurveFittingEdge</span> : <span class="keyword">public</span> g2o::BaseUnaryEdge&lt;<span class="number">1</span>, <span class="type">double</span>, CurveFittingVertex&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">CurveFittingEdge</span><span class="params">(<span class="type">double</span> x)</span> : BaseUnaryEdge(), _x(x) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算曲线模型误差</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">computeError</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="type">const</span> CurveFittingVertex *v = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> CurveFittingVertex *&gt; (_vertices[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">const</span> Eigen::Vector3d abc = v-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">        _error(<span class="number">0</span>, <span class="number">0</span>) = _measurement - std::<span class="built_in">exp</span>(<span class="built_in">abc</span>(<span class="number">0</span>, <span class="number">0</span>) * _x * _x + <span class="built_in">abc</span>(<span class="number">1</span>, <span class="number">0</span>) * _x + <span class="built_in">abc</span>(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算雅可比矩阵</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">linearizeOplus</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="type">const</span> CurveFittingVertex *v = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> CurveFittingVertex *&gt; (_vertices[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">const</span> Eigen::Vector3d abc = v-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">        <span class="type">double</span> y = <span class="built_in">exp</span>(abc[<span class="number">0</span>] * _x * _x + abc[<span class="number">1</span>] * _x + abc[<span class="number">2</span>]);</span><br><span class="line">        _jacobianOplusXi[<span class="number">0</span>] = -_x * _x * y;</span><br><span class="line">        _jacobianOplusXi[<span class="number">1</span>] = -_x * y;</span><br><span class="line">        _jacobianOplusXi[<span class="number">2</span>] = -y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">read</span><span class="params">(istream &amp;in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">write</span><span class="params">(ostream &amp;out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> _x;  <span class="comment">// x 值， y 值为 _measurement</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">double</span> ar = <span class="number">1.0</span>, br = <span class="number">2.0</span>, cr = <span class="number">1.0</span>;          <span class="comment">// 真实参数值</span></span><br><span class="line">    <span class="type">double</span> ae = <span class="number">2.0</span>, be = <span class="number">-1.0</span>, ce = <span class="number">5.0</span>;         <span class="comment">// 估计参数值</span></span><br><span class="line">    <span class="type">int</span> N = <span class="number">100</span>;                                   <span class="comment">// 数据点</span></span><br><span class="line">    <span class="type">double</span> w_sigma = <span class="number">1.0</span>;                         <span class="comment">// 噪声Sigma值</span></span><br><span class="line">    <span class="type">double</span> inv_sigma = <span class="number">1.0</span> / w_sigma;</span><br><span class="line">    cv::RNG rng;                                   <span class="comment">// OpenCV随机数产生器</span></span><br><span class="line"></span><br><span class="line">    vector&lt;<span class="type">double</span>&gt; x_data, y_data;      <span class="comment">// 数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="type">double</span> x = i / <span class="number">100.0</span>;</span><br><span class="line">        x_data.<span class="built_in">push_back</span>(x);</span><br><span class="line">        y_data.<span class="built_in">push_back</span>(<span class="built_in">exp</span>(ar * x * x + br * x + cr) + rng.<span class="built_in">gaussian</span>(w_sigma * w_sigma));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建图优化，先设定g2o</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;<span class="number">3</span>, <span class="number">1</span>&gt;&gt; BlockSolverType;  <span class="comment">// 每个误差项优化变量维度为3，误差值维度为1</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::LinearSolverDense&lt;BlockSolverType::PoseMatrixType&gt; LinearSolverType; <span class="comment">// 线性求解器类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 梯度下降方法，可以从GN, LM, DogLeg 中选</span></span><br><span class="line">    <span class="comment">// 已修正：使用 std::make_unique</span></span><br><span class="line">    <span class="keyword">auto</span> solver = <span class="keyword">new</span> g2o::<span class="built_in">OptimizationAlgorithmGaussNewton</span>(</span><br><span class="line">        std::<span class="built_in">make_unique</span>&lt;BlockSolverType&gt;(std::<span class="built_in">make_unique</span>&lt;LinearSolverType&gt;()));</span><br><span class="line">    g2o::SparseOptimizer optimizer;     <span class="comment">// 图模型</span></span><br><span class="line">    optimizer.<span class="built_in">setAlgorithm</span>(solver);    <span class="comment">// 设置求解器</span></span><br><span class="line">    optimizer.<span class="built_in">setVerbose</span>(<span class="literal">true</span>);        <span class="comment">// 打开调试输出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往图中增加顶点</span></span><br><span class="line">    CurveFittingVertex *v = <span class="keyword">new</span> <span class="built_in">CurveFittingVertex</span>();</span><br><span class="line">    v-&gt;<span class="built_in">setEstimate</span>(Eigen::<span class="built_in">Vector3d</span>(ae, be, ce));</span><br><span class="line">    v-&gt;<span class="built_in">setId</span>(<span class="number">0</span>);</span><br><span class="line">    optimizer.<span class="built_in">addVertex</span>(v);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往图中增加边</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        CurveFittingEdge *edge = <span class="keyword">new</span> <span class="built_in">CurveFittingEdge</span>(x_data[i]);</span><br><span class="line">        edge-&gt;<span class="built_in">setId</span>(i);</span><br><span class="line">        edge-&gt;<span class="built_in">setVertex</span>(<span class="number">0</span>, v);                 <span class="comment">// 设置连接的顶点</span></span><br><span class="line">        edge-&gt;<span class="built_in">setMeasurement</span>(y_data[i]);       <span class="comment">// 观测数值</span></span><br><span class="line">        edge-&gt;<span class="built_in">setInformation</span>(Eigen::Matrix&lt;<span class="type">double</span>, <span class="number">1</span>, <span class="number">1</span>&gt;::<span class="built_in">Identity</span>() * <span class="number">1</span> / (w_sigma * w_sigma)); <span class="comment">// 信息矩阵：协方差矩阵之逆</span></span><br><span class="line">        optimizer.<span class="built_in">addEdge</span>(edge);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行优化</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;start optimization&quot;</span> &lt;&lt; endl;</span><br><span class="line">    chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    optimizer.<span class="built_in">initializeOptimization</span>();</span><br><span class="line">    optimizer.<span class="built_in">optimize</span>(<span class="number">10</span>);</span><br><span class="line">    chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="type">double</span>&gt;&gt;(t2 - t1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;solve time cost = &quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; seconds. &quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出优化值</span></span><br><span class="line">    Eigen::Vector3d abc_estimate = v-&gt;<span class="built_in">estimate</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;estimated model: &quot;</span> &lt;&lt; abc_estimate.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(ch6)</span><br><span class="line"></span><br><span class="line">set(CMAKE_BUILD_TYPE Release)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++17 -O3&quot;</span>)</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">list(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenCV</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ceres</span></span><br><span class="line">find_package(Ceres REQUIRED)</span><br><span class="line">include_directories($&#123;CERES_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # g2o</span></span><br><span class="line">find_package(g2o REQUIRED)</span><br><span class="line">include_directories($&#123;g2o_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Eigen</span></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line"></span><br><span class="line">add_executable(gaussNewton gaussNewton.cpp)</span><br><span class="line">target_link_libraries(gaussNewton $&#123;OpenCV_LIBS&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(ceresCurveFitting ceresCurveFitting.cpp)</span><br><span class="line">target_link_libraries(ceresCurveFitting $&#123;OpenCV_LIBS&#125; $&#123;CERES_LIBRARIES&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(g2oCurveFitting g2oCurveFitting.cpp)</span><br><span class="line"><span class="comment"># target_link_libraries(g2oCurveFitting $&#123;OpenCV_LIBS&#125; $&#123;g2o_LIBRARIES&#125;)</span></span><br><span class="line">target_link_libraries(g2oCurveFitting</span><br><span class="line">    $&#123;OpenCV_LIBS&#125;</span><br><span class="line">    g2o_core</span><br><span class="line">    g2o_solver_dense</span><br><span class="line">    g2o_stuff</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch6/build$ ./g2oCurveFitting </span><br><span class="line">start optimization</span><br><span class="line">iteration= 0     chi2= 376785.128234     time= 1.0607e-05        cumTime= 1.0607e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 1     chi2= 35673.566018      time= 2.992e-06         cumTime= 1.3599e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 2     chi2= 2195.012304       time= 2.785e-06         cumTime= 1.6384e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 3     chi2= 174.853126        time= 2.811e-06         cumTime= 1.9195e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 4     chi2= 102.779695        time= 3.413e-06         cumTime= 2.2608e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 5     chi2= 101.937194        time= 2.985e-06         cumTime= 2.5593e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 6     chi2= 101.937020        time= 2.965e-06         cumTime= 2.8558e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 7     chi2= 101.937020        time= 2.605e-06         cumTime= 3.1163e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 8     chi2= 101.937020        time= 2.901e-06         cumTime= 3.4064e-05     edges= 100      schur= 0</span><br><span class="line">iteration= 9     chi2= 101.937020        time= 2.797e-06         cumTime= 3.6861e-05     edges= 100      schur= 0</span><br><span class="line">solve time cost = 0.000727411 seconds. </span><br><span class="line">estimated model: 0.890912   2.1719 0.943629</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/08/25/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%BA%94%E8%AE%B2%EF%BC%89--%E7%9B%B8%E6%9C%BA%E4%B8%8E%E5%9B%BE%E5%83%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/25/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%BA%94%E8%AE%B2%EF%BC%89--%E7%9B%B8%E6%9C%BA%E4%B8%8E%E5%9B%BE%E5%83%8F/" class="post-title-link" itemprop="url">第五讲-相机与图像</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-25 00:00:00 / 修改时间：11:31:01" itemprop="dateCreated datePublished" datetime="2025-08-25T00:00:00+08:00">2025-08-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第五讲）–相机与图像"><a href="#视觉SLAM十四讲（第五讲）–相机与图像" class="headerlink" title="视觉SLAM十四讲（第五讲）–相机与图像"></a>视觉SLAM十四讲（第五讲）–相机与图像</h1><p>计算机中，一张照片由很多像素组成，每个像素记录色彩或亮度的信息。</p>
<h2 id="相机模型"><a href="#相机模型" class="headerlink" title="相机模型"></a>相机模型</h2><p>相机将三维坐标点映射到二位图像平面可以由一个几何模型描述。例如针孔模型。同时，由于相机镜头有透镜，使得光线投影到成像平面的过程中会产生畸变，因此需要针孔和畸变模型描述投影过程。两个模型可以将外部的三维点投影到相机内部成像平面，构成<code>内参数</code>。</p>
<h3 id="针孔相机模型"><a href="#针孔相机模型" class="headerlink" title="针孔相机模型"></a>针孔相机模型</h3><p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20190102115709713.png" alt="Overview of each camera model (pinhole + fisheye) - Programmer Sought"></p>
<p>$$<br>\frac{Z}{f} &#x3D; -\frac{X}{X’} &#x3D; -\frac{Y}{Y’}<br>$$<br>由图可以知道如上式关系，其中负号表示成像是倒立的。为了更符合实际，等价将成像平面对称地放到相机前方，和三维空间点放到摄像机坐标系同一侧，如下图所示，所得等式也稍作调整：<br>$$<br>\frac{Z}{f} &#x3D; \frac{X}{X’} &#x3D; \frac{Y}{Y’}<br>$$<br><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20181113171148585.png" alt="几何光学 | 1-1 几何光学基本定律与成像基本概念 - 知乎"></p>
<p>整理一下上述公式：<br>$$<br>X’ &#x3D; f\frac{X}{Z}<br>\<br>Y’ &#x3D; f\frac{Y}{Z}<br>$$<br>进行处理后的正像被称为针孔模型。在相机中，我们最终获得的是一个个像素，需要在成像平面上对像进行采样和量化，为了描述将光线转换成图像像素的过程，在物理平面上固定一个**像素平面$o-u-v$。**在像素平面得到$P^{‘}$的像素坐标：$[u, v]^T$​​。</p>
<p>下图是不同坐标系的表示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/f15758757d381093fa8e45670bfc09d4.png"></p>
<blockquote>
<p>像素坐标系</p>
</blockquote>
<p>表示三维空间物体在图像平面的投影，像素是离散化的。坐标原点在CCD图像平面的左上角，u轴平行于CCD平面水平向右，v轴垂直与u轴向下，坐标使用(u, v)表示。像素坐标系与成像平面之间相差一个<code>缩放</code>和一个<code>远点的平移</code>。设像素坐标在u轴上缩放了α倍，在v轴上缩放了β倍。同时原点平移了$[c_x,c_y]^T$。那么，$P^{‘}$的坐标与像素坐标$[u, v]^ T$的关系是：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250822194654199.png" alt="image-20250822194654199"></p>
<p>其中，中间的两组成的矩阵$K$称为相机的内参数矩阵，通常不会发生改变。如果需要自己确定相机内参的话，就需要所谓的标定技术例如张正友标定法。至于外参，我们使用的是$P$在相机坐标系（就是实际的相机的坐标系）下的坐标，但是实际上由于相机在运动，所以$P$的相机坐标应该是他的世界坐标系，即根据相机当前的位姿变换到相机坐标系的结果$P_w$。相机的位姿由它的旋转矩阵R和平移向量t描述：<br>$$<br>ZP_{uv} &#x3D; Z \begin{bmatrix} u \ v \ 1 \end{bmatrix} &#x3D; \mathbf{K}(\mathbf{R}P_{w} + \mathbf{t}) &#x3D; \mathbf{K}\mathbf{T}P_{w}<br>$$<br>其中，相机的位姿R，t又称为<code>相机的外参数</code>。</p>
<p>投影相当于在由世界坐标系到相机坐标系的转化过程中，再除掉最后一维的数值（深度）。相当于进行一个归一化处理，得到点$P$在相机<strong>归一化平面</strong>上的投影：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250822201917962.png" alt="image-20250822201917962"></p>
<p><strong>归一化坐标</strong>可以理解为相机前方z &#x3D; 1处的平面上的点，这个平面也称为归一化平面，归一化坐标左乘内参就是像素坐标，如果对于相机坐标系同时乘以任意非零常数，得到的归一化坐标都是一样的，这就是<strong>点的深度在投影过程中丢失了</strong>，所以单目视觉得不到像素点的深度值。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/MengYa_Dream/article/details/120233806">图像处理——4个坐标系及相关转换图像像素坐标系 图像物理坐标系 相机坐标系 世界坐标系_图像坐标系-CSDN博客</a></p>
<hr>
<h3 id="畸变模型"><a href="#畸变模型" class="headerlink" title="畸变模型"></a>畸变模型</h3><p>为了获得好的成像效果，会在相机前方加上透镜，会影响光线传播，由透镜形状引起的畸变称为径向畸变，主要分为：桶形畸变和枕形畸变。除了透镜的形状会引入畸变，由于相机的组装过程中不能使透镜与成像面严格平行，所以会引入切向畸变。所以要进行畸变校正，具体参考书本101页。</p>
<p>主要是理解四个坐标系之间的变换关系。</p>
<hr>
<h3 id="双目相机模型"><a href="#双目相机模型" class="headerlink" title="双目相机模型"></a>双目相机模型</h3><p>由于根据单个相机无法确定空间点的具体位置，只有当P的深度确定时，才能确切知道空间位置。可以通过同步采集左右相机的图像，计算图像间的视差，估计每一个像素的深度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/stereo.PNG" alt="stereo"></p>
<p>双目相机一般由左眼和右眼两个<strong>水平放置</strong>的相机组成。上图中左右两个相机都是使用针孔相机模型，两个相机的成像平面在同一个水平面上，同时两个相机光心是水平放置的，因此对于一个P点，其在两个图像上的投影点的行坐标是相同的，我们通过对其纵坐标的处理便可以得到视差了。</p>
<p>图中两个相机光心之间的距离b被成为双目相机的<strong>基线</strong>，是与焦距f一样重要的参数。</p>
<p>根据上图，假设一个空间点P，在左右目各成一像$P_L$与$P_R$，分别以两个光心垂直的位置为二维坐标原点，则$P_L$的横坐标为$u_L$，$P_R$的横坐标为$u_R$，可以发现$u_R$是一个负数。根据上图中右侧三角形相似的原理，可以得到下面公式<br>$$<br>\frac{z-f}{z}&#x3D;\frac{b-u_{L}+u_{R}}{b}<br>$$<br>得到：<br>$$<br>z &#x3D; \frac{fb}{d}, d&#x3D; u_L -u_R<br>$$<br>d称为视差。</p>
<hr>
<h3 id="RGB-D相机模型"><a href="#RGB-D相机模型" class="headerlink" title="RGB-D相机模型"></a>RGB-D相机模型</h3><p>相较于双目相机通过视差计算深度，RGB-D相机能够主动测量每个像素的深度，主要分为两类RGB-D相机：</p>
<ol>
<li>通过红外结构光原理测量像素距离</li>
<li>通过飞行实践原理测量像素距离</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/cae3ffa05c1d4dd7a52cd9cc25b860c9.png" alt="img"></p>
<p>无论哪种，都要向探测目标发射一束光线（通常为红外光）。在红外结构光原理中，相机根据返回的结构光图案，计算物体与自身的距离。在TOF原理中，先发射脉冲光，根据发送到返回之间的光束飞行时间计算物体与自身的距离。这里只做简单介绍</p>
<hr>
<h2 id="图像"><a href="#图像" class="headerlink" title="图像"></a>图像</h2><p>数学中，图像可以用一个矩阵描述，计算机中，可以用二维数组表示。我们使用OpenCV来进行图像处理，在一张灰度图中，每个像素位置$(x, y)$对应一个灰度值$I$，所以一张宽度为$w$、高度为$h$的图像，在数学上记为一个函数：<br>$$<br>I(x, y) : \mathbb{R}^{2} \mapsto \mathbb{R}<br>$$<br>$(x, y)$是像素坐标。用0~255的整数表达图像的灰度读数。那么一张宽度为640像素、高度为480像素分辨率的灰度图可以表示为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> image[<span class="number">480</span>][<span class="number">640</span>]</span><br></pre></td></tr></table></figure>

<p>因为在图像中，数组的行数对应图像的高度，列数对应图像的宽度。图像以二维数组形式存储，当访问某一个像素时，需要指明所处的坐标。</p>
<p>我们讨论一个位于x,y处的像素，访问方式是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> pixel = image[y][x]</span><br></pre></td></tr></table></figure>

<p>至于像素数据的记录，只做一个简单介绍，如下图展示的，例如一般灰度值用8位整数记录0~255d的值，彩色图则使用三通道，24位记录。</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250822214528123.png" alt="image-20250822214528123"></p>
<hr>
<h2 id="实践：计算机中的图像"><a href="#实践：计算机中的图像" class="headerlink" title="实践：计算机中的图像"></a>实践：计算机中的图像</h2><h3 id="OpenCV基本使用方法"><a href="#OpenCV基本使用方法" class="headerlink" title="OpenCV基本使用方法"></a>OpenCV基本使用方法</h3><blockquote>
<p>安装opencv</p>
</blockquote>
<p>环境：ubuntu20.04 vm17</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrate -y</span><br><span class="line"><span class="built_in">sudo</span> apt install libopencv-dev python3-opencv -y</span><br></pre></td></tr></table></figure>



<p>新建文件夹及文件：<code>slambook/ch5/imageBasics/imageBasics.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 读取argv[1]指定的图像</span></span><br><span class="line">  cv::Mat image;</span><br><span class="line">  image = cv::<span class="built_in">imread</span>(argv[<span class="number">1</span>]); <span class="comment">//cv::imread函数读取指定路径下的图像</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断图像文件是否正确读取</span></span><br><span class="line">  <span class="keyword">if</span> (image.data == <span class="literal">nullptr</span>) &#123; <span class="comment">//数据不存在,可能是文件不存在</span></span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;文件&quot;</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; <span class="string">&quot;不存在.&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件顺利读取, 首先输出一些基本信息</span></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;图像宽为&quot;</span> &lt;&lt; image.cols &lt;&lt; <span class="string">&quot;,高为&quot;</span> &lt;&lt; image.rows &lt;&lt; <span class="string">&quot;,通道数为&quot;</span> &lt;&lt; image.<span class="built_in">channels</span>() &lt;&lt; endl;</span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;image&quot;</span>, image);      <span class="comment">// 用cv::imshow显示图像</span></span><br><span class="line">  cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);                  <span class="comment">// 暂停程序,等待一个按键输入</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断image的类型</span></span><br><span class="line">  <span class="keyword">if</span> (image.<span class="built_in">type</span>() != CV_8UC1 &amp;&amp; image.<span class="built_in">type</span>() != CV_8UC3) &#123;</span><br><span class="line">    <span class="comment">// 图像类型不符合要求</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;请输入一张彩色图或灰度图.&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历图像, 请注意以下遍历方式亦可使用于随机像素访问</span></span><br><span class="line">  <span class="comment">// 使用 std::chrono 来给算法计时</span></span><br><span class="line">  chrono::steady_clock::time_point t1 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> y = <span class="number">0</span>; y &lt; image.rows; y++) &#123;</span><br><span class="line">    <span class="comment">// 用cv::Mat::ptr获得图像的行指针</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *row_ptr = image.<span class="built_in">ptr</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt;(y);  <span class="comment">// row_ptr是第y行的头指针</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> x = <span class="number">0</span>; x &lt; image.cols; x++) &#123;</span><br><span class="line">      <span class="comment">// 访问位于 x,y 处的像素</span></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">char</span> *data_ptr = &amp;row_ptr[x * image.<span class="built_in">channels</span>()]; <span class="comment">// data_ptr 指向待访问的像素数据</span></span><br><span class="line">      <span class="comment">// 输出该像素的每个通道,如果是灰度图就只有一个通道</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c != image.<span class="built_in">channels</span>(); c++) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> data = data_ptr[c]; <span class="comment">// data为I(x,y)第c个通道的值</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  chrono::steady_clock::time_point t2 = chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">  chrono::duration&lt;<span class="type">double</span>&gt; time_used = chrono::duration_cast &lt; chrono::duration &lt; <span class="type">double</span> &gt;&gt; (t2 - t1);</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;遍历图像用时：&quot;</span> &lt;&lt; time_used.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot; 秒。&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关于 cv::Mat 的拷贝</span></span><br><span class="line">  <span class="comment">// 直接赋值并不会拷贝数据</span></span><br><span class="line">  cv::Mat image_another = image;</span><br><span class="line">  <span class="comment">// 修改 image_another 会导致 image 发生变化</span></span><br><span class="line">  <span class="built_in">image_another</span>(cv::<span class="built_in">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>)).<span class="built_in">setTo</span>(<span class="number">0</span>); <span class="comment">// 将左上角100*100的块置零</span></span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;image&quot;</span>, image);</span><br><span class="line">  cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用clone函数来拷贝数据</span></span><br><span class="line">  cv::Mat image_clone = image.<span class="built_in">clone</span>();</span><br><span class="line">  <span class="built_in">image_clone</span>(cv::<span class="built_in">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>)).<span class="built_in">setTo</span>(<span class="number">255</span>);</span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;image&quot;</span>, image);</span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;image_clone&quot;</span>, image_clone);</span><br><span class="line">  cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对于图像还有很多基本的操作,如剪切,旋转,缩放等,限于篇幅就不一一介绍了,请参看OpenCV官方文档查询每个函数的调用方法.</span></span><br><span class="line">  cv::<span class="built_in">destroyAllWindows</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line"></span><br><span class="line">project(imageBasics)</span><br><span class="line"></span><br><span class="line">set( CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++14&quot;</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找OpenCV</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果找到OpenCV，则执行以下操作</span></span><br><span class="line">if(OpenCV_FOUND)</span><br><span class="line">  <span class="comment"># 包含OpenCV的头文件目录</span></span><br><span class="line">  include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 添加可执行文件</span></span><br><span class="line">  add_executable(imageBasics imageBasics.cpp)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 链接OpenCV库</span></span><br><span class="line">  target_link_libraries(imageBasics $&#123;OpenCV_LIBRARIES&#125;)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>把源代码中的图片复制到同一文件夹下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20250825101854724.png"></p>
<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch5/imageBasics/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch5/imageBasics/build</span><br><span class="line">hita@hita-vm:~/slambook/ch5/imageBasics/build$ make</span><br><span class="line">[100%] Built target imageBasics</span><br><span class="line">hita@hita-vm:~/slambook/ch5/imageBasics/build$ ./imageBasics ../ubuntu.png </span><br><span class="line">图像宽为1200,高为674,通道数为3</span><br><span class="line">遍历图像用时：0.00393242 秒。</span><br></pre></td></tr></table></figure>

<p>结果为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250825102058073.png" alt="image-20250825102058073"></p>
<hr>
<h3 id="图像去畸变"><a href="#图像去畸变" class="headerlink" title="图像去畸变"></a>图像去畸变</h3><p>新建文件 <code>slambook/ch5/imageBasics/undistrotImage.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">string image_file = <span class="string">&quot;../distorted.png&quot;</span>;   <span class="comment">// 请确保路径正确</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 本程序实现去畸变部分的代码。尽管我们可以调用OpenCV的去畸变，但自己实现一遍有助于理解。</span></span><br><span class="line">  <span class="comment">// 畸变参数</span></span><br><span class="line">  <span class="type">double</span> k1 = <span class="number">-0.28340811</span>, k2 = <span class="number">0.07395907</span>, p1 = <span class="number">0.00019359</span>, p2 = <span class="number">1.76187114e-05</span>;</span><br><span class="line">  <span class="comment">// 内参</span></span><br><span class="line">  <span class="type">double</span> fx = <span class="number">458.654</span>, fy = <span class="number">457.296</span>, cx = <span class="number">367.215</span>, cy = <span class="number">248.375</span>;</span><br><span class="line"></span><br><span class="line">  cv::Mat image = cv::<span class="built_in">imread</span>(image_file, <span class="number">0</span>);   <span class="comment">// 图像是灰度图，CV_8UC1</span></span><br><span class="line">  <span class="type">int</span> rows = image.rows, cols = image.cols;</span><br><span class="line">  cv::Mat image_undistort = cv::<span class="built_in">Mat</span>(rows, cols, CV_8UC1);   <span class="comment">// 去畸变以后的图</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算去畸变后图像的内容</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">0</span>; v &lt; rows; v++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> u = <span class="number">0</span>; u &lt; cols; u++) &#123;</span><br><span class="line">      <span class="comment">// 按照公式，计算点(u,v)对应到畸变图像中的坐标(u_distorted, v_distorted)</span></span><br><span class="line">      <span class="type">double</span> x = (u - cx) / fx, y = (v - cy) / fy;</span><br><span class="line">      <span class="type">double</span> r = <span class="built_in">sqrt</span>(x * x + y * y);</span><br><span class="line">      <span class="type">double</span> x_distorted = x * (<span class="number">1</span> + k1 * r * r + k2 * r * r * r * r) + <span class="number">2</span> * p1 * x * y + p2 * (r * r + <span class="number">2</span> * x * x);</span><br><span class="line">      <span class="type">double</span> y_distorted = y * (<span class="number">1</span> + k1 * r * r + k2 * r * r * r * r) + p1 * (r * r + <span class="number">2</span> * y * y) + <span class="number">2</span> * p2 * x * y;</span><br><span class="line">      <span class="type">double</span> u_distorted = fx * x_distorted + cx;</span><br><span class="line">      <span class="type">double</span> v_distorted = fy * y_distorted + cy;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 赋值 (最近邻插值)</span></span><br><span class="line">      <span class="keyword">if</span> (u_distorted &gt;= <span class="number">0</span> &amp;&amp; v_distorted &gt;= <span class="number">0</span> &amp;&amp; u_distorted &lt; cols &amp;&amp; v_distorted &lt; rows) &#123;</span><br><span class="line">        image_undistort.<span class="built_in">at</span>&lt;uchar&gt;(v, u) = image.<span class="built_in">at</span>&lt;uchar&gt;((<span class="type">int</span>) v_distorted, (<span class="type">int</span>) u_distorted);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        image_undistort.<span class="built_in">at</span>&lt;uchar&gt;(v, u) = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 画图去畸变后图像</span></span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;distorted&quot;</span>, image);</span><br><span class="line">  cv::<span class="built_in">imshow</span>(<span class="string">&quot;undistorted&quot;</span>, image_undistort);</span><br><span class="line">  cv::<span class="built_in">waitKey</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line"></span><br><span class="line">project(imageBasics)</span><br><span class="line"></span><br><span class="line">set( CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++14&quot;</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找OpenCV</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果找到OpenCV，则执行以下操作</span></span><br><span class="line">if(OpenCV_FOUND)</span><br><span class="line">  <span class="comment"># 包含OpenCV的头文件目录</span></span><br><span class="line">  include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 添加可执行文件</span></span><br><span class="line">  add_executable(imageBasics imageBasics.cpp)</span><br><span class="line">  add_executable(undistortImage undistortImage.cpp)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 链接OpenCV库</span></span><br><span class="line">  target_link_libraries(imageBasics $&#123;OpenCV_LIBRARIES&#125;)</span><br><span class="line">  target_link_libraries(undistortImage $&#123;OpenCV_LIBRARIES&#125;)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>终端输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch5/imageBasics/build$ cmake ..</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch5/imageBasics/build</span><br><span class="line">hita@hita-vm:~/slambook/ch5/imageBasics/build$ make</span><br><span class="line">Scanning dependencies of target undistortImage</span><br><span class="line">[ 25%] Building CXX object CMakeFiles/undistortImage.<span class="built_in">dir</span>/undistortImage.cpp.o</span><br><span class="line">[ 50%] Linking CXX executable undistortImage</span><br><span class="line">[ 50%] Built target undistortImage</span><br><span class="line">[100%] Built target imageBasics</span><br><span class="line">hita@hita-vm:~/slambook/ch5/imageBasics/build$ ./undistortImage </span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250825104800880.png" alt="image-20250825104800880"></p>
<h2 id="实践：3D视觉"><a href="#实践：3D视觉" class="headerlink" title="实践：3D视觉"></a>实践：3D视觉</h2><h3 id="双目视觉"><a href="#双目视觉" class="headerlink" title="双目视觉"></a>双目视觉</h3><p>可以从双目视觉的左右图像出发，计算图像对应的视差图，计算各像素在相机坐标系下的坐标，生成点云。</p>
<p>新建文件夹及文件：<code>slambook/ch5/stereoVision/stereoVision.cpp</code></p>
<p>首先讲源代码中两个图像放置在该文件夹下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pangolin/pangolin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件路径</span></span><br><span class="line">string left_file = <span class="string">&quot;../left.png&quot;</span>;</span><br><span class="line">string right_file = <span class="string">&quot;../right.png&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在pangolin中画图，已写好，无需调整</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showPointCloud</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> vector&lt;Vector4d, Eigen::aligned_allocator&lt;Vector4d&gt;&gt; &amp;pointcloud)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内参</span></span><br><span class="line">    <span class="type">double</span> fx = <span class="number">718.856</span>, fy = <span class="number">718.856</span>, cx = <span class="number">607.1928</span>, cy = <span class="number">185.2157</span>;</span><br><span class="line">    <span class="comment">// 基线</span></span><br><span class="line">    <span class="type">double</span> b = <span class="number">0.573</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取图像</span></span><br><span class="line">    cv::Mat left = cv::<span class="built_in">imread</span>(left_file, <span class="number">0</span>);</span><br><span class="line">    cv::Mat right = cv::<span class="built_in">imread</span>(right_file, <span class="number">0</span>);</span><br><span class="line">    cv::Ptr&lt;cv::StereoSGBM&gt; sgbm = cv::StereoSGBM::<span class="built_in">create</span>(</span><br><span class="line">        <span class="number">0</span>, <span class="number">96</span>, <span class="number">9</span>, <span class="number">8</span> * <span class="number">9</span> * <span class="number">9</span>, <span class="number">32</span> * <span class="number">9</span> * <span class="number">9</span>, <span class="number">1</span>, <span class="number">63</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">32</span>);    <span class="comment">// 神奇的参数</span></span><br><span class="line">    cv::Mat disparity_sgbm, disparity;</span><br><span class="line">    sgbm-&gt;<span class="built_in">compute</span>(left, right, disparity_sgbm);</span><br><span class="line">    disparity_sgbm.<span class="built_in">convertTo</span>(disparity, CV_32F, <span class="number">1.0</span> / <span class="number">16.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成点云</span></span><br><span class="line">    vector&lt;Vector4d, Eigen::aligned_allocator&lt;Vector4d&gt;&gt; pointcloud;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果你的机器慢，请把后面的v++和u++改成v+=2, u+=2</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">0</span>; v &lt; left.rows; v++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> u = <span class="number">0</span>; u &lt; left.cols; u++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (disparity.<span class="built_in">at</span>&lt;<span class="type">float</span>&gt;(v, u) &lt;= <span class="number">0.0</span> || disparity.<span class="built_in">at</span>&lt;<span class="type">float</span>&gt;(v, u) &gt;= <span class="number">96.0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">Vector4d <span class="title">point</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, left.at&lt;uchar&gt;(v, u) / <span class="number">255.0</span>)</span></span>; <span class="comment">// 前三维为xyz,第四维为颜色</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据双目模型计算 point 的位置</span></span><br><span class="line">            <span class="type">double</span> x = (u - cx) / fx;</span><br><span class="line">            <span class="type">double</span> y = (v - cy) / fy;</span><br><span class="line">            <span class="type">double</span> depth = fx * b / (disparity.<span class="built_in">at</span>&lt;<span class="type">float</span>&gt;(v, u));</span><br><span class="line">            point[<span class="number">0</span>] = x * depth;</span><br><span class="line">            point[<span class="number">1</span>] = y * depth;</span><br><span class="line">            point[<span class="number">2</span>] = depth;</span><br><span class="line"></span><br><span class="line">            pointcloud.<span class="built_in">push_back</span>(point);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;disparity&quot;</span>, disparity / <span class="number">96.0</span>);</span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 画出点云</span></span><br><span class="line">    <span class="built_in">showPointCloud</span>(pointcloud);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showPointCloud</span><span class="params">(<span class="type">const</span> vector&lt;Vector4d, Eigen::aligned_allocator&lt;Vector4d&gt;&gt; &amp;pointcloud)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pointcloud.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Point cloud is empty!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pangolin::<span class="built_in">CreateWindowAndBind</span>(<span class="string">&quot;Point Cloud Viewer&quot;</span>, <span class="number">1024</span>, <span class="number">768</span>);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_BLEND);</span><br><span class="line">    <span class="built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line"></span><br><span class="line">    <span class="function">pangolin::OpenGlRenderState <span class="title">s_cam</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        pangolin::ProjectionMatrix(<span class="number">1024</span>, <span class="number">768</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">512</span>, <span class="number">389</span>, <span class="number">0.1</span>, <span class="number">1000</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">        pangolin::ModelViewLookAt(<span class="number">0</span>, <span class="number">-0.1</span>, <span class="number">-1.8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.0</span>, <span class="number">-1.0</span>, <span class="number">0.0</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line">    pangolin::View &amp;d_cam = pangolin::<span class="built_in">CreateDisplay</span>()</span><br><span class="line">        .<span class="built_in">SetBounds</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, pangolin::Attach::<span class="built_in">Pix</span>(<span class="number">175</span>), <span class="number">1.0</span>, <span class="number">-1024.0f</span> / <span class="number">768.0f</span>)</span><br><span class="line">        .<span class="built_in">SetHandler</span>(<span class="keyword">new</span> pangolin::<span class="built_in">Handler3D</span>(s_cam));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pangolin::<span class="built_in">ShouldQuit</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">        d_cam.<span class="built_in">Activate</span>(s_cam);</span><br><span class="line">        <span class="built_in">glClearColor</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glPointSize</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">glBegin</span>(GL_POINTS);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;p: pointcloud) &#123;</span><br><span class="line">            <span class="built_in">glColor3f</span>(p[<span class="number">3</span>], p[<span class="number">3</span>], p[<span class="number">3</span>]);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(p[<span class="number">0</span>], p[<span class="number">1</span>], p[<span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">glEnd</span>();</span><br><span class="line">        pangolin::<span class="built_in">FinishFrame</span>();</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">5000</span>);   <span class="comment">// sleep 5 ms</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line">project(stereoVision)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 C++ 标准</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有依赖库</span></span><br><span class="line"><span class="comment"># 这会设置相应的变量，如 *_INCLUDE_DIRS 和 *_LIBRARIES</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line">find_package(Pangolin REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加头文件搜索目录</span></span><br><span class="line"><span class="comment"># 编译器需要知道去哪里找 .hpp 文件</span></span><br><span class="line">include_directories(</span><br><span class="line">    $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;Pangolin_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加可执行文件</span></span><br><span class="line">add_executable(stereoVision stereoVision.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接库文件</span></span><br><span class="line"><span class="comment"># 链接器需要知道去哪里找库的实现文件</span></span><br><span class="line">target_link_libraries(stereoVision</span><br><span class="line">    $&#123;OpenCV_LIBRARIES&#125;</span><br><span class="line">    $&#123;Pangolin_LIBRARIES&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>在终端输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch5/steroVision/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch5/steroVision/build</span><br><span class="line">hita@hita-vm:~/slambook/ch5/steroVision/build$ make </span><br><span class="line">[100%] Built target stereoVision</span><br><span class="line">hita@hita-vm:~/slambook/ch5/steroVision/build$ ./stereoVision </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250825110158793.png" alt="image-20250825110158793"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250825110214053.png" alt="image-20250825110214053"></p>
<h3 id="RGB-D视觉"><a href="#RGB-D视觉" class="headerlink" title="RGB-D视觉"></a>RGB-D视觉</h3><p>RGB-D相机可以通过物理的方法获取像素深度信息，如果已知相机内外参，就可以计算任何一个像素在世界坐标系下的位置，从而建立一个点云地图。将相关文件放置到<code>slambook/ch5/rgbd/</code>文件夹下，有类似结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── color</span><br><span class="line">│   ├── 1.png</span><br><span class="line">│   ├── 2.png</span><br><span class="line">│   ├── 3.png</span><br><span class="line">│   ├── 4.png</span><br><span class="line">│   └── 5.png</span><br><span class="line">├── depth</span><br><span class="line">│   ├── 1.pgm</span><br><span class="line">│   ├── 2.pgm</span><br><span class="line">│   ├── 3.pgm</span><br><span class="line">│   ├── 4.pgm</span><br><span class="line">│   └── 5.pgm</span><br><span class="line">├── joinMap.cpp</span><br><span class="line">└── pose.txt</span><br></pre></td></tr></table></figure>

<p>分别对应RGB图，深度图和五张图像的相机外参位姿（以$T_{wc}$形式）。为平移向量+旋转四元数。</p>
<p>新建文件<code>slambook/ch5/rgbd/jointMap.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;fstream&gt;</span><br><span class="line">#include &lt;opencv2/opencv.hpp&gt;</span><br><span class="line">#include &lt;boost/format.hpp&gt;  // for formating strings</span><br><span class="line">#include &lt;pangolin/pangolin.h&gt;</span><br><span class="line">#include &lt;sophus/se3.hpp&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line">typedef vector&lt;Sophus::SE3d, Eigen::aligned_allocator&lt;Sophus::SE3d&gt;&gt; TrajectoryType;</span><br><span class="line">typedef Eigen::Matrix&lt;double, 6, 1&gt; Vector6d;</span><br><span class="line"></span><br><span class="line">// 在pangolin中画图，已写好，无需调整</span><br><span class="line">void showPointCloud(</span><br><span class="line">    const vector&lt;Vector6d, Eigen::aligned_allocator&lt;Vector6d&gt;&gt; &amp;pointcloud);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">    vector&lt;cv::Mat&gt; colorImgs, depthImgs;    // 彩色图和深度图</span><br><span class="line">    TrajectoryType poses;         // 相机位姿</span><br><span class="line"></span><br><span class="line">    ifstream fin(&quot;../pose.txt&quot;);</span><br><span class="line">    if (!fin) &#123;</span><br><span class="line">        cerr &lt;&lt; &quot;请在有pose.txt的目录下运行此程序&quot; &lt;&lt; endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">        boost::format fmt(&quot;../%s/%d.%s&quot;); //图像文件格式</span><br><span class="line">        colorImgs.push_back(cv::imread((fmt % &quot;color&quot; % (i + 1) % &quot;png&quot;).str()));</span><br><span class="line">        depthImgs.push_back(cv::imread((fmt % &quot;depth&quot; % (i + 1) % &quot;pgm&quot;).str(), -1)); // 使用-1读取原始图像</span><br><span class="line"></span><br><span class="line">        double data[7] = &#123;0&#125;;</span><br><span class="line">        for (auto &amp;d:data)</span><br><span class="line">            fin &gt;&gt; d;</span><br><span class="line">        Sophus::SE3d pose(Eigen::Quaterniond(data[6], data[3], data[4], data[5]),</span><br><span class="line">                          Eigen::Vector3d(data[0], data[1], data[2]));</span><br><span class="line">        poses.push_back(pose);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 计算点云并拼接</span><br><span class="line">    // 相机内参 </span><br><span class="line">    double cx = 325.5;</span><br><span class="line">    double cy = 253.5;</span><br><span class="line">    double fx = 518.0;</span><br><span class="line">    double fy = 519.0;</span><br><span class="line">    double depthScale = 1000.0;</span><br><span class="line">    vector&lt;Vector6d, Eigen::aligned_allocator&lt;Vector6d&gt;&gt; pointcloud;</span><br><span class="line">    pointcloud.reserve(1000000);</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">        cout &lt;&lt; &quot;转换图像中: &quot; &lt;&lt; i + 1 &lt;&lt; endl;</span><br><span class="line">        cv::Mat color = colorImgs[i];</span><br><span class="line">        cv::Mat depth = depthImgs[i];</span><br><span class="line">        Sophus::SE3d T = poses[i];</span><br><span class="line">        for (int v = 0; v &lt; color.rows; v++)</span><br><span class="line">            for (int u = 0; u &lt; color.cols; u++) &#123;</span><br><span class="line">                unsigned int d = depth.ptr&lt;unsigned short&gt;(v)[u]; // 深度值</span><br><span class="line">                if (d == 0) continue; // 为0表示没有测量到</span><br><span class="line">                Eigen::Vector3d point;</span><br><span class="line">                point[2] = double(d) / depthScale;</span><br><span class="line">                point[0] = (u - cx) * point[2] / fx;</span><br><span class="line">                point[1] = (v - cy) * point[2] / fy;</span><br><span class="line">                Eigen::Vector3d pointWorld = T * point;</span><br><span class="line"></span><br><span class="line">                Vector6d p;</span><br><span class="line">                p.head&lt;3&gt;() = pointWorld;</span><br><span class="line">                p[5] = color.data[v * color.step + u * color.channels()];   // blue</span><br><span class="line">                p[4] = color.data[v * color.step + u * color.channels() + 1]; // green</span><br><span class="line">                p[3] = color.data[v * color.step + u * color.channels() + 2]; // red</span><br><span class="line">                pointcloud.push_back(p);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &quot;点云共有&quot; &lt;&lt; pointcloud.size() &lt;&lt; &quot;个点.&quot; &lt;&lt; endl;</span><br><span class="line">    showPointCloud(pointcloud);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void showPointCloud(const vector&lt;Vector6d, Eigen::aligned_allocator&lt;Vector6d&gt;&gt; &amp;pointcloud) &#123;</span><br><span class="line"></span><br><span class="line">    if (pointcloud.empty()) &#123;</span><br><span class="line">        cerr &lt;&lt; &quot;Point cloud is empty!&quot; &lt;&lt; endl;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pangolin::CreateWindowAndBind(&quot;Point Cloud Viewer&quot;, 1024, 768);</span><br><span class="line">    glEnable(GL_DEPTH_TEST);</span><br><span class="line">    glEnable(GL_BLEND);</span><br><span class="line">    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line"></span><br><span class="line">    pangolin::OpenGlRenderState s_cam(</span><br><span class="line">        pangolin::ProjectionMatrix(1024, 768, 500, 500, 512, 389, 0.1, 1000),</span><br><span class="line">        pangolin::ModelViewLookAt(0, -0.1, -1.8, 0, 0, 0, 0.0, -1.0, 0.0)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pangolin::View &amp;d_cam = pangolin::CreateDisplay()</span><br><span class="line">        .SetBounds(0.0, 1.0, pangolin::Attach::Pix(175), 1.0, -1024.0f / 768.0f)</span><br><span class="line">        .SetHandler(new pangolin::Handler3D(s_cam));</span><br><span class="line"></span><br><span class="line">    while (pangolin::ShouldQuit() == false) &#123;</span><br><span class="line">        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">        d_cam.Activate(s_cam);</span><br><span class="line">        glClearColor(1.0f, 1.0f, 1.0f, 1.0f);</span><br><span class="line"></span><br><span class="line">        glPointSize(2);</span><br><span class="line">        glBegin(GL_POINTS);</span><br><span class="line">        for (auto &amp;p: pointcloud) &#123;</span><br><span class="line">            glColor3d(p[3] / 255.0, p[4] / 255.0, p[5] / 255.0);</span><br><span class="line">            glVertex3d(p[0], p[1], p[2]);</span><br><span class="line">        &#125;</span><br><span class="line">        glEnd();</span><br><span class="line">        pangolin::FinishFrame();</span><br><span class="line">        usleep(5000);   // sleep 5 ms</span><br><span class="line">    &#125;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line">project(joinMap)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 C++ 标准</span></span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有依赖库</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">find_package(Eigen3 REQUIRED)</span><br><span class="line">find_package(Pangolin REQUIRED)</span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加头文件搜索目录</span></span><br><span class="line">include_directories(</span><br><span class="line">    $&#123;OpenCV_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">    $&#123;Pangolin_INCLUDE_DIRS&#125;</span><br><span class="line">    $&#123;Sophus_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加可执行文件</span></span><br><span class="line">add_executable(joinMap joinMap.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接库文件</span></span><br><span class="line">target_link_libraries(joinMap</span><br><span class="line">    $&#123;OpenCV_LIBRARIES&#125;</span><br><span class="line">    $&#123;Pangolin_LIBRARIES&#125;</span><br><span class="line">    $&#123;Sophus_LIBRARIES&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>终端输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch5/rgbd/build$ cmake ..</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch5/rgbd/build</span><br><span class="line">hita@hita-vm:~/slambook/ch5/rgbd/build$ make</span><br><span class="line">[100%] Built target joinMap</span><br><span class="line">hita@hita-vm:~/slambook/ch5/rgbd/build$ ./joinMap </span><br><span class="line">转换图像中: 1</span><br><span class="line">转换图像中: 2</span><br><span class="line">转换图像中: 3</span><br><span class="line">转换图像中: 4</span><br><span class="line">转换图像中: 5</span><br><span class="line">点云共有1081843个点.</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250825112657741.png" alt="image-20250825112657741"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/08/20/2025-08-20-%E7%AC%AC%E5%9B%9B%E8%AE%B2-%E6%9D%8E%E7%BE%A4%E6%9D%8E%E4%BB%A3%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/20/2025-08-20-%E7%AC%AC%E5%9B%9B%E8%AE%B2-%E6%9D%8E%E7%BE%A4%E6%9D%8E%E4%BB%A3%E6%95%B0/" class="post-title-link" itemprop="url">第四讲-李群李代数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-08-20 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-20T00:00:00+08:00">2025-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-22 16:01:51" itemprop="dateModified" datetime="2025-08-22T16:01:51+08:00">2025-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第四讲）——李群李代数"><a href="#视觉SLAM十四讲（第四讲）——李群李代数" class="headerlink" title="视觉SLAM十四讲（第四讲）——李群李代数"></a>视觉SLAM十四讲（第四讲）——李群李代数</h1><h2 id="李群与李代数基础"><a href="#李群与李代数基础" class="headerlink" title="李群与李代数基础"></a>李群与李代数基础</h2><p>三维旋转矩阵构成了特殊的正交群 $SO(3)$,而变换矩阵构成了特殊欧式群$SE(3)$.有如下格式：<br>$$<br>\begin{align*}<br>\mathrm{SO}(3) &amp;&#x3D; { R \in \mathbb{R}^{3 \times 3} \mid RR^T &#x3D; I, \det(R) &#x3D; 1 }, \<br>\mathrm{SE}(3) &amp;&#x3D; \left{ T &#x3D;<br>\begin{bmatrix}<br>R &amp; t \<br>0^T &amp; 1<br>\end{bmatrix} \in \mathbb{R}^{4 \times 4} \mid R \in \mathrm{SO}(3), t \in \mathbb{R}^3 \right}.<br>\end{align*}<br>$$<br>这些旋转矩阵或者变换矩阵对于加法是不封闭的，即任意两个旋转矩阵按照矩阵加法的定义，和不再是一个旋转矩阵。但是他们的乘法是封闭的。对于这种只有一个（良好的）运算的集合，称之为群。</p>
<h3 id="群"><a href="#群" class="headerlink" title="群"></a>群</h3><p>群（Group）是一种集合加上一种运算的的代数结构。把集合记作A，运算记为. 群可以记作$G &#x3D; (A,.)$.群要求满足条件：</p>
<blockquote>
<p>封结幺逆（丰俭由你）</p>
</blockquote>
<ol>
<li>封：两个元素都属于群，乘积也属于群</li>
<li>结：结合律</li>
<li>幺元：群中至少有一个元素，别的元素与其相乘都是自身</li>
<li>逆：对于群中所有的元素，群中至少有一个元素，与其他元素相乘都得到一个固定元素</li>
</ol>
<hr>
<h3 id="李代数的引出"><a href="#李代数的引出" class="headerlink" title="李代数的引出"></a>李代数的引出</h3><blockquote>
<p>反对成矩阵</p>
</blockquote>
<p>$$<br>A^T &#x3D; -A<br>\<br>a_ji &#x3D; -aij<br>\<br>$$</p>
<p>对角线元素为零，对称位置元素互为相反数。</p>
<p>在三维欧几里得空间中，两个向量的叉积运算可以完全等价为一个反对称矩阵和一个向量的乘法来表示。</p>
<img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250820204806939.png" alt="image-20250820204806939" style="zoom:67%;" />

<p>在书中用^表示将一个向量构造成一个反对称矩阵。叉积等价于矩阵乘法。</p>
<p>若$R$是任意旋转矩阵，代表某个相机的旋转，它会随时间连续变化，是时间的函数：$R(t)$</p>
<p>由：$$R(t)R(t)^{T} &#x3D; I$$，对等式两边求导：</p>
<p>$$<br>\dot{R}(t)R(t)^{T} + R(t)\dot{R}(t)^{T} &#x3D; 0<br>\<br>\dot{R}(t)R(t)^{T} &#x3D; -(\dot{R}(t)R(t)^{T})^{T}<br>$$<br>所以，矩阵：$\dot{R}(t)R(t)^{T}$是一个反对称矩阵。根据上面叉积的知识，我们可以找到一个三维向量$\phi(t) \in \mathbb{R}^{3}$​与之对应:<br>$$<br>\dot{\mathbf{R}}(t)\mathbf{R}(t)^{T} &#x3D; \phi(t)^{\wedge}<br>$$<br>等式两边右乘$\mathbf{R}(t)$,由于是正交阵，所以有：<br>$$<br>\dot{\mathbf{R}}(t) &#x3D; \phi(t)^{\wedge}\mathbf{R}(t) &#x3D; \begin{bmatrix} 0 &amp; -\phi_{3} &amp; \phi_{2} \ \phi_{3} &amp; 0 &amp; -\phi_{1} \ -\phi_{2} &amp; \phi_{1} &amp; 0 \end{bmatrix} \mathbf{R}(t)<br>$$<br>可以看到，每次对旋转矩阵求一次导数，只需要左乘一个$\phi(t)^{\wedge}$​即可。</p>
<p>可以把上式子看成一个微分方程，解得：<br>$$<br>\mathbf{R}(t) &#x3D; \exp(\hat{\phi}_{0}t)<br>$$<br>说明：</p>
<ol>
<li>给定某时刻的R，我们就能求出一个$\phi$,它描述了R在局部的导数关系。与R对应的$\phi$ 有什么含义.其实  $\phi$ 正是对应到  $SO(3)$ 上的李代数 $\mathfrak{so}(3)$.</li>
<li>其次，给定某个向量$\phi$时，矩阵指数$\exp(\phi^{\wedge})$如何计算？反之，给定R，能否有相反的运算来计算$\phi$，事实上，这正是李群与李代数之间的指数对数映射。</li>
</ol>
<hr>
<h3 id="李代数定义"><a href="#李代数定义" class="headerlink" title="李代数定义"></a>李代数定义</h3><blockquote>
<p>李代数定义</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250821111930875.png" alt="image-20250821111930875"></p>
<ol>
<li>每个李群都有与之对应的李代数。如上式中**$\phi(t)$就是李代数，$R(t)$就是李群**，李代数描述了李群的局部性质。例如$\mathfrak{so}(3)$就反映了$SO(3)$​的局部导数性质。</li>
<li>两个向量还有李括号运算，表达了两个元素的差异。例如叉积就是一种李括号。</li>
</ol>
<hr>
<h3 id="李代数-mathfrak-so-3"><a href="#李代数-mathfrak-so-3" class="headerlink" title="李代数$\mathfrak{so}(3)$"></a>李代数$\mathfrak{so}(3)$</h3><p>之前提到的$\phi$就是一种李代数。每个$\phi$都可以生成一个反对称矩阵：<br>$$<br>\mathbf{\Phi} &#x3D; \phi^{\wedge} &#x3D; \begin{bmatrix} 0 &amp; -\phi_{3} &amp; \phi_{2} \ \phi_{3} &amp; 0 &amp; -\phi_{1} \ -\phi_{2} &amp; \phi_{1} &amp; 0 \end{bmatrix} \in \mathbb{R}^{3\times3}<br>$$<br>在此定义下，两个向量$\phi_1,\phi_2$的李括号是：<br>$$<br>[\phi_{1}, \phi_{2}] &#x3D; (\mathbf{\Phi}<em>{1}\mathbf{\Phi}</em>{2} - \mathbf{\Phi}<em>{2}\mathbf{\Phi}</em>{1})^{\vee}<br>$$<br>该向量与反对成矩阵是一一对应的，不存在歧义的情况。即$\mathfrak{so}(3)$的元素是三维向量或者三维反对成矩阵，不加区别：<br>$$<br>\mathbf{so}(3) &#x3D; { \phi \in \mathbb{R}^{3}, \mathbf{\Phi} &#x3D; \phi^{\wedge} \in \mathbb{R}^{3\times3} }<br>$$<br>可以看到$\mathfrak{so}(3)$的内容：它们是一个由三维向量组成的集合，每个向量对应一个反对称矩阵，可以用于表达旋转矩阵的倒数，它与R的关系由指数映射给定：<br>$$<br>\mathbf{R}(t) &#x3D; \exp(\phi^{\wedge})<br>$$</p>
<hr>
<h3 id="李代数-mathfrak-se-3"><a href="#李代数-mathfrak-se-3" class="headerlink" title="李代数$\mathfrak{se}(3)$"></a>李代数$\mathfrak{se}(3)$</h3><p>对于$SE(3)$,也有对应李代数$\mathfrak{se}(3)$。位于$\mathbb{R}^6$空间中：<br>$$<br>\mathbf{se}(3) &#x3D; \left{ \boldsymbol{\xi} &#x3D; \begin{bmatrix} \rho \ \phi \end{bmatrix} \in \mathbb{R}^{6}, \rho \in \mathbb{R}^{3}, \phi \in \mathbf{so}(3), \boldsymbol{\xi}^{\wedge} &#x3D; \begin{bmatrix} \phi^{\wedge} &amp; \rho \ \mathbf{0}^{T} &amp; 0 \end{bmatrix} \in \mathbb{R}^{4\times4} \right}<br>$$<br>将每个$\mathfrak{se}(3)$元素记为$ \xi $,这是一个六维向量。前三维表示平移，后三维旋转。同时拓展了^的含义。<strong>使用$\wedge,\vee$​，指代“从向量到矩阵”和”从矩阵到向量“的关系</strong>。</p>
<p>李括号：<br>$$<br>[\boldsymbol{\xi}<em>{1}, \boldsymbol{\xi}</em>{2}] &#x3D; (\hat{\boldsymbol{\xi}}<em>{1}\hat{\boldsymbol{\xi}}</em>{2} - \hat{\boldsymbol{\xi}}<em>{2}\hat{\boldsymbol{\xi}}</em>{1})^{\vee}<br>$$</p>
<hr>
<h2 id="指数与对数映射"><a href="#指数与对数映射" class="headerlink" title="指数与对数映射"></a>指数与对数映射</h2><h3 id="SO-3-上的指数映射"><a href="#SO-3-上的指数映射" class="headerlink" title="$SO(3)$上的指数映射"></a>$SO(3)$上的指数映射</h3><p>指数映射，即$ \exp(\phi^{\wedge})$​的泰勒展开:<br>$$<br>\exp(\phi^{\wedge}) &#x3D; \sum_{n&#x3D;0}^{\infty} \frac{1}{n!} (\phi^{\wedge})^{n}<br>$$<br>简化计算方法，$\phi$是三维向量，可以定义它的模长和方向，分别记为：$\theta,a$于是就有$\phi &#x3D; \theta a$，这里$a$是一个长度为1的方向向量，对于$a^\wedge$,有以下两条性质：<br>$$<br>\mathbf{a}^{\wedge}\mathbf{a}^{\wedge} &#x3D; \begin{bmatrix} -a_{2}^{2} - a_{3}^{2} &amp; a_{1}a_{2} &amp; a_{1}a_{3} \ a_{1}a_{2} &amp; -a_{1}^{2} - a_{3}^{2} &amp; a_{2}a_{3} \ a_{1}a_{3} &amp; a_{2}a_{3} &amp; -a_{1}^{2} - a_{2}^{2} \end{bmatrix} &#x3D; \mathbf{a}\mathbf{a}^{T} - I<br>\<br>\<br>\mathbf{a}^{\wedge}\mathbf{a}^{\wedge}\mathbf{a}^{\wedge} &#x3D; \mathbf{a}^{\wedge}(\mathbf{a}\mathbf{a}^{T} - I) &#x3D; -\mathbf{a}^{\wedge}<br>$$<br>由此提供了$a^ \wedge$的高阶项方法。可以写成：<br>$$<br>\exp(\theta\mathbf{a}^{\wedge}) &#x3D; \cos\theta I + (1 - \cos\theta)\mathbf{a}\mathbf{a}^{T} + \sin\theta\mathbf{a}^{\wedge}<br>$$<br>（具体参考14讲公式4-22）这个和罗德里格斯公式是一样的，说明：$\mathfrak{se}(3)$实际上是由所谓的旋转向量组成的空间。指数映射就是罗德里格斯公式。通过这个就可以把$\mathfrak{se}(3)$中任意一个向量对应到一个位于$SO(3)$中的旋转矩阵。反之定义对数映射，也可以把$SO(3)$中的元素对应到$\mathfrak{se}(3)$中：<br>$$<br>\phi &#x3D; \ln(\mathbf{R})^{\vee} &#x3D; \left( \sum_{n&#x3D;0}^{\infty} \frac{(-1)^{n}}{n+1} (\mathbf{R}-I)^{n+1} \right)^{\vee}<br>$$<br>至于怎么根据对应的旋转矩阵求解李代数，可以利用迹的性质以及特征向量来求旋转角度与旋转轴。具体如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250821161823738.png" alt="image-20250821161823738"></p>
<p>这样就求得了旋转角度，关于转轴，由于$Rn &#x3D; n$说明转轴$n$是矩阵$R$特征值为1对应的特征向量。求解方程，归一化之后即可得到旋转轴。</p>
<p>值得注意的是，指数映射是一个满射并不是单射，意味着在一个李群可以找到一个李代数，但是可能存在多个李代数映射同一个李群。旋转角具有周期性，如果把旋转角固定到±$\pi$​之间那么李群与李代数之间的就是一一对应了。</p>
<h3 id="SE-3-上的指数映射"><a href="#SE-3-上的指数映射" class="headerlink" title="$SE(3)$上的指数映射"></a>$SE(3)$上的指数映射</h3><p>$\mathfrak{se}(3)$上的指数映射形式是：<br>$$<br>\exp(\boldsymbol{\xi}^{\wedge}) &#x3D; \begin{bmatrix} \displaystyle\sum_{n&#x3D;0}^{\infty} \frac{1}{n!} (\phi^{\wedge})^{n} &amp; \displaystyle\sum_{n&#x3D;0}^{\infty} \frac{1}{(n+1)!} (\phi^{\wedge})^{n} \rho \ \mathbf{0}^{T} &amp; 1 \end{bmatrix}<br>\<br>\<br>\triangleq \begin{bmatrix} \mathbf{R} &amp; J\rho \ \mathbf{0}^{T} &amp; 1 \end{bmatrix} &#x3D; \mathbf{T}<br>$$<br>指数映射中：右上角$J$可得出：<br>$$<br>\mathbf{J} &#x3D; \frac{\sin\theta}{\theta} I + \left(1 - \frac{\sin\theta}{\theta}\right) \mathbf{a}\mathbf{a}^{T} + \frac{1 - \cos\theta}{\theta} \mathbf{a}^{\wedge}<br>$$<br>与罗德里格斯公式类似，左上为旋转矩阵，右上为平移部分，是以$J$为稀矩阵的线性变换。具体的转换关系可以由下图展示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/20201128193021844.png" alt="李群和李代数以及线性变换相关笔记_李代数的几何意义-CSDN博客"></p>
<h2 id="李代数求导与扰动模型"><a href="#李代数求导与扰动模型" class="headerlink" title="李代数求导与扰动模型"></a>李代数求导与扰动模型</h2><h3 id="BHC公式与近似形式"><a href="#BHC公式与近似形式" class="headerlink" title="BHC公式与近似形式"></a>BHC公式与近似形式</h3><p>使用李代数可以进行优化，在优化中导数是非常有必要的信息，会在非线性优化中使用。</p>
<p>矩阵做乘法时，李代数发生什么变化？并不是简单的加法。即<br>$$<br>\exp(\hat{\phi}<em>{1}^{\wedge}) \exp(\hat{\phi}</em>{2}^{\wedge}) &#x3D; \exp\left( (\phi_{1} + \phi_{2})^{\wedge} \right)<br>$$<br>或者等价于：<br>$$<br>\ln(\exp(\mathbf{A})\exp(\mathbf{B})) &#x3D; \mathbf{A} + \mathbf{B}<br>$$<br>该式在矩阵时<strong>不成立</strong>。两个李代数指数映射乘积的完整形式，由BCH公式给出：<br>$$<br>\ln(\exp(A)\exp(B)) &#x3D; A + B + \frac{1}{2}[A, B] + \frac{1}{12}[A, [A, B]] - \frac{1}{12}[B, [A, B]] + \dots<br>$$<br>其中$[]$​是李括号。这表明，当处理两个矩阵之积时，会产生一些由李括号组成的余项。当$\phi_1 \phi_2$为小量时，小量二次以上的项都可以忽略不计。此时近似为：<br>$$<br>\ln(\exp(\phi_{1}^{\wedge})\exp(\phi_{2}^{\wedge}))^{\vee} \approx \begin{cases} J_{l}(\phi_{2})^{-1}\phi_{1} + \phi_{2} &amp; \text{当}\phi_1\text{为小量,} \ J_{r}(\phi_{1})^{-1}\phi_{2} + \phi_{1} &amp; \text{当}\phi_2\text{为小量.} \end{cases}<br>$$<br>下标$l$就是左乘，下标$r$就是右乘，其中$J$就是之前转换的那个$J$。</p>
<p>如第一个近似：当对一个旋转矩阵$R_2$（李代数为$\phi_2$）左乘一个微小旋转矩阵$R_1$（李代数为$\phi_1$）时，可以近似看作在原有的李代数上加一项$J_1(\phi_2)^-1\phi_1$​.</p>
<p><strong>记忆方法</strong>：</p>
<ol>
<li>小量在哪边，雅可比的下标方向就在哪边</li>
<li>大量进雅可比自变量</li>
<li>最后结果时雅可比乘小量，再加上大量</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250821210325423.png" alt="image-20250821210325423"></p>
<p>这样就可以谈论李群乘法与李代数加法的关系了。其实就是研究两者之间是怎么变换的近似关系的。</p>
<hr>
<h3 id="SO-3-上的李代数求导"><a href="#SO-3-上的李代数求导" class="headerlink" title="$SO(3)$上的李代数求导"></a>$SO(3)$上的李代数求导</h3><p>在SLAM中，要估计一个相机的位置和姿态，该位姿是由$SO(3)$山的旋转矩阵或者$SE(3)$上的变换矩阵描述的。设某个时刻机器人的位姿$T$。观察到世界坐标位于$p$的点,产生了一个观测数据$z$。那么，由坐标变换关系可知：<br>$$<br>\mathbf{z} &#x3D; \mathbf{T}\mathbf{p} + \mathbf{\omega}<br>$$<br>其中$\omega$是随机噪声。所以通常会计算理想的观测与实际数据的误差：<br>$$<br>e &#x3D; \mathbf{z} - \mathbf{T}\mathbf{p}<br>$$<br>假设一共有N个这样的路标点和观测点，于是有N个上式。对于机器人进行位姿估计，相当于寻找一个最优的T，使得整体误差最小化：<br>$$<br>\min_{T} J(T) &#x3D; \sum_{i&#x3D;1}^{N} |\mathbf{z}<em>{i} - T\mathbf{p}</em>{i}|_{2}^{2}<br>$$<br>求解此问题，就需要计算目标函数$J$关于变换矩阵$T$的导数。重要的是，<strong>我们经常构建与位姿有关的函数，然后讨论该函数关于位子的导数，来调整当前的估计值</strong>。我们把$T$当作普通矩阵<strong>处理优化</strong>，就必须要加以约束，李代数有向量组成，具有良好的加法运算，所以使用李代数解决求导问题可以放分为两个思路：</p>
<ol>
<li>用李代数表示姿态，根据李代数加法对李代数求导</li>
<li>对李群左乘或者右乘微小扰动，然后对扰动求导，称为左扰动和右扰动模型。</li>
</ol>
<p>第一种是李代数求导模型，第二种是扰动模型。</p>
<hr>
<h3 id="李代数求导"><a href="#李代数求导" class="headerlink" title="李代数求导"></a>李代数求导</h3><p>考虑$SO(3)$上的情况，假设对于一个空间点$p$进行旋转，得到$Rp$。仙子啊，要计算旋转之后点的坐标相对于旋转的导数，可以暂且记为：<br>$$<br>\frac{\partial(R\mathbf{p})}{\partial R}<br>$$<br>由于$SO(3)$没有加法，所以导数无法正常计算，使用对应的李代数$\phi$计算：<br>$$<br>\frac{\partial(exp(\phi^{\wedge}p))}{\partial \phi}<br>$$<br>推导出旋转以后的点相对于李代数的导数：<br>$$<br>\frac{\partial(\mathbf{R}\mathbf{p})}{\partial\phi} &#x3D; (-\mathbf{R}\mathbf{p})^{\wedge}\mathbf{J}_{l}<br>$$</p>
<h3 id="扰动模型（左乘）"><a href="#扰动模型（左乘）" class="headerlink" title="扰动模型（左乘）"></a>扰动模型（左乘）</h3><p>上述提到的另外一个求导方式是对于R进行一次扰动$\Delta R$，看结果相对于扰动的变化率。可以是左乘也可以是右乘，有些许差异。设左扰动$\Delta R$​对应的李代数是$\varphi$,对其求导：<br>$$<br>\frac{\partial(\mathbf{R}\mathbf{p})}{\partial\boldsymbol{\varphi}} &#x3D; \lim_{\varphi \to 0} \frac{\exp(\varphi^{\wedge})\exp(\mathbf{\phi}^{\wedge})\mathbf{p} - \exp(\mathbf{\phi}^{\wedge})\mathbf{p}}{\varphi}<br>&#x3D; -(Rp)^{\wedge}<br>$$<br>可见，相较于李代数求导，省去一个雅可比的计算，使得扰动模型更为实用。</p>
<hr>
<h3 id="SE-3-上的李代数求导"><a href="#SE-3-上的李代数求导" class="headerlink" title="$SE(3)$上的李代数求导"></a>$SE(3)$上的李代数求导</h3><p>假设，某空间点$p$经过一次变换$T$(对应李代数是$\xi$),得到$Tp$，现在给$T$左乘一个扰动$\Delta T &#x3D; \mathbf{exp}(\delta \xi^\wedge)$,扰动项的李代数是：$\delta \xi &#x3D; [\delta \rho,\delta \phi]^T$。</p>
<p>直接给出扰动模型：<br>$$<br>\frac{\partial(\mathbf{T}\mathbf{p})}{\partial\delta\boldsymbol{\xi}} &#x3D; \lim_{\delta\boldsymbol{\xi} \to 0} \frac{\exp((\delta\boldsymbol{\xi})^{\wedge})\exp(\boldsymbol{\xi}^{\wedge})\mathbf{p} - \exp(\boldsymbol{\xi}^{\wedge})\mathbf{p}}{\delta\boldsymbol{\xi}}<br>\ &#x3D; \begin{bmatrix} \mathbf{I} &amp; -(\mathbf{R}\mathbf{p} + \mathbf{t})^{\wedge} \ \mathbf{0}^{T} &amp; \mathbf{0}^{T} \end{bmatrix} \stackrel{\mathrm{def}}{&#x3D;} (\mathbf{T}\mathbf{p})^{\odot}<br>$$<br>最后一个是运算符，它把一个齐次坐标的空间点变换成一个4x6的矩阵。假设$a,b,x,y$都是列向量，那么在运算符写法下，有：<br>$$<br>\frac{d \begin{bmatrix} a \ b \end{bmatrix}}{d \begin{bmatrix} x \ y \end{bmatrix}} &#x3D; \left( \frac{d[a, b]^{T}}{d \begin{bmatrix} x \ y \end{bmatrix}} \right)^{T} &#x3D; \begin{bmatrix} \frac{da}{dx} &amp; \frac{db}{dx} \ \frac{da}{dy} &amp; \frac{db}{dy} \end{bmatrix}^{T} &#x3D; \begin{bmatrix} \frac{da}{dx} &amp; \frac{da}{dy} \ \frac{db}{dx} &amp; \frac{db}{dy} \end{bmatrix}<br>$$</p>
<h2 id="实践：Sophus"><a href="#实践：Sophus" class="headerlink" title="实践：Sophus"></a>实践：Sophus</h2><h3 id="Sophus的基本使用"><a href="#Sophus的基本使用" class="headerlink" title="Sophus的基本使用"></a>Sophus的基本使用</h3><p>Sophus库支持$SO(3)$和$SE(3)$，是直接在Eigen上开发的，这个库只需要编译，不需要安装。</p>
<blockquote>
<p>使用Sophus</p>
</blockquote>
<ol>
<li>安装fmt</li>
</ol>
<p>首先安装fmt,由于使用的代码使用的是模板库，所以需要安装。</p>
<p>打开终端，可以在文件夹 <code>3rdparty</code>打开终端，这次忘了，懒得改了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/fmtlib/fmt.git</span><br><span class="line">cd fmt</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装Sophus库</li>
</ol>
<p>同样在终端打开：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/strasdat/Sophus.git</span><br><span class="line">cd Sophus</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>如果出现报错，可能需要修改一下CMakeLists.txt文件。</p>
<p>安装成功之后，可以测试一下。</p>
<p>新建文件：<code>slambook/ch4/useSophus.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;sophus/se3.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  Matrix3d R = <span class="built_in">AngleAxisd</span>(M_PI / <span class="number">2</span>, <span class="built_in">Vector3d</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)).<span class="built_in">toRotationMatrix</span>();</span><br><span class="line">  <span class="function">Quaterniond <span class="title">q</span><span class="params">(R)</span></span>;</span><br><span class="line">  <span class="function">Sophus::SO3d <span class="title">SO3_R</span><span class="params">(R)</span></span>;</span><br><span class="line">  <span class="function">Sophus::SO3d <span class="title">SO3_q</span><span class="params">(q)</span></span>;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;SO(3) from matrix:\n&quot;</span> &lt;&lt; SO3_R.<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;SO(3) from quaternion:\n&quot;</span> &lt;&lt; SO3_q.<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;they are equal&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  Vector3d so3 = SO3_R.<span class="built_in">log</span>();</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;so3 = &quot;</span> &lt;&lt; so<span class="number">3.</span><span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;so3 hat=\n&quot;</span> &lt;&lt; Sophus::SO3d::<span class="built_in">hat</span>(so3) &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;so3 hat vee= &quot;</span> &lt;&lt; Sophus::SO3d::<span class="built_in">vee</span>(Sophus::SO3d::<span class="built_in">hat</span>(so3)).<span class="built_in">transpose</span>() &lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">  <span class="function">Vector3d <span class="title">update_so3</span><span class="params">(<span class="number">1e-4</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">  Sophus::SO3d SO3_updated = Sophus::SO3d::<span class="built_in">exp</span>(update_so3) * SO3_R;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;SO3 updated = \n&quot;</span> &lt;&lt; SO3_updated.<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写CmakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line">project(useSophus)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为使用 sophus，需要使用find_package命令找到它</span></span><br><span class="line">find_package(Sophus REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Eigen</span></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line">add_executable(useSophus useSophus.cpp)</span><br><span class="line">target_link_libraries(useSophus Sophus::Sophus)</span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch4/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch4/build</span><br><span class="line">hita@hita-vm:~/slambook/ch4/build$ make </span><br><span class="line">[100%] Built target useSophus</span><br><span class="line">hita@hita-vm:~/slambook/ch4/build$ ./useSophus </span><br><span class="line">SO(3) from matrix:</span><br><span class="line">2.22045e-16          -1           0</span><br><span class="line">          1 2.22045e-16           0</span><br><span class="line">          0           0           1</span><br><span class="line">SO(3) from quaternion:</span><br><span class="line">2.22045e-16          -1           0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="例子：评估轨迹的误差"><a href="#例子：评估轨迹的误差" class="headerlink" title="例子：评估轨迹的误差"></a>例子：评估轨迹的误差</h3><p>在实际工程中，需要评估一个算法的估计轨迹与真实轨迹的差异来评价算法的精度。现在来计算两条轨迹的误差。有很多种误差评估指标，<strong>如绝对轨迹误差</strong>，每个位姿李代数的<strong>均方根误差</strong>，还有<strong>绝对平移误差</strong>等。利用Sophus库，可以实现计算。分别有<code>groundtruth.txt</code>和<code>estimated.txt</code>两条轨迹,计算误差，显示到3D窗口。</p>
<p>新建文件：<code>slambook/ch4/examples/trajectoryError.cpp</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;fstream&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;pangolin/pangolin.h&gt;</span><br><span class="line">#include &lt;sophus/se3.hpp&gt;</span><br><span class="line"></span><br><span class="line">using namespace Sophus;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">string groundtruth_file = &quot;../../examples/groundtruth.txt&quot;;</span><br><span class="line">string estimated_file = &quot;../../examples/estimated.txt&quot;;</span><br><span class="line"></span><br><span class="line">typedef vector&lt;Sophus::SE3d, Eigen::aligned_allocator&lt;Sophus::SE3d&gt;&gt; TrajectoryType;</span><br><span class="line"></span><br><span class="line">void DrawTrajectory(const TrajectoryType &amp;gt, const TrajectoryType &amp;esti);</span><br><span class="line"></span><br><span class="line">TrajectoryType ReadTrajectory(const string &amp;path);</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  TrajectoryType groundtruth = ReadTrajectory(groundtruth_file);</span><br><span class="line">  TrajectoryType estimated = ReadTrajectory(estimated_file);</span><br><span class="line">  assert(!groundtruth.empty() &amp;&amp; !estimated.empty());</span><br><span class="line">  assert(groundtruth.size() == estimated.size());</span><br><span class="line"></span><br><span class="line">  // compute rmse</span><br><span class="line">  double rmse = 0;</span><br><span class="line">  for (size_t i = 0; i &lt; estimated.size(); i++) &#123;</span><br><span class="line">    Sophus::SE3d p1 = estimated[i], p2 = groundtruth[i];</span><br><span class="line">    double error = (p2.inverse() * p1).log().norm();</span><br><span class="line">    rmse += error * error;</span><br><span class="line">  &#125;</span><br><span class="line">  rmse = rmse / double(estimated.size());</span><br><span class="line">  rmse = sqrt(rmse);</span><br><span class="line">  cout &lt;&lt; &quot;RMSE = &quot; &lt;&lt; rmse &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  DrawTrajectory(groundtruth, estimated);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TrajectoryType ReadTrajectory(const string &amp;path) &#123;</span><br><span class="line">  ifstream fin(path);</span><br><span class="line">  TrajectoryType trajectory;</span><br><span class="line">  if (!fin) &#123;</span><br><span class="line">    cerr &lt;&lt; &quot;trajectory &quot; &lt;&lt; path &lt;&lt; &quot; not found.&quot; &lt;&lt; endl;</span><br><span class="line">    return trajectory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  while (!fin.eof()) &#123;</span><br><span class="line">    double time, tx, ty, tz, qx, qy, qz, qw;</span><br><span class="line">    fin &gt;&gt; time &gt;&gt; tx &gt;&gt; ty &gt;&gt; tz &gt;&gt; qx &gt;&gt; qy &gt;&gt; qz &gt;&gt; qw;</span><br><span class="line">    Sophus::SE3d p1(Eigen::Quaterniond(qw, qx, qy, qz), Eigen::Vector3d(tx, ty, tz));</span><br><span class="line">    trajectory.push_back(p1);</span><br><span class="line">  &#125;</span><br><span class="line">  return trajectory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void DrawTrajectory(const TrajectoryType &amp;gt, const TrajectoryType &amp;esti) &#123;</span><br><span class="line">  // create pangolin window and plot the trajectory</span><br><span class="line">  pangolin::CreateWindowAndBind(&quot;Trajectory Viewer&quot;, 1024, 768);</span><br><span class="line">  glEnable(GL_DEPTH_TEST);</span><br><span class="line">  glEnable(GL_BLEND);</span><br><span class="line">  glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line"></span><br><span class="line">  pangolin::OpenGlRenderState s_cam(</span><br><span class="line">      pangolin::ProjectionMatrix(1024, 768, 500, 500, 512, 389, 0.1, 1000),</span><br><span class="line">      pangolin::ModelViewLookAt(0, -0.1, -1.8, 0, 0, 0, 0.0, -1.0, 0.0)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  pangolin::View &amp;d_cam = pangolin::CreateDisplay()</span><br><span class="line">      .SetBounds(0.0, 1.0, pangolin::Attach::Pix(175), 1.0, -1024.0f / 768.0f)</span><br><span class="line">      .SetHandler(new pangolin::Handler3D(s_cam));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  while (pangolin::ShouldQuit() == false) &#123;</span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    d_cam.Activate(s_cam);</span><br><span class="line">    glClearColor(1.0f, 1.0f, 1.0f, 1.0f);</span><br><span class="line"></span><br><span class="line">    glLineWidth(2);</span><br><span class="line">    for (size_t i = 0; i &lt; gt.size() - 1; i++) &#123;</span><br><span class="line">      glColor3f(0.0f, 0.0f, 1.0f);  // blue for ground truth</span><br><span class="line">      glBegin(GL_LINES);</span><br><span class="line">      auto p1 = gt[i], p2 = gt[i + 1];</span><br><span class="line">      glVertex3d(p1.translation()[0], p1.translation()[1], p1.translation()[2]);</span><br><span class="line">      glVertex3d(p2.translation()[0], p2.translation()[1], p2.translation()[2]);</span><br><span class="line">      glEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (size_t i = 0; i &lt; esti.size() - 1; i++) &#123;</span><br><span class="line">      glColor3f(1.0f, 0.0f, 0.0f);  // red for estimated</span><br><span class="line">      glBegin(GL_LINES);</span><br><span class="line">      auto p1 = esti[i], p2 = esti[i + 1];</span><br><span class="line">      glVertex3d(p1.translation()[0], p1.translation()[1], p1.translation()[2]);</span><br><span class="line">      glVertex3d(p2.translation()[0], p2.translation()[1], p2.translation()[2]);</span><br><span class="line">      glEnd();</span><br><span class="line">    &#125;</span><br><span class="line">    pangolin::FinishFrame();</span><br><span class="line">    usleep(5000);   // sleep 5 ms</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line">project(trajectoryError)</span><br><span class="line"></span><br><span class="line">option(USE_UBUNTU_20 &quot;Set to ON if you are using Ubuntu 20.04&quot; OFF)</span><br><span class="line">find_package(Pangolin REQUIRED)</span><br><span class="line">if(USE_UBUNTU_20)</span><br><span class="line">    message(&quot;You are using Ubuntu 20.04, fmt::fmt will be linked&quot;)</span><br><span class="line">    find_package(fmt REQUIRED)</span><br><span class="line">    set(FMT_LIBRARIES fmt::fmt)</span><br><span class="line">endif()</span><br><span class="line">include_directories($&#123;Pangolin_INCLUDE_DIRS&#125;)</span><br><span class="line">add_executable(trajectoryError trajectoryError.cpp)</span><br><span class="line">target_link_libraries(trajectoryError $&#123;Pangolin_LIBRARIES&#125; $&#123;FMT_LIBRARIES&#125;)</span><br></pre></td></tr></table></figure>

<p>记得把源代码中的两个轨迹保存到<code>slambook/ch4/examples/</code></p>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch4/examples/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch4/examples/build</span><br><span class="line">hita@hita-vm:~/slambook/ch4/examples/build$ make</span><br><span class="line">[100%] Built target trajectoryError</span><br><span class="line">hita@hita-vm:~/slambook/ch4/examples/build$ ./trajectoryError </span><br><span class="line">RMSE = 2.20728</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250822155141451.png" alt="image-20250822155141451"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://gen2710.netlify.app/2025/08/20/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%89%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E4%B8%89%E7%BB%B4%E5%88%9A%E4%BD%93%E8%BF%90%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/jiangbaoaaa/my_blog_img/main/myself.jpg">
      <meta itemprop="name" content="Hita">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="U.N.O">
      <meta itemprop="description" content="Gains Don't Stop!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | U.N.O">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/20/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2%EF%BC%88%E7%AC%AC%E4%B8%89%E8%AE%B2%EF%BC%89%E2%80%94%E2%80%94%E4%B8%89%E7%BB%B4%E5%88%9A%E4%BD%93%E8%BF%90%E5%8A%A8/" class="post-title-link" itemprop="url">第三讲-三位刚体运动</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-20 00:00:00 / 修改时间：19:57:49" itemprop="dateCreated datePublished" datetime="2025-08-20T00:00:00+08:00">2025-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E8%A7%89SLAM%E5%8D%81%E5%9B%9B%E8%AE%B2/" itemprop="url" rel="index"><span itemprop="name">视觉SLAM十四讲</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="视觉SLAM十四讲（第三讲）——三维刚体运动"><a href="#视觉SLAM十四讲（第三讲）——三维刚体运动" class="headerlink" title="视觉SLAM十四讲（第三讲）——三维刚体运动"></a>视觉SLAM十四讲（第三讲）——三维刚体运动</h1><h2 id="旋转矩阵"><a href="#旋转矩阵" class="headerlink" title="旋转矩阵"></a>旋转矩阵</h2><h3 id="点、向量和坐标系"><a href="#点、向量和坐标系" class="headerlink" title="点、向量和坐标系"></a>点、向量和坐标系</h3><p>前面基础知识跳过</p>
<p><strong>向量内积</strong></p>
<p>公式如下<br>$$<br>a⋅b&#x3D;a<br>T<br> b&#x3D;<br>i&#x3D;1<br>∑<br>3<br>​<br> a<br>i<br>​<br> b<br>i<br>​<br> &#x3D;∣a∣∣b∣cos⟨a,b⟩<br>$$<br>内积可以描述向量间的投影关系，其中$$ &lt;a,b&gt;$$ 表示向量夹角。</p>
<p><strong>向量外积</strong><br>$$<br>\boldsymbol{a} \times \boldsymbol{b} &#x3D; \begin{vmatrix}<br>\boldsymbol{e}_1 &amp; \boldsymbol{e}_2 &amp; \boldsymbol{e}_3 <br>a_1 &amp; a_2 &amp; a_3 <br>b_1 &amp; b_2 &amp; b_3<br>\end{vmatrix} &#x3D; \begin{bmatrix}<br>a_2b_3 - a_3b_2 <br>a_3b_1 - a_1b_3 <br>a_1b_2 - a_2b_1<br>\end{bmatrix} &#x3D; \begin{bmatrix}<br>0 &amp; -a_3 &amp; a_2 <br>a_3 &amp; 0 &amp; -a_1 <br>-a_2 &amp; a_1 &amp; 0<br>\end{bmatrix} \boldsymbol{b} \triangleq \boldsymbol{a}^\land \boldsymbol{b}<br>$$<br>外积的结果是一个向量，方向垂直两个向量，大小是$|a||b|sin&lt;a,b&gt;$ 是两个向量张成的四边形的有向面积.对于外积运算引入$∧$,是一个反对成符号。<br>$$<br>a ∧ &#x3D;<br>\begin{bmatrix}<br>0 &amp; -a_3 &amp; a_2 \<br>a_3 &amp; 0 &amp; -a_1 \<br>-a_2 &amp; a_1 &amp; 0<br>\end{bmatrix}<br>$$</p>
<h3 id="坐标系间的欧氏变换"><a href="#坐标系间的欧氏变换" class="headerlink" title="坐标系间的欧氏变换"></a>坐标系间的欧氏变换</h3><p>旋转矩阵有一些特别的性质。它是一个行列式为1的正交矩阵。所以将$n$维旋转矩阵的集合定义为：<br>$$<br>\text{SO}(n)&#x3D;{ \boldsymbol{R} \in \mathbb{R}^{n \times n} \mid \boldsymbol{R}\boldsymbol{R}^{\text{T}} &#x3D; \boldsymbol{I}, \det(\boldsymbol{R}) &#x3D; 1 }<br>$$<br>so{n}是特殊正交群的意思（Special Orthogonal Group）。这个集合由n维空间的旋转矩阵组成，n&#x3D;3即三维空间的旋转矩阵。</p>
<p>$R_{12}$是指把坐标系2的向量变换到坐标系1，而平移$t_{12}$是指在坐标系1下取的坐标，即从1指向2的向量在坐标系1下的坐标。</p>
<h3 id="变换矩阵与齐次变换"><a href="#变换矩阵与齐次变换" class="headerlink" title="变换矩阵与齐次变换"></a>变换矩阵与齐次变换</h3><p>对于变换矩阵$T$,它具有比较特别的结构，左上角为旋转矩阵，右侧为平移向量，左下角为0向量，右下角为1.这种矩阵又称为特殊欧式群（Special Euclidean Group）<br>$$<br>\mathrm{SE}(3)&#x3D;\left{ \boldsymbol{T}&#x3D;\begin{bmatrix} \boldsymbol{R} &amp; \boldsymbol{t} \ \boldsymbol{0}^{\mathrm{T}} &amp; 1 \end{bmatrix} \in \mathbb{R}^{4\times4} \mid \boldsymbol{R} \in \mathrm{SO}(3), \boldsymbol{t} \in \mathbb{R}^3 \right}<br>$$<br>用$T_{12}$表示从2到1的变换。总的来说，坐标系之间的运动由欧式变换描述，由平移和旋转组成，旋转可以由旋转矩阵$SO(3)$描述，平移直接由一个$ \mathbb{R}^3$向量描述，最后，如果将平移与旋转放在一个矩阵中，就形成了变换矩阵$SE(3)$.</p>
<hr>
<h2 id="实践：Eigen"><a href="#实践：Eigen" class="headerlink" title="实践：Eigen"></a>实践：Eigen</h2><p>Eigen是一个开源的线性代数库，提供快速的有关矩阵的线性代数运算，下面是eigen3的官方文档链接：</p>
<p><a target="_blank" rel="noopener" href="https://libeigen.gitlab.io/eigen/docs-nightly/"> Eigen: Main Page</a></p>
<p>输入以下命令安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libeigen3-dev</span><br></pre></td></tr></table></figure>

<p>一个库由头文件以及库文件组成，其中Eigen头文件所在位置可以通过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo updatedb</span><br><span class="line">locate eigen3 | grep include</span><br></pre></td></tr></table></figure>

<p>存放在：<code>/usr/include/eigen3/</code>中</p>
<p>与其他库相比，Eigen是一个纯用头文件搭建的库，意味着只能找到它的头文件没有类似.so或者.a的二进制文件，只需要引入Eigen头文件即可使用。不需要链接库文件。可以写一段代码来实际练习EIgen:</p>
<p>新建文件：<code>slambook/ch3/useEigen/eigenMatrix.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MATRIX_SIZE 50</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    Matrix&lt;<span class="type">float</span>, <span class="number">2</span>, <span class="number">3</span>&gt; matrix_23;</span><br><span class="line">    Vector3d v_3d;</span><br><span class="line">    Matrix&lt;<span class="type">float</span>, <span class="number">3</span>, <span class="number">1</span>&gt; vd_3d;</span><br><span class="line">    Matrix3d matrix_33 = Matrix3d::<span class="built_in">Zero</span>();</span><br><span class="line">    Matrix&lt;<span class="type">double</span>, Dynamic, Dynamic&gt; matrix_dynamic;</span><br><span class="line">    MatrixXd matrix_x;</span><br><span class="line"></span><br><span class="line">    matrix_23 &lt;&lt; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;matrix 2x3 from 1 to 6: \n&quot;</span> &lt;&lt; matrix_23 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;print matrix 2x3: &quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) cout &lt;&lt; <span class="built_in">matrix_23</span>(i, j) &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">        cout &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v_3d &lt;&lt; <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>;</span><br><span class="line">    vd_3d &lt;&lt; <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">2</span>, <span class="number">1</span>&gt; result = matrix_<span class="number">23.</span><span class="built_in">cast</span>&lt;<span class="type">double</span>&gt;() * v_3d;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[1,2,3;4,5,6]*[3,2,1]=&quot;</span> &lt;&lt; result.<span class="built_in">transpose</span>() &lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    Matrix&lt;<span class="type">float</span>, <span class="number">2</span>,<span class="number">1</span>&gt; result2 = matrix_23 * vd_3d;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[1,2,3;4,5,6]*[4,5,6]=&quot;</span> &lt;&lt; result<span class="number">2.</span><span class="built_in">transpose</span>() &lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    matrix_33 = Matrix3d::<span class="built_in">Random</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;random matrix: \n&quot;</span> &lt;&lt; matrix_33 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;transpose: \n&quot;</span> &lt;&lt; matrix_<span class="number">33.</span><span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;sum: &quot;</span> &lt;&lt; matrix_<span class="number">33.</span><span class="built_in">sum</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;tracd: &quot;</span> &lt;&lt; matrix_<span class="number">33.</span><span class="built_in">trace</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;times 10: \n&quot;</span> &lt;&lt; <span class="number">10</span> * matrix_33 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;inverse: \n&quot;</span> &lt;&lt; matrix_<span class="number">33.</span><span class="built_in">inverse</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;det: &quot;</span> &lt;&lt; matrix_<span class="number">33.</span><span class="built_in">determinant</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="function">SelfAdjointEigenSolver&lt;Matrix3d&gt; <span class="title">eigen_solver</span><span class="params">(matrix_<span class="number">33.</span>transpose() * matrix_33)</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Eigen values = \n&quot;</span> &lt;&lt; eigen_solver.<span class="built_in">eigenvalues</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Eigen vactors = \n&quot;</span> &lt;&lt; eigen_solver.<span class="built_in">eigenvectors</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, MATRIX_SIZE, MATRIX_SIZE&gt; matrix_NN</span><br><span class="line">        = MatrixXd::<span class="built_in">Random</span>(MATRIX_SIZE, MATRIX_SIZE);</span><br><span class="line">    matrix_NN = matrix_NN * matrix_NN.<span class="built_in">transpose</span>();</span><br><span class="line">    Matrix&lt;<span class="type">double</span>, MATRIX_SIZE, <span class="number">1</span>&gt; v_Nd = MatrixXd:: <span class="built_in">Random</span>(MATRIX_SIZE, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">clock_t</span> time_stt = <span class="built_in">clock</span>();</span><br><span class="line">    Matrix&lt;<span class="type">double</span>, MATRIX_SIZE, <span class="number">1</span>&gt; x = matrix_NN.<span class="built_in">inverse</span>() * v_Nd;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;time of normal inverse is &quot;</span> </span><br><span class="line">         &lt;&lt; <span class="number">1000</span> * (<span class="built_in">clock</span>() - time_stt) /(<span class="type">double</span>) CLOCKS_PER_SEC &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;x = &quot;</span> &lt;&lt; x.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    time_stt = <span class="built_in">clock</span>();</span><br><span class="line">    x = matrix_NN.<span class="built_in">colPivHouseholderQr</span>().<span class="built_in">solve</span>(v_Nd);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;time of QR decomposition is &quot;</span> </span><br><span class="line">         &lt;&lt; <span class="number">1000</span> * (<span class="built_in">clock</span>() - time_stt) /(<span class="type">double</span>) CLOCKS_PER_SEC &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;x = &quot;</span> &lt;&lt; x.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    time_stt = <span class="built_in">clock</span>();</span><br><span class="line">    x = matrix_NN.<span class="built_in">ldlt</span>().<span class="built_in">solve</span>(v_Nd);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;time of ldlt decomposition is &quot;</span> </span><br><span class="line">         &lt;&lt; <span class="number">1000</span> * (<span class="built_in">clock</span>() - time_stt) /(<span class="type">double</span>) CLOCKS_PER_SEC &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;x = &quot;</span> &lt;&lt; x.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(useEigen)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include_directories( <span class="string">&quot;/usr/include/eigen3&quot;</span> )</span><br><span class="line">add_executable(eigenMatrix eigenMatrix.cpp)</span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch3/useEigen/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch3/useEigen/build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/useEigen/build$ make</span><br><span class="line">[100%] Built target eigenMatrix</span><br><span class="line">hita@hita-vm:~/slambook/ch3/useEigen/build$ ./eigenMatrix </span><br><span class="line">matrix 2x3 from 1 to 6: </span><br><span class="line">1 2 3</span><br><span class="line">4 5 6</span><br><span class="line">print matrix 2x3: </span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>编译之后即可输出结果。</p>
<hr>
<h2 id="旋转向量与欧拉角"><a href="#旋转向量与欧拉角" class="headerlink" title="旋转向量与欧拉角"></a>旋转向量与欧拉角</h2><h3 id="旋转向量"><a href="#旋转向量" class="headerlink" title="旋转向量"></a>旋转向量</h3><blockquote>
<p>旋转向量</p>
</blockquote>
<p>方向与旋转轴一致，向量长度来表示旋转角度。对于变换矩阵，使用一个旋转向量和一个平移向量来表示一次变换。这样就不再冗余。</p>
<blockquote>
<p>罗德里格斯旋转公式</p>
</blockquote>
<h1 id="vrot"><a href="#vrot" class="headerlink" title="$$vrot"></a>$$<br>v<br>r<br>o<br>t</h1><p>cos<br>θ<br>v<br>+<br>(<br>1<br>−<br>cos<br>θ<br>)<br>(<br>k<br>⋅<br>v<br>)<br>k<br>+<br>sin<br>θ<br>k<br>×<br>v<br>$$</p>
<p>附上一张图片：</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Orthogonal_decomposition_unit_vector_rodrigues_rotation_formula.svg/350px-Orthogonal_decomposition_unit_vector_rodrigues_rotation_formula.svg.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/1903168-20200217220414404-1389795950.png" alt="向量的分解图示"></p>
<p>其中v是三维向量，k是与旋转轴同向的单位向量，θ是v绕着k的右手方向旋转角度。vrot表示旋转之后的向量。</p>
<h1 id="矩阵形式-vrot"><a href="#矩阵形式-vrot" class="headerlink" title="矩阵形式$$vrot"></a><strong>矩阵形式</strong><br>$$<br>v<br>r<br>o<br>t</h1><h1 id="Rv-其中R是旋转矩阵，表示如下：-R"><a href="#Rv-其中R是旋转矩阵，表示如下：-R" class="headerlink" title="Rv$$其中R是旋转矩阵，表示如下：$$R"></a>R<br>v<br>$$<br>其中R是旋转矩阵，表示如下：<br>$$<br>R</h1><h1 id="cosθI-1−cosθ-kkT-sinθk∧-其中I表示单位矩阵，K表示旋转向量，k-表示由k得到的反对成矩阵，-R"><a href="#cosθI-1−cosθ-kkT-sinθk∧-其中I表示单位矩阵，K表示旋转向量，k-表示由k得到的反对成矩阵，-R" class="headerlink" title="cosθI+(1−cosθ)kkT+sinθk∧$$其中I表示单位矩阵，K表示旋转向量，k^表示由k得到的反对成矩阵，$$R"></a>cos<br>θ<br>I<br>+<br>(<br>1<br>−<br>cos<br>θ<br>)<br>k<br>k<br>T<br>+<br>sin<br>θ<br>k<br>∧<br>$$<br>其中I表示单位矩阵，K表示旋转向量，k^表示由k得到的反对成矩阵，<br>$$<br>R</h1><p>I<br>+<br>(<br>sin<br>θ<br>)<br>K<br>+<br>(<br>1<br>−<br>cos<br>θ<br>)<br>K<br>2<br>$$<br>其中K，表示旋转向量生成的反对成矩阵。</p>
<p>参考资料：</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1DF411s7sn/?spm_id_from=333.337.search-card.all.click&vd_source=f241df170c33a3be666ec10b59feb689">罗德里格斯公式推导_哔哩哔哩_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wtyuan/p/12324495.html">罗德里格斯旋转公式（Rodrigues’ rotation formula）推导 - wtyuan - 博客园</a></p>
<p>符号∧是向量到反对称矩阵的转换符。反之，我们也可以计算从一个旋转矩阵到旋转向量的转换。对于转角 θ，取两边的迹，有<br>$$<br>\begin{aligned}\operatorname{tr}(R)&amp;&#x3D;\cos\theta\operatorname{tr}(\boldsymbol{I})+(1-\cos\theta)\operatorname{tr}(\boldsymbol{k}\boldsymbol{k}^\mathrm{T})+\sin\theta\operatorname{tr}(\boldsymbol{k}^\wedge)\&amp;\mathrm{.}\&amp;&#x3D;1+2\cos\theta\end{aligned}<br>$$<br>得到：<br>$$<br>\theta&#x3D;\arccos\left(\frac{\operatorname{tr}(\boldsymbol{R})-1}{2}\right)<br>$$<br>旋转轴上的向量在旋转后不发生改变，说明：<br>$$<br>Rn &#x3D; n<br>$$</p>
<hr>
<h3 id="欧拉角"><a href="#欧拉角" class="headerlink" title="欧拉角"></a>欧拉角</h3><p>三个转角：</p>
<ol>
<li>绕物体的Z轴旋转，得到偏航角(yaw)</li>
<li>绕旋转之后的Y轴旋转，得到俯仰角(pitch)</li>
<li>绕旋转之后的X轴旋转，得到滚转角(roll)</li>
</ol>
<p>此时可以通过[r,p,y]T这样一个三维向量描述任意旋转，rpy角的旋转顺序是ZYX.</p>
<blockquote>
<p>万向锁</p>
</blockquote>
<p>欧拉角的一个重大问题就是会碰到万向锁问题，只有使用动态的欧拉角才会出现万向锁问题（绕物体坐标系的三个轴旋转），当第二次转动的角度为±90°的时候，第一次转动与第二次转动其实为绕同一个轴转动，所以在SLAM中很少用欧拉角来表示姿态。</p>
<hr>
<h2 id="四元数"><a href="#四元数" class="headerlink" title="四元数"></a>四元数</h2><h3 id="四元数定义"><a href="#四元数定义" class="headerlink" title="四元数定义"></a>四元数定义</h3><p>四元数是由实数加上三个元素i, j, k 组成，具有如下关系：</p>
<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/104e96d68f7752e8741c1558bc33e99c5db2e0a5" alt="{\displaystyle i^{2}&#x3D;j^{2}&#x3D;k^{2}&#x3D;ijk&#x3D;-1\,}"></p>
<p>每个四元数都是1， i， j,  k 的线性组合，可以用单位四元数表示三维空间的任意一个旋转。</p>
<p>三个虚部满足如下关系：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250819201107925.png" alt="image-20250819201107925"></p>
<p><strong>四元数中乘i是绕i轴旋转180°，与复数中有所不同。</strong></p>
<hr>
<h3 id="四元数的运算"><a href="#四元数的运算" class="headerlink" title="四元数的运算"></a>四元数的运算</h3><p>四元数同样由四则运算，这里不多介绍，值得注意的是，四元数的乘法通常是不可交换的。共轭是把虚部取负号。四元数和自己的逆的乘积为实四元数1。其他的详细可参考：</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E5%9B%9B%E5%85%83%E6%95%B8">四元数 - 维基百科，自由的百科全书</a></p>
<h3 id="用四元数表示旋转"><a href="#用四元数表示旋转" class="headerlink" title="用四元数表示旋转"></a>用四元数表示旋转</h3><p>首先把三维空间点用一个虚四元数来表述：<br>$$<br>p &#x3D; [0, x, y, z]T &#x3D; [0, v]T<br>$$<br>相当于把四元数的三个虚部与空间中的三个轴相对应。那么旋转后的点 p’ 可以表示为这样的乘积：<br>$$<br>P^{\prime}&#x3D;qpq^{-1}<br>$$<br>结果也是四元数，把虚部取出来，即为旋转之后点的坐标。</p>
<h3 id="四元数到其他旋转表示的转换"><a href="#四元数到其他旋转表示的转换" class="headerlink" title="四元数到其他旋转表示的转换"></a>四元数到其他旋转表示的转换</h3><p>任意四元数描述了一个旋转，旋转可以用旋转矩阵或者旋转向量表示。四元数乘法可以有一种矩阵的乘法表示：<br>$$<br>q &#x3D; [s, v]^T<br>$$<br>定义如下符号：<br>$$<br>\left.q^+&#x3D;\left[\begin{array}{cc}s&amp;-v^\mathrm{T}\\v&amp;s\boldsymbol{I}+\boldsymbol{v}^\wedge\end{array}\right.\right]<br>$$</p>
<p>$$<br>q^\oplus&#x3D;\begin{bmatrix}s&amp;-v^\mathrm{T}\\v&amp;s\boldsymbol{I}-\boldsymbol{v}^\mathrm{T}\end{bmatrix}<br>$$</p>
<p>这两个符号将四元数映射为一个4x4的矩阵，于是四元数乘法可以写成矩阵形式：<br>$$<br>\left.q_1^+q_2&#x3D;\left[\begin{array}{cc}s_1&amp;-\boldsymbol{v}_1^T\\\boldsymbol{v}_1&amp;s_1\boldsymbol{I}+\boldsymbol{v}_1^\wedge\end{array}\right.\right]\begin{bmatrix}s_2\\\boldsymbol{v}_2\end{bmatrix}&#x3D;\begin{bmatrix}-\boldsymbol{v}_1^T\boldsymbol{v}_2+s_1s_2\\s_1\boldsymbol{v}_2+s_2\boldsymbol{v}_1+\boldsymbol{v}_1^\wedge\boldsymbol{v}_2\end{bmatrix}&#x3D;\boldsymbol{q}_1\boldsymbol{q}_2<br>$$<br>同理可得:<br>$$<br>q_1q_2&#x3D;q_1^+q_2&#x3D;q_2^\oplus q_1<br>$$<br>则有：<br>$$<br>\begin{aligned}p^{\prime}&amp;&#x3D;qpq^{-1}&#x3D;q^+p^+q^{-1}\&amp;&#x3D;q^+q^{-1}\oplus p\end{aligned}<br>$$<br>四元数到旋转向量的转换公式：<br>$$<br>\begin{cases}<br>\theta &#x3D; 2 \arccos q_0 \<br>[n_x, n_y, n_z]^\mathrm{T} &#x3D; \frac{[q_1, q_2, q_3]^\mathrm{T}}{\sin\frac{\theta}{2}}<br>\end{cases}<br>$$</p>
<hr>
<h2 id="相似、仿射、射影变换"><a href="#相似、仿射、射影变换" class="headerlink" title="相似、仿射、射影变换"></a>相似、仿射、射影变换</h2><h3 id="相似变换"><a href="#相似变换" class="headerlink" title="相似变换"></a>相似变换</h3><p>允许物体进行均匀放缩。三维相似变换的集合也被叫做相似变换群，记为$Sim(3)$</p>
<h3 id="仿射变换"><a href="#仿射变换" class="headerlink" title="仿射变换"></a>仿射变换</h3><p>该变换只要求A是一个可逆矩阵，不必是正交矩阵，经过仿射变换后，立方体不再是方的，但是各个面仍然是平行四边形。</p>
<h3 id="射影变换"><a href="#射影变换" class="headerlink" title="射影变换"></a>射影变换</h3><p>从真实世界到相机照片的变换是一个射影变换。</p>
<hr>
<h2 id="实践：Eigen几何模块"><a href="#实践：Eigen几何模块" class="headerlink" title="实践：Eigen几何模块"></a>实践：Eigen几何模块</h2><h3 id="Eigen几何模块的数据演示"><a href="#Eigen几何模块的数据演示" class="headerlink" title="Eigen几何模块的数据演示"></a>Eigen几何模块的数据演示</h3><p>新建文件：<code>slambook/ch3/useGeometry/useGeometry.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    Matrix3d rotation_matrix = Matrix3d::<span class="built_in">Identity</span>();</span><br><span class="line">    <span class="function">AngleAxisd <span class="title">rotation_vector</span><span class="params">(M_PI / <span class="number">4</span>, Vector3d(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>))</span></span>;</span><br><span class="line">    cout.<span class="built_in">precision</span>(<span class="number">3</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;rotation matrix = \n &quot;</span> &lt;&lt; rotation_vector.<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line">    rotation_matrix = rotation_vector.<span class="built_in">toRotationMatrix</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">Vector3d <span class="title">v</span><span class="params">(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    Vector3d v_rotated  = rotation_matrix * v;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;(1, 0, 0) after rotation (by angle axis) = &quot;</span> &lt;&lt; v_rotated.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    Vector3d euler_angles = rotation_matrix.<span class="built_in">eulerAngles</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;yaw pitch roll = &quot;</span> &lt;&lt; euler_angles.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line">    Isometry3d T = Isometry3d::<span class="built_in">Identity</span>();</span><br><span class="line">    T.<span class="built_in">rotate</span>(rotation_vector);</span><br><span class="line">    T.<span class="built_in">pretranslate</span>(<span class="built_in">Vector3d</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>));</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Transform matrix = \n&quot;</span> &lt;&lt; T.<span class="built_in">matrix</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    Vector3d v_transformed = T * v;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;v transformed = &quot;</span> &lt;&lt; v_transformed.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    Quaterniond q = <span class="built_in">Quaterniond</span>(rotation_vector);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;quaternion from rotation vector = &quot;</span> &lt;&lt; q.<span class="built_in">coeffs</span>().<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line">    q = <span class="built_in">Quaterniond</span>(rotation_matrix);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;quaternion from rotation matrix = &quot;</span> &lt;&lt; q.<span class="built_in">coeffs</span>().<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    v_rotated = q * v;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;(1, 0, 0) after rotation = &quot;</span> &lt;&lt; v_rotated.<span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required( VERSION 2.8 )</span><br><span class="line">project( geometry )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加Eigen头文件</span></span><br><span class="line">include_directories( <span class="string">&quot;/usr/include/eigen3&quot;</span> )</span><br><span class="line"></span><br><span class="line">add_executable(eigenGeometry useGeometry.cpp)</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch3/useGeometry$ mkdir build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/useGeometry$ cd build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/useGeometry/build$ cmake ..</span><br><span class="line">-- The C compiler identification is GNU 9.4.0</span><br><span class="line">-- The CXX compiler identification is GNU 9.4.0</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch3/useGeometry/build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/useGeometry/build$ make</span><br><span class="line">Scanning dependencies of target eigenGeometry</span><br><span class="line">[ 50%] Building CXX object CMakeFiles/eigenGeometry.dir/useGeometry.cpp.o</span><br><span class="line">[100%] Linking CXX executable eigenGeometry</span><br><span class="line">[100%] Built target eigenGeometry</span><br><span class="line">hita@hita-vm:~/slambook/ch3/useGeometry/build$ ./eigenGeometry </span><br><span class="line">rotation matrix = </span><br><span class="line">  0.707 -0.707      0</span><br><span class="line"> 0.707  0.707      0</span><br><span class="line">     0      0      1</span><br><span class="line">(1, 0, 0) after rotation (by angle axis) = 0.707 0.707     0</span><br><span class="line">yaw pitch roll = 0.785    -0     0</span><br><span class="line">Transform matrix = </span><br><span class="line"> 0.707 -0.707      0      1</span><br><span class="line"> 0.707  0.707      0      3</span><br><span class="line">     0      0      1      4</span><br><span class="line">     0      0      0      1</span><br><span class="line">v transformed = 1.71 3.71    4</span><br><span class="line">quaternion from rotation vector =     0     0 0.383 0.924</span><br><span class="line">quaternion from rotation matrix =     0     0 0.383 0.924</span><br><span class="line">(1, 0, 0) after rotation = 0.707 0.707     0</span><br></pre></td></tr></table></figure>

<h3 id="实际的坐标变换例子"><a href="#实际的坐标变换例子" class="headerlink" title="实际的坐标变换例子"></a>实际的坐标变换例子</h3><p><strong>例子</strong></p>
<p>设有机器人一号和机器人二号位于世界坐标系中。记世界坐标系为W，机器人的坐标系为 R1和R2。机器人一号的位姿为q1 &#x3D; [0.35, 0.2, 0.3, 0.1]T, t1 &#x3D; [0.3, 0.1, 0.1]T。机器人二号的位姿为q2 &#x3D; [−0.5, 0.4, −0.1, 0.2]T, t2 &#x3D; [−0.1, 0.5, 0.3]T。这里的q和t表达的是世界坐标系到相机坐标系的变换关系。机器人一号看到某个点在自身的坐标系下坐标为pR1 &#x3D; [0.5, 0, 0.2]T，求该向量在机器人二号坐标系下的坐标。</p>
<p>新建文件 <code>slambook/ch3/examples/coordinateTransform.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="function">Quaterniond <span class="title">q1</span><span class="params">(<span class="number">0.35</span>, <span class="number">0.2</span>, <span class="number">0.3</span>, <span class="number">0.1</span>)</span>, <span class="title">q2</span><span class="params">(<span class="number">-0.5</span>, <span class="number">0.4</span>, <span class="number">-0.1</span>, <span class="number">0.2</span>)</span></span>;</span><br><span class="line">    q<span class="number">1.</span><span class="built_in">normalize</span>();</span><br><span class="line">    q<span class="number">2.</span><span class="built_in">normalize</span>();</span><br><span class="line">    <span class="function">Vector3d <span class="title">t1</span><span class="params">(<span class="number">0.3</span>, <span class="number">0.1</span>, <span class="number">0.1</span>)</span>, <span class="title">t2</span><span class="params">(<span class="number">-0.1</span>, <span class="number">0.5</span>, <span class="number">0.3</span>)</span></span>;</span><br><span class="line">    <span class="function">Vector3d <span class="title">p1</span><span class="params">(<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0.2</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Isometry3d <span class="title">T1w</span><span class="params">(q1)</span>, <span class="title">T2w</span><span class="params">(q2)</span></span>;</span><br><span class="line">    T1w.<span class="built_in">pretranslate</span>(t1);</span><br><span class="line">    T2w.<span class="built_in">pretranslate</span>(t2);</span><br><span class="line"></span><br><span class="line">    Vector3d p2 = T2w * T1w.<span class="built_in">inverse</span>() * p1;</span><br><span class="line">    cout &lt;&lt; endl &lt;&lt; p<span class="number">2.</span><span class="built_in">transpose</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(examples)</span><br><span class="line"></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line">add_executable(coordinateTransform coordinateTransform.cpp)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch3/examples/build$ cmake ..</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch3/examples/build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/examples/build$ make</span><br><span class="line">[100%] Built target coordinateTransform</span><br><span class="line">hita@hita-vm:~/slambook/ch3/examples/build$ ./coordinateTransform </span><br><span class="line"></span><br><span class="line">-0.0309731    0.73499   0.296108</span><br></pre></td></tr></table></figure>

<p>程序只需要计算：<br>$$<br>p_{R_2} &#x3D; T_{R_2,W} T_{W,R_1} p_{R_1}<br>$$<br>即可，四元数使用之前需要归一化处理确保计算结果正确、稳定高效。</p>
<hr>
<h2 id="可视化演示"><a href="#可视化演示" class="headerlink" title="可视化演示"></a>可视化演示</h2><blockquote>
<p>安装Pangolin</p>
</blockquote>
<p>新建文件夹：<code>slambook/3rdparty/</code></p>
<p>在终端输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/stevenlovegrove/Pangolin.git</span><br><span class="line">cd Pangolin</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">cmake --build .</span><br><span class="line">sudo make install</span><br><span class="line">sudo ldconfig</span><br></pre></td></tr></table></figure>

<p>编译成功之后测试一下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd Pangolin/build/examples/HelloPangolin</span><br><span class="line">./HelloPangolin</span><br></pre></td></tr></table></figure>

<p>会看到一个结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250820153311084.png" alt="image-20250820153311084"></p>
<p>这代表安装成功了</p>
<p>新建文件 <code>slambook/ch3/examples/plotTrajectory.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pangolin/pangolin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path to trajectory file</span></span><br><span class="line">string trajectory_file = <span class="string">&quot;../../examples/trajectory.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawTrajectory</span><span class="params">(vector&lt;Isometry3d, Eigen::aligned_allocator&lt;Isometry3d&gt;&gt;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    vector&lt;Isometry3d, Eigen::aligned_allocator&lt;Isometry3d&gt;&gt; poses;</span><br><span class="line">    <span class="function">ifstream <span class="title">fin</span><span class="params">(trajectory_file)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!fin) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;cannot find trajectory file at &quot;</span> &lt;&lt; trajectory_file &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!fin.<span class="built_in">eof</span>()) &#123;</span><br><span class="line">        <span class="type">double</span> time, tx, ty, tz, qx, qy, qz, qw;</span><br><span class="line">        fin &gt;&gt; time &gt;&gt; tx &gt;&gt; ty &gt;&gt; tz &gt;&gt; qx &gt;&gt; qy &gt;&gt; qz &gt;&gt; qw;</span><br><span class="line">        <span class="function">Isometry3d <span class="title">Twr</span><span class="params">(Quaterniond(qw, qx, qy, qz))</span></span>;</span><br><span class="line">        Twr.<span class="built_in">pretranslate</span>(<span class="built_in">Vector3d</span>(tx, ty, tz));</span><br><span class="line">        poses.<span class="built_in">push_back</span>(Twr);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;read total&quot;</span> &lt;&lt; poses.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;pose entries&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// draw trajectory in pangolin</span></span><br><span class="line">    <span class="built_in">DrawTrajectory</span>(poses);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawTrajectory</span><span class="params">(vector&lt;Isometry3d, Eigen::aligned_allocator&lt;Isometry3d&gt;&gt; poses)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create pangolin window and plot the trajectory</span></span><br><span class="line">    pangolin::<span class="built_in">CreateWindowAndBind</span>(<span class="string">&quot;Trajectory Viewer&quot;</span>, <span class="number">1024</span>, <span class="number">768</span>);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_BLEND);</span><br><span class="line">    <span class="built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line"></span><br><span class="line">    <span class="function">pangolin::OpenGlRenderState <span class="title">s_cam</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    pangolin::ProjectionMatrix(<span class="number">1024</span>, <span class="number">768</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">512</span>, <span class="number">389</span>, <span class="number">0.1</span>, <span class="number">1000</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">    pangolin::ModelViewLookAt(<span class="number">0</span>, <span class="number">-0.1</span>, <span class="number">-1.8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.0</span>, <span class="number">-1.0</span>, <span class="number">0.0</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line">    pangolin::View &amp;d_cam = pangolin::<span class="built_in">CreateDisplay</span>()</span><br><span class="line">        .<span class="built_in">SetBounds</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">-1024.0f</span> / <span class="number">768.0f</span>)</span><br><span class="line">        .<span class="built_in">SetHandler</span>(<span class="keyword">new</span> pangolin::<span class="built_in">Handler3D</span>(s_cam));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pangolin::<span class="built_in">ShouldQuit</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line">        d_cam.<span class="built_in">Activate</span>(s_cam);</span><br><span class="line">        <span class="built_in">glClearColor</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        <span class="built_in">glLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; poses.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="comment">// 画每个位姿的三个坐标轴</span></span><br><span class="line">            Vector3d Ow = poses[i].<span class="built_in">translation</span>();</span><br><span class="line">            Vector3d Xw = poses[i] * (<span class="number">0.1</span> * <span class="built_in">Vector3d</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">            Vector3d Yw = poses[i] * (<span class="number">0.1</span> * <span class="built_in">Vector3d</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">            Vector3d Zw = poses[i] * (<span class="number">0.1</span> * <span class="built_in">Vector3d</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">            <span class="built_in">glBegin</span>(GL_LINES);</span><br><span class="line">            <span class="built_in">glColor3f</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(Ow[<span class="number">0</span>], Ow[<span class="number">1</span>], Ow[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(Xw[<span class="number">0</span>], Xw[<span class="number">1</span>], Xw[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glColor3f</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(Ow[<span class="number">0</span>], Ow[<span class="number">1</span>], Ow[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(Yw[<span class="number">0</span>], Yw[<span class="number">1</span>], Yw[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glColor3f</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(Ow[<span class="number">0</span>], Ow[<span class="number">1</span>], Ow[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(Zw[<span class="number">0</span>], Zw[<span class="number">1</span>], Zw[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glEnd</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 画出连线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; poses.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="built_in">glColor3f</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">            <span class="built_in">glBegin</span>(GL_LINES);</span><br><span class="line">            <span class="keyword">auto</span> p1 = poses[i], p2 = poses[i<span class="number">+1</span>];</span><br><span class="line">            <span class="built_in">glVertex3d</span>(p<span class="number">1.</span><span class="built_in">translation</span>()[<span class="number">0</span>], p<span class="number">1.</span><span class="built_in">translation</span>()[<span class="number">1</span>], p<span class="number">1.</span><span class="built_in">translation</span>()[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glVertex3d</span>(p<span class="number">2.</span><span class="built_in">translation</span>()[<span class="number">0</span>], p<span class="number">2.</span><span class="built_in">translation</span>()[<span class="number">1</span>], p<span class="number">2.</span><span class="built_in">translation</span>()[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">glEnd</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        pangolin::<span class="built_in">FinishFrame</span>();</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">5000</span>); <span class="comment">// sleep 5 ms</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更新CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 2.8)</span><br><span class="line">project(examples)</span><br><span class="line"></span><br><span class="line">include_directories(<span class="string">&quot;/usr/include/eigen3&quot;</span>)</span><br><span class="line">add_executable(coordinateTransform coordinateTransform.cpp)</span><br><span class="line"></span><br><span class="line">find_package(Pangolin REQUIRED)</span><br><span class="line">include_directories($&#123;Pangolin_INCLUDE_DIRS&#125;)</span><br><span class="line">add_executable(plotTrajectory plotTrajectory.cpp)</span><br><span class="line">target_link_libraries(plotTrajectory $&#123;Pangolin_LIBRARIES&#125;)</span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch3/examples/build$ cmake ..</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch3/examples/build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/examples/build$ make </span><br><span class="line">Scanning dependencies of target plotTrajectory</span><br><span class="line">[ 25%] Building CXX object CMakeFiles/plotTrajectory.<span class="built_in">dir</span>/plotTrajectory.cpp.o</span><br><span class="line">[ 50%] Linking CXX executable plotTrajectory</span><br><span class="line">[ 50%] Built target plotTrajectory</span><br><span class="line">[100%] Built target coordinateTransform</span><br><span class="line">hita@hita-vm:~/slambook/ch3/examples/build$ ./plotTrajectory </span><br><span class="line"><span class="built_in">read</span> total620pose entries</span><br></pre></td></tr></table></figure>

<p>显示结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250820154628932.png" alt="image-20250820154628932"></p>
<hr>
<h3 id="显示相机位姿"><a href="#显示相机位姿" class="headerlink" title="显示相机位姿"></a>显示相机位姿</h3><p>新建文件 <code>slambook/ch3/visualizeGeometry.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Core&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Geometry&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pangolin/pangolin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RotationMatrix</span> &#123;</span><br><span class="line">  Matrix3d matrix = Matrix3d::<span class="built_in">Identity</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ostream &amp;<span class="keyword">operator</span>&lt;&lt;(ostream &amp;out, <span class="type">const</span> RotationMatrix &amp;r) &#123;</span><br><span class="line">  out.<span class="built_in">setf</span>(ios::fixed);</span><br><span class="line">  Matrix3d matrix = r.matrix;</span><br><span class="line">  out &lt;&lt; <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">  out &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; <span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; <span class="built_in">matrix</span>(<span class="number">0</span>, <span class="number">0</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">0</span>, <span class="number">1</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">0</span>, <span class="number">2</span>) &lt;&lt; <span class="string">&quot;],&quot;</span></span><br><span class="line">      &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">1</span>, <span class="number">0</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">1</span>, <span class="number">1</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; <span class="string">&quot;],&quot;</span></span><br><span class="line">      &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">2</span>, <span class="number">0</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">2</span>, <span class="number">1</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; <span class="built_in">matrix</span>(<span class="number">2</span>, <span class="number">2</span>) &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">istream &amp;<span class="keyword">operator</span>&gt;&gt;(istream &amp;in, RotationMatrix &amp;r) &#123;</span><br><span class="line">  <span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TranslationVector</span> &#123;</span><br><span class="line">  Vector3d trans = <span class="built_in">Vector3d</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ostream &amp;<span class="keyword">operator</span>&lt;&lt;(ostream &amp;out, <span class="type">const</span> TranslationVector &amp;t) &#123;</span><br><span class="line">  out &lt;&lt; <span class="string">&quot;=[&quot;</span> &lt;&lt; t.<span class="built_in">trans</span>(<span class="number">0</span>) &lt;&lt; <span class="string">&#x27;,&#x27;</span> &lt;&lt; t.<span class="built_in">trans</span>(<span class="number">1</span>) &lt;&lt; <span class="string">&#x27;,&#x27;</span> &lt;&lt; t.<span class="built_in">trans</span>(<span class="number">2</span>) &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">istream &amp;<span class="keyword">operator</span>&gt;&gt;(istream &amp;in, TranslationVector &amp;t) &#123;</span><br><span class="line">  <span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">QuaternionDraw</span> &#123;</span><br><span class="line">  Quaterniond q;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ostream &amp;<span class="keyword">operator</span>&lt;&lt;(ostream &amp;out, <span class="type">const</span> QuaternionDraw quat) &#123;</span><br><span class="line">  <span class="keyword">auto</span> c = quat.q.<span class="built_in">coeffs</span>();</span><br><span class="line">  out &lt;&lt; <span class="string">&quot;=[&quot;</span> &lt;&lt; c[<span class="number">0</span>] &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; c[<span class="number">1</span>] &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; c[<span class="number">2</span>] &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; c[<span class="number">3</span>] &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">istream &amp;<span class="keyword">operator</span>&gt;&gt;(istream &amp;in, <span class="type">const</span> QuaternionDraw quat) &#123;</span><br><span class="line">  <span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  pangolin::<span class="built_in">CreateWindowAndBind</span>(<span class="string">&quot;visualize geometry&quot;</span>, <span class="number">1000</span>, <span class="number">600</span>);</span><br><span class="line">  <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">  <span class="function">pangolin::OpenGlRenderState <span class="title">s_cam</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    pangolin::ProjectionMatrix(<span class="number">1000</span>, <span class="number">600</span>, <span class="number">420</span>, <span class="number">420</span>, <span class="number">500</span>, <span class="number">300</span>, <span class="number">0.1</span>, <span class="number">1000</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">    pangolin::ModelViewLookAt(<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, pangolin::AxisY)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> UI_WIDTH = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">  pangolin::View &amp;d_cam = pangolin::<span class="built_in">CreateDisplay</span>().</span><br><span class="line">    <span class="built_in">SetBounds</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, pangolin::Attach::<span class="built_in">Pix</span>(UI_WIDTH), <span class="number">1.0</span>, <span class="number">-1000.0f</span> / <span class="number">600.0f</span>).</span><br><span class="line">    <span class="built_in">SetHandler</span>(<span class="keyword">new</span> pangolin::<span class="built_in">Handler3D</span>(s_cam));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ui</span></span><br><span class="line">  <span class="function">pangolin::Var&lt;RotationMatrix&gt; <span class="title">rotation_matrix</span><span class="params">(<span class="string">&quot;ui.R&quot;</span>, RotationMatrix())</span></span>;</span><br><span class="line">  <span class="function">pangolin::Var&lt;TranslationVector&gt; <span class="title">translation_vector</span><span class="params">(<span class="string">&quot;ui.t&quot;</span>, TranslationVector())</span></span>;</span><br><span class="line">  <span class="function">pangolin::Var&lt;TranslationVector&gt; <span class="title">euler_angles</span><span class="params">(<span class="string">&quot;ui.rpy&quot;</span>, TranslationVector())</span></span>;</span><br><span class="line">  <span class="function">pangolin::Var&lt;QuaternionDraw&gt; <span class="title">quaternion</span><span class="params">(<span class="string">&quot;ui.q&quot;</span>, QuaternionDraw())</span></span>;</span><br><span class="line">  pangolin::<span class="built_in">CreatePanel</span>(<span class="string">&quot;ui&quot;</span>).<span class="built_in">SetBounds</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, pangolin::Attach::<span class="built_in">Pix</span>(UI_WIDTH));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!pangolin::<span class="built_in">ShouldQuit</span>()) &#123;</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    d_cam.<span class="built_in">Activate</span>(s_cam);</span><br><span class="line"></span><br><span class="line">    pangolin::OpenGlMatrix matrix = s_cam.<span class="built_in">GetModelViewMatrix</span>();</span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">4</span>&gt; m = matrix;</span><br><span class="line"></span><br><span class="line">    RotationMatrix R;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++)</span><br><span class="line">        R.<span class="built_in">matrix</span>(i, j) = <span class="built_in">m</span>(j, i);</span><br><span class="line">    rotation_matrix = R;</span><br><span class="line"></span><br><span class="line">    TranslationVector t;</span><br><span class="line">    t.trans = <span class="built_in">Vector3d</span>(<span class="built_in">m</span>(<span class="number">0</span>, <span class="number">3</span>), <span class="built_in">m</span>(<span class="number">1</span>, <span class="number">3</span>), <span class="built_in">m</span>(<span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">    t.trans = -R.matrix * t.trans;</span><br><span class="line">    translation_vector = t;</span><br><span class="line"></span><br><span class="line">    TranslationVector euler;</span><br><span class="line">    euler.trans = R.matrix.<span class="built_in">eulerAngles</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    euler_angles = euler;</span><br><span class="line"></span><br><span class="line">    QuaternionDraw quat;</span><br><span class="line">    quat.q = <span class="built_in">Quaterniond</span>(R.matrix);</span><br><span class="line">    quaternion = quat;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glColor3f</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line">    pangolin::<span class="built_in">glDrawColouredCube</span>();</span><br><span class="line">    <span class="comment">// draw the original axis</span></span><br><span class="line">    <span class="built_in">glLineWidth</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">glColor3f</span>(<span class="number">0.8f</span>, <span class="number">0.f</span>, <span class="number">0.f</span>);</span><br><span class="line">    <span class="built_in">glBegin</span>(GL_LINES);</span><br><span class="line">    <span class="built_in">glVertex3f</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glVertex3f</span>(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glColor3f</span>(<span class="number">0.f</span>, <span class="number">0.8f</span>, <span class="number">0.f</span>);</span><br><span class="line">    <span class="built_in">glVertex3f</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glVertex3f</span>(<span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glColor3f</span>(<span class="number">0.2f</span>, <span class="number">0.2f</span>, <span class="number">1.f</span>);</span><br><span class="line">    <span class="built_in">glVertex3f</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glVertex3f</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">    pangolin::<span class="built_in">FinishFrame</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建CMakeLists.txt</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cmake_minimum_required( VERSION 2.8 )</span><br><span class="line">project( visualizeGeometry )</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_FLAGS <span class="string">&quot;-std=c++14&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加Eigen头文件</span></span><br><span class="line">include_directories( <span class="string">&quot;/usr/include/eigen3&quot;</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加Pangolin依赖</span></span><br><span class="line">find_package( Pangolin )</span><br><span class="line">include_directories( $&#123;Pangolin_INCLUDE_DIRS&#125; )</span><br><span class="line"></span><br><span class="line">add_executable( visualizeGeometry visualizeGeometry.cpp )</span><br><span class="line">target_link_libraries( visualizeGeometry $&#123;Pangolin_LIBRARIES&#125; )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hita@hita-vm:~/slambook/ch3/visualizeGeometry/build$ cmake ..</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/hita/slambook/ch3/visualizeGeometry/build</span><br><span class="line">hita@hita-vm:~/slambook/ch3/visualizeGeometry/build$ make</span><br><span class="line">[100%] Built target visualizeGeometry</span><br><span class="line">hita@hita-vm:~/slambook/ch3/visualizeGeometry/build$ ./visualizeGeometry </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jiangbaoaaa/my_blog_img@main/image-20250820160139624.png" alt="image-20250820160139624"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Hita</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
